<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-G1Z5RZE927"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-G1Z5RZE927');
  </script>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Campus - ילקוט דיגיטלי חכם</title>
  
  <!-- Meta Tags לשיתוף ברשתות חברתיות -->
  <meta name="description" content="My Campus - הילקוט הדיגיטלי החכם שלך. מחברות, משימות, יומן ועוד - הכל במקום אחד!">
  
  <!-- Open Graph (Facebook, WhatsApp, LinkedIn) -->
  <meta property="og:title" content="My Campus - ילקוט דיגיטלי חכם">
  <meta property="og:description" content="הילקוט הדיגיטלי החכם שלך. מחברות, משימות, יומן ועוד - הכל במקום אחד!">
  <meta property="og:image" content="https://brickyeda.github.io/digitalbag/logo.png">
  <meta property="og:url" content="https://brickyeda.github.io/digitalbag/">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="My Campus">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="My Campus - ילקוט דיגיטלי חכם">
  <meta name="twitter:description" content="הילקוט הדיגיטלי החכם שלך. מחברות, משימות, יומן ועוד - הכל במקום אחד!">
  <meta name="twitter:image" content="https://brickyeda.github.io/digitalbag/logo.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://brickyeda.github.io/digitalbag/logo.png">
  <link rel="apple-touch-icon" href="https://brickyeda.github.io/digitalbag/logo.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --accent-color: #4ecdc4;
      --text-primary: #2c3e50;
      --text-secondary: #7f8c8d;
      --background-main: #f8f9fa;
      --background-card: #ffffff;
      --border-color: #e9ecef;
      --shadow-light: rgba(0,0,0,0.1);
      --shadow-medium: rgba(0,0,0,0.15);
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --line-color: #d3d3d3;
      --line-dark: #b8b8b8;
      --margin-line: #ff6b6b;
      --task-high: #e74c3c;
      --task-medium: #f39c12;
      --task-low: #27ae60;
      --completed-task: #95a5a6;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--background-main);
      color: var(--text-primary);
      line-height: 1.6;
      direction: rtl;
      
      /* הגדלת מסך ברירת מחדל ל-75% */
      zoom: 0.85;
      -moz-transform: scale(0.75);
      -moz-transform-origin: 0 0;
    }

    /* Navigation Bar */
    .navbar {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 0 20px;
      box-shadow: 0 4px 20px var(--shadow-medium);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      height: 70px;
    }

    .navbar-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 100%;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.5rem;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .navbar-brand .logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
      animation: gentle-bounce 3s ease-in-out infinite;
    }

    @keyframes gentle-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    .navbar-menu {
      display: flex;
      gap: 0;
      list-style: none;
    }

    .navbar-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      position: relative;
    }

    .navbar-item:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-2px);
    }

    .navbar-item.active {
      background: rgba(255,255,255,0.2);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .navbar-item .icon {
      font-size: 1.2rem;
    }

    .navbar-user {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info {
      text-align: left;
    }

    .user-name {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .user-time {
      font-size: 1.3rem;
      font-weight: 700;
      opacity: 1;
    }

    .user-date {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .datetime-display {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .settings-icon {
      font-size: 1.3rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .settings-icon:hover {
      background: rgba(255,255,255,0.15);
      transform: rotate(30deg);
    }

    .fullscreen-icon {
      font-size: 1.3rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
      user-select: none;
    }

    .fullscreen-icon:hover {
      background: rgba(255,255,255,0.15);
      transform: scale(1.1);
    }

    .fullscreen-icon.active {
      background: rgba(255,255,255,0.2);
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    /* Page Container */
    .page-container {
      margin-top: 70px;
      min-height: calc(100vh - 70px);
    }

    .page {
      display: none;
      padding: 6px 20px;
      max-width: 1400px;
      margin: 0 auto;
      animation: fadeIn 0.5s ease-in;
      position: relative;
      min-height: 100vh;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }


    .gallery-view {
      display: none;
      padding: 40px 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .gallery-view.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }

    .gallery-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 0 10px;
    }

    .gallery-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .gallery-close-btn {
      background: var(--danger-color);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .gallery-close-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
      padding: 10px;
    }

    .gallery-item {
      background: var(--background-card);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 15px var(--shadow-light);
      border: 2px solid var(--border-color);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .gallery-item:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 8px 30px var(--shadow-medium);
      border-color: var(--primary-color);
    }

    .gallery-item.current-page {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
    }

    .gallery-thumbnail {
      width: 100%;
      height: 350px;
      position: relative;
      overflow: hidden;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gallery-thumbnail-content {
      width: 100%;
      height: 100%;
      transform: scale(0.85);
      transform-origin: center;
      pointer-events: none;
    }

    .gallery-info {
      padding: 15px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }

    .gallery-page-number {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .gallery-page-preview {
      font-size: 0.85rem;
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .gallery-empty {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-secondary);
    }

    .gallery-empty-icon {
      font-size: 5rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .gallery-empty-text {
      font-size: 1.2rem;
      font-weight: 600;
    }

    /* Zoom Controls */
.zoom-controls {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 8px;
  background: rgba(255, 255, 255, 0.95);
  padding: 6px 12px;
  border-radius: 10px;
  border: 2px solid var(--primary-color);
}
    .zoom-controls.active {
      display: flex;
    }

.zoom-btn {
  width: 35px;
  height: 35px;
  border: none;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1.2rem;
  font-weight: bold;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

    .zoom-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .zoom-btn:active {
      transform: scale(0.95);
    }

    .zoom-reset {
      background: var(--accent-color);
      font-size: 0.8rem;
      padding: 8px;
      height: auto;
    }

.zoom-level {
  text-align: center;
  font-size: 0.8rem;
  color: var(--text-primary);
  font-weight: 700;
  padding: 0 8px;
  min-width: 50px;
}

    #notebookContent {
      transform-origin: center;
      transition: transform 0.3s ease;
    }

/* Export Menu Styles */
.export-btn-wrapper {
  position: relative;
}

.export-menu {
  position: absolute;
  top: calc(100% + 5px);
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  padding: 10px;
  min-width: 220px;
  z-index: 1001;
  display: none;
  border: 2px solid var(--primary-color);
}

.export-menu.active {
  display: block;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.export-option {
  padding: 12px 15px;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.95rem;
  color: var(--text-primary);
  margin-bottom: 5px;
}

.export-option:last-child {
  margin-bottom: 0;
}

.export-option:hover {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  transform: translateX(-3px);
}

.export-option .icon {
  font-size: 1.2rem;
}

.export-option .text {
  flex: 1;
}

    /* Homepage Styles */
    .welcome-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
    }

    .welcome-section::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: float 8s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-30px) rotate(180deg); }
    }

    .welcome-content {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 40px;
      align-items: center;
    }

    .welcome-text h1 {
      font-size: 2.5rem;
      margin-bottom: 15px;
      font-weight: 700;
    }

    .welcome-text .subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .welcome-text .institution {
      font-size: 1rem;
      opacity: 0.8;
    }

    .welcome-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      min-width: 350px;
    }

    .stat-item {
      text-align: center;
      background: rgba(255,255,255,0.15);
      border-radius: 15px;
      padding: 15px;
      backdrop-filter: blur(10px);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .stat-item:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-3px);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    /* Notifications Panel */
    .notifications-panel {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      min-width: 320px;
      max-width: 400px;
      z-index: 99999;
      color: var(--text-primary);
      text-align: right;
    }

    .notifications-panel.show {
      display: block;
      animation: fadeInDown 0.3s ease;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    .notifications-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      font-size: 1rem;
    }

    .notifications-header button {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 5px;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .notifications-header button:hover {
      background: var(--border-color);
      color: var(--danger-color);
    }

    .notifications-list {
      max-height: 350px;
      overflow-y: auto;
      padding: 10px;
    }

    .notification-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 8px;
      background: var(--background-main);
      transition: all 0.2s;
    }

    .notification-item:hover {
      background: var(--border-color);
    }

    .notification-item.urgent {
      background: #fff5f5;
      border-right: 3px solid var(--danger-color);
    }

    .notification-item.warning {
      background: #fffbeb;
      border-right: 3px solid var(--warning-color);
    }

    .notification-icon {
      font-size: 1.5rem;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .notification-time {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .notification-empty {
      text-align: center;
      padding: 30px;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .tool-card {
      background: var(--background-card);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 25px var(--shadow-light);
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .tool-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      transform: scaleX(0);
      transform-origin: right;
      transition: transform 0.3s ease;
    }

    .tool-card:hover::before {
      transform: scaleX(1);
      transform-origin: left;
    }

    .tool-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 35px var(--shadow-medium);
    }

    .tool-icon {
      font-size: 3rem;
      margin-bottom: 20px;
      display: block;
    }

    .tool-title {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .tool-description {
      color: var(--text-secondary);
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .tool-status {
      font-size: 0.85rem;
      padding: 6px 12px;
      border-radius: 20px;
      background: var(--accent-color);
      color: white;
      display: inline-block;
    }

    /* Page Headers */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .back-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .back-btn:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }

    .add-page-btn {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .add-page-btn:hover {
      background: #219a52;
      transform: translateY(-2px);
    }

#notebookView .page-header {
  position: sticky;
  top: 70px;
  z-index: 100;
  background: var(--background-main);
  padding: 20px;
  margin: 0;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

#notebookContent {
  max-height: calc(100vh - 250px);
  overflow-y: auto;
padding: 0px 10px 10px 10px;
}

    /* Tasks Page Styles */
    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .tasks-stats {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .task-stat {
      text-align: center;
      padding: 15px 20px;
      background: var(--background-card);
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow-light);
      min-width: 100px;
    }

    .task-stat-number {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .task-stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .task-filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 2px solid var(--border-color);
      background: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .filter-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .filter-btn:hover {
      border-color: var(--primary-color);
    }

    .tasks-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
      margin-bottom: 30px;
    }

    .tasks-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .task-card {
      background: var(--background-card);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px var(--shadow-light);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      position: relative;
    }

    .task-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px var(--shadow-medium);
    }

    .task-card.completed {
      opacity: 0.7;
      background: #f8f9fa;
    }

    .task-card.completed .task-title {
      text-decoration: line-through;
      color: var(--completed-task);
    }

    .task-priority {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 8px;
      height: calc(100% - 30px);
      border-radius: 4px;
    }

    .task-priority.high { background: var(--task-high); }
    .task-priority.medium { background: var(--task-medium); }
    .task-priority.low { background: var(--task-low); }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      padding-right: 20px;
    }

    .task-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--text-primary);
    }

    .task-category {
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 12px;
      background: var(--accent-color);
      color: white;
      display: inline-block;
    }

    .task-content {
      margin-bottom: 15px;
      padding-right: 20px;
    }

    .task-description {
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .task-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
      padding-right: 20px;
    }

    .task-due-date {
      font-size: 0.9rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .task-due-date.overdue {
      color: var(--danger-color);
      font-weight: 600;
    }

    .task-due-date.today {
      color: var(--warning-color);
      font-weight: 600;
    }

    .task-actions {
      display: flex;
      gap: 10px;
    }

    .task-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }

    .complete-btn {
      background: var(--success-color);
      color: white;
    }

    .complete-btn:hover {
      background: #219a52;
    }

    .edit-btn {
      background: var(--warning-color);
      color: white;
    }

    .edit-btn:hover {
      background: #e67e22;
    }

    .delete-btn {
      background: var(--danger-color);
      color: white;
    }

    .delete-btn:hover {
      background: #c0392b;
    }

    /* Task Creator Panel */
    .task-creator {
      background: var(--background-card);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 25px var(--shadow-light);
      border: 1px solid var(--border-color);
      height: fit-content;
      position: sticky;
      top: 100px;
    }

    .creator-title {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
      font-family: inherit;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .priority-options {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    .priority-option {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .priority-option.high {
      border-color: var(--task-high);
      color: var(--task-high);
    }

    .priority-option.medium {
      border-color: var(--task-medium);
      color: var(--task-medium);
    }

    .priority-option.low {
      border-color: var(--task-low);
      color: var(--task-low);
    }

.priority-option.selected.high {
  background: var(--task-high);
  color: white;
  border-color: var(--task-high);
  font-weight: 600;
}

.priority-option.selected.medium {
  background: var(--task-medium);
  color: white;
  border-color: var(--task-medium);
  font-weight: 600;
}

.priority-option.selected.low {
  background: var(--task-low);
  color: white;
  border-color: var(--task-low);
  font-weight: 600;
}

    .create-task-btn {
      width: 100%;
      padding: 15px;
      background: var(--success-color);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .create-task-btn:hover {
      background: #219a52;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }

    .create-task-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Calendar Styles */
    .calendar-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--background-card);
      border-radius: 15px;
      box-shadow: 0 4px 15px var(--shadow-light);
    }

    .calendar-nav-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .calendar-nav-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .nav-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: all 0.3s ease;
    }

    .nav-btn:hover {
      background: var(--secondary-color);
      transform: scale(1.1);
    }

    .current-month {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .today-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .today-btn:hover {
      background: #45b7aa;
      transform: translateY(-2px);
    }

    .view-toggles {
      display: flex;
      background: var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    .view-btn {
      background: transparent;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      color: var(--text-secondary);
    }

    .view-btn.active {
      background: var(--primary-color);
      color: white;
    }

    .view-btn:hover:not(.active) {
      background: rgba(102, 126, 234, 0.1);
      color: var(--primary-color);
    }

    .calendar-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .calendar-stat {
      background: var(--background-card);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 15px var(--shadow-light);
      border: 1px solid var(--border-color);
    }

    .calendar-container {
      background: var(--background-card);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px var(--shadow-light);
      margin-bottom: 30px;
    }

    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      margin-bottom: 10px;
    }

    .calendar-day-header {
      padding: 15px 10px;
      text-align: center;
      font-weight: 600;
      color: var(--text-secondary);
      background: var(--background-main);
      border-radius: 8px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    .calendar-day {
      background: white;
      min-height: 120px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .calendar-day:hover {
      background: rgba(102, 126, 234, 0.05);
    }

    .calendar-day.other-month {
      background: #f8f9fa;
      color: var(--text-secondary);
    }

    .calendar-day.today {
      background: rgba(102, 126, 234, 0.1);
      border: 2px solid var(--primary-color);
    }

    .calendar-day.has-events {
      background: rgba(78, 205, 196, 0.05);
    }

    .day-number {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .day-events {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .event-item {
      background: var(--primary-color);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-item:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .event-item.lesson { background: #667eea; }
    .event-item.exam { background: #e74c3c; }
    .event-item.assignment { background: #f39c12; }
    .event-item.personal { background: #9b59b6; }
    .event-item.holiday { background: #27ae60; }
    .event-item.task { background: #4ecdc4; }

    .event-more {
      color: var(--text-secondary);
      font-size: 0.7rem;
      text-align: center;
      padding: 2px;
      cursor: pointer;
    }

    .quick-events {
      background: var(--background-card);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 25px var(--shadow-light);
    }

    .quick-events h3 {
      margin-bottom: 20px;
      color: var(--text-primary);
      font-size: 1.2rem;
    }

    .quick-event-buttons {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .quick-btn {
      background: white;
      border: 2px solid var(--border-color);
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quick-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px var(--shadow-light);
    }

    .lesson-btn:hover { border-color: #667eea; color: #667eea; }
    .exam-btn:hover { border-color: #e74c3c; color: #e74c3c; }
    .assignment-btn:hover { border-color: #f39c12; color: #f39c12; }
    .personal-btn:hover { border-color: #9b59b6; color: #9b59b6; }
    .holiday-btn:hover { border-color: #27ae60; color: #27ae60; }

    /* Calendar Sidebar Styles */
    .calendar-sidebar {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .events-search {
      background: var(--background-card);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px var(--shadow-light);
      border: 1px solid var(--border-color);
    }

    .events-search h3 {
      margin-bottom: 15px;
      color: var(--text-primary);
      font-size: 1.2rem;
    }

    .search-form {
      display: flex;
      flex-direction: column;
    }

    .events-list-sidebar {
      background: var(--background-card);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px var(--shadow-light);
      border: 1px solid var(--border-color);
      flex: 1;
      max-height: 500px;
      overflow-y: auto;
    }

    .events-list-sidebar h3 {
      margin-bottom: 15px;
      color: var(--text-primary);
      font-size: 1.2rem;
      position: sticky;
      top: 0;
      background: var(--background-card);
      padding-bottom: 10px;
    }

    .sidebar-events {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sidebar-event-item {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 12px;
      border-left: 4px solid var(--primary-color);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sidebar-event-item:hover {
      background: #e9ecef;
      transform: translateX(-5px);
    }

    .sidebar-event-item.lesson { border-left-color: #667eea; }
    .sidebar-event-item.exam { border-left-color: #e74c3c; }
    .sidebar-event-item.assignment { border-left-color: #f39c12; }
    .sidebar-event-item.personal { border-left-color: #9b59b6; }
    .sidebar-event-item.holiday { border-left-color: #27ae60; }
    .sidebar-event-item.task { border-left-color: #4ecdc4; }

    .sidebar-event-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .sidebar-event-details {
      font-size: 0.8rem;
      color: var(--text-secondary);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sidebar-event-time {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .sidebar-event-location {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Week View Styles */
    .week-view {
      background: var(--background-card);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px var(--shadow-light);
      margin-bottom: 30px;
    }

    .week-header {
      display: grid;
      grid-template-columns: 80px repeat(7, 1fr);
      gap: 1px;
      margin-bottom: 10px;
      background: var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    .week-time-label {
      background: var(--background-main);
      padding: 10px;
      text-align: center;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .week-day-header {
      background: var(--background-main);
      padding: 15px 10px;
      text-align: center;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .week-content {
      display: grid;
      grid-template-columns: 80px repeat(7, 1fr);
      gap: 1px;
      background: var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      min-height: 400px;
    }

    .week-hour-slot {
      background: white;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: flex-start;
      padding: 5px;
      min-height: 50px;
      position: relative;
    }

    .week-day-column {
      background: white;
      position: relative;
      min-height: 400px;
    }

    .week-event {
      background: var(--primary-color);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      margin: 2px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: absolute;
      left: 2px;
      right: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .week-event:hover {
      transform: scale(1.02);
      z-index: 10;
    }

    /* Day View Styles */
    .day-view {
      background: var(--background-card);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px var(--shadow-light);
      margin-bottom: 30px;
    }

    .day-header {
      text-align: center;
      padding: 20px;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 20px;
    }

    .day-header h3 {
      font-size: 1.8rem;
      margin-bottom: 5px;
      color: var(--text-primary);
    }

    .day-header .day-date {
      font-size: 1rem;
      color: var(--text-secondary);
    }

    .day-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 500px;
      overflow-y: auto;
    }

    .day-event {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      border-right: 4px solid var(--primary-color);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .day-event:hover {
      background: #e9ecef;
      transform: translateX(-5px);
    }

    .day-event.lesson { border-right-color: #667eea; }
    .day-event.exam { border-right-color: #e74c3c; }
    .day-event.assignment { border-right-color: #f39c12; }
    .day-event.personal { border-right-color: #9b59b6; }
    .day-event.holiday { border-right-color: #27ae60; }
    .day-event.task { border-right-color: #4ecdc4; }

    .day-event-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .day-event-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1.1rem;
    }

    .day-event-type {
      background: var(--primary-color);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .day-event-details {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .day-event-time {
      font-weight: 500;
      margin-bottom: 5px;
    }

    .day-event-location {
      margin-bottom: 5px;
    }

    .day-event-description {
      font-style: italic;
    }


    /* Event Creator Modal */
    .event-form-group {
      margin-bottom: 20px;
    }

    .event-type-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .event-type-option {
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      position: relative;
    }

    .event-type-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px var(--shadow-light);
    }

    .event-type-option.selected {
      border-color: var(--primary-color);
      background: rgba(102, 126, 234, 0.05);
    }

    .event-type-option.selected::after {
      content: '✓';
      position: absolute;
      top: 8px;
      left: 8px;
      background: var(--primary-color);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
    }

    .event-type-icon {
      font-size: 2rem;
      margin-bottom: 8px;
      display: block;
    }

    .event-type-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

.time-inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

/* תיקון עבור תאי תאריך בחיפוש */
.events-search .time-inputs {
  grid-template-columns: 1fr;
  gap: 8px;
}

.events-search .form-input[type="date"] {
  width: 100%;
  font-size: 0.85rem;
  padding: 8px 10px;
}

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary-color);
    }

    .repeat-options {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: rgba(102, 126, 234, 0.05);
      border-radius: 8px;
    }

    .repeat-options.show {
      display: block;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 1.5rem;
      margin-bottom: 10px;
    }

    .empty-description {
      font-size: 1rem;
      margin-bottom: 20px;
    }

    /* Notebooks Page Styles */
    .subjects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
    }

.subject-card {
  background: linear-gradient(135deg, white 0%, #fafafa 100%);
  border-radius: 20px;
  padding: 30px;
  box-shadow: 
    0 4px 12px rgba(0,0,0,0.08),
    0 12px 40px rgba(0,0,0,0.12),
    inset 0 -2px 8px rgba(0,0,0,0.03);
  border: 1px solid rgba(0,0,0,0.06);
  border-right: 6px solid var(--subject-color, #667eea);
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  transform: translateY(0) scale(1);
}

.subject-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 8px;
  background: linear-gradient(90deg, 
    var(--subject-color) 0%, 
    transparent 50%
  );
  opacity: 0.15;
}

.subject-card:hover {
  transform: translateY(-12px) scale(1.02);
  box-shadow: 
    0 8px 20px rgba(0,0,0,0.12),
    0 20px 60px rgba(0,0,0,0.18),
    inset 0 -2px 8px rgba(0,0,0,0.05);
  border-right-width: 8px;
}

    .subject-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 35px var(--shadow-medium);
    }

    .subject-icon {
      font-size: 3.5rem;
      margin-bottom: 20px;
      display: block;
    }

    .subject-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .subject-info {
      color: var(--text-secondary);
      margin-bottom: 15px;
    }

    .subject-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }

    .pages-count {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .last-updated {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .notebook-actions {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 5px;
      z-index: 10;
    }

    .notebook-delete-btn {
      background: var(--danger-color);
      color: white;
      border: none;
      padding: 5px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .notebook-delete-btn:hover {
      background: #c0392b;
    }

    .notebook-duplicate-btn {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 5px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .notebook-duplicate-btn:hover {
      background: linear-gradient(135deg, #2980b9, #1f6aa5);
      transform: scale(1.1);
    }

    .notebook-duplicate-btn.premium-locked {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      cursor: pointer;
    }

    .notebook-duplicate-btn.premium-locked:hover {
      background: linear-gradient(135deg, #f39c12, #e67e22);
    }

    /* Placeholder Pages */
    .placeholder-page {
      text-align: center;
      padding: 60px 40px;
      background: var(--background-card);
      border-radius: 20px;
      box-shadow: 0 8px 25px var(--shadow-light);
    }

    .placeholder-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.6;
    }

    .placeholder-title {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-primary);
    }

    .placeholder-desc {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 30px;
    }

    .placeholder-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .placeholder-btn:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .modal-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 600px;
      max-height: 85vh;
      overflow-y: auto;
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(50px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 25px 30px;
      border-radius: 20px 20px 0 0;
      position: relative;
    }

    .modal-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .close-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 30px;
    }

    .modal-footer {
      padding: 25px 30px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-cancel {
      background: #f8f9fa;
      color: var(--text-secondary);
      border: 2px solid var(--border-color);
    }

    .btn-cancel:hover {
      background: #e9ecef;
      color: var(--text-primary);
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

.radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 10px 15px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .radio-option:hover {
      background: var(--background-main);
      border-color: var(--primary-color);
    }

    .radio-option input[type="radio"] {
      cursor: pointer;
    }

    .radio-option span {
      font-weight: 500;
    }

    /* Notebook Page Styles */
    .notebook-page {
      min-height: 1200px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px var(--shadow-light);
      border: 1px solid var(--border-color);
      margin-bottom: 30px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .notebook-page.active-page {
      border: 3px solid var(--primary-color);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
    }

.notebook-header {
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf0 100%);
  padding: 10px 15px;
  border-bottom: 3px solid #d0d7de;
  box-shadow: 
    0 2px 8px rgba(0,0,0,0.08),
    inset 0 1px 0 rgba(255,255,255,0.8);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
}

.notebook-header::after {
  content: '';
  position: absolute;
  bottom: -3px;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, 
    transparent 0%, 
    rgba(0,0,0,0.1) 50%, 
    transparent 100%
  );
}

.notebook-title {
  font-size: 1.4rem;
  font-weight: 600;
  color: #2c3e50;
  margin: 0;
  text-shadow: 0 1px 2px rgba(255,255,255,0.8);
  letter-spacing: -0.5px;
}


    .notebook-title {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    /* Page Type Styles */
    /* דף שורות */
.lined-page {
  position: relative;
  min-height: 1100px;
  background: #fefef8;
  padding: 100px;  /* חזרה ל-padding רגיל */
  box-shadow: 
    inset 0 0 50px rgba(0,0,0,0.02),
    0 10px 30px rgba(0,0,0,0.1);
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}

/* שוליים אדומים בצד */
.lined-page::after {
  content: '';
  position: absolute;
  top: 0;
  right: 80px;  /* שנה מ-50px ל-80px */
  width: 2px;
  height: 100%;
  background: #ff6b6b;
  opacity: 0.6;
}

.lined-page::before {
  content: '';
  position: absolute;
  top: 30px;
  left: 30px;
  right: 80px;
  bottom: 30px;
  background-image: 
    repeating-linear-gradient(
      to bottom,
      transparent 0px,
      transparent 44px,  /* שינוי */
      #d4e2f0 44px,      /* שינוי */
      #d4e2f0 45px       /* שינוי */
    );
  background-size: 100% 50px;  /* שינוי מ-30px ל-45px */
  pointer-events: none;
  z-index: 0;
}

.lined-page::before {
  content: '';
  position: absolute;
  top: 30px;
  left: 30px;
  right: 80px;
  bottom: 30px;
  background-image: 
    repeating-linear-gradient(
      to bottom,
      transparent 0px,
      transparent 36px,    /* line-height פחות 9px */
      #d4e2f0 40px,
      #d4e2f0 37px,
      transparent 37px,
      transparent 45px     /* זה ה-line-height */
    );
  background-size: 100% 45px;
  background-position: 0 20px;  /* <-- זה החדש! מזיז את הקווים למטה */
  pointer-events: none;
  z-index: 0;
}

    .lined-textarea::placeholder {
      color: var(--text-secondary);
      opacity: 0.6;
    }

    /* דף משובץ */
.grid-page {
  position: relative;
  min-height: 1100px;
  background: #f8fbff;
  padding: 100px;  /* רגיל */
    }

.grid-page::before {
  content: '';
  position: absolute;
  top: 30px;
  left: 30px;
  right: 30px;
  bottom: 30px;
  background-image: 
    repeating-linear-gradient(
      to bottom,
      transparent 0px,
      transparent 19px,
      rgba(180, 200, 220, 0.4) 19px,
      rgba(180, 200, 220, 0.4) 20px
    ),
    repeating-linear-gradient(
      to right,
      transparent 0px,
      transparent 19px,
      rgba(180, 200, 220, 0.4) 19px,
      rgba(180, 200, 220, 0.4) 20px
    ),
    repeating-linear-gradient(
      to bottom,
      transparent 0px,
      transparent 99px,
      rgba(100, 140, 180, 0.6) 99px,
      rgba(100, 140, 180, 0.6) 100px
    ),
    repeating-linear-gradient(
      to right,
      transparent 0px,
      transparent 99px,
      rgba(100, 140, 180, 0.6) 99px,
      rgba(100, 140, 180, 0.6) 100px
    );
  background-size: 100% 20px, 20px 100%, 100% 100px, 100px 100%;
  pointer-events: none;
}

.grid-page {
  position: relative;
  min-height: 1100px;
  background: #f8fbff;
  padding: 60px;
  box-shadow: 
    inset 0 0 50px rgba(0,0,0,0.02),
    0 10px 30px rgba(0,0,0,0.1);
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}

.grid-page::after {
  content: '';
  position: absolute;
  top: 0;
  right: 40px;  /* התאם למרחק שרצית */
  width: 2px;
  height: 100%;
  background: linear-gradient(to bottom, #ff6b6b 0%, #ff8787 100%);
  opacity: 0.5;
}

.grid-page::before {
  content: '';
  position: absolute;
  top: 30px;
  left: 30px;
  right: 40px;  /* זהה ל-right של הקו האדום */
  bottom: 30px;
  background-image: 
    repeating-linear-gradient(
      to bottom,
      transparent 0px,
      transparent 19px,
      rgba(180, 200, 220, 0.4) 19px,
      rgba(180, 200, 220, 0.4) 20px
    ),
    repeating-linear-gradient(
      to right,
      transparent 0px,
      transparent 19px,
      rgba(180, 200, 220, 0.4) 19px,
      rgba(180, 200, 220, 0.4) 20px
    ),
    repeating-linear-gradient(
      to bottom,
      transparent 0px,
      transparent 99px,
      rgba(100, 140, 180, 0.6) 99px,
      rgba(100, 140, 180, 0.6) 100px
    ),
    repeating-linear-gradient(
      to right,
      transparent 0px,
      transparent 99px,
      rgba(100, 140, 180, 0.6) 99px,
      rgba(100, 140, 180, 0.6) 100px
    );
  background-size: 100% 20px, 20px 100%, 100% 100px, 100px 100%;
  pointer-events: none;
}

.grid-page::after {
  content: '';
  position: absolute;
  top: 0;
  right: 35px;
  width: 2px;
  height: 100%;
  background: linear-gradient(to bottom, #ff6b6b 0%, #ff8787 100%);
  opacity: 0.5;
}

.grid-textarea {
  width: calc(100% - 70px);  /* התאם בדיוק ל-right של המשבצות */
  height: 400px;
  border: none;
  outline: none;
  background: transparent;
  font-size: 1rem;
  line-height: 1.4;
  color: var(--text-primary);
  font-family: 'Consolas', 'Monaco', monospace;
  text-decoration: inherit; /* הוסף שורה זו */
  resize: none;
  position: relative;
  z-index: 1;
  padding: 0;
  margin: 0;
  margin-right: 30px;  /* זהה למרחק הקו האדום מהקצה */
}

    .grid-textarea::placeholder {
      color: var(--text-secondary);
      opacity: 0.6;
    }

    /* דף חלק */
.blank-page {
  position: relative;
  min-height: 500px;
  background: #fffef9;
  padding: 30px;
  box-shadow: 
    inset 0 0 80px rgba(0,0,0,0.03),
    0 10px 40px rgba(0,0,0,0.12),
    0 2px 8px rgba(0,0,0,0.06);
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}

/* טקסטורת נייר עדינה */
.blank-page::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 20% 30%, rgba(0,0,0,0.01) 1px, transparent 1px),
    radial-gradient(circle at 60% 70%, rgba(0,0,0,0.01) 1px, transparent 1px),
    radial-gradient(circle at 80% 20%, rgba(0,0,0,0.01) 1px, transparent 1px);
  background-size: 50px 50px, 80px 80px, 60px 60px;
  pointer-events: none;
  border-radius: 8px;
}

    .blank-page::before {
      content: '';
      position: absolute;
      top: 30px;
      left: 30px;
      right: 30px;
      bottom: 30px;
      background-image: 
        linear-gradient(to bottom, var(--line-color) 0px, var(--line-color) 1px, transparent 1px),
        linear-gradient(to right, var(--line-color) 0px, var(--line-color) 1px, transparent 1px),
        linear-gradient(to bottom, transparent calc(100% - 1px), var(--line-color) calc(100% - 1px)),
        linear-gradient(to right, transparent calc(100% - 1px), var(--line-color) calc(100% - 1px));
      background-size: 100% 1px, 1px 100%, 100% 1px, 1px 100%;
      background-position: 0 0, 0 0, 0 100%, 100% 0;
      background-repeat: no-repeat;
      pointer-events: none;
    }

    .blank-textarea {
      width: 100%;
      height: 400px;
      border: none;
      outline: none;
      background: transparent;
      font-size: 1.1rem;
      line-height: 1.6;
      color: var(--text-primary);
      font-family: 'Arial', sans-serif;
      resize: none;
      position: relative;
      z-index: 1;
      padding: 0;
      margin: 0;
    }

    .blank-textarea::placeholder {
      color: var(--text-secondary);
      opacity: 0.6;
    }

/* דף צ'קליסט */
.checklist-page {
  position: relative;
  min-height: 800px;
  background: linear-gradient(135deg, #f0fdf4, #ecfdf5);
  padding: 30px;
  box-shadow: 
    inset 0 0 50px rgba(0,0,0,0.02),
    0 10px 30px rgba(0,0,0,0.1);
  border-radius: 8px;
  border: 1px solid #bbf7d0;
}

.checklist-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 20px;
}

.checklist-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 15px;
  background: white;
  border-radius: 10px;
  border: 2px solid #e2e8f0;
  transition: all 0.3s ease;
}

.checklist-item:hover {
  border-color: #22c55e;
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
}

.checklist-item.completed {
  background: #f0fdf4;
  border-color: #86efac;
}

.checklist-item.completed .checklist-text {
  text-decoration: line-through;
  color: #9ca3af;
}

.checklist-checkbox {
  width: 24px;
  height: 24px;
  border: 2px solid #d1d5db;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.checklist-checkbox:hover {
  border-color: #22c55e;
  background: #f0fdf4;
}

.checklist-checkbox.checked {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border-color: #22c55e;
  color: white;
}

.checklist-text {
  flex: 1;
  border: none;
  outline: none;
  font-size: 1rem;
  background: transparent;
  color: #1f2937;
  font-family: inherit;
}

.checklist-text::placeholder {
  color: #9ca3af;
}

.checklist-delete {
  opacity: 0;
  background: none;
  border: none;
  color: #ef4444;
  cursor: pointer;
  font-size: 1.2rem;
  padding: 5px;
  transition: opacity 0.2s ease;
}

.checklist-item:hover .checklist-delete {
  opacity: 1;
}

.checklist-add-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 20px;
  margin-top: 10px;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.checklist-add-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
}

.checklist-add-btn:disabled {
  background: #d1d5db;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.checklist-limit-warning {
  text-align: center;
  padding: 15px;
  background: #fef3c7;
  border: 2px solid #fcd34d;
  border-radius: 10px;
  color: #92400e;
  margin-top: 15px;
}

.checklist-limit-warning button {
  margin-top: 10px;
  padding: 8px 20px;
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: 600;
  cursor: pointer;
}

.global-formatting-toolbar {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  border: 2px solid var(--border-color);
  border-radius: 10px;
  padding: 8px 15px;
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
  box-shadow: 0 4px 12px var(--shadow-light);
  
  /* השתמש ב-fixed */
  position: fixed;
  top: 70px;
  left: 240px;  /* אחרי סרגל הנוסחאות */
  right: 240px; /* לפני סרגל הציור */
  z-index: 90;
  margin: 0;
}

/* תוסיף ריפוד לתוכן כדי שלא יוסתר */
#notebookContent {
  margin-top: 100px; /* גובה סרגל הכלים הראשי + סרגל הציור + מרווחים */
}

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 10px;
      border-left: 2px solid var(--border-color);
    }

    .toolbar-group:first-child {
      border-left: none;
      padding-left: 0;
    }

    .toolbar-btn {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      min-width: 36px;
      height: 36px;
      justify-content: center;
    }

    .toolbar-btn:hover {
      background: #f8f9fa;
      border-color: var(--primary-color);
      transform: translateY(-1px);
    }

    .toolbar-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .toolbar-select {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.9rem;
      color: var(--text-primary);
      cursor: pointer;
      min-width: 80px;
      height: 36px;
    }

    .toolbar-select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .toolbar-color-btn {
      position: relative;
      width: 36px;
      height: 36px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .toolbar-color-btn::after {
      content: '';
      position: absolute;
      bottom: 3px;
      left: 3px;
      right: 3px;
      height: 4px;
      border-radius: 2px;
    }

    .text-color-btn::after {
      background: var(--current-text-color, #000000);
    }

    .bg-color-btn::after {
      background: var(--current-bg-color, #ffff00);
    }

    .color-picker {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 4px 20px var(--shadow-medium);
      z-index: 1000;
      display: none;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      width: 200px;
    }

    .color-picker.show {
      display: grid;
    }

    .color-option-mini {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: transform 0.2s ease;
    }

    .color-option-mini:hover {
      transform: scale(1.2);
    }

/* Math Formulas Toolbar */
/* Math Formulas Toolbar - Vertical Sidebar */
.math-formulas-toolbar {
  background: linear-gradient(180deg, #f39c12, #e67e22);
  border: 2px solid var(--border-color);
  border-radius: 15px;
  padding: 20px 15px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  box-shadow: 0 4px 12px var(--shadow-light);
  position: absolute;
  left: -190px;
  top: 120px;
  width: 200px;
  max-height: calc(100vh - 180px);
  overflow-y: auto;
  z-index: 100;
  transition: all 0.3s ease;
}

.math-formulas-toolbar:hover {
scrollbar-gutter: stable;
  width: 220px;
  box-shadow: 0 8px 20px var(--shadow-medium);

}

.formulas-title {
  font-size: 1rem;
  font-weight: 600;
  color: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  text-align: center;
  padding-bottom: 15px;
  border-bottom: 2px solid rgba(255,255,255,0.3);
}

.formulas-title span {
  font-size: 1.8rem;
}

.formulas-container {
  display: flex;
  flex-direction: column;
  gap: 15px;
  width: 100%;
}

.formula-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 15px 0;
  border-top: 2px solid rgba(255,255,255,0.2);
  width: 100%;
}

.formula-group:first-of-type {
  border-top: none;
  padding-top: 0;
}
/* כפתור קישור לנוסחאון PDF */
.nuschon-link-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  background: white;
  color: #e67e22;
  border: 2px solid rgba(255,255,255,0.5);
  border-radius: 10px;
  padding: 12px 15px;
  font-size: 0.95rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 10px;
}

.nuschon-link-btn:hover {
  background: #fff5eb;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.formula-item {
  background: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px 12px;
  cursor: grab;
  font-family: 'Times New Roman', serif;
  font-size: 14px;
  color: var(--text-primary);
  transition: all 0.2s ease;
  user-select: none;
  text-align: center;
  position: relative;
  white-space: nowrap;
  width: 100%;
  box-sizing: border-box;
}

/* נוסחא שנשחררה על הדף */
.dropped-formula {
  position: absolute;
  background: white;
  border: 2px solid #f39c12;
  border-radius: 8px;
  padding: 10px 15px;
  cursor: move;
  font-family: 'Times New Roman', serif;
  font-size: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 5;
  min-width: 60px;
  min-height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: visible;
  
  /* תיקון כיוון הטקסט */
  direction: ltr !important;
  text-align: center !important;
  unicode-bidi: embed;
}

.dropped-formula:hover {
  border-color: #e67e22;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.dropped-formula.selected {
  border-color: #667eea;
  border-width: 3px;
}

/* תוכן הנוסחה */
.formula-content {
  white-space: nowrap;
  outline: none;
  cursor: text;
  min-width: 20px;
}

.formula-content:focus {
  background: #fffef8;
  border-radius: 4px;
}

/* כפתור מחיקה */
.formula-delete-btn {
  position: absolute;
  top: -10px;
  right: -10px;
  background: #e74c3c;
  color: white;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  z-index: 15;
  border: 2px solid white;
}

.dropped-formula:hover .formula-delete-btn,
.dropped-formula.selected .formula-delete-btn {
  display: flex;
}

/* ידיות למתיחה - RESIZE HANDLES */
.formula-resize-handle {
  position: absolute;
  width: 12px;
  height: 12px;
  background: #667eea;
  border: 2px solid white;
  border-radius: 2px;
  z-index: 10;
  display: none;
}

.dropped-formula:hover .formula-resize-handle,
.dropped-formula.selected .formula-resize-handle {
  display: block;
}

.formula-resize-handle.top-right {
  top: -6px;
  right: -6px;
  cursor: ne-resize;
}

.formula-resize-handle.top-left {
  top: -6px;
  left: -6px;
  cursor: nw-resize;
}

.formula-resize-handle.bottom-right {
  bottom: -6px;
  right: -6px;
  cursor: se-resize;
}

.formula-resize-handle.bottom-left {
  bottom: -6px;
  left: -6px;
  cursor: sw-resize;
}

.formula-resize-handle.middle-right {
  top: 50%;
  right: -6px;
  transform: translateY(-50%);
  cursor: e-resize;
}

.formula-resize-handle.middle-left {
  top: 50%;
  left: -6px;
  transform: translateY(-50%);
  cursor: w-resize;
}

.formula-resize-handle.top-middle {
  top: -6px;
  left: 50%;
  transform: translateX(-50%);
  cursor: n-resize;
}

.formula-resize-handle.bottom-middle {
  bottom: -6px;
  left: 50%;
  transform: translateX(-50%);
  cursor: s-resize;
}

.formula-item:active {
  cursor: grabbing;
  transform: scale(0.95);
}


.formula-item.dragging {
  opacity: 0.5;
  transform: rotate(5deg);
}

.formula-preview {
  position: absolute;
  left: 100%;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 11px;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
  z-index: 1000;
  margin-left: 10px;
}

.formula-item:hover .formula-preview {
  opacity: 1;
}

/* Scrollbar for formulas toolbar */
.math-formulas-toolbar::-webkit-scrollbar {
  width: 10px;
}

.math-formulas-toolbar::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.1);
}

.math-formulas-toolbar::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.4);
  border-radius: 2px;
}

.math-formulas-toolbar::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.6);
}/* Math Formulas Toolbar - Vertical Sidebar */

.math-formulas-toolbar:hover {
  width: 220px;
  box-shadow: 0 8px 20px var(--shadow-medium);
}

.formulas-title {
  font-size: 1rem;
  font-weight: 600;
  color: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  text-align: center;
  padding-bottom: 15px;
  border-bottom: 2px solid rgba(255,255,255,0.3);
}

.formulas-title span {
  font-size: 1.8rem;
}

.formulas-container {
  display: flex;
  flex-direction: column;
  gap: 15px;
  width: 100%;
}

.formula-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 15px 0;
  border-top: 2px solid rgba(255,255,255,0.2);
  width: 100%;
}

.formula-group:first-of-type {
  border-top: none;
  padding-top: 0;
}

.formula-item {
  background: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px 12px;
  cursor: grab;
  font-family: 'Times New Roman', serif;
  font-size: 14px;
  color: var(--text-primary);
  transition: all 0.2s ease;
  user-select: none;
  text-align: center;
  position: relative;
  white-space: nowrap;
  width: 100%;
  box-sizing: border-box;
}

.formula-item:hover {
  transform: translateX(-5px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  background: #f8f9fa;
  z-index: 10;
}

.formula-item:active {
  cursor: grabbing;
  transform: scale(0.95);
}

.formula-item.dragging {
  opacity: 0.5;
  transform: rotate(5deg);
}

.formula-preview {
  position: absolute;
  left: 100%;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 11px;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
  z-index: 1000;
  margin-left: 10px;
}

.formula-item:hover .formula-preview {
  opacity: 1;
}

/* Scrollbar for formulas toolbar */
.math-formulas-toolbar::-webkit-scrollbar {
  width: 20px;
}

.math-formulas-toolbar::-webkit-scrollbar-track {
background: rgba(24, 9, 236, 0.7);}

.math-formulas-toolbar::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.4);
  border-radius: 2px;
}

.math-formulas-toolbar::-webkit-scrollbar-thumb:hover {
background: rgba(24, 9, 236, 0.9);
}


/* Shape Options Dropdown - Adjusted for sidebar */
/* Shape Options Dropdown */
.shape-dropdown {
  position: relative;
  display: inline-block;
}

.shape-dropdown .drawing-btn {
  margin: 0;
}

.shape-options {
  display: none;
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  margin-top: 8px;
  background: white;
  border: 2px solid #ddd;
  border-radius: 10px;
  padding: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  z-index: 2000;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  min-width: 250px;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

/* פתיחה בריחוף */
.shape-dropdown:hover .shape-options {
  display: grid;
  opacity: 1;
  visibility: visible;
}

.shape-options.show {
  display: grid;
  opacity: 1;
  visibility: visible;
}

.shape-option {
  padding: 12px 8px;
  border: 2px solid #ddd;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
  font-size: 0.8rem;
  background: white;
  font-weight: 500;
}

.shape-option:hover {
  background: #f8f9fa;
  border-color: var(--primary-color);
  transform: scale(1.05);
}

.shape-option.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* Interactive Image Styling */
.interactive-image-container {
  position: absolute;
  cursor: move;
  user-select: none;
  z-index: 10;
  border: 2px dashed transparent;
  transition: border 0.2s ease;
}

.interactive-image-container:hover {
  border-color: var(--primary-color);
}

.interactive-image-container.selected {
  border: 2px solid var(--primary-color);
}

.interactive-image-container img {
  display: block;
  width: 100%;
  height: 100%;
  pointer-events: none;
  border-radius: 8px;
}

/* Image Controls */
.image-controls {
  position: absolute;
  top: -40px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 5px;
  display: none;
  gap: 5px;
  box-shadow: 0 4px 12px var(--shadow-light);
  z-index: 100;
}

.interactive-image-container.selected .image-controls {
  display: flex;
}

.image-control-btn {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  width: 30px;
  height: 30px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.2s ease;
}

.image-control-btn:hover {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* Resize Handles */
.resize-handle {
  position: absolute;
  width: 10px;
  height: 10px;
  background: var(--primary-color);
  border: 2px solid white;
  border-radius: 50%;
  display: none;
}

.interactive-image-container.selected .resize-handle {
  display: block;
}

.resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
.resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
.resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
.resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

/* PDF Viewer Container */
.pdf-viewer-container {
  position: absolute;
  background: white;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  box-shadow: 0 8px 24px var(--shadow-medium);
  cursor: move;
  user-select: none;
  z-index: 15;
  overflow: hidden;
  min-width: 400px;
  min-height: 500px;
}

.pdf-viewer-container.selected {
  border-color: var(--primary-color);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
}

.pdf-viewer-header {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  padding: 12px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: move;
}

.pdf-viewer-title {
  font-weight: 600;
  font-size: 0.95rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

.pdf-viewer-controls {
  display: flex;
  gap: 5px;
}

.pdf-control-btn {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  color: white;
  border-radius: 4px;
  width: 28px;
  height: 28px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.2s ease;
}

.pdf-control-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.05);
}

.pdf-viewer-body {
  background: #f5f5f5;
  padding: 15px;
  overflow-y: auto;
  max-height: 600px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.pdf-page-canvas {
  background: white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin: 5px 0;
  border-radius: 4px;
}

.pdf-viewer-footer {
  background: var(--background-main);
  padding: 10px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top: 1px solid var(--border-color);
}

.pdf-page-nav {
  display: flex;
  gap: 10px;
  align-items: center;
}

.pdf-nav-btn {
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: all 0.2s ease;
}

.pdf-nav-btn:hover {
  background: var(--secondary-color);
}

.pdf-nav-btn:disabled {
  background: var(--text-secondary);
  cursor: not-allowed;
  opacity: 0.5;
}

.pdf-page-info {
  font-size: 0.9rem;
  color: var(--text-secondary);
  font-weight: 500;
}

/* Resize Handles for PDF */
.pdf-viewer-container .resize-handle {
  position: absolute;
  width: 10px;
  height: 10px;
  background: var(--primary-color);
  border: 2px solid white;
  border-radius: 50%;
  display: none;
}

.pdf-viewer-container.selected .resize-handle {
  display: block;
}
/* Scrollbar for toolbar */
.drawing-toolbar::-webkit-scrollbar {
  height: 4px;
  width: 4px;
}

.drawing-toolbar::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.1);
}

.drawing-toolbar::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.4);
  border-radius: 2px;
}

.drawing-toolbar::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.6);
}

/* Scrollbar for drawing-controls - זה מה שבאמת רואים! */
.drawing-controls::-webkit-scrollbar {
  height: 3px;
}

.drawing-controls::-webkit-scrollbar-track {
  background: transparent;
}

.drawing-controls::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.3);
  border-radius: 10px;
}

.drawing-controls::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.5);
}

/* Drawing Layer */
.page-canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 10;
}

.page-canvas.drawing-active {
  pointer-events: auto;
  cursor: crosshair;
}

    /* Enhanced textarea with rich formatting support */
    .enhanced-textarea {
      width: 100%;
      height: 1100px;
      border: none;
      outline: none;
      background: transparent;
      font-size: 1.1rem;
      line-height: 1.6;
      color: var(--text-primary);
      font-family: 'Arial', sans-serif;
      resize: none;
      position: relative;
      z-index: 1;
      padding: 0;
      margin: 0;
    }

    /* Formatting classes for rich text */
    .bold { font-weight: bold; }
    .italic { font-style: italic; }
    .underline { text-decoration: underline; }
    .strikethrough { text-decoration: line-through; }
    
    .text-left { text-align: left; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-justify { text-align: justify; }

    .font-small { font-size: 0.9rem; }
    .font-normal { font-size: 1.1rem; }
    .font-large { font-size: 1.3rem; }
    .font-extra-large { font-size: 1.6rem; }

    /* Special formatting indicators */
    .formatting-indicator {
      position: absolute;
      top: 5px;
      right: 10px;
      background: rgba(102, 126, 234, 0.1);
      color: var(--primary-color);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* Delete button for pages */
    .tool-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 500;
    }

    .tool-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .delete-page-btn {
      background: var(--danger-color) !important;
    }

    .delete-page-btn:hover {
      background: #c0392b !important;
    }

    /* Modal for creating notebooks */
    .form-section {
      margin-bottom: 30px;
    }

    .form-section:last-child {
      margin-bottom: 0;
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .page-type-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .page-type-option {
      border: 2px solid var(--border-color);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      position: relative;
    }

    .page-type-option:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px var(--shadow-light);
    }

    .page-type-option.selected {
      border-color: var(--primary-color);
      background: rgba(102, 126, 234, 0.05);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .page-type-option.selected::after {
      content: '✓';
      position: absolute;
      top: 8px;
      left: 8px;
      background: var(--primary-color);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .page-type-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
      display: block;
    }

    .page-type-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--text-primary);
    }

    .page-type-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
    }

    .color-option {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s ease;
      position: relative;
    }

    .color-option:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .color-option.selected {
      border-color: white;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.3);
      transform: scale(1.05);
    }

    .color-option.selected::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    .color-preview {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .preview-swatch {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      border: 2px solid white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .preview-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .btn-create {
      background: var(--success-color);
      color: white;
    }

    .btn-create:hover {
      background: #229954;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }

    .btn-create:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .navbar-menu {
        display: none;
      }

      .welcome-content {
        grid-template-columns: 1fr;
        text-align: center;
      }

      .welcome-stats {
        justify-self: center;
      }

      .page-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }

      .tools-grid,
      .subjects-grid {
        grid-template-columns: 1fr;
      }

      .tasks-grid {
        grid-template-columns: 1fr;
      }

      .task-creator {
        position: static;
        order: -1;
      }

      .tasks-header {
        flex-direction: column;
        align-items: stretch;
      }

      .tasks-stats {
        justify-content: center;
      }

      .page {
        padding: 20px 15px;
      }

      .modal-content {
        width: 95%;
        margin: 10px;
      }

      .modal-footer {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      /* Notebook mobile styles */
      .global-formatting-toolbar {
        padding: 8px 12px;
        gap: 8px;
      }

      .toolbar-group {
        padding: 0 5px;
        gap: 4px;
      }

      .toolbar-btn {
        min-width: 32px;
        height: 32px;
        padding: 4px 8px;
        font-size: 0.8rem;
      }

.toolbar-btn.active {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  transform: scale(0.95);
  box-shadow: inset 0 2px 8px rgba(0,0,0,0.2);
}

.toolbar-btn.active:hover {
  transform: scale(0.95);
  background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
}

      .toolbar-select {
        min-width: 70px;
        height: 32px;
        font-size: 0.8rem;
      }

      .lined-page,
      .grid-page, 
      .blank-page {
        padding: 20px;
      }
      
      .lined-textarea,
      .grid-textarea,
      .blank-textarea {
        height: 300px;
        font-size: 1rem;
      }
      
      .lined-textarea {
        line-height: 50px;
      }

      .page-type-grid {
        grid-template-columns: 1fr;
      }

      .color-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      .calendar-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .quick-event-buttons {
        justify-content: center;
      }

      .event-type-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .time-inputs {
        grid-template-columns: 1fr;
      }

      /* Calendar Sidebar Mobile */
      .calendar-sidebar {
        margin-bottom: 20px;
      }

      .events-search {
        padding: 15px;
      }

      .events-list-sidebar {
        max-height: 300px;
        padding: 15px;
      }

      /* Calendar Grid Mobile */
      #calendar .page {
        padding: 15px 10px;
      }

      #calendar div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
    }

/* אנימציית הופעת דף */
@keyframes pageFlip {
  0% {
    opacity: 0;
    transform: perspective(1000px) rotateY(-15deg);
    transform-origin: right center;
  }
  100% {
    opacity: 1;
    transform: perspective(1000px) rotateY(0deg);
  }
}

.notebook-page {
  animation: pageFlip 0.6s ease-out;
}

/* אנימציה לכתיבה */
@keyframes textGlow {
  0%, 100% {
    text-shadow: none;
  }
  50% {
    text-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
  }
}

.enhanced-textarea:focus {
  animation: textGlow 2s ease-in-out infinite;
}

:root {
  --paper-texture: 
    radial-gradient(circle at 20% 30%, rgba(0,0,0,0.02) 1px, transparent 1px),
    radial-gradient(circle at 60% 70%, rgba(0,0,0,0.015) 1px, transparent 1px),
    radial-gradient(circle at 80% 20%, rgba(0,0,0,0.02) 1px, transparent 1px);
  --paper-shadow: 
    0 1px 2px rgba(0,0,0,0.05),
    0 4px 12px rgba(0,0,0,0.08),
    0 12px 40px rgba(0,0,0,0.1);
}

/* Calculator Styles */
.mode-btn:hover {
  background: rgba(102, 126, 234, 0.1) !important;
  color: var(--primary-color) !important;
}

.mode-btn.active {
  background: var(--primary-color) !important;
  color: white !important;
}

.button-grid button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.button-grid button:active {
  transform: translateY(0);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.history-item {
  padding: 15px;
  background: #f8f9fa;
  border-radius: 10px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  border-right: 4px solid var(--primary-color);
}

.history-item:hover {
  background: #e9ecef;
  transform: translateX(-5px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.history-expression {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 5px;
  direction: ltr;
  text-align: left;
}

.history-result {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 5px;
  direction: ltr;
  text-align: left;
  font-family: 'Courier New', monospace;
}

.history-time {
  font-size: 0.75rem;
  color: var(--text-secondary);
  opacity: 0.7;
}

/* Programmer Mode Styles */
.programmer-mode.button-grid {
  display: none;
}

.programmer-displays {
  display: none;
}

/* Show programmer displays when in programmer mode */
body:has(.mode-btn[data-mode="programmer"].active) .programmer-displays {
  display: block !important;
}

/* Base buttons in programmer mode */
[onclick*="setBase"].active {
  background: var(--primary-color) !important;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

/* Hex buttons disabled state */
.hex-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

/* הדגשת כפתורים פעילים בסרגל כלים */
.toolbar-btn.format-active {
  background: rgba(102, 126, 234, 0.2);
  border: 2px solid var(--primary-color);
  transform: scale(0.95);
}

/* ===== Sticky Notes Styles ===== */
.sticky-notes-fab {
  position: fixed;
  bottom: 30px;
  left: 100px;
  width: 70px;
  height: 70px;
  background: linear-gradient(135deg, #ffd700, #ffed4e);
  border-radius: 50%;
  box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 9999;
  font-size: 1.8rem;
  transition: all 0.3s ease;
  border: 3px solid #f0c800;
}

.sticky-notes-fab:hover {
  transform: scale(1.1) rotate(5deg);
  box-shadow: 0 6px 30px rgba(255, 215, 0, 0.6);
}

.sticky-notes-fab:active {
  transform: scale(0.95);
}

.sticky-note {
  position: fixed;
  width: 280px;
  min-height: 200px;
  background: #ffd700;
  border-radius: 8px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
  z-index: 9000;
  display: flex;
  flex-direction: column;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  resize: both;
  overflow: auto;
}

.sticky-note.color-yellow { background: #ffd700; }
.sticky-note.color-pink { background: #ffb3d9; }
.sticky-note.color-blue { background: #a8d8ff; }
.sticky-note.color-green { background: #b3ffb3; }
.sticky-note.color-purple { background: #d4b3ff; }
.sticky-note.color-orange { background: #ffcc99; }

.sticky-note-header {
  padding: 10px 12px;
  cursor: move;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  user-select: none;
}

.sticky-note-title {
  font-weight: 600;
  font-size: 0.9rem;
  color: rgba(0, 0, 0, 0.7);
  flex: 1;
}

.sticky-note-controls {
  display: flex;
  gap: 8px;
}

.sticky-note-btn {
  width: 24px;
  height: 24px;
  border: none;
  background: rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.sticky-note-btn:hover {
  background: rgba(0, 0, 0, 0.2);
  transform: scale(1.1);
}

.sticky-note-content {
  flex: 1;
  padding: 15px;
  outline: none;
  border: none;
  background: transparent;
  font-size: 0.95rem;
  line-height: 1.6;
  color: #333;
  resize: none;
  font-family: inherit;
  overflow-y: auto;
}

.sticky-note-content::-webkit-scrollbar {
  width: 6px;
}

.sticky-note-content::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 3px;
}

.sticky-notes-menu {
  position: fixed;
  bottom: 100px;
  left: 30px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
  padding: 15px;
  z-index: 10000;
  display: none;
  min-width: 220px;
}

.sticky-notes-menu.show {
  display: block;
  animation: slideUp 0.3s ease;
}

.menu-title {
  font-weight: 600;
  font-size: 0.95rem;
  color: var(--text-primary);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.color-options {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 15px;
}

.color-option {
  width: 50px;
  height: 50px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 3px solid transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
}

.color-option:hover {
  transform: scale(1.1);
  border-color: var(--primary-color);
}

.color-option.yellow { background: #ffd700; }
.color-option.pink { background: #ffb3d9; }
.color-option.blue { background: #a8d8ff; }
.color-option.green { background: #b3ffb3; }
.color-option.purple { background: #d4b3ff; }
.color-option.orange { background: #ffcc99; }

.menu-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
  font-size: 0.85rem;
  color: var(--text-secondary);
}

@keyframes fadeOut {
  from { opacity: 1; transform: scale(1); }
  to { opacity: 0; transform: scale(0.8); }
}

/* ===== Timer Page Styles ===== */
#timer.page {
  position: fixed;        /* ← חדש! מצמיד את הדף */
  top: 70px;             /* ← מתחיל בדיוק אחרי ה-navbar */
  left: 0;               /* ← צמוד לשמאל */
  right: 0;              /* ← צמוד לימין */
  bottom: 0;             /* ← צמוד לתחתית */
  padding: 15px;         /* ← רק 15px מסביב */
}
.timer-container {
  width: 100%;
  max-width: 1400px;
  height: auto;
  max-height: none;
  background: white;
  border-radius: 30px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  overflow: visible;
  animation: slideIn 0.6s ease-out;
  display: flex;
  flex-direction: column;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.timer-header {
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  color: white;
  padding: 20px 30px;
  text-align: center;
  flex-shrink: 0;
}

.timer-header h1 {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 5px;
  text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.timer-header p {
  font-size: 0.95rem;
  opacity: 0.9;
}

.timer-tabs {
  display: flex;
  background: #f8fafc;
  border-bottom: 2px solid #e2e8f0;
  flex-shrink: 0;
}

.timer-tab {
  flex: 1;
  padding: 15px;
  text-align: center;
  font-size: 1.1rem;
  font-weight: 600;
  color: #64748b;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  background: none;
  border: none;
  font-family: inherit;
}

.timer-tab:hover {
  background: rgba(99, 102, 241, 0.05);
  color: #6366f1;
}

.timer-tab.active {
  color: #6366f1;
  background: white;
}

.timer-tab.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #6366f1, #8b5cf6);
  animation: slideTimerWidth 0.3s ease;
}

@keyframes slideTimerWidth {
  from { width: 0; left: 50%; }
  to { width: 100%; left: 0; }
}

.timer-content {
  padding: 20px 30px;
  flex: 1;
  overflow: visible;
  display: flex;
  flex-direction: column;
}

.timer-tab-content {
  display: none;
  animation: fadeIn 0.4s ease;
  flex: 1;
  overflow: visible;
}

.timer-tab-content.active {
  display: flex;
  flex-direction: row;
  gap: 30px;
  align-items: flex-start;
}

.timer-display {
  text-align: center;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  gap: 10px;
}

.timer-time {
  font-size: 3.5rem;
  font-weight: 700;
  font-family: 'Courier New', monospace;
  background: linear-gradient(135deg, #6366f1, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: 0.05em;
  text-shadow: 0 5px 15px rgba(0,0,0,0.1);
  line-height: 1;
}

.timer-time-label {
  font-size: 0.9rem;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  font-weight: 600;
}

.timer-visual-indicator {
  width: 120px;
  height: 120px;
  position: relative;
}

.timer-circle-progress {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}

.timer-circle-bg {
  fill: none;
  stroke: #e2e8f0;
  stroke-width: 8;
}

.timer-circle-fill {
  fill: none;
  stroke: url(#timerGradient);
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dashoffset 0.3s ease;
}

.timer-pulse-ring {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 130px;
  height: 130px;
  border-radius: 50%;
  border: 3px solid #6366f1;
  opacity: 0;
}

.timer-pulse-ring.active {
  animation: timerPulse 2s ease-out infinite;
}

@keyframes timerPulse {
  0% {
    transform: translate(-50%, -50%) scale(0.8);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(1.3);
    opacity: 0;
  }
}

.timer-center-icon {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 3.5rem;
  opacity: 0.8;
}

.timer-controls {
  display: flex;
  flex-direction: column;
  gap: 12px;
  justify-content: center;
  min-width: 200px;
}

.timer-btn {
  padding: 15px 25px;
  font-size: 1rem;
  font-weight: 600;
  border: none;
  border-radius: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 10px;
  justify-content: center;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-family: inherit;
  width: 100%;
}

.timer-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.timer-btn:active {
  transform: translateY(-1px);
}

.timer-btn-primary {
  background: linear-gradient(135deg, #10b981, #34d399);
  color: white;
}

.timer-btn-warning {
  background: linear-gradient(135deg, #f59e0b, #fbbf24);
  color: white;
}

.timer-btn-danger {
  background: linear-gradient(135deg, #ef4444, #f87171);
  color: white;
}

.timer-btn-secondary {
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: white;
}

.timer-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.timer-input-section {
  display: flex;
  gap: 15px;
  justify-content: center;
  align-items: center;
  margin-bottom: 15px;
  padding: 15px 20px;
  background: linear-gradient(145deg, #f8fafc, #f1f5f9);
  border-radius: 16px;
  border: 2px solid #e2e8f0;
}

.timer-input-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  position: relative;
}

.timer-input-icon {
  font-size: 1.2rem;
  margin-bottom: 2px;
  filter: grayscale(0.3);
  transition: all 0.3s ease;
}

.timer-input-group:focus-within .timer-input-icon {
  filter: grayscale(0);
  transform: scale(1.1);
}

.timer-input-group input {
  width: 60px;
  padding: 10px 8px;
  font-size: 1.4rem;
  text-align: center;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  font-weight: 700;
  color: #667eea;
  background: white;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: 'Segoe UI', system-ui, sans-serif;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.timer-input-group input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15), 0 4px 15px rgba(102, 126, 234, 0.15);
  transform: scale(1.05);
}

.timer-input-group input::placeholder {
  color: #cbd5e1;
}

.timer-input-group label {
  font-size: 0.75rem;
  font-weight: 600;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.timer-input-separator {
  font-size: 1.8rem;
  font-weight: 700;
  color: #94a3b8;
  margin-top: -10px;
}

.timer-input-label {
  font-size: 0.8rem;
  font-weight: 600;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.timer-time-input {
  width: 80px;
  padding: 12px;
  font-size: 1.5rem;
  text-align: center;
  border: 3px solid #e2e8f0;
  border-radius: 15px;
  font-weight: 700;
  color: #6366f1;
  transition: all 0.3s ease;
  font-family: 'Courier New', monospace;
}

.timer-time-input:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
  transform: scale(1.05);
}

.timer-time-input.highlight {
  animation: highlightInput 1s ease;
}

@keyframes highlightInput {
  0%, 100% {
    border-color: #e2e8f0;
  }
  50% {
    border-color: #ec4899;
    box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.2);
  }
}

.timer-presets {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin-top: 15px;
  margin-bottom: 15px;
}

.timer-preset {
  padding: 10px 8px;
  background: linear-gradient(145deg, #ffffff, #f8fafc);
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.timer-preset::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #667eea, #764ba2);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.timer-preset:hover::before {
  opacity: 1;
}

.timer-preset:hover {
  background: linear-gradient(145deg, #ffffff, #f0f4ff);
  border-color: #667eea;
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
}

.timer-preset:active {
  transform: translateY(-1px);
}

/* צבעים שונים לכפתורים */
.timer-preset[data-color="blue"]::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
.timer-preset[data-color="cyan"]::before { background: linear-gradient(90deg, #06b6d4, #22d3ee); }
.timer-preset[data-color="green"]::before { background: linear-gradient(90deg, #10b981, #34d399); }
.timer-preset[data-color="teal"]::before { background: linear-gradient(90deg, #14b8a6, #2dd4bf); }
.timer-preset[data-color="red"]::before { background: linear-gradient(90deg, #ef4444, #f87171); }
.timer-preset[data-color="purple"]::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
.timer-preset[data-color="orange"]::before { background: linear-gradient(90deg, #f97316, #fb923c); }
.timer-preset[data-color="pink"]::before { background: linear-gradient(90deg, #ec4899, #f472b6); }

.timer-preset[data-color="blue"]:hover { border-color: #3b82f6; box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2); }
.timer-preset[data-color="cyan"]:hover { border-color: #06b6d4; box-shadow: 0 8px 20px rgba(6, 182, 212, 0.2); }
.timer-preset[data-color="green"]:hover { border-color: #10b981; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2); }
.timer-preset[data-color="teal"]:hover { border-color: #14b8a6; box-shadow: 0 8px 20px rgba(20, 184, 166, 0.2); }
.timer-preset[data-color="red"]:hover { border-color: #ef4444; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.2); }
.timer-preset[data-color="purple"]:hover { border-color: #8b5cf6; box-shadow: 0 8px 20px rgba(139, 92, 246, 0.2); }
.timer-preset[data-color="orange"]:hover { border-color: #f97316; box-shadow: 0 8px 20px rgba(249, 115, 22, 0.2); }
.timer-preset[data-color="pink"]:hover { border-color: #ec4899; box-shadow: 0 8px 20px rgba(236, 72, 153, 0.2); }

/* פומודורו - עיצוב מיוחד */
.timer-preset.pomodoro {
  background: linear-gradient(145deg, #fef2f2, #fee2e2);
  border-color: #fca5a5;
}

.timer-preset.pomodoro:hover {
  background: linear-gradient(145deg, #fee2e2, #fecaca);
  border-color: #ef4444;
}

.timer-preset.custom {
  background: linear-gradient(145deg, #fdf4ff, #fae8ff);
  border: 2px dashed #d8b4fe;
}

.timer-preset.custom:hover {
  background: linear-gradient(145deg, #fae8ff, #f5d0fe);
  border-color: #c084fc;
  border-style: solid;
}

.timer-preset-icon {
  font-size: 1.6rem;
  margin-bottom: 4px;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}

.timer-preset-name {
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 2px;
  font-size: 0.85rem;
}

.timer-preset-time {
  font-size: 0.75rem;
  color: #64748b;
  font-weight: 500;
}

.timer-laps {
  background: #f8fafc;
  border-radius: 20px;
  padding: 20px;
  max-height: none;
  overflow-y: auto;
  flex: 0 0 350px;
  display: flex;
  flex-direction: column;
}

.timer-laps-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 12px;
  border-bottom: 2px solid #e2e8f0;
  flex-shrink: 0;
}

.timer-laps-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: #1e293b;
  display: flex;
  align-items: center;
  gap: 8px;
}

.timer-laps-count {
  background: #6366f1;
  color: white;
  padding: 5px 15px;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: 600;
}

.timer-lap-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: white;
  border-radius: 12px;
  margin-bottom: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  border-right: 4px solid #6366f1;
  animation: slideInRight 0.4s ease;
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.timer-lap-item:hover {
  transform: translateX(-5px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.timer-lap-number {
  font-size: 1rem;
  font-weight: 700;
  color: #6366f1;
  min-width: 80px;
}

.timer-lap-time {
  font-size: 1.1rem;
  font-weight: 700;
  font-family: 'Courier New', monospace;
  color: #1e293b;
  flex: 1;
  text-align: center;
}

.timer-lap-diff {
  font-size: 0.9rem;
  font-family: 'Courier New', monospace;
  color: #64748b;
  min-width: 100px;
  text-align: left;
}

.timer-lap-item.fastest {
  border-right-color: #10b981;
  background: linear-gradient(to left, rgba(16, 185, 129, 0.05), white);
}

.timer-lap-item.slowest {
  border-right-color: #ef4444;
  background: linear-gradient(to left, rgba(239, 68, 68, 0.05), white);
}

.timer-empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #64748b;
}

.timer-empty-icon {
  font-size: 3rem;
  margin-bottom: 10px;
  opacity: 0.3;
}

.timer-empty-text {
  font-size: 1rem;
  font-weight: 500;
}

.timer-layout {
  display: flex;
  flex-direction: column;
  flex: 1;
  gap: 1px;
}

.timer-main {
  display: flex;
  gap: 30px;
  align-items: center;
  flex: 1;
}

.timer-laps::-webkit-scrollbar {
  width: 8px;
}

.timer-laps::-webkit-scrollbar-track {
  background: #e2e8f0;
  border-radius: 10px;
}

.timer-laps::-webkit-scrollbar-thumb {
  background: #6366f1;
  border-radius: 10px;
}

@media (max-width: 1200px) {
  .timer-tab-content.active {
    flex-direction: column;
  }

  .timer-laps {
    flex: 0 0 250px;
    width: 100%;
  }

  .timer-main {
    flex-direction: column;
  }
}

@media (max-width: 768px) {
  #timer.page {
    padding: 10px;
  }

  .timer-container {
    height: 100%;
    max-height: none;
    border-radius: 20px;
  }

  .timer-header h1 {
    font-size: 1.5rem;
  }

  .timer-time {
    font-size: 3rem;
  }

  .timer-presets {
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  .timer-preset {
    padding: 12px 8px;
  }

  .timer-preset-icon {
    font-size: 1.8rem;
  }

  .timer-input-section {
    flex-wrap: wrap;
    padding: 20px 15px;
  }

  .timer-input-group input {
    width: 65px;
    font-size: 1.5rem;
    padding: 12px 8px;
  }

  .timer-input-separator {
    font-size: 2rem;
  }

  .timer-controls {
    min-width: auto;
    width: 100%;
  }

  .timer-lap-item {
    flex-direction: column;
    gap: 8px;
    text-align: center;
  }

  .timer-lap-number,
  .timer-lap-time,
  .timer-lap-diff {
    min-width: auto;
    text-align: center;
  }
}

/* ========== Weekly Schedule Styles ========== */
.schedule-container {
  background: var(--background-card);
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 8px 25px var(--shadow-light);
  overflow-x: auto;
}

.schedule-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px;
}

.schedule-table th,
.schedule-table td {
  border: 2px solid var(--border-color);
  padding: 12px 8px;
  text-align: center;
  min-width: 120px;
  height: 70px;
  vertical-align: top;
}

.schedule-table th {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  font-weight: 600;
  font-size: 1rem;
  position: sticky;
  top: 0;
}

.schedule-table th:first-child {
  width: 80px;
  min-width: 80px;
}

.schedule-table .time-cell {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  font-weight: 600;
  color: var(--text-primary);
  font-size: 0.95rem;
}

.schedule-cell {
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  background: white;
}

.schedule-cell:hover {
  background: #f0f4ff;
  transform: scale(1.02);
}

.schedule-cell.has-lesson {
  background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
  border-color: #4caf50;
}

.schedule-cell.has-lesson:hover {
  background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
}

.lesson-content {
  display: flex;
  flex-direction: column;
  gap: 4px;
  height: 100%;
  justify-content: center;
}

.lesson-subject {
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text-primary);
}

.lesson-room {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.lesson-teacher {
  font-size: 0.7rem;
  color: var(--text-secondary);
  opacity: 0.8;
}

.empty-cell-hint {
  color: #ccc;
  font-size: 1.5rem;
}

/* Schedule Modal */
.schedule-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.schedule-modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.schedule-modal {
  background: white;
  border-radius: 16px;
  padding: 30px;
  width: 90%;
  max-width: 450px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.schedule-modal-overlay.active .schedule-modal {
  transform: scale(1);
}

.schedule-modal h3 {
  margin-bottom: 20px;
  font-size: 1.3rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.schedule-form-group {
  margin-bottom: 18px;
}

.schedule-form-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: var(--text-primary);
  font-size: 0.9rem;
}

.schedule-form-group input,
.schedule-form-group select {
  width: 100%;
  padding: 12px;
  border: 2px solid var(--border-color);
  border-radius: 10px;
  font-size: 1rem;
  transition: border-color 0.3s ease;
  font-family: inherit;
}

.schedule-form-group input:focus,
.schedule-form-group select:focus {
  outline: none;
  border-color: var(--primary-color);
}

.schedule-modal-buttons {
  display: flex;
  gap: 12px;
  margin-top: 25px;
}

.schedule-modal-buttons button {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: inherit;
}

.schedule-btn-save {
  background: linear-gradient(135deg, var(--success-color), #219a52);
  color: white;
}

.schedule-btn-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
}

.schedule-btn-delete {
  background: linear-gradient(135deg, var(--danger-color), #c0392b);
  color: white;
}

.schedule-btn-delete:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
}

.schedule-btn-cancel {
  background: #e9ecef;
  color: var(--text-primary);
}

.schedule-btn-cancel:hover {
  background: #dee2e6;
}

.schedule-stats {
  display: flex;
  gap: 20px;
  margin-bottom: 25px;
  flex-wrap: wrap;
}

.schedule-stat {
  background: var(--background-card);
  padding: 15px 25px;
  border-radius: 12px;
  box-shadow: 0 4px 12px var(--shadow-light);
  text-align: center;
  min-width: 120px;
}

.schedule-stat-number {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary-color);
}

.schedule-stat-label {
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.schedule-actions {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.schedule-action-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 10px;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: inherit;
  font-weight: 500;
}

.schedule-action-btn.primary {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
}

.schedule-action-btn.danger {
  background: linear-gradient(135deg, var(--danger-color), #c0392b);
  color: white;
}

.schedule-action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px var(--shadow-medium);
}

@media (max-width: 768px) {
  .schedule-table th,
  .schedule-table td {
    min-width: 90px;
    padding: 8px 4px;
    font-size: 0.8rem;
  }
  
  .schedule-stats {
    justify-content: center;
  }
  
  .schedule-modal {
    padding: 20px;
    margin: 10px;
  }
}

/* ========== Footer Styles ========== */
.app-footer {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  padding: 20px;
  text-align: center;
  border-top: 1px solid var(--border-color);
  margin-top: 40px;
}

.footer-content {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.footer-copyright {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.footer-about-btn {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: inherit;
  display: flex;
  align-items: center;
  gap: 6px;
}

.footer-about-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

/* About Modal */
.about-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.about-modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.about-modal {
  background: white;
  border-radius: 20px;
  padding: 40px;
  width: 90%;
  max-width: 450px;
  box-shadow: 0 25px 80px rgba(0,0,0,0.3);
  transform: scale(0.9) translateY(20px);
  transition: transform 0.3s ease;
  text-align: center;
}

.about-modal-overlay.active .about-modal {
  transform: scale(1) translateY(0);
}

.about-logo {
  width: 80px;
  height: 80px;
  margin-bottom: 15px;
  animation: gentle-bounce 3s ease-in-out infinite;
}

.about-title {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 5px;
}

.about-subtitle {
  color: var(--text-secondary);
  font-size: 1rem;
  margin-bottom: 20px;
}

.about-version {
  display: inline-block;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  margin-bottom: 25px;
}

.about-divider {
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--border-color), transparent);
  margin: 20px 0;
}

.about-developer {
  margin-bottom: 20px;
}

.about-developer-label {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 5px;
}

.about-developer-name {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-primary);
}

.about-contact {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 25px;
}

.about-contact-label {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.about-contact-email {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.about-contact-email a {
  color: var(--primary-color);
  text-decoration: none;
  font-weight: 600;
  font-size: 0.95rem;
  transition: color 0.3s ease;
}

.about-contact-email a:hover {
  color: var(--secondary-color);
}

.about-close-btn {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: inherit;
}

.about-close-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

/* ========== Auto Logout Warning ========== */
.auto-logout-warning {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.auto-logout-warning.active {
  opacity: 1;
  visibility: visible;
}

.auto-logout-content {
  background: white;
  border-radius: 20px;
  padding: 40px;
  text-align: center;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
  animation: warningPulse 2s ease-in-out infinite;
}

@keyframes warningPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

.auto-logout-icon {
  font-size: 4rem;
  margin-bottom: 15px;
  animation: iconBounce 1s ease-in-out infinite;
}

@keyframes iconBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.auto-logout-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 10px;
}

.auto-logout-message {
  color: var(--text-secondary);
  font-size: 1rem;
  margin-bottom: 5px;
}

.auto-logout-countdown {
  font-size: 3rem;
  font-weight: 700;
  color: var(--danger-color);
  margin: 20px 0;
  font-family: 'Courier New', monospace;
}

.auto-logout-note {
  font-size: 0.85rem;
  color: var(--success-color);
  margin-bottom: 20px;
}

.auto-logout-btn {
  background: linear-gradient(135deg, var(--success-color), #219a52);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: inherit;
  width: 100%;
}

.auto-logout-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
}

/* My Links Page Styles */
.links-container {
  padding: 20px;
}

.links-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  flex-wrap: wrap;
  gap: 15px;
}

.links-stats {
  display: flex;
  gap: 20px;
  margin-bottom: 25px;
  flex-wrap: wrap;
}

.links-stat {
  background: var(--background-card);
  padding: 15px 25px;
  border-radius: 12px;
  box-shadow: 0 4px 12px var(--shadow-light);
  text-align: center;
  min-width: 120px;
}

.links-stat-number {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary-color);
}

.links-stat-label {
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.links-actions {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.links-action-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: inherit;
  font-weight: 500;
}

.links-action-btn.primary {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
}

.links-action-btn.danger {
  background: linear-gradient(135deg, var(--danger-color), #c0392b);
  color: white;
}

.links-action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px var(--shadow-medium);
}

.links-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
}

.link-card {
  background: var(--background-card);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 15px var(--shadow-light);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.link-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px var(--shadow-medium);
}

.link-card::before {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  left: 0;
  height: 4px;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
}

.link-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.link-favicon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  object-fit: cover;
  background: var(--background-main);
  padding: 4px;
}

.link-card-actions {
  display: flex;
  gap: 8px;
}

.link-card-action {
  width: 30px;
  height: 30px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 0.9rem;
  background: var(--background-main);
}

.link-card-action:hover {
  transform: scale(1.1);
}

.link-card-action.edit:hover {
  background: var(--primary-color);
  color: white;
}

.link-card-action.delete:hover {
  background: var(--danger-color);
  color: white;
}

.link-name {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.link-url {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 15px;
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
  word-break: break-all;
  direction: ltr;
  text-align: right;
}

.link-open-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-family: inherit;
}

.link-open-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.links-empty {
  text-align: center;
  padding: 60px 20px;
  background: var(--background-card);
  border-radius: 16px;
  box-shadow: 0 4px 15px var(--shadow-light);
}

.links-empty-icon {
  font-size: 4rem;
  margin-bottom: 20px;
}

.links-empty-title {
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 10px;
}

.links-empty-text {
  color: var(--text-secondary);
  margin-bottom: 20px;
}

/* Link Modal */
.link-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.link-modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.link-modal {
  background: white;
  border-radius: 16px;
  padding: 25px;
  width: 90%;
  max-width: 450px;
  transform: translateY(-20px);
  transition: all 0.3s ease;
}

.link-modal-overlay.active .link-modal {
  transform: translateY(0);
}

.link-modal h3 {
  font-size: 1.3rem;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.link-form-group {
  margin-bottom: 18px;
}

.link-form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: var(--text-primary);
}

.link-form-group input {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid var(--border-color);
  border-radius: 10px;
  font-size: 1rem;
  font-family: inherit;
  transition: all 0.3s ease;
}

.link-form-group input:focus {
  outline: none;
  border-color: var(--primary-color);
}

.link-form-group input[dir="ltr"] {
  text-align: left;
}

.link-modal-buttons {
  display: flex;
  gap: 10px;
  margin-top: 25px;
}

.link-modal-buttons button {
  flex: 1;
  padding: 12px 20px;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: inherit;
}

.link-btn-save {
  background: linear-gradient(135deg, var(--success-color), #219150);
  color: white;
}

.link-btn-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
}

.link-btn-cancel {
  background: var(--background-main);
  color: var(--text-primary);
}

.link-btn-cancel:hover {
  background: var(--border-color);
}

.links-search {
  position: relative;
  margin-bottom: 20px;
}

.links-search input {
  width: 100%;
  padding: 12px 15px 12px 45px;
  border: 2px solid var(--border-color);
  border-radius: 10px;
  font-size: 1rem;
  font-family: inherit;
  transition: all 0.3s ease;
}

.links-search input:focus {
  outline: none;
  border-color: var(--primary-color);
}

.links-search-icon {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.2rem;
}

/* ===== Interactive Shapes Styles ===== */
.interactive-shape {
  position: absolute;
  cursor: move;
  user-select: none;
  z-index: 100;
}

.interactive-shape.selected {
  outline: 2px dashed #667eea;
  outline-offset: 3px;
}

.shape-controls {
  position: absolute;
  top: -50px;
  left: 50%;
  transform: translateX(-50%);
  display: none;
  gap: 5px;
  background: white;
  padding: 8px 12px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.25);
  z-index: 1000;
  flex-wrap: nowrap;
  white-space: nowrap;
}

.interactive-shape.selected .shape-controls {
  display: flex;
}

.shape-control-btn {
  width: 32px;
  height: 32px;
  border: none;
  background: #f0f0f0;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.shape-control-btn:hover {
  background: #667eea;
  color: white;
  transform: scale(1.1);
}

.shape-color-input {
  width: 32px;
  height: 32px;
  border: 2px solid #ddd;
  border-radius: 6px;
  cursor: pointer;
  padding: 0;
  overflow: hidden;
}

.shape-color-input::-webkit-color-swatch-wrapper { padding: 0; }
.shape-color-input::-webkit-color-swatch { border: none; border-radius: 4px; }

.shape-resize-handle {
  position: absolute;
  width: 14px;
  height: 14px;
  background: white;
  border: 2px solid #667eea;
  border-radius: 50%;
  z-index: 102;
  display: none;
}

.interactive-shape.selected .shape-resize-handle { display: block; }

.shape-resize-handle.nw { top: -7px; left: -7px; cursor: nwse-resize; }
.shape-resize-handle.ne { top: -7px; right: -7px; cursor: nesw-resize; }
.shape-resize-handle.sw { bottom: -7px; left: -7px; cursor: nesw-resize; }
.shape-resize-handle.se { bottom: -7px; right: -7px; cursor: nwse-resize; }

.shape-rotate-handle {
  position: absolute;
  top: -75px;
  left: 50%;
  transform: translateX(-50%);
  width: 24px;
  height: 24px;
  background: #667eea;
  border-radius: 50%;
  cursor: grab;
  z-index: 1001;
  display: none;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  font-weight: bold;
}

.interactive-shape.selected .shape-rotate-handle { display: flex; }

.shape-rotate-line {
  position: absolute;
  top: -55px;
  left: 50%;
  width: 2px;
  height: 50px;
  background: #667eea;
  transform: translateX(-50%);
  display: none;
  z-index: 1001;
}

.interactive-shape.selected .shape-rotate-line { display: block; }

  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-content">
      <div class="navbar-brand" onclick="app.showPage('homepage')">
        <img src="https://brickyeda.github.io/digitalbag/logo.png" alt="Logo" class="logo">
        <span>My Campus</span>
      </div>
      
      <ul class="navbar-menu">
        <li class="navbar-item active" onclick="app.showPage('homepage')" data-page="homepage">
          <span class="icon">🏠</span>
          <span>בית</span>
        </li>
        <li class="navbar-item" onclick="app.showPage('notebooks')" data-page="notebooks">
          <span class="icon">📚</span>
          <span>מחברות</span>
        </li>
        <li class="navbar-item" onclick="app.showPage('tasks')" data-page="tasks">
          <span class="icon">✅</span>
          <span>משימות</span>
        </li>
        <li class="navbar-item" onclick="app.showPage('calendar')" data-page="calendar">
          <span class="icon">📅</span>
          <span>יומן</span>
        </li>
        <li class="navbar-item" onclick="app.showPage('calculator')" data-page="calculator">
          <span class="icon">🧮</span>
          <span>מחשבון</span>
        </li>
        <li class="navbar-item" onclick="app.showPage('timer')" data-page="timer">
          <span class="icon">⏱️</span>
          <span>שעון עצר</span>
        </li>
        <li class="navbar-item" onclick="app.showPage('schedule')" data-page="schedule">
          <span class="icon">🗓️</span>
          <span>מערכת</span>
        </li>
        <li class="navbar-item" onclick="app.showPage('mylinks')" data-page="mylinks">
          <span class="icon">🔗</span>
          <span>קישורים</span>
        </li>
      </ul>

      <div class="navbar-user">
        <div class="user-info">
          <div class="user-name" id="navUserName" style="display: none;">לא מחובר</div>
          <div class="datetime-display">
            <div class="user-time" id="navTime">12:34</div>
            <div class="user-date" id="navDate">01.01.2025</div>
          </div>
        </div>
        <button id="premiumInfoBtn" onclick="app.openPremiumInfo()" title="מה כלול בפרימיום?" class="premium-star-btn">⭐</button>
        <button class="logout-btn" id="logoutBtn" onclick="app.logout()" style="display: none;">התנתק</button>
        <div class="fullscreen-icon" id="fullscreenBtn" onclick="app.toggleFullscreen()" title="מסך מלא">⛶</div>

<div class="settings-icon" style="display: none;" onclick="app.openSettings()">⚙️</div>
      </div>
    </div>
  </nav>

  <!-- Page Container -->
  <div class="page-container" id="pageContainer">
    
    <!-- Homepage -->
    <div id="homepage" class="page active">
      <div class="welcome-section">
        <div class="welcome-content">
          <div class="welcome-text">
            <h1 id="welcomeGreeting">שלום!</h1>
<div class="subtitle" id="welcomeSubtitle">מיקוד שמוביל להצלחה</div>
            <div class="institution" id="welcomeInstitution">הילקוד החכם שלך</div>
            <button onclick="logout()" style="margin-top: 15px; padding: 10px 20px; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; border-radius: 8px; font-size: 0.95rem; cursor: pointer; transition: transform 0.2s;">
              🚪 התנתק
            </button>
          </div>
          <div class="welcome-stats">
            <div class="stat-item" onclick="app.showPage('tasks')">
              <div class="stat-number" id="todayTasks">0</div>
              <div class="stat-label">משימות היום</div>
            </div>
            <div class="stat-item" style="position: relative;" onclick="app.toggleNotificationsPanel(event)">
              <div class="stat-number" id="notificationsCount">🔔 0</div>
              <div class="stat-label">התראות</div>
            </div>
            <div class="stat-item" onclick="app.showPage('notebooks')">
              <div class="stat-number" id="activeNotebooks">6</div>
              <div class="stat-label">מחברות פעילות</div>
            </div>
            <div class="stat-item" onclick="app.showPage('calendar')">
              <div class="stat-number" id="nextClassTime">14:30</div>
              <div class="stat-label">השיעור הבא</div>
            </div>
            <div class="stat-item" onclick="app.showPage('tasks')">
              <div class="stat-number" id="openTasksCount">0</div>
              <div class="stat-label">משימות פתוחות</div>
            </div>
          </div>
        </div>
      </div>

      <div class="tools-grid">
        <div class="tool-card" onclick="app.showPage('notebooks')">
          <span class="tool-icon">📚</span>
          <div class="tool-title">מחברות לפי מקצועות</div>
          <div class="tool-description">כל המחברות שלי מסודרות לפי מקצועות עם דפים, רישומים וכלי כתיבה מתקדמים</div>
          <span class="tool-status">6 מחברות פעילות</span>
        </div>

        <div class="tool-card" onclick="app.showPage('tasks')">
          <span class="tool-icon">✅</span>
          <div class="tool-title">מנהל משימות חכם</div>
          <div class="tool-description">רשימת מטלות מתקדמת עם מעקב ביצועים, תזכורות ולוחות זמנים</div>
          <span class="tool-status" id="taskStatusHome">טוען...</span>
        </div>

        <div class="tool-card" onclick="app.showPage('calendar')">
          <span class="tool-icon">📅</span>
          <div class="tool-title">יומן ולוח שנה</div>
          <div class="tool-description">מערכת שעות, מועדי בחינות, אירועים חשובים ותכנון יומי ושבועי</div>
          <span class="tool-status" id="calendarStatusHome">טוען...</span>
        </div>

        <div class="tool-card" onclick="app.showPage('calculator')">
          <span class="tool-icon">🧮</span>
          <div class="tool-title">מחשבון מדעי מתקדם</div>
          <div class="tool-description">מחשבון מדעי מלא עם פונקציות טריגונומטריות, לוגריתמים, זיכרון והיסטוריה מלאה</div>
          <span class="tool-status">מוכן לשימוש!</span>
        </div>


        <div class="tool-card" onclick="app.showPage('timer')">
          <span class="tool-icon">⏱️</span>
          <div class="tool-title">שעון עצר וטיימר</div>
          <div class="tool-description">שעון עצר לבחינות, טיימר ומעקב זמן למידה יעיל</div>
          <span class="tool-status">מוכן לשימוש!</span>
        </div>

        <div class="tool-card" onclick="app.showPage('schedule')">
          <span class="tool-icon">🗓️</span>
          <div class="tool-title">מערכת שעות שבועית</div>
          <div class="tool-description">בנה את מערכת השיעורים שלך והיא תסתנכרן אוטומטית ליומן</div>
          <span class="tool-status" id="scheduleStatusHome">0 שיעורים</span>
        </div>

        <div class="tool-card" onclick="app.showPage('mylinks')">
          <span class="tool-icon">🔗</span>
          <div class="tool-title">הקישורים שלי</div>
          <div class="tool-description">שמור קישורים לאתרים שימושיים וגש אליהם בקלות בכל עת</div>
          <span class="tool-status" id="linksStatusHome">0 קישורים</span>
        </div>

<div class="tool-card" onclick="alert('תכונה זו תתווסף בקרוב! 🔧')">
          <span class="tool-icon">🏆</span>
          <div class="tool-title">ההישגים שלי</div>
          <div class="tool-description">עקוב אחרי ההישגים שלך, אתגרים יומיים ונקודות זכות על פעילות במערכת</div>
          <span class="tool-status">בפיתוח</span>
        </div>
      </div>

      <!-- Footer -->
      <footer class="app-footer">
        <div class="footer-content">
          <span class="footer-copyright">© 2026 My Campus | פותח ע"י שחר ברגיג</span>
          <button class="footer-about-btn" onclick="openAboutModal()">
            <span>ℹ️</span>
            אודות
          </button>
        </div>
      </footer>
    </div>

    <!-- Notebooks Page -->
    <div id="notebooks" class="page">
      <div class="page-header">
        <h1 class="page-title">
          <span>📚</span>
          המחברות שלי
        </h1>
        <div style="display: flex; gap: 15px;">
          <button class="add-page-btn" onclick="app.openNotebookCreator()">
            <span>➕</span>
            הוסף מחברת
          </button>
          <button class="back-btn" onclick="app.showPage('homepage')">
            <span>←</span>
            חזור לדף הבית
          </button>
        </div>
      </div>

      <div class="subjects-grid" id="subjectsGrid">
        <!-- מחברות יטענו כאן -->
      </div>
    </div>

    <!-- Individual Notebook View -->
    <div id="notebookView" class="page">
     
<!-- Math Formulas Toolbar -->
<div class="math-formulas-toolbar" id="mathFormulasToolbar">
  <div class="formulas-title">
    <span>📐</span>
    נוסחאות מתמטיות
  </div>
  
  <div class="formulas-container">
      <!-- כפתור קישור לנוסחאון -->
  <a href="nuschon_math.pdf" target="_blank" class="nuschon-link-btn" title="פתח נוסחאון מתמטיקה 5 יח״ל">
    📄 נוסחאון מלא
  </a>
    <div class="formula-group">
      <div class="formula-item" draggable="true" data-formula="ax² + bx + c = 0" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        ax² + bx + c = 0
        <div class="formula-preview">משוואה ריבועית</div>
      </div>
      
      <div class="formula-item" draggable="true" data-formula="x = (-b ± √(b²-4ac)) / 2a" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        x = (-b ± √Δ) / 2a
        <div class="formula-preview">נוסחת השורשים</div>
      </div>
      
      <div class="formula-item" draggable="true" data-formula="a² + b² = c²" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        a² + b² = c²
        <div class="formula-preview">משפט פיתגורס</div>
      </div>
    </div>

    <div class="formula-group">
      <div class="formula-item" draggable="true" data-formula="A = πr²" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        A = πr²
        <div class="formula-preview">שטח עיגול</div>
      </div>
      
      <div class="formula-item" draggable="true" data-formula="V = 4/3 × πr³" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        V = 4/3 × πr³
        <div class="formula-preview">נפח כדור</div>
      </div>
      
      <div class="formula-item" draggable="true" data-formula="P = 2πr" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        P = 2πr
        <div class="formula-preview">היקף עיגול</div>
      </div>
    </div>

    <div class="formula-group">
      <div class="formula-item" draggable="true" data-formula="F = ma" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        F = ma
        <div class="formula-preview">חוק התאוצה</div>
      </div>
      
      <div class="formula-item" draggable="true" data-formula="E = mc²" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        E = mc²
        <div class="formula-preview">תורת היחסות</div>
      </div>
      
      <div class="formula-item" draggable="true" data-formula="v = s/t" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        v = s/t
        <div class="formula-preview">מהירות</div>
      </div>
    </div>

    <div class="formula-group">
      <div class="formula-item" draggable="true" data-formula="A + B = C" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        A + B = C
        <div class="formula-preview">תבנית חיבור</div>
      </div>
      
      <div class="formula-item" draggable="true" data-formula="A - B = C" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        A - B = C
        <div class="formula-preview">תבנית חיסור</div>
      </div>
      
      <div class="formula-item" draggable="true" data-formula="A × B = C" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        A × B = C
        <div class="formula-preview">תבנית כפל</div>
      </div>
      
      <div class="formula-item" draggable="true" data-formula="A ÷ B = C" ondragstart="app.dragFormula(event)" ondragend="app.endDragFormula(event)">
        A ÷ B = C
        <div class="formula-preview">תבנית חילוק</div>
      </div>
    </div>
  </div>
</div>

<!-- Drawing Toolbar - Vertical Sidebar -->
      <!-- Formatting Toolbar - בתוך הדף עצמו -->
<div class="global-formatting-toolbar" id="inPageToolbar" style="position: sticky !important; top: 80px !important; z-index: 999 !important; background: #f8f9fa !important; margin-bottom: 20px;">
        <!-- Font Group -->
        <div class="toolbar-group">
          <select class="toolbar-select" id="inPageFontFamily" onchange="app.changeGlobalFontFamily(this.value)">
            <option value="Arial">Arial</option>
            <option value="Georgia">Georgia</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Helvetica">Helvetica</option>
            <option value="Courier New">Courier New</option>
            <option value="David">David</option>
            <option value="Miriam">Miriam</option>
          </select>
          
          <select class="toolbar-select" id="inPageFontSize" onchange="app.changeGlobalFontSize(this.value)">
            <option value="12">12px</option>
            <option value="14">14px</option>
            <option value="16">16px</option>
            <option value="18">18px</option>
            <option value="20">20px</option>
            <option value="24">24px</option>
            <option value="28" selected>28px</option>
            <option value="32">32px</option>
          </select>
        </div>

        <!-- Text Formatting Group -->
        <div class="toolbar-group">
          <button class="toolbar-btn" id="inPageBold" onclick="app.toolbarBold()" title="מודגש">
            <strong>B</strong>
          </button>
          <button class="toolbar-btn" id="inPageItalic" onclick="app.toolbarItalic()" title="נטוי">
            <em>I</em>
          </button>
          <button class="toolbar-btn" id="inPageUnderline" onclick="app.toolbarUnderline()" title="קו תחתון">
            <u>U</u>
          </button>
          <button class="toolbar-btn" id="inPageStrike" onclick="app.toolbarStrikethrough()" title="קו חוצה">
            <s>S</s>
<button class="toolbar-btn" onclick="app.toolbarHighlight()" title="סימון">
  🖍️
</button>
<button class="toolbar-btn" onclick="app.toolbarInsertLink()" title="הוסף קישור">
  🔗
</button>
<button class="toolbar-btn" onclick="app.toolbarInsertImage()" title="הוסף תמונה">
  🖼️
</button>
<button class="toolbar-btn" onclick="app.toolbarInsertPDF()" title="הוסף PDF">
  📄
</button>
          </button>
        </div>

        <!-- Color Group -->
        <div class="toolbar-group">
          <div style="position: relative;">
            <button class="toolbar-color-btn text-color-btn" id="inPageTextColor" onclick="app.toggleGlobalColorPicker('text')" title="צבע טקסט">
              A
            </button>
            <div class="color-picker" id="inpage-text-color-picker">
              <!-- צבעים יתווספו בJS -->
            </div>
          </div>
        </div>

        <!-- Alignment Group -->
        <div class="toolbar-group">
          <button class="toolbar-btn" onclick="app.setGlobalAlignment('right')" title="יישור ימין">
            ⇤
          </button>
          <button class="toolbar-btn" onclick="app.setGlobalAlignment('center')" title="יישור מרכז">
            ⇕
          </button>
          <button class="toolbar-btn" onclick="app.setGlobalAlignment('left')" title="יישור שמאל">
            ⇥
          </button>
          <button class="toolbar-btn" onclick="app.setGlobalAlignment('justify')" title="יישור דו-צדדי">
            ⇿
          </button>
        </div>

        <!-- List Group -->
        <div class="toolbar-group">
          <button class="toolbar-btn" onclick="app.insertGlobalList('bullet')" title="רשימת תבליטים">
            • ◦ ▪
          </button>
          <button class="toolbar-btn" onclick="app.insertGlobalList('numbered')" title="רשימה ממוספרת">
            1. 2. 3.
          </button>
          <button class="toolbar-btn" onclick="app.insertGlobalSymbol('★')" title="הוסף כוכב">
            ★
          </button>
          <button class="toolbar-btn" onclick="app.insertGlobalSymbol('✓')" title="הוסף וי">
            ✓
          </button>
          <button class="toolbar-btn" onclick="app.insertGlobalSymbol('→')" title="הוסף חץ">
            →
          </button>
        </div>

        <!-- Drawing Tools Group -->
        <div class="toolbar-group" style="display: flex; align-items: center; gap: 8px;">
          <button class="toolbar-btn" id="drawingModeBtn" onclick="app.drawing.toggleDrawingMode()" title="הפעל/כבה ציור" style="background: #27ae60; color: white;">
            🎨 <span id="drawingModeText" style="font-size: 0.7rem;">ציור</span>
          </button>
          <button class="toolbar-btn" id="pencilBtn" onclick="app.drawing.selectTool('pencil')" title="עיפרון">
            ✏️
          </button>
          <button class="toolbar-btn" id="eraserBtn" onclick="app.drawing.selectTool('eraser')" title="מחק">
            🧹
          </button>
          <select class="toolbar-select" id="shapeSelect" onchange="app.drawing.selectShape(this.value)" style="width: auto;">
            <option value="">צורות</option>
            <option value="circle">⭕ עיגול</option>
            <option value="square">⬜ ריבוע</option>
            <option value="rectangle">▬ מלבן</option>
            <option value="triangle">🔺 משולש</option>
            <option value="line">➖ קו</option>
            <option value="arrow">➡️ חץ</option>
            <option value="star">⭐ כוכב</option>
            <option value="heart">❤️ לב</option>
            <option value="diamond">💎 מעויין</option>
          </select>
          <select class="toolbar-select" id="pencilType" onchange="app.drawing.changePencilType(this.value)" style="width: auto;">
            <option value="solid">רגיל</option>
            <option value="marker">טוש</option>
            <option value="chalk">גיר</option>
            <option value="spray">ספריי</option>
          </select>
          <input type="color" id="drawingColor" value="#000000" onchange="app.drawing.changeColor(this.value)" title="צבע ציור" style="width: 32px; height: 32px; border: none; cursor: pointer; border-radius: 4px;">
          <span id="thicknessDisplay" style="font-size: 0.8rem; min-width: 20px; text-align: center;">3</span>
          <input type="range" id="thicknessSlider" min="1" max="20" value="3" oninput="app.drawing.changeThickness(this.value)" title="עובי" style="width: 80px;">
          <button class="toolbar-btn" onclick="document.querySelectorAll('.page-canvas.drawing-active').forEach(c => { if(c._undo) c._undo(); })" title="ביטול">
            ↶
          </button>
          <button class="toolbar-btn" onclick="if(confirm('למחוק הכל?')) { document.querySelectorAll('.page-canvas').forEach(c => c.getContext('2d').clearRect(0,0,c.width,c.height)); }" title="נקה הכל" style="background: #e74c3c; color: white;">
            🗑️
          </button>
        </div>
      </div>

<div class="page-header" style="position: sticky; top: 150px; z-index: 100; background: var(--background-main); padding-top: 5px; padding-bottom: 5px;">
  <h1 class="page-title" id="currentNotebookTitle">
    <span id="currentNotebookIcon">📚</span>
    <span id="currentNotebookName">מחברת</span>
  </h1>
  <div style="display: flex; gap: 15px; align-items: center;">
    <!-- Zoom Controls -->
    <div class="zoom-controls" id="zoomControls" style="display: flex;">
      <button class="zoom-btn" onclick="app.zoomIn()" title="הגדל">
        ➕
      </button>
      <div class="zoom-level" id="zoomLevel">100%</div>
      <button class="zoom-btn" onclick="app.zoomOut()" title="הקטן">
        ➖
      </button>
      <button class="zoom-btn zoom-reset" onclick="app.resetZoom()" title="אפס זום">
        ↺
      </button>
    </div>
    
    <div class="export-btn-wrapper">
      <button class="add-page-btn premium-feature-btn" onclick="app.toggleExportMenu(event)">
        <span>📄</span>
        ייצא ל-PDF
        <span class="premium-badge">⭐</span>
      </button>
      <div class="export-menu" id="exportMenu">
        <div class="export-option" onclick="app.exportCurrentPage()">
          <span class="icon">📄</span>
          <span class="text">ייצא דף נוכחי</span>
          <span class="premium-badge-small">⭐</span>
        </div>
        <div class="export-option" onclick="app.exportTodayPages()">
          <span class="icon">📅</span>
          <span class="text">ייצא דפים מהיום</span>
          <span class="premium-badge-small">⭐</span>
        </div>
        <div class="export-option" onclick="app.exportAllNotebook()">
          <span class="icon">📚</span>
          <span class="text">ייצא את כל המחברת</span>
          <span class="premium-badge-small">⭐</span>
        </div>
      </div>
    </div>
    <button class="add-page-btn" onclick="app.toggleGalleryView()" style="background: linear-gradient(135deg, #667eea, #764ba2);">
      <span>📱</span>
      תצוגת גלריה
    </button>
    <button class="add-page-btn" onclick="app.addNotebookPage()">
      <span>➕</span>
      הוסף דף
    </button>
    <button class="back-btn" onclick="app.showPage('notebooks')">
      <span>←</span>
      חזור למחברות
    </button>
  </div>
</div>

      <div id="notebookContent">
        <!-- תוכן המחברת יטען כאן -->
      </div>
    </div>

    <!-- Gallery View -->
    <div class="gallery-view" id="galleryView">
      <div class="gallery-header">
        <div class="gallery-title">
          <span>🖼️</span>
          <span id="galleryNotebookName">תצוגת גלריה</span>
        </div>
        <button class="gallery-close-btn" onclick="app.closeGalleryView()">
          <span>✕</span>
          <span>חזרה לעריכה</span>
        </button>
      </div>
      <div class="gallery-grid" id="galleryGrid">
        <!-- Gallery items will be inserted here -->
      </div>
    </div>

    <!-- Tasks Page -->
    <div id="tasks" class="page">
      <div class="page-header">
        <h1 class="page-title">
          <span>✅</span>
          מנהל המשימות
        </h1>
        <button class="back-btn" onclick="app.showPage('homepage')">
          <span>←</span>
          חזור לדף הבית
        </button>
      </div>

      <div class="tasks-header">
        <div class="tasks-stats">
          <div class="task-stat">
            <div class="task-stat-number" id="totalTasks">0</div>
            <div class="task-stat-label">סה"כ משימות</div>
          </div>
          <div class="task-stat">
            <div class="task-stat-number" id="pendingTasks">0</div>
            <div class="task-stat-label">ממתינות</div>
          </div>
          <div class="task-stat">
            <div class="task-stat-number" id="completedTasks">0</div>
            <div class="task-stat-label">הושלמו</div>
          </div>
          <div class="task-stat">
            <div class="task-stat-number" id="overdueTasks">0</div>
            <div class="task-stat-label">באיחור</div>
          </div>
        </div>

        <div class="task-filters">
          <button class="filter-btn active" onclick="app.filterTasks('all')" data-filter="all">הכל</button>
          <button class="filter-btn" onclick="app.filterTasks('pending')" data-filter="pending">ממתינות</button>
          <button class="filter-btn" onclick="app.filterTasks('completed')" data-filter="completed">הושלמו</button>
          <button class="filter-btn" onclick="app.filterTasks('today')" data-filter="today">היום</button>
          <button class="filter-btn" onclick="app.filterTasks('overdue')" data-filter="overdue">באיחור</button>
        </div>
      </div>

      <div class="tasks-grid">
        <div class="tasks-list" id="tasksList">
          <!-- משימות יטענו כאן -->
        </div>

        <div class="task-creator">
          <div class="creator-title">
            <span>➕</span>
            משימה חדשה
          </div>

          <div class="form-group">
            <label class="form-label" for="taskTitle">כותרת המשימה</label>
            <input type="text" id="taskTitle" class="form-input" placeholder="לדוגמה: לסיים מטלה במתמטיקה" maxlength="100">
          </div>

          <div class="form-group">
            <label class="form-label" for="taskDescription">תיאור (אופציונלי)</label>
            <textarea id="taskDescription" class="form-textarea" placeholder="תיאור המשימה או הערות נוספות..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label" for="taskCategory">קטגוריה</label>
            <select id="taskCategory" class="form-select">
              <option value="לימודים">לימודים</option>
              <option value="מטלות">מטלות</option>
              <option value="בחינות">בחינות</option>
              <option value="פרויקטים">פרויקטים</option>
              <option value="אישי">אישי</option>
              <option value="אחר">אחר</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">רמת עדיפות</label>
            <div class="priority-options">
              <div class="priority-option high" onclick="app.selectPriority('high')" data-priority="high">
                גבוהה
              </div>
              <div class="priority-option medium selected" onclick="app.selectPriority('medium')" data-priority="medium">
                בינונית
              </div>
              <div class="priority-option low" onclick="app.selectPriority('low')" data-priority="low">
                נמוכה
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="taskDueDate">תאריך יעד</label>
            <input type="date" id="taskDueDate" class="form-input">
          </div>

          <div class="form-group">
            <label class="form-label" for="taskDueTime">שעת יעד</label>
            <input type="time" id="taskDueTime" class="form-input">
          </div>

          <button class="create-task-btn" onclick="app.createTask()" id="createTaskBtn">
            <span>✨</span>
            צור משימה
          </button>
        </div>
      </div>
    </div>

    <!-- Calendar Page -->
    <div id="calendar" class="page">
      <div class="page-header">
        <h1 class="page-title">
          <span>📅</span>
          יומן ולוח שנה
        </h1>
        <div style="display: flex; gap: 15px;">
          <button class="add-page-btn" onclick="app.openEventCreator()">
            <span>➕</span>
            הוסף אירוע
          </button>
          <button class="back-btn" onclick="app.showPage('homepage')">
            <span>←</span>
            חזור לדף הבית
          </button>
        </div>
      </div>

      <!-- Calendar Navigation -->
      <div class="calendar-nav">
        <div class="calendar-nav-left">
          <button class="nav-btn" onclick="app.previousPeriod()">
            <span>‹</span>
          </button>
          <button class="nav-btn" onclick="app.nextPeriod()">
            <span>›</span>
          </button>
          <h2 class="current-month" id="currentMonth">ינואר 2024</h2>
        </div>
        
        <div class="calendar-nav-right">
          <button class="today-btn" onclick="app.goToToday()">היום</button>
          <div class="view-toggles">
            <button class="view-btn active" onclick="app.changeView('month')" data-view="month">חודש</button>
            <button class="view-btn" onclick="app.changeView('week')" data-view="week">שבוע</button>
            <button class="view-btn" onclick="app.changeView('day')" data-view="day">יום</button>
          </div>
        </div>
      </div>

      <!-- Calendar Stats -->
      <div class="calendar-stats">
        <div class="calendar-stat">
          <div class="stat-number" id="monthEvents">0</div>
          <div class="stat-label">אירועים החודש</div>
        </div>
        <div class="calendar-stat">
          <div class="stat-number" id="upcomingExams">0</div>
          <div class="stat-label">בחינות קרובות</div>
        </div>
        <div class="calendar-stat">
          <div class="stat-number" id="weekClasses">0</div>
          <div class="stat-label">שיעורים השבוע</div>
        </div>
        <div class="calendar-stat">
          <div class="stat-number" id="todayEvents">0</div>
          <div class="stat-label">אירועים היום</div>
        </div>
      </div>

      <!-- Calendar Main Content -->
      <div style="display: grid; grid-template-columns: 350px 1fr; gap: 30px;">
        
        <!-- Search and Events Sidebar -->
        <div class="calendar-sidebar">
          <!-- Search Events -->
          <div class="events-search">
            <h3>🔍 חיפוש אירועים</h3>
            <div class="search-form">
              <input type="text" id="eventSearchInput" class="form-input" placeholder="חפש אירועים..." 
                     oninput="app.searchEvents(this.value)" style="margin-bottom: 15px;">
              
              <!-- Filter by Event Type -->
              <div class="form-group">
                <label class="form-label">סינון לפי סוג:</label>
                <select id="eventTypeFilter" class="form-select" onchange="app.filterEventsByType(this.value)">
                  <option value="">כל הסוגים</option>
                  <option value="lesson">שיעורים</option>
                  <option value="exam">בחינות</option>
                  <option value="assignment">מטלות</option>
                  <option value="personal">אישי</option>
                  <option value="holiday">חופש</option>
                  <option value="task">משימות</option>
                </select>
              </div>

              <!-- Filter by Date Range -->
              <div class="form-group">
                <label class="form-label">טווח תאריכים:</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px;">
                  <input type="date" id="startDateFilter" class="form-input" onchange="app.filterByDateRange()">
                  <input type="date" id="endDateFilter" class="form-input" onchange="app.filterByDateRange()">
                </div>
              </div>

              <button class="btn btn-primary" onclick="app.clearFilters()" style="width: 100%; margin-top: 10px;">
                🗑️ נקה סינונים
              </button>
            </div>
          </div>

          <!-- Events List -->
          <div class="events-list-sidebar">
            <h3 id="eventsListTitle">📋 אירועים קרובים</h3>
            <div id="sidebarEventsList" class="sidebar-events">
              <!-- Events will be populated here -->
            </div>
          </div>
        </div>

        <!-- Calendar Display -->
        <div>
          <!-- Calendar Grid for Month View -->
          <div class="calendar-container" id="monthView">
            <div class="calendar-header">
              <div class="calendar-day-header">ראשון</div>
              <div class="calendar-day-header">שני</div>
              <div class="calendar-day-header">שלישי</div>
              <div class="calendar-day-header">רביעי</div>
              <div class="calendar-day-header">חמישי</div>
              <div class="calendar-day-header">שישי</div>
              <div class="calendar-day-header">שבת</div>
            </div>
            <div class="calendar-grid" id="calendarGrid">
              <!-- Days will be generated here -->
            </div>
          </div>

          <!-- Week View -->
          <div class="week-view" id="weekView" style="display: none;">
            <div class="week-header" id="weekHeader">
              <!-- Week days headers will be generated here -->
            </div>
            <div class="week-content" id="weekContent">
              <!-- Week events will be generated here -->
            </div>
          </div>

          <!-- Day View -->
          <div class="day-view" id="dayView" style="display: none;">
            <div class="day-header" id="dayHeader">
              <!-- Day header will be generated here -->
            </div>
            <div class="day-content" id="dayContent">
              <!-- Day events will be generated here -->
            </div>
          </div>

          <!-- Quick Add Events -->
          <div class="quick-events">
            <h3>הוספה מהירה:</h3>
            <div class="quick-event-buttons">
              <button class="quick-btn lesson-btn" onclick="app.quickAddEvent('lesson')">
                📚 שיעור
              </button>
              <button class="quick-btn exam-btn" onclick="app.quickAddEvent('exam')">
                📝 בחינה
              </button>
              <button class="quick-btn assignment-btn" onclick="app.quickAddEvent('assignment')">
                📋 מטלה
              </button>
              <button class="quick-btn personal-btn" onclick="app.quickAddEvent('personal')">
                🎉 אישי
              </button>
              <button class="quick-btn holiday-btn" onclick="app.quickAddEvent('holiday')">
                🏖️ חופש
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

<!-- Calculator Page -->
<div id="calculator" class="page">
  <div class="page-header">
    <h1 class="page-title">
      <span>🧮</span>
      מחשבון מדעי מתקדם
    </h1>
    <button class="back-btn" onclick="app.showPage('homepage')">
      <span>←</span>
      חזור לדף הבית
    </button>
  </div>

  <div style="display: grid; grid-template-columns: 1fr 300px; gap: 30px; margin-bottom: 30px;">
    
    <!-- Calculator Main Section -->
    <div>
      <!-- Display -->
      <div style="background: linear-gradient(135deg, #2c3e50, #34495e); border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
        <div id="displayHistory" style="color: rgba(255,255,255,0.6); font-size: 1rem; min-height: 25px; text-align: left; margin-bottom: 10px;"></div>
        <div id="displayCurrent" style="color: white; font-size: 3rem; font-weight: 300; text-align: left; word-break: break-all; min-height: 60px; direction: ltr;">0</div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; gap: 10px; align-items: center;">
            <span id="memoryIndicator" style="display: none; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; color: white;">M</span>
            <span id="angleMode" style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; color: white;">DEG</span>
          </div>
          <div style="color: rgba(255,255,255,0.4); font-size: 0.8rem;">מחשבון מדעי</div>
        </div>
      </div>

      <!-- Mode Buttons -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 5px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <button class="mode-btn active" data-mode="basic" onclick="app.calculator.toggleMode('basic')" style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: var(--primary-color); color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">
          📱 בסיסי
        </button>
        <button class="mode-btn" data-mode="scientific" onclick="app.calculator.toggleMode('scientific')" style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: transparent; color: var(--text-primary); font-weight: 600; cursor: pointer; transition: all 0.3s;">
          🔬 מדעי
        </button>
        <button class="mode-btn" data-mode="programmer" onclick="app.calculator.toggleMode('programmer')" style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: transparent; color: var(--text-primary); font-weight: 600; cursor: pointer; transition: all 0.3s;">
          💻 מתכנת
        </button>
      </div>

      <!-- Basic Mode Buttons -->
      <div class="button-grid basic-mode" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
        <!-- Row 1 -->
        <button onclick="app.calculator.clearEntry()" style="background: #e74c3c; color: white; border: none; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">CE</button>
        <button onclick="app.calculator.clear()" style="background: #e67e22; color: white; border: none; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">C</button>
        <button onclick="app.calculator.backspace()" style="background: #95a5a6; color: white; border: none; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">⌫</button>
        <button onclick="app.calculator.operation('/')" style="background: #3498db; color: white; border: none; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">÷</button>
        
        <!-- Row 2 -->
        <button onclick="app.calculator.inputNumber('7')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">7</button>
        <button onclick="app.calculator.inputNumber('8')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">8</button>
        <button onclick="app.calculator.inputNumber('9')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">9</button>
        <button onclick="app.calculator.operation('*')" style="background: #3498db; color: white; border: none; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">×</button>
        
        <!-- Row 3 -->
        <button onclick="app.calculator.inputNumber('4')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">4</button>
        <button onclick="app.calculator.inputNumber('5')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">5</button>
        <button onclick="app.calculator.inputNumber('6')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">6</button>
        <button onclick="app.calculator.operation('-')" style="background: #3498db; color: white; border: none; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">−</button>
        
        <!-- Row 4 -->
        <button onclick="app.calculator.inputNumber('1')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">1</button>
        <button onclick="app.calculator.inputNumber('2')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">2</button>
        <button onclick="app.calculator.inputNumber('3')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">3</button>
        <button onclick="app.calculator.operation('+')" style="background: #3498db; color: white; border: none; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">+</button>
        
        <!-- Row 5 -->
        <button onclick="app.calculator.plusMinus()" style="background: #95a5a6; color: white; border: none; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">±</button>
        <button onclick="app.calculator.inputNumber('0')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">0</button>
        <button onclick="app.calculator.decimal()" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">.</button>
        <button onclick="app.calculator.equals()" style="background: #27ae60; color: white; border: none; padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s;">=</button>
      </div>

      <!-- Scientific Mode Buttons -->
      <div class="button-grid scientific-mode" style="display: none; grid-template-columns: repeat(5, 1fr); gap: 10px;">
        <!-- Row 1 -->
        <button onclick="app.calculator.function('sin')" style="background: #9b59b6; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">sin</button>
        <button onclick="app.calculator.function('cos')" style="background: #9b59b6; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">cos</button>
        <button onclick="app.calculator.function('tan')" style="background: #9b59b6; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">tan</button>
        <button onclick="app.calculator.function('log')" style="background: #8e44ad; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">log</button>
        <button onclick="app.calculator.function('ln')" style="background: #8e44ad; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">ln</button>
        
        <!-- Row 2 -->
        <button onclick="app.calculator.function('asin')" style="background: #9b59b6; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">asin</button>
        <button onclick="app.calculator.function('acos')" style="background: #9b59b6; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">acos</button>
        <button onclick="app.calculator.function('atan')" style="background: #9b59b6; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">atan</button>
        <button onclick="app.calculator.function('power10')" style="background: #8e44ad; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">10ˣ</button>
        <button onclick="app.calculator.function('exp')" style="background: #8e44ad; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">eˣ</button>
        
        <!-- Row 3 -->
        <button onclick="app.calculator.constant('pi')" style="background: #16a085; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">π</button>
        <button onclick="app.calculator.constant('e')" style="background: #16a085; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">e</button>
        <button onclick="app.calculator.operation('^')" style="background: #3498db; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">xʸ</button>
        <button onclick="app.calculator.function('square')" style="background: #3498db; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">x²</button>
        <button onclick="app.calculator.function('cube')" style="background: #3498db; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">x³</button>
        
        <!-- Row 4 -->
        <button onclick="app.calculator.function('sqrt')" style="background: #27ae60; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">√</button>
        <button onclick="app.calculator.function('reciprocal')" style="background: #27ae60; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">1/x</button>
        <button onclick="app.calculator.function('factorial')" style="background: #27ae60; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">n!</button>
        <button onclick="app.calculator.function('abs')" style="background: #27ae60; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">|x|</button>
        <button onclick="app.calculator.function('percent')" style="background: #f39c12; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">%</button>
        
        <!-- Row 5 - Memory -->
        <button onclick="app.calculator.memoryClear()" style="background: #e67e22; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">MC</button>
        <button onclick="app.calculator.memoryRecall()" style="background: #d35400; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">MR</button>
        <button onclick="app.calculator.memoryPlus()" style="background: #d35400; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">M+</button>
        <button onclick="app.calculator.memoryMinus()" style="background: #d35400; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">M-</button>
        <button onclick="app.calculator.toggleAngleMode()" style="background: #16a085; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">DEG</button>
        
        <!-- Standard buttons -->
        <button onclick="app.calculator.clearEntry()" style="background: #e74c3c; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">CE</button>
        <button onclick="app.calculator.clear()" style="background: #e67e22; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">C</button>
        <button onclick="app.calculator.backspace()" style="background: #95a5a6; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">⌫</button>
        <button onclick="app.calculator.operation('/')" style="background: #3498db; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">÷</button>
        <button onclick="app.calculator.openParenthesis()" style="background: #7f8c8d; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">(</button>
        
        <!-- Numbers and operators -->
        <button onclick="app.calculator.inputNumber('7')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">7</button>
        <button onclick="app.calculator.inputNumber('8')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">8</button>
        <button onclick="app.calculator.inputNumber('9')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">9</button>
        <button onclick="app.calculator.operation('*')" style="background: #3498db; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">×</button>
        <button onclick="app.calculator.closeParenthesis()" style="background: #7f8c8d; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">)</button>
        
        <button onclick="app.calculator.inputNumber('4')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">4</button>
        <button onclick="app.calculator.inputNumber('5')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">5</button>
        <button onclick="app.calculator.inputNumber('6')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">6</button>
        <button onclick="app.calculator.operation('-')" style="background: #3498db; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">−</button>
        <button onclick="app.calculator.function('rand')" style="background: #95a5a6; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">Rnd</button>
        
        <button onclick="app.calculator.inputNumber('1')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">1</button>
        <button onclick="app.calculator.inputNumber('2')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">2</button>
        <button onclick="app.calculator.inputNumber('3')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">3</button>
        <button onclick="app.calculator.operation('+')" style="background: #3498db; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">+</button>
        <button onclick="app.calculator.operation('mod')" style="background: #7f8c8d; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">mod</button>
        
        <button onclick="app.calculator.plusMinus()" style="background: #95a5a6; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">±</button>
        <button onclick="app.calculator.inputNumber('0')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">0</button>
        <button onclick="app.calculator.decimal()" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">.</button>
        <button onclick="app.calculator.equals()" style="background: #27ae60; color: white; border: none; padding: 15px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600; grid-column: span 2;">=</button>
      </div>

      <!-- Programmer Mode Buttons -->
      <div class="button-grid programmer-mode" style="display: none; grid-template-columns: repeat(5, 1fr); gap: 10px;">
        <!-- Base Selection -->
        <button onclick="app.calculator.setBase(16)" style="background: #9b59b6; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">HEX</button>
        <button onclick="app.calculator.setBase(10)" class="active" style="background: #8e44ad; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">DEC</button>
        <button onclick="app.calculator.setBase(8)" style="background: #9b59b6; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">OCT</button>
        <button onclick="app.calculator.setBase(2)" style="background: #9b59b6; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">BIN</button>
        <button onclick="app.calculator.clear()" style="background: #e74c3c; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">C</button>
        
        <!-- Bitwise Operations -->
        <button onclick="app.calculator.bitwiseOperation('and')" style="background: #16a085; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">AND</button>
        <button onclick="app.calculator.bitwiseOperation('or')" style="background: #16a085; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">OR</button>
        <button onclick="app.calculator.bitwiseOperation('xor')" style="background: #16a085; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">XOR</button>
        <button onclick="app.calculator.bitwiseOperation('not')" style="background: #16a085; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">NOT</button>
        <button onclick="app.calculator.backspace()" style="background: #95a5a6; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">⌫</button>
        
        <!-- Hex Digits -->
        <button class="hex-btn" onclick="app.calculator.inputHex('A')" style="background: #3498db; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">A</button>
        <button class="hex-btn" onclick="app.calculator.inputHex('B')" style="background: #3498db; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">B</button>
        <button class="hex-btn" onclick="app.calculator.inputHex('C')" style="background: #3498db; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">C</button>
        <button class="hex-btn" onclick="app.calculator.inputHex('D')" style="background: #3498db; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">D</button>
        <button onclick="app.calculator.operation('/')" style="background: #e67e22; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">÷</button>
        
        <button class="hex-btn" onclick="app.calculator.inputHex('E')" style="background: #3498db; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">E</button>
        <button class="hex-btn" onclick="app.calculator.inputHex('F')" style="background: #3498db; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">F</button>
        <button onclick="app.calculator.bitwiseOperation('lshift')" style="background: #27ae60; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;"><<</button>
        <button onclick="app.calculator.bitwiseOperation('rshift')" style="background: #27ae60; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">>>
        <!-- Numbers Row 1 -->
        <button onclick="app.calculator.inputNumber('7')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">7</button>
        <button onclick="app.calculator.inputNumber('8')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">8</button>
        <button onclick="app.calculator.inputNumber('9')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">9</button>
        <button onclick="app.calculator.operation('mod')" style="background: #f39c12; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">mod</button>
        <button onclick="app.calculator.operation('-')" style="background: #e67e22; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">−</button>
        
        <!-- Numbers Row 2 -->
        <button onclick="app.calculator.inputNumber('4')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">4</button>
        <button onclick="app.calculator.inputNumber('5')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">5</button>
        <button onclick="app.calculator.inputNumber('6')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">6</button>
        <button onclick="app.calculator.openParenthesis()" style="background: #95a5a6; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">(</button>
        <button onclick="app.calculator.operation('+')" style="background: #e67e22; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">+</button>
        
        <!-- Numbers Row 3 -->
        <button onclick="app.calculator.inputNumber('1')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">1</button>
        <button onclick="app.calculator.inputNumber('2')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">2</button>
        <button onclick="app.calculator.inputNumber('3')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">3</button>
        <button onclick="app.calculator.closeParenthesis()" style="background: #95a5a6; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">)</button>
        <button onclick="app.calculator.equals()" style="background: #27ae60; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600; grid-row: span 2;">=</button>
        
        <!-- Bottom Row -->
        <button onclick="app.calculator.plusMinus()" style="background: #95a5a6; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">±</button>
        <button onclick="app.calculator.inputNumber('0')" style="background: white; color: var(--text-primary); border: 1px solid #ddd; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600; grid-column: span 2;">0</button>
        <button onclick="app.calculator.operation('^')" style="background: #f39c12; color: white; border: none; padding: 12px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600;">xʸ</button>
      </div>
      
      <!-- Programmer Mode Displays -->
      <div class="programmer-displays" style="display: none; margin-top: 20px; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
          <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">HEX</div>
            <div id="hexDisplay" style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary); font-family: 'Courier New', monospace; direction: ltr;">0</div>
          </div>
          <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">DEC</div>
            <div id="decDisplay" style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary); font-family: 'Courier New', monospace; direction: ltr;">0</div>
          </div>
          <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">OCT</div>
            <div id="octDisplay" style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary); font-family: 'Courier New', monospace; direction: ltr;">0</div>
          </div>
          <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">BIN</div>
            <div id="binDisplay" style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary); font-family: 'Courier New', monospace; direction: ltr;">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- History Sidebar -->
    <div style="background: white; border-radius: 20px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); height: fit-content; max-height: 600px; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color);">
        <h3 style="margin: 0; color: var(--text-primary); font-size: 1.3rem;">📜 היסטוריה</h3>
        <button onclick="app.calculator.clearHistory()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s;">
          🗑️ נקה
        </button>
      </div>
      <div id="historyList">
        <div class="history-empty" style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
          <div class="empty-icon" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;">🧮</div>
          <div class="empty-text" style="font-size: 1rem; line-height: 1.6;">אין היסטוריה עדיין<br>התחל לחשב!</div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End of Calculator Page -->

    <!-- Timer Page -->
    <div id="timer" class="page">
      <div class="timer-container">
        <!-- Header -->
        <div class="timer-header">
          <h1>⏱️ טיימר ושעון עצר</h1>
          <p>מעקב זמן מדויק ומקצועי</p>
        </div>

        <!-- Tabs -->
        <div class="timer-tabs">
          <button class="timer-tab active" onclick="timerApp.switchTab('stopwatch')">
            🏃 שעון עצר
          </button>
          <button class="timer-tab" onclick="timerApp.switchTab('timer')">
            ⏲️ טיימר
          </button>
        </div>

        <!-- Content -->
        <div class="timer-content">
          <!-- Stopwatch -->
          <div class="timer-tab-content active" id="stopwatchContent">
            <div class="timer-display">
              <!-- Visual Indicator -->
              <div class="timer-visual-indicator">
                <svg class="timer-circle-progress" viewBox="0 0 200 200">
                  <circle class="timer-circle-bg" cx="100" cy="100" r="90"></circle>
                  <circle class="timer-circle-fg" cx="100" cy="100" r="90" id="stopwatchCircle"></circle>
                </svg>
                <div class="timer-pulse" id="stopwatchPulse"></div>
              </div>

              <div class="timer-time" id="stopwatchTime">00:00:00<span style="font-size: 0.6em; opacity: 0.8;">.0</span></div>
              
              <div class="timer-controls">
                <button class="timer-btn timer-btn-start" id="stopwatchStart" onclick="timerApp.startStopwatch()">
                  <span>▶️</span>
                  <span>התחל</span>
                </button>
                <button class="timer-btn timer-btn-pause" id="stopwatchPause" onclick="timerApp.pauseStopwatch()" style="display: none;">
                  <span>⏸️</span>
                  <span>השהה</span>
                </button>
                <button class="timer-btn timer-btn-secondary" onclick="timerApp.recordLap()">
                  <span>🏁</span>
                  <span>סיבוב</span>
                </button>
                <button class="timer-btn timer-btn-danger" onclick="timerApp.resetStopwatch()">
                  <span>🔄</span>
                  <span>אפס</span>
                </button>
              </div>
            </div>

            <!-- Laps -->
            <div class="timer-laps-container" id="lapsContainer" style="display: none;">
              <div class="timer-laps-header">
                <span>🏁 סיבובים</span>
                <span class="timer-laps-count" id="lapsCount">0</span>
              </div>
              <div class="timer-laps-list" id="lapsList">
                <div class="timer-empty-state">
                  <div class="timer-empty-icon">🏁</div>
                  <div class="timer-empty-text">לא נרשמו סיבובים עדיין</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Timer -->
          <div class="timer-tab-content" id="timerContent">
            <div class="timer-display">
              <!-- Timer Presets -->
              <div class="timer-presets">
                <button class="timer-preset" onclick="timerApp.setPreset(1, 0)" data-color="blue">
                  <div class="timer-preset-icon">⚡</div>
                  <div class="timer-preset-name">דקה</div>
                  <div class="timer-preset-time">1:00</div>
                </button>
                <button class="timer-preset" onclick="timerApp.setPreset(5, 0)" data-color="cyan">
                  <div class="timer-preset-icon">☕</div>
                  <div class="timer-preset-name">5 דקות</div>
                  <div class="timer-preset-time">5:00</div>
                </button>
                <button class="timer-preset" onclick="timerApp.setPreset(10, 0)" data-color="green">
                  <div class="timer-preset-icon">📖</div>
                  <div class="timer-preset-name">10 דקות</div>
                  <div class="timer-preset-time">10:00</div>
                </button>
                <button class="timer-preset" onclick="timerApp.setPreset(15, 0)" data-color="teal">
                  <div class="timer-preset-icon">✏️</div>
                  <div class="timer-preset-name">15 דקות</div>
                  <div class="timer-preset-time">15:00</div>
                </button>
                <button class="timer-preset pomodoro" onclick="timerApp.setPreset(25, 0)" data-color="red">
                  <div class="timer-preset-icon">🍅</div>
                  <div class="timer-preset-name">פומודורו</div>
                  <div class="timer-preset-time">25:00</div>
                </button>
                <button class="timer-preset" onclick="timerApp.setPreset(30, 0)" data-color="purple">
                  <div class="timer-preset-icon">🎯</div>
                  <div class="timer-preset-name">30 דקות</div>
                  <div class="timer-preset-time">30:00</div>
                </button>
                <button class="timer-preset" onclick="timerApp.setPreset(45, 0)" data-color="orange">
                  <div class="timer-preset-icon">📚</div>
                  <div class="timer-preset-name">45 דקות</div>
                  <div class="timer-preset-time">45:00</div>
                </button>
                <button class="timer-preset custom" onclick="timerApp.focusOnInput()" data-color="pink">
                  <div class="timer-preset-icon">⚙️</div>
                  <div class="timer-preset-name">הזנה ידנית</div>
                  <div class="timer-preset-time">בחר</div>
                </button>
              </div>

              <!-- Timer Input -->
              <div class="timer-input-section">
                <div class="timer-input-group">
                  <div class="timer-input-icon">🕐</div>
                  <input type="number" id="timerHours" value="0" min="0" max="23" placeholder="0">
                  <label>שעות</label>
                </div>
                <span class="timer-input-separator">:</span>
                <div class="timer-input-group">
                  <div class="timer-input-icon">⏱️</div>
                  <input type="number" id="timerMinutes" value="0" min="0" max="59" placeholder="0">
                  <label>דקות</label>
                </div>
                <span class="timer-input-separator">:</span>
                <div class="timer-input-group">
                  <div class="timer-input-icon">⚡</div>
                  <input type="number" id="timerSeconds" value="0" min="0" max="59" placeholder="0">
                  <label>שניות</label>
                </div>
              </div>

              <!-- Visual Indicator -->
              <div class="timer-visual-indicator">
                <svg class="timer-circle-progress" viewBox="0 0 200 200">
                  <circle class="timer-circle-bg" cx="100" cy="100" r="90"></circle>
                  <circle class="timer-circle-fg timer" cx="100" cy="100" r="90" id="timerCircle"></circle>
                </svg>
                <div class="timer-pulse" id="timerPulse"></div>
              </div>

              <div class="timer-time" id="timerTime">00:00:00</div>
              
              <div class="timer-controls">
                <button class="timer-btn timer-btn-start" id="timerStart" onclick="timerApp.startTimer()">
                  <span>▶️</span>
                  <span>התחל</span>
                </button>
                <button class="timer-btn timer-btn-pause" id="timerPause" onclick="timerApp.pauseTimer()" style="display: none;">
                  <span>⏸️</span>
                  <span>השהה</span>
                </button>
                <button class="timer-btn timer-btn-danger" onclick="timerApp.resetTimer()">
                  <span>🔄</span>
                  <span>אפס</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Weekly Schedule Page -->
    <div id="schedule" class="page">
      <div class="page-header">
        <h1 class="page-title">
          <span>🗓️</span>
          מערכת שעות שבועית
        </h1>
        <button class="back-btn" onclick="app.showPage('homepage')">
          <span>←</span>
          חזור לדף הבית
        </button>
      </div>

      <!-- Schedule Stats -->
      <div class="schedule-stats">
        <div class="schedule-stat">
          <div class="schedule-stat-number" id="totalLessons">0</div>
          <div class="schedule-stat-label">שיעורים בשבוע</div>
        </div>
        <div class="schedule-stat">
          <div class="schedule-stat-number" id="todayLessons">0</div>
          <div class="schedule-stat-label">שיעורים היום</div>
        </div>
        <div class="schedule-stat">
          <div class="schedule-stat-number" id="uniqueSubjects">0</div>
          <div class="schedule-stat-label">מקצועות</div>
        </div>
      </div>

      <!-- Schedule Actions -->
      <div class="schedule-actions">
        <button class="schedule-action-btn primary" onclick="scheduleApp.syncToCalendar()">
          <span>🔄</span>
          סנכרן ליומן
        </button>
        <button class="schedule-action-btn danger" onclick="scheduleApp.clearAll()">
          <span>🗑️</span>
          נקה הכל
        </button>
      </div>

      <!-- Schedule Table -->
      <div class="schedule-container">
        <table class="schedule-table" id="scheduleTable">
          <thead>
            <tr>
              <th>שעה</th>
              <th>ראשון</th>
              <th>שני</th>
              <th>שלישי</th>
              <th>רביעי</th>
              <th>חמישי</th>
              <th>שישי</th>
            </tr>
          </thead>
          <tbody id="scheduleBody">
            <!-- Will be generated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

  <!-- Schedule Edit Modal -->
  <div class="schedule-modal-overlay" id="scheduleModal">
    <div class="schedule-modal">
      <h3>📚 <span id="scheduleModalTitle">הוסף שיעור</span></h3>
      
      <div class="schedule-form-group">
        <label>שם המקצוע:</label>
        <input type="text" id="lessonSubject" placeholder="לדוגמה: מתמטיקה" list="subjectsList">
        <datalist id="subjectsList">
          <option value="מתמטיקה">
          <option value="אנגלית">
          <option value="עברית">
          <option value="היסטוריה">
          <option value="תנ״ך">
          <option value="פיזיקה">
          <option value="כימיה">
          <option value="ביולוגיה">
          <option value="ספרות">
          <option value="אזרחות">
          <option value="גיאוגרפיה">
          <option value="מדעי המחשב">
          <option value="חינוך גופני">
          <option value="אמנות">
          <option value="מוזיקה">
        </datalist>
      </div>
      
      <div class="schedule-form-group">
        <label>חדר/כיתה:</label>
        <input type="text" id="lessonRoom" placeholder="לדוגמה: כיתה 12">
      </div>
      
      <div class="schedule-form-group">
        <label>מורה (אופציונלי):</label>
        <input type="text" id="lessonTeacher" placeholder="לדוגמה: גב' כהן">
      </div>
      
      <div class="schedule-modal-buttons">
        <button class="schedule-btn-save" onclick="scheduleApp.saveLesson()">💾 שמור</button>
        <button class="schedule-btn-delete" id="deleteLessonBtn" onclick="scheduleApp.deleteLesson()" style="display: none;">🗑️ מחק</button>
        <button class="schedule-btn-cancel" onclick="scheduleApp.closeModal()">ביטול</button>
      </div>
    </div>
  </div>

    <!-- My Links Page -->
    <div id="mylinks" class="page">
      <div class="page-header">
        <h1 class="page-title">
          <span>🔗</span>
          הקישורים שלי
        </h1>
        <button class="back-btn" onclick="app.showPage('homepage')">
          <span>←</span>
          חזור לדף הבית
        </button>
      </div>

      <!-- Links Stats -->
      <div class="links-stats">
        <div class="links-stat">
          <div class="links-stat-number" id="totalLinks">0</div>
          <div class="links-stat-label">סה"כ קישורים</div>
        </div>
      </div>

      <!-- Links Actions -->
      <div class="links-actions">
        <button class="links-action-btn primary" onclick="linksApp.openAddModal()">
          <span>➕</span>
          הוסף קישור
        </button>
        <button class="links-action-btn danger" onclick="linksApp.clearAll()">
          <span>🗑️</span>
          נקה הכל
        </button>
      </div>

      <!-- Search -->
      <div class="links-search">
        <input type="text" id="linksSearchInput" placeholder="חפש קישור..." oninput="linksApp.filterLinks()">
        <span class="links-search-icon">🔍</span>
      </div>

      <!-- Links Grid -->
      <div class="links-grid" id="linksGrid">
        <!-- Links will be rendered here -->
      </div>

      <!-- Empty State -->
      <div class="links-empty" id="linksEmpty" style="display: none;">
        <div class="links-empty-icon">🔗</div>
        <div class="links-empty-title">אין קישורים שמורים</div>
        <div class="links-empty-text">הוסף קישורים לאתרים שימושיים כדי לגשת אליהם בקלות</div>
        <button class="links-action-btn primary" onclick="linksApp.openAddModal()">
          <span>➕</span>
          הוסף קישור ראשון
        </button>
      </div>
    </div>

  <!-- Link Add/Edit Modal -->
  <div class="link-modal-overlay" id="linkModal">
    <div class="link-modal">
      <h3>🔗 <span id="linkModalTitle">הוסף קישור</span></h3>
      
      <div class="link-form-group">
        <label>שם הקישור:</label>
        <input type="text" id="linkName" placeholder="לדוגמה: Google">
      </div>
      
      <div class="link-form-group">
        <label>כתובת URL:</label>
        <input type="url" id="linkUrl" placeholder="https://www.google.com" dir="ltr">
      </div>
      
      <div class="link-modal-buttons">
        <button class="link-btn-save" onclick="linksApp.saveLink()">💾 שמור</button>
        <button class="link-btn-cancel" onclick="linksApp.closeModal()">ביטול</button>
      </div>
    </div>
  </div>

</div>
<!-- End of Page Container -->

  <!-- Task Edit Modal -->
  <div class="modal-overlay" id="taskEditModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">
          <span>✏️</span>
          עריכת משימה
        </h2>
        <button class="close-btn" onclick="app.closeTaskEditModal()">✕</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="editTaskTitle">כותרת המשימה</label>
          <input type="text" id="editTaskTitle" class="form-input" maxlength="160">
        </div>

        <div class="form-group">
          <label class="form-label" for="editTaskDescription">תיאור</label>
          <textarea id="editTaskDescription" class="form-textarea"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label" for="editTaskCategory">קטגוריה</label>
          <select id="editTaskCategory" class="form-select">
            <option value="לימודים">לימודים</option>
            <option value="מטלות">מטלות</option>
            <option value="בחינות">בחינות</option>
            <option value="פרויקטים">פרויקטים</option>
            <option value="אישי">אישי</option>
            <option value="אחר">אחר</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">רמת עדיפות</label>
          <div class="priority-options" id="editPriorityOptions">
            <div class="priority-option high" onclick="app.selectEditPriority('high')" data-priority="high">
              גבוהה
            </div>
            <div class="priority-option medium" onclick="app.selectEditPriority('medium')" data-priority="medium">
              בינונית
            </div>
            <div class="priority-option low" onclick="app.selectEditPriority('low')" data-priority="low">
              נמוכה
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="editTaskDueDate">תאריך יעד</label>
          <input type="date" id="editTaskDueDate" class="form-input">
        </div>

        <div class="form-group">
          <label class="form-label" for="editTaskDueTime">שעת יעד</label>
          <input type="time" id="editTaskDueTime" class="form-input">
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="app.closeTaskEditModal()">
          <span>✕</span>
          ביטול
        </button>
        <button class="btn btn-primary" onclick="app.saveTaskEdit()">
          <span>💾</span>
          שמור שינויים
        </button>
      </div>
    </div>
  </div>

<!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">
          <span>⚙️</span>
          הגדרות
        </h2>
        <button class="close-btn" onclick="app.closeSettings()">✕</button>
      </div>
      
      <div class="modal-body">
        <!-- פרטי משתמש -->
        <div class="form-section">
          <div class="section-title">
            <span>👤</span>
            פרטי המשתמש
          </div>
          <div class="form-group">
            <label class="form-label" for="userName">שם מלא</label>
            <input type="text" id="userName" class="form-input" placeholder="הכנס את שמך המלא">
          </div>
          <div class="form-group">
            <label class="form-label" for="userAge">גיל</label>
            <input type="number" id="userAge" class="form-input" placeholder="הכנס את גילך" min="1" max="120">
          </div>
          <div class="form-group">
            <label class="form-label" for="userAddress">כתובת</label>
            <input type="text" id="userAddress" class="form-input" placeholder="הכנס את כתובתך">
          </div>
          <div class="form-group">
            <label class="form-label" for="userSchool">בית ספר</label>
            <input type="text" id="userSchool" class="form-input" placeholder="הכנס את שם בית הספר">
          </div>
        </div>

        <!-- הגדרות תצוגה -->
        <div class="form-section">
          <div class="section-title">
            <span>🎨</span>
            הגדרות תצוגה
          </div>
          <div class="form-group">
            <label class="form-label">ערכת צבעים</label>
            <div style="display: flex; gap: 15px;">
              <label class="radio-option">
                <input type="radio" name="theme" value="light" checked onchange="app.changeTheme('light')">
                <span>☀️ בהיר</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="theme" value="dark" onchange="app.changeTheme('dark')">
                <span>🌙 כהה</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">שפת ממשק</label>
            <div style="display: flex; gap: 15px;">
              <label class="radio-option">
                <input type="radio" name="language" value="he" checked onchange="app.changeLanguage('he')">
                <span>🇮🇱 עברית</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="language" value="en" onchange="app.changeLanguage('en')">
                <span>🇺🇸 English</span>
              </label>
            </div>
          </div>
        </div>

        <!-- הגדרות שמירה -->
        <div class="form-section">
          <div class="section-title">
            <span>💾</span>
            הגדרות שמירה
          </div>
          <div class="form-group">
            <label class="form-label" for="autoSaveInterval">שמירה אוטומטית (שניות)</label>
            <input type="number" id="autoSaveInterval" class="form-input" placeholder="30" min="10" max="300" value="30">
            <small style="color: var(--text-secondary); font-size: 0.85rem;">מומלץ: 30-60 שניות</small>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="secondary-btn" onclick="app.closeSettings()">ביטול</button>
        <button class="primary-btn" onclick="app.saveSettingsAndLogin()">
          💾 שמור והתחבר
        </button>
      </div>
    </div>
  </div>

  <!-- Modal for creating notebook -->
  <div class="modal-overlay" id="notebookModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">
          <span>📚</span>
          יצירת מחברת חדשה
        </h2>
        <button class="close-btn" onclick="app.closeNotebookCreator()">✕</button>
      </div>
      
      <div class="modal-body">
        <!-- Notebook Name -->
        <div class="form-section">
          <div class="section-title">
            <span>✏️</span>
            פרטי המחברת
          </div>
          <div class="form-group">
            <label class="form-label" for="notebookName">שם המחברת</label>
            <input type="text" id="notebookName" class="form-input" placeholder="לדוגמה: מתמטיקה כיתה י״ג" maxlength="50">
          </div>
        </div>

        <!-- Page Type Selection -->
        <div class="form-section">
          <div class="section-title">
            <span>📄</span>
            סוג הדפים
          </div>
          <div class="page-type-grid">
            <div class="page-type-option" data-type="lined" onclick="app.selectPageType('lined')">
              <span class="page-type-icon">📝</span>
              <div class="page-type-title">דף שורות</div>
              <div class="page-type-desc">קווים אופקיים לכתיבה נעימה</div>
            </div>
            <div class="page-type-option" data-type="grid" onclick="app.selectPageType('grid')">
              <span class="page-type-icon">📊</span>
              <div class="page-type-title">דף משובץ</div>
              <div class="page-type-desc">רשת ריבועים למתמטיקה</div>
            </div>
            <div class="page-type-option" data-type="blank" onclick="app.selectPageType('blank')">
              <span class="page-type-icon">🎨</span>
              <div class="page-type-title">דף חלק</div>
              <div class="page-type-desc">דף ריק לציורים וחופש יצירה</div>
            </div>
            <div class="page-type-option" data-type="checklist" onclick="app.selectPageType('checklist')">
              <span class="page-type-icon">✅</span>
              <div class="page-type-title">צ'קליסט</div>
              <div class="page-type-desc">רשימות קניות, ציוד וטיולים</div>
              <span class="premium-badge-small">⭐</span>
            </div>
          </div>
        </div>

        <!-- Color Selection -->
        <div class="form-section">
          <div class="section-title">
            <span>🎨</span>
            צבע המחברת
          </div>
          <div class="color-grid">
            <div class="color-option" style="background: #9b59b6;" data-color="#9b59b6" onclick="app.selectColor('#9b59b6')"></div>
            <div class="color-option" style="background: #e74c3c;" data-color="#e74c3c" onclick="app.selectColor('#e74c3c')"></div>
            <div class="color-option" style="background: #3498db;" data-color="#3498db" onclick="app.selectColor('#3498db')"></div>
            <div class="color-option" style="background: #27ae60;" data-color="#27ae60" onclick="app.selectColor('#27ae60')"></div>
            <div class="color-option" style="background: #f39c12;" data-color="#f39c12" onclick="app.selectColor('#f39c12')"></div>
            <div class="color-option" style="background: #16a085;" data-color="#16a085" onclick="app.selectColor('#16a085')"></div>
            <div class="color-option" style="background: #8e44ad;" data-color="#8e44ad" onclick="app.selectColor('#8e44ad')"></div>
            <div class="color-option" style="background: #c0392b;" data-color="#c0392b" onclick="app.selectColor('#c0392b')"></div>
            <div class="color-option" style="background: #2980b9;" data-color="#2980b9" onclick="app.selectColor('#2980b9')"></div>
            <div class="color-option" style="background: #229954;" data-color="#229954" onclick="app.selectColor('#229954')"></div>
            <div class="color-option" style="background: #d35400;" data-color="#d35400" onclick="app.selectColor('#d35400')"></div>
            <div class="color-option" style="background: #148f77;" data-color="#148f77" onclick="app.selectColor('#148f77')"></div>
          </div>
          
          <div class="color-preview">
            <div class="preview-swatch" id="colorPreview" style="background: #9b59b6;"></div>
            <span class="preview-text">הצבע שנבחר יופיע כקו צבעוני בצד המחברת</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="app.closeNotebookCreator()">
          <span>✕</span>
          ביטול
        </button>
        <button class="btn btn-create" id="createBtn" onclick="app.createNotebook()">
          <span>✨</span>
          צור מחברת
        </button>
      </div>
    </div>
  </div>


  <!-- About Modal -->
  <div class="about-modal-overlay" id="aboutModal" onclick="closeAboutModal(event)">
    <div class="about-modal" onclick="event.stopPropagation()">
      <img src="https://brickyeda.github.io/digitalbag/logo.png" alt="My Campus Logo" class="about-logo">
      <h2 class="about-title">My Campus</h2>
      <p class="about-subtitle">הילקוט הדיגיטלי החכם שלך</p>
      <span class="about-version">גרסה 1.0</span>
      
      <div class="about-divider"></div>
      
      <div class="about-developer">
        <div class="about-developer-label">פותח ע"י</div>
        <div class="about-developer-name">שחר ברגיג</div>
      </div>
      
      <div class="about-contact">
        <div class="about-contact-label">📧 לשאלות, הצעות ומשוב</div>
        <div class="about-contact-email">
          <a href="mailto:brickyeda@gmail.com">brickyeda@gmail.com</a>
        </div>
      </div>
      
      <button class="about-close-btn" onclick="closeAboutModal()">סגור</button>
    </div>
  </div>

  <!-- Auto Logout Warning -->
  <div class="auto-logout-warning" id="autoLogoutWarning">
    <div class="auto-logout-content">
      <div class="auto-logout-icon">⏰</div>
      <h3 class="auto-logout-title">האם אתה עדיין כאן?</h3>
      <p class="auto-logout-message">לא זוהתה פעילות במערכת זמן רב.</p>
      <p class="auto-logout-message">המערכת תתנתק אוטומטית בעוד:</p>
      <div class="auto-logout-countdown" id="logoutCountdown">5:00</div>
      <p class="auto-logout-note">הנתונים שלך יישמרו אוטומטית</p>
      <button class="auto-logout-btn" onclick="autoLogout.stayLoggedIn()">
        ✋ אני כאן - המשך עבודה
      </button>
    </div>
  </div>

  <!-- Sticky Notes FAB and Menu -->
  <div class="sticky-notes-fab" id="stickyNotesFab" onclick="stickyNotes.toggleMenu()" title="דפי ממו">
    📝
  </div>

  <div class="sticky-notes-menu" id="stickyNotesMenu">
    <div class="menu-title">
      <span>📝</span>
      בחר צבע לדף ממו
    </div>
    <div class="color-options">
      <div class="color-option yellow" onclick="stickyNotes.createNote('yellow')" title="צהוב">📝</div>
      <div class="color-option pink" onclick="stickyNotes.createNote('pink')" title="ורוד">💗</div>
      <div class="color-option blue" onclick="stickyNotes.createNote('blue')" title="כחול">💙</div>
      <div class="color-option green" onclick="stickyNotes.createNote('green')" title="ירוק">💚</div>
      <div class="color-option purple" onclick="stickyNotes.createNote('purple')" title="סגול">💜</div>
      <div class="color-option orange" onclick="stickyNotes.createNote('orange')" title="כתום">🧡</div>
    </div>
    <div class="menu-footer">
      <span id="notesCount">0 דפי ממו</span>
      <button class="sticky-note-btn" onclick="stickyNotes.clearAll()" title="מחק הכל">🗑️</button>
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // ========== About Modal Functions ==========
    function openAboutModal() {
      document.getElementById('aboutModal').classList.add('active');
    }
    
    function closeAboutModal(event) {
      if (!event || event.target === event.currentTarget) {
        document.getElementById('aboutModal').classList.remove('active');
      }
    }
    
    // סגירה עם Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeAboutModal();
      }
    });

    // ========== Auto Logout System ==========
    const autoLogout = {
      inactivityTime: 30 * 60 * 1000, // 30 דקות
      warningTime: 5 * 60 * 1000, // 5 דקות אזהרה
      inactivityTimer: null,
      warningTimer: null,
      warningShown: false,

      init() {
        this.resetTimer();
        this.setupEventListeners();
        console.log('✅ מערכת Auto Logout הופעלה');
      },

      setupEventListeners() {
        // אירועים שמעידים על פעילות
        const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        events.forEach(event => {
          document.addEventListener(event, () => this.onActivity(), { passive: true });
        });
      },

      onActivity() {
        // אם ההתראה מוצגת וזוהתה פעילות - בטל את ההתנתקות
        if (this.warningShown) {
          this.hideWarning();
          console.log('✅ זוהתה פעילות - ביטול התנתקות אוטומטית');
        }
        this.resetTimer();
      },

      resetTimer() {
        // נקה טיימרים קיימים
        if (this.inactivityTimer) clearTimeout(this.inactivityTimer);
        if (this.warningTimer) clearTimeout(this.warningTimer);
        this.warningShown = false;

        // התחל טיימר חדש - אחרי 30 דקות תציג אזהרה
        this.inactivityTimer = setTimeout(() => {
          this.showWarning();
        }, this.inactivityTime);
      },

      showWarning() {
        this.warningShown = true;
        document.getElementById('autoLogoutWarning').classList.add('active');
        this.startCountdown();

        // אחרי 5 דקות נוספות - התנתק
        this.warningTimer = setTimeout(() => {
          this.performAutoLogout();
        }, this.warningTime);
      },

      hideWarning() {
        this.warningShown = false;
        document.getElementById('autoLogoutWarning').classList.remove('active');
        if (this.warningTimer) clearTimeout(this.warningTimer);
        if (this.countdownInterval) clearInterval(this.countdownInterval);
      },

      startCountdown() {
        let seconds = 300; // 5 דקות
        const countdownEl = document.getElementById('logoutCountdown');
        
        this.countdownInterval = setInterval(() => {
          seconds--;
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          countdownEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
          
          if (seconds <= 0) {
            clearInterval(this.countdownInterval);
          }
        }, 1000);
      },

      async performAutoLogout() {
        try {
          // שמור את כל הנתונים לפני התנתקות
          console.log('💾 שומר נתונים לפני התנתקות אוטומטית...');
          
          if (typeof app !== 'undefined') {
            if (app.tasks) await saveToSupabase('task_data', app.tasks);
            if (app.events) await saveToSupabase('calendar_data', app.events);
            if (app.subjects) await saveToSupabase('notebook_data', app.subjects);
          }
          if (typeof scheduleApp !== 'undefined' && scheduleApp.schedule) {
            await saveToSupabase('weekly_schedule', scheduleApp.schedule);
          }

          console.log('✅ נתונים נשמרו - מתנתק...');

          // שמור את מצב הטוטוריאל לפני מחיקה
          const tutorialKeys = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('tutorialState_')) {
              tutorialKeys.push({ key: key, value: localStorage.getItem(key) });
            }
          }

          // התנתק
          await supabaseClient.auth.signOut();
          localStorage.clear();
          sessionStorage.clear();
          
          // שחזר את מצב הטוטוריאל
          tutorialKeys.forEach(item => {
            localStorage.setItem(item.key, item.value);
          });
          
          window.location.replace('login_FIXED_NOW.html?t=' + Date.now() + '&reason=timeout');
        } catch (error) {
          console.error('שגיאה בהתנתקות אוטומטית:', error);
          window.location.replace('login_FIXED_NOW.html?t=' + Date.now());
        }
      },

      stayLoggedIn() {
        this.hideWarning();
        this.resetTimer();
      }
    };

    // ========== הגדרות Supabase ==========
    const SUPABASE_URL = 'https://ditiequwboxbiqrzvfhr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpdGllcXV3Ym94Ymlxcnp2ZmhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NDQ4NDUsImV4cCI6MjA4MTQyMDg0NX0.HM6FhOilvJJnLpooweEQjuXmdUBEZ9jc-59jIS_be_k';
    
    let supabaseClient = null;
    let currentUser = null;
    
    // אתחול Supabase
    function initSupabase() {
      if (typeof window.supabase !== 'undefined') {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('✅ Supabase מוכן');
        return true;
      }
      return false;
    }
    
    // בדיקת משתמש מחובר
    async function checkAuth() {
      if (!supabaseClient) return false;
      
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session && session.user) {
          currentUser = session.user;
          console.log('✅ משתמש מחובר:', currentUser.email);
          return true;
        } else {
          console.log('❌ אין משתמש מחובר');
          return false;
        }
      } catch (error) {
        console.error('שגיאה בבדיקת התחברות:', error);
        return false;
      }
    }
    
    // התנתקות
    async function logout() {
      if (confirm('האם אתה בטוח שברצונך להתנתק?')) {
        try {
          // התנתק מ-Supabase קודם
          await supabaseClient.auth.signOut();
          
          // שמור את מצב הטוטוריאל לפני מחיקה
          const tutorialKeys = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('tutorialState_')) {
              tutorialKeys.push({ key: key, value: localStorage.getItem(key) });
            }
          }
          
          // נקה את כל הנתונים המקומיים
          localStorage.clear();
          sessionStorage.clear();
          
          // שחזר את מצב הטוטוריאל
          tutorialKeys.forEach(item => {
            localStorage.setItem(item.key, item.value);
          });
          
          console.log('✅ התנתקות הצליחה - נתונים מקומיים נוקו (מצב טוטוריאל נשמר)');
          
          // הוסף cache busting - מונע בעיות cache
          window.location.replace('login_FIXED_NOW.html?t=' + Date.now());
        } catch (error) {
          console.error('שגיאה בהתנתקות:', error);
          alert('שגיאה בהתנתקות');
        }
      }
    }
    
    // שמירת נתונים ל-Supabase
    async function saveToSupabase(table, data) {
      if (!supabaseClient || !currentUser) {
        console.log('⚠️ Supabase לא זמין, שומר רק ב-localStorage');
        return { success: false };
      }
      
      try {
        const { error } = await supabaseClient
          .from(table)
          .upsert({
            user_id: currentUser.id,
            data: data,
            updated_at: new Date().toISOString()
          }, { onConflict: 'user_id' });
        
        if (error) throw error;
        console.log(`✅ נשמר ב-Supabase: ${table}`);
        return { success: true };
      } catch (error) {
        console.error(`שגיאה בשמירה ל-${table}:`, error);
        return { success: false, error };
      }
    }
    
    // טעינת נתונים מ-Supabase
    async function loadFromSupabase(table) {
      if (!supabaseClient || !currentUser) {
        console.log('⚠️ Supabase לא זמין, טוען מ-localStorage');
        return null;
      }
      
      try {
        const { data, error } = await supabaseClient
          .from(table)
          .select('data')
          .eq('user_id', currentUser.id)
          .single();
        
        if (error && error.code !== 'PGRST116') throw error; // PGRST116 = לא נמצא
        
        if (data) {
          console.log(`✅ נטען מ-Supabase: ${table}`);
          return data.data;
        }
        return null;
      } catch (error) {
        console.error(`שגיאה בטעינה מ-${table}:`, error);
        return null;
      }
    }
    
    // מגבלות גרסה חינמית
    const FREE_LIMITS = {
      maxNotebooks: 5,
      maxPages: {
        lined: 20,
        grid: 20,
        blank: 1,
        checklist: 1
      },
      maxPerType: {
        lined: 2,
        grid: 1,
        blank: 1,
        checklist: 1
      },
      maxActiveTasks: 20,
      maxChecklistItems: 5  // מקסימום שורות בצ'קליסט למשתמש חינמי
    };
    
    // אפליקציה ראשית
    const app = {
autoSaveInterval: null,
      // נתונים
      currentNotebook: null,
      activeTextareaIndex: undefined,
      saveInterval: null,
      userData: {},
      isPro: false, // האם המשתמש פרימיום
      selectedPriority: 'medium',
      selectedEventType: 'lesson',
      selectedPageType: 'lined',
      selectedColor: '#9b59b6',
      currentFilter: 'all',
      editingTaskId: null,
      
      // משימות
      tasks: [],
      
      // אירועים
      events: [],
      currentCalendarMonth: new Date().getMonth(),
      currentCalendarYear: new Date().getFullYear(),
      currentCalendarView: 'month',
      searchQuery: '',
      filteredEvents: [],
      
      // מחברות ברירת מחדל (5 מחברות לגרסה חינמית - כולל טעימה לצ'קליסט)
      subjects: {
        math: {
          title: 'מתמטיקה',
          icon: '🧮',
          color: '#9b59b6',
          description: 'אלגברה, גיאומטריה וחשבון',
          pageType: 'grid',
          pages: [
            {
              title: 'דף ראשון',
              content: 'ברוכים הבאים למחברת מתמטיקה!\nהתחילו לכתוב כאן...',
              date: new Date().toLocaleDateString('he-IL')
            }
          ]
        },
        hebrew: {
          title: 'עברית',
          icon: '📝',
          color: '#e74c3c',
          description: 'ספרות, לשון ותחביר',
          pageType: 'lined',
          pages: [
            {
              title: 'דף ראשון',
              content: 'ברוכים הבאים למחברת עברית!\nהתחילו לכתוב כאן...',
              date: new Date().toLocaleDateString('he-IL')
            }
          ]
        },
        science: {
          title: 'מדעים',
          icon: '🔬',
          color: '#27ae60',
          description: 'פיזיקה, כימיה וביולוגיה',
          pageType: 'lined',
          pages: [
            {
              title: 'דף ראשון',
              content: 'ברוכים הבאים למחברת מדעים!\nהתחילו לכתוב כאן...',
              date: new Date().toLocaleDateString('he-IL')
            }
          ]
        },
        drawing: {
          title: 'ציור',
          icon: '🎨',
          color: '#9b59b6',
          description: 'מחברת ציור חלקה',
          pageType: 'blank',
          pages: [
            {
              title: 'דף ציור',
              content: '',
              date: new Date().toLocaleDateString('he-IL')
            }
          ]
        },
        checklist: {
          title: 'רשימות',
          icon: '✅',
          color: '#22c55e',
          description: 'רשימות קניות, ציוד וטיולים',
          pageType: 'checklist',
          pages: [
            {
              title: 'רשימה לדוגמה',
              checklistItems: [
                { text: 'פריט ראשון - לחץ כדי לסמן ✓', checked: false },
                { text: 'פריט שני', checked: false },
                { text: 'פריט שלישי', checked: true }
              ],
              date: new Date().toLocaleDateString('he-IL')
            }
          ]
        }
      },



      // אתחול
      init: async function() {
        console.log('🔄 מאתחל אפליקציה...');
        
        // אתחול Supabase
        initSupabase();
        
        // בדיקת התחברות
        const isAuthenticated = await checkAuth();
        if (!isAuthenticated) {
          console.log('❌ משתמש לא מחובר - מעביר למסך התחברות');
          window.location.href = 'login_FIXED_NOW.html';
          return;
        }
        
        console.log('✅ משתמש מחובר:', currentUser.email);
        
        // בדיקה אם זה משתמש חדש/אחר
        const lastUserId = localStorage.getItem('lastUserId');
        if (!lastUserId || lastUserId !== currentUser.id) {
          console.log('🔄 מנקה נתונים מקומיים (משתמש אחר או כניסה ראשונה)');
          
          // נקה את כל הנתונים - בכוח!
          const keysToRemove = ['notebookData', 'taskData', 'calendarData', 'userData', 'appSettings'];
          keysToRemove.forEach(key => {
            localStorage.removeItem(key);
            console.log(`  ✅ נמחק: ${key}`);
          });
        }
        
        // שמור את ה-ID של המשתמש הנוכחי
        localStorage.setItem('lastUserId', currentUser.id);
        localStorage.setItem('isLoggedIn', 'true');
        
        // הצג את האימייל של המשתמש
        this.displayUserEmail();
        
        this.loadUserData();
        await this.loadUserPlan(currentUser.id); // טעינת סטטוס פרימיום
        this.updatePremiumInfoDisplay(); // עדכון כפתור הכוכב
        this.updateTime();
        setInterval(() => this.updateTime(), 1000);
        await this.loadNotebookData();
        await this.loadTaskData();
        await this.loadCalendarData();
        this.renderNotebooks();
        this.renderTasks();
        this.updateTaskStats();
        
        // עדכון הנתונים בדף הבית אחרי טעינת כל המידע
        this.loadWelcomeData();
        this.updateNotifications();
        

// אתחול כלי ציור
this.drawing.init();

// אתחול מערכת צורות אינטראקטיביות
this.interactiveShapes.init();

        // אתחול המחשבון
        this.calculator.init();
        
        // עדכון ראשוני של הסרגל הצדדי ללוח שנה
        setTimeout(() => {
          this.updateSidebarEventsList();
        }, 100);
// טעינת והחלת הגדרות
        const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
        if (settings.theme) {
          this.applyTheme(settings.theme);
        }
        if (settings.autoSaveInterval) {
          this.startAutoSave(settings.autoSaveInterval);
        }
this.showPage('homepage');
        
        // אתחול התראות Push בדפדפן
        this.initPushNotifications();
        
        // בדיקת התראות כל דקה
        setInterval(() => this.checkAndSendNotifications(), 60000);
        
        console.log('✅ אפליקציה הופעלה בהצלחה!');
      },
      
      // הצגת אימייל המשתמש
      displayUserEmail() {
        const greetingElement = document.getElementById('welcomeGreeting');
        if (greetingElement && currentUser) {
          // נסה להציג את שם המשתמש מה-metadata
          const username = currentUser.user_metadata?.username;
          
          if (username) {
            // יש שם משתמש - הצג אותו
            greetingElement.textContent = `שלום ${username}!`;
          } else if (currentUser.email.endsWith('@temp.local')) {
            // אימייל זמני - חלץ את שם המשתמש
            const usernameFromEmail = currentUser.email.replace('@temp.local', '');
            greetingElement.textContent = `שלום ${usernameFromEmail}!`;
          } else {
            // אין שם משתמש - הצג את החלק לפני ה-@ באימייל
            const usernameFromEmail = currentUser.email.split('@')[0];
            greetingElement.textContent = `שלום ${usernameFromEmail}!`;
          }
        }
      },

      // עדכון שעה
      updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('he-IL', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: false 
        });
        const dateString = now.toLocaleDateString('he-IL', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
        const timeElement = document.getElementById('navTime');
        const dateElement = document.getElementById('navDate');
        if (timeElement) {
          timeElement.textContent = timeString;
        }
        if (dateElement) {
          dateElement.textContent = dateString;
        }
      },

      // טעינת נתוני משתמש
      loadUserData() {
        // מערכת ישנה - מנקים אותה ועוברים למערכת החדשה
        const oldSaved = localStorage.getItem('digitalBackpackUser');
        if (oldSaved) {
          try {
            const oldData = JSON.parse(oldSaved);
            // אם יש נתונים ישנים ואין נתונים חדשים, מעבירים אותם
            const newSettings = JSON.parse(localStorage.getItem('appSettings')) || {};
            if (oldData.name && !newSettings.userName) {
              newSettings.userName = oldData.name;
            }
            if (oldData.institution && !newSettings.userSchool) {
              newSettings.userSchool = oldData.institution;
            }
            localStorage.setItem('appSettings', JSON.stringify(newSettings));
            // מוחקים את המערכת הישנה
            localStorage.removeItem('digitalBackpackUser');
          } catch(e) {
            console.log('שגיאה בטעינת נתונים ישנים');
          }
        }
      },

      // טעינת סטטוס פרימיום של המשתמש
      async loadUserPlan(userId) {
        try {
          const { data, error } = await supabaseClient
            .from('profiles')
            .select('plan, plan_until')
            .eq('id', userId)
            .single();

          if (error || !data) {
            this.isPro = false;
            console.log('📊 סטטוס פרימיום: Free');
            return;
          }

          this.isPro = data.plan === 'pro' && new Date(data.plan_until) > new Date();
          console.log('📊 סטטוס פרימיום:', this.isPro ? 'Pro ✨' : 'Free');
        } catch (e) {
          console.log('שגיאה בטעינת סטטוס פרימיום:', e);
          this.isPro = false;
        }
      },

      // פתיחת עמוד שדרוג
      openUpgradeModal(featureName) {
        // שומר את שם הפיצ'ר שגרם לפתיחה (אופציונלי לשימוש עתידי)
        this.upgradeFeature = featureName;
        document.getElementById('upgradeModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      },

      // סגירת עמוד שדרוג
      closeUpgradeModal() {
        document.getElementById('upgradeModal').classList.add('hidden');
        document.body.style.overflow = '';
      },

      // מעבר לתשלום (בינתיים placeholder)
      goToCheckout() {
        // כאן יהיה קישור ל-Stripe Checkout
        alert('🚧 מערכת התשלומים בבנייה!\n\nבקרוב תוכל לשדרג לפרימיום.');
      },

      startFreeTrial() {
        // כאן יהיה הפעלת ניסיון חינמי
        alert('🎁 ניסיון חינמי בבנייה!\n\nבקרוב תוכל לנסות פרימיום ל-7 ימים חינם.');
      },

      selectPlan(planType) {
        // עדכון בחירת תוכנית
        document.getElementById('monthly').checked = (planType === 'monthly');
        document.getElementById('yearly').checked = (planType === 'yearly');
      },

      // פתיחת מודאל מידע פרימיום
      openPremiumInfo() {
        document.getElementById('premiumInfoModal').classList.remove('hidden');
        this.updatePremiumInfoDisplay();
      },

      // סגירת מודאל מידע פרימיום
      closePremiumInfo() {
        document.getElementById('premiumInfoModal').classList.add('hidden');
      },

      // עדכון תצוגת מודאל פרימיום לפי סטטוס
      updatePremiumInfoDisplay() {
        const proSection = document.getElementById('proSectionContent');
        const starBtn = document.getElementById('premiumInfoBtn');
        
        if (this.isPro) {
          // משתמש פרימיום
          if (starBtn) {
            starBtn.innerHTML = '✅';
            starBtn.title = 'יש לך פרימיום!';
          }
          if (proSection) {
            proSection.innerHTML = `
              <div class="pro-active-message">
                <div class="pro-active-icon">🎉</div>
                <h4>יש לך פרימיום!</h4>
                <p>כל התכונות פתוחות עבורך</p>
              </div>
            `;
          }
        } else {
          // משתמש חינמי
          if (starBtn) {
            starBtn.innerHTML = '⭐';
            starBtn.title = 'מה כלול בפרימיום?';
          }
        }
      },

      // בדיקה אם אפשר ליצור מחברת חדשה
      canCreateNotebook(type) {
        if (this.isPro) return true;

        const notebookCount = Object.keys(this.subjects).length;
        
        // בדיקת מגבלת מחברות כללית
        if (notebookCount >= FREE_LIMITS.maxNotebooks) {
          this.openUpgradeModal('יצירת יותר מ-3 מחברות');
          return false;
        }

        // ספירת מחברות מאותו סוג
        const countByType = Object.values(this.subjects).filter(n => n.pageType === type).length;
        
        if (countByType >= FREE_LIMITS.maxPerType[type]) {
          const typeNames = {
            lined: 'מחברות שורה',
            grid: 'מחברות משובצות',
            blank: 'מחברות חלקות'
          };
          this.openUpgradeModal(`יצירת ${typeNames[type] || 'מחברות'} נוספות`);
          return false;
        }

        return true;
      },

      // בדיקה אם אפשר להוסיף דף למחברת
      canAddPage(notebookKey) {
        if (this.isPro) return true;

        const notebook = this.subjects[notebookKey];
        if (!notebook) return false;

        const pageType = notebook.pageType || 'lined';
        const maxPages = FREE_LIMITS.maxPages[pageType] || 20;
        const currentPages = notebook.pages ? notebook.pages.length : 0;

        if (currentPages >= maxPages) {
          if (pageType === 'blank') {
            this.openUpgradeModal('הוספת דפים נוספים למחברת חלקה');
          } else {
            this.openUpgradeModal(`הוספת יותר מ-${maxPages} דפים למחברת`);
          }
          return false;
        }

        return true;
      },

      // בדיקה אם אפשר להוסיף משימה חדשה
      canAddTask() {
        if (this.isPro) return true;

        const activeTasks = this.tasks.filter(t => !t.completed);
        
        if (activeTasks.length >= FREE_LIMITS.maxActiveTasks) {
          this.openUpgradeModal('ניהול יותר מ-20 משימות פעילות');
          return false;
        }

        return true;
      },

      // עדכון ממשק משתמש
      updateUserInterface() {
        // לא עושים כלום - השתמש ב-updateUserNameDisplay במקום
        // הפונקציה הזאת נשארת למטרות תאימות אחורה
      },

      // ברכה לפי שעה
      getGreeting() {
        const hour = new Date().getHours();
        if (hour < 12) return 'בוקר טוב';
        if (hour < 18) return 'צהריים טובים';
        return 'ערב טוב';
      },

      // טעינת נתוני דף הבית
      loadWelcomeData() {
        const notebooksCount = Object.keys(this.subjects).length;
        const activeNotebooksElement = document.getElementById('activeNotebooks');
        if (activeNotebooksElement) {
          activeNotebooksElement.textContent = notebooksCount;
        }

        // עדכון משימות היום
        const today = new Date().toISOString().split('T')[0];
        const todayTasks = this.tasks.filter(task => 
          !task.completed && task.dueDate === today
        ).length;
        
        const todayTasksElement = document.getElementById('todayTasks');
        if (todayTasksElement) {
          todayTasksElement.textContent = todayTasks;
        }

        // עדכון השיעור הבא מהלוח
        const now = new Date();
        const nextClass = this.events
          .filter(event => {
            if (event.type !== 'lesson') return false;
            const eventDateTime = new Date(event.date + 'T' + event.startTime);
            return eventDateTime > now;
          })
          .sort((a, b) => new Date(a.date + 'T' + a.startTime) - new Date(b.date + 'T' + b.startTime))[0];
          
        const nextClassElement = document.getElementById('nextClassTime');
        if (nextClassElement) {
          if (nextClass) {
            nextClassElement.textContent = nextClass.date === today ? nextClass.startTime : 'מחר';
          } else {
            nextClassElement.textContent = '--:--';
          }
        }

        // עדכון סטטוס משימות בדף הבית
        const taskStatusElement = document.getElementById('taskStatusHome');
        const pendingCount = this.tasks.filter(task => !task.completed).length;
        if (taskStatusElement) {
          taskStatusElement.textContent = `${pendingCount} משימות פתוחות`;
        }

        // עדכון ריבוע משימות פתוחות
        const openTasksElement = document.getElementById('openTasksCount');
        if (openTasksElement) {
          openTasksElement.textContent = pendingCount;
        }

        // עדכון סטטוס לוח השנה בדף הבית
        const calendarStatusElement = document.getElementById('calendarStatusHome');
        if (calendarStatusElement) {
          const todayEvents = this.events.filter(event => event.date === today).length;
          calendarStatusElement.textContent = `${todayEvents} אירועים היום`;
        }

        // עדכון סטטוס מערכת שעות בדף הבית
        const scheduleStatusElement = document.getElementById('scheduleStatusHome');
        if (scheduleStatusElement && typeof scheduleApp !== 'undefined') {
          const lessonsCount = Object.keys(scheduleApp.schedule).length;
          scheduleStatusElement.textContent = `${lessonsCount} שיעורים`;
        }

        // עדכון התראות
        this.updateNotifications();
      },

      // עדכון התראות
      updateNotifications() {
        const notifications = this.getUpcomingNotifications();
        const countElement = document.getElementById('notificationsCount');
        if (countElement) {
          countElement.textContent = `🔔 ${notifications.length}`;
        }
        this.renderNotificationsList(notifications);
      },

      // קבלת התראות קרובות
      getUpcomingNotifications() {
        const notifications = [];
        const now = new Date();
        const in24Hours = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        const in12Hours = new Date(now.getTime() + 12 * 60 * 60 * 1000);

        // התראות על משימות
        this.tasks.filter(task => !task.completed).forEach(task => {
          const taskDateTime = new Date(task.dueDate + 'T' + (task.dueTime || '23:59'));
          const timeDiff = taskDateTime - now;
          const hoursDiff = timeDiff / (1000 * 60 * 60);

          if (hoursDiff <= 0 && hoursDiff > -1) {
            notifications.push({
              type: 'urgent',
              icon: '🚨',
              title: task.title,
              time: 'עכשיו!',
              category: 'משימה'
            });
          } else if (hoursDiff > 0 && hoursDiff <= 12) {
            notifications.push({
              type: 'warning',
              icon: '⏰',
              title: task.title,
              time: `בעוד ${Math.round(hoursDiff)} שעות`,
              category: 'משימה'
            });
          } else if (hoursDiff > 12 && hoursDiff <= 24) {
            notifications.push({
              type: 'normal',
              icon: '📋',
              title: task.title,
              time: `מחר ב-${task.dueTime || '23:59'}`,
              category: 'משימה'
            });
          }
        });

        // התראות על אירועים
        this.events.forEach(event => {
          const eventDateTime = new Date(event.date + 'T' + event.startTime);
          const timeDiff = eventDateTime - now;
          const hoursDiff = timeDiff / (1000 * 60 * 60);

          if (hoursDiff <= 0 && hoursDiff > -1) {
            notifications.push({
              type: 'urgent',
              icon: '🔴',
              title: event.title,
              time: 'עכשיו!',
              category: 'אירוע'
            });
          } else if (hoursDiff > 0 && hoursDiff <= 12) {
            notifications.push({
              type: 'warning',
              icon: '📅',
              title: event.title,
              time: `בעוד ${Math.round(hoursDiff)} שעות`,
              category: 'אירוע'
            });
          } else if (hoursDiff > 12 && hoursDiff <= 24) {
            notifications.push({
              type: 'normal',
              icon: '📆',
              title: event.title,
              time: `מחר ב-${event.startTime}`,
              category: 'אירוע'
            });
          }
        });

        // מיון לפי דחיפות
        notifications.sort((a, b) => {
          const priority = { urgent: 0, warning: 1, normal: 2 };
          return priority[a.type] - priority[b.type];
        });

        return notifications;
      },

      // הצגת רשימת ההתראות
      renderNotificationsList(notifications) {
        const listElement = document.getElementById('notificationsList');
        if (!listElement) return;

        if (notifications.length === 0) {
          listElement.innerHTML = '<div class="notification-empty">🎉 אין התראות קרובות</div>';
          return;
        }

        listElement.innerHTML = notifications.map(notif => `
          <div class="notification-item ${notif.type}">
            <div class="notification-icon">${notif.icon}</div>
            <div class="notification-content">
              <div class="notification-title">${notif.title}</div>
              <div class="notification-time">${notif.category} • ${notif.time}</div>
            </div>
          </div>
        `).join('');
      },

      // פתיחת/סגירת חלונית התראות
      toggleNotificationsPanel(event) {
        if (event) {
          event.stopPropagation();
        }
        const panel = document.getElementById('notificationsPanel');
        if (panel) {
          panel.classList.toggle('show');
          if (panel.classList.contains('show')) {
            this.updateNotifications();
          }
        }
      },

      closeNotificationsPanel() {
        const panel = document.getElementById('notificationsPanel');
        if (panel) {
          panel.classList.remove('show');
        }
      },

      // אתחול התראות Push בדפדפן
      async initPushNotifications() {
        if (!('Notification' in window)) {
          console.log('הדפדפן לא תומך בהתראות');
          return;
        }

        // הצג את הבאנר אם עדיין לא אושר
        this.updateNotificationPermissionBanner();

        if (Notification.permission === 'default') {
          // ננסה לבקש הרשאה אוטומטית
          try {
            const permission = await Notification.requestPermission();
            console.log('הרשאת התראות:', permission);
            this.updateNotificationPermissionBanner();
          } catch (e) {
            console.log('שגיאה בבקשת הרשאה:', e);
          }
        }
      },

      // עדכון באנר ההרשאה
      updateNotificationPermissionBanner() {
        const banner = document.getElementById('notificationPermissionBanner');
        if (banner) {
          if (Notification.permission === 'granted') {
            banner.style.display = 'none';
          } else {
            banner.style.display = 'block';
          }
        }
      },

      // בקשת הרשאה ידנית
      async requestNotificationPermission() {
        try {
          const permission = await Notification.requestPermission();
          console.log('הרשאת התראות:', permission);
          this.updateNotificationPermissionBanner();
          
          if (permission === 'granted') {
            this.sendPushNotification('🎉 התראות אושרו!', 'תקבל תזכורות על משימות ואירועים');
          }
        } catch (e) {
          console.log('שגיאה בבקשת הרשאה:', e);
          alert('לא הצלחנו לבקש הרשאה. נסה דרך הגדרות הדפדפן.');
        }
      },

      // שליחת התראת Push
      sendPushNotification(title, body, icon = '🔔') {
        if (Notification.permission !== 'granted') return;

        const notification = new Notification(title, {
          body: body,
          icon: 'https://brickyeda.github.io/digitalbag/logo.png',
          badge: 'https://brickyeda.github.io/digitalbag/logo.png',
          tag: title, // מונע כפילויות
          requireInteraction: true
        });

        notification.onclick = () => {
          window.focus();
          notification.close();
        };
      },

      // מעקב אחרי התראות שכבר נשלחו
      sentNotifications: new Set(),

      // בדיקה ושליחת התראות
      checkAndSendNotifications() {
        const now = new Date();
        
        // בדיקת משימות
        this.tasks.filter(task => !task.completed).forEach(task => {
          const taskDateTime = new Date(task.dueDate + 'T' + (task.dueTime || '23:59'));
          const timeDiff = taskDateTime - now;
          const minutesDiff = timeDiff / (1000 * 60);

          // התראה בזמן המשימה (0-1 דקות)
          const nowKey = `task-now-${task.id}`;
          if (minutesDiff >= -1 && minutesDiff <= 1 && !this.sentNotifications.has(nowKey)) {
            this.sendPushNotification(
              '⏰ משימה עכשיו!',
              `${task.title} - הגיע הזמן!`
            );
            this.sentNotifications.add(nowKey);
          }

          // התראה 12 שעות לפני (720 דקות)
          const h12Key = `task-12h-${task.id}`;
          if (minutesDiff >= 719 && minutesDiff <= 721 && !this.sentNotifications.has(h12Key)) {
            this.sendPushNotification(
              '📋 תזכורת משימה',
              `${task.title} - בעוד 12 שעות`
            );
            this.sentNotifications.add(h12Key);
          }

          // התראה 24 שעות לפני (1440 דקות)
          const h24Key = `task-24h-${task.id}`;
          if (minutesDiff >= 1439 && minutesDiff <= 1441 && !this.sentNotifications.has(h24Key)) {
            this.sendPushNotification(
              '📋 תזכורת משימה',
              `${task.title} - מחר`
            );
            this.sentNotifications.add(h24Key);
          }
        });

        // בדיקת אירועים
        this.events.forEach(event => {
          const eventDateTime = new Date(event.date + 'T' + event.startTime);
          const timeDiff = eventDateTime - now;
          const minutesDiff = timeDiff / (1000 * 60);

          // התראה בזמן האירוע
          const nowKey = `event-now-${event.id}`;
          if (minutesDiff >= -1 && minutesDiff <= 1 && !this.sentNotifications.has(nowKey)) {
            this.sendPushNotification(
              '🔴 אירוע עכשיו!',
              `${event.title} - ${event.location || ''}`
            );
            this.sentNotifications.add(nowKey);
          }

          // התראה 12 שעות לפני
          const h12Key = `event-12h-${event.id}`;
          if (minutesDiff >= 719 && minutesDiff <= 721 && !this.sentNotifications.has(h12Key)) {
            this.sendPushNotification(
              '📅 תזכורת אירוע',
              `${event.title} - בעוד 12 שעות`
            );
            this.sentNotifications.add(h12Key);
          }

          // התראה 24 שעות לפני
          const h24Key = `event-24h-${event.id}`;
          if (minutesDiff >= 1439 && minutesDiff <= 1441 && !this.sentNotifications.has(h24Key)) {
            this.sendPushNotification(
              '📅 תזכורת אירוע',
              `${event.title} - מחר`
            );
            this.sentNotifications.add(h24Key);
          }
        });

        // עדכון התראות בממשק
        this.updateNotifications();
      },

      // מעבר בין דפים
      showPage(pageId) {
        console.log('עובר לדף:', pageId);
       
        // Close gallery if leaving notebookView
        if (pageId !== 'notebookView') {
          const galleryView = document.getElementById('galleryView');
          const galleryControls = document.getElementById('galleryControls');
          if (galleryView) {
            galleryView.classList.remove('active');
          }
          if (galleryControls) {
            galleryControls.classList.remove('active');
          }
          const notebookContent = document.getElementById('notebookContent');
          if (notebookContent) {
            notebookContent.style.display = 'block';
          }
          const zoomControls = document.getElementById('zoomControls');
          if (zoomControls) {
            zoomControls.classList.remove('active');
          }
          // Reset zoom when leaving notebook
          this.currentZoom = 100;
          this.applyZoom();
        }
       
// שמור ציורים לפני מעבר לדף אחר
if (this.currentNotebook && pageId !== 'notebookView') {
  this.saveCurrentNotebookDrawings();
}
 
        // הסתר את כל הדפים
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        
        // הצג את הדף הנדרש
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
          targetPage.classList.add('active');
        }
        
        // עדכן ניווט
        this.updateNavigation(pageId);
        
        // פעולות מיוחדות לדפים מסוימים
        if (pageId === 'notebooks') {
          this.renderNotebooks();
        } else if (pageId === 'tasks') {
          this.renderTasks();
          this.updateTaskStats();
        } else if (pageId === 'calendar') {
          this.loadCalendarData();
          this.renderCalendar();
          this.updateCalendarStats();
        } else if (pageId === 'homepage') {
          this.loadWelcomeData();
        } else if (pageId === 'schedule') {
          scheduleApp.loadSchedule().then(() => {
            scheduleApp.renderTable();
            scheduleApp.updateStats();
          });
        } else if (pageId === 'mylinks') {
          linksApp.loadLinks().then(() => {
            linksApp.renderLinks();
            linksApp.updateStats();
          });
        } else if (pageId === 'notebookView') {
          this.renderNotebookContent();
} else if (pageId === 'notebooks') {
  // שמור ציורים לפני יציאה מהמחברת
  if (this.currentNotebook) {
    this.saveCurrentNotebookDrawings();
  }
  this.renderNotebooks();
        }
        
        // בדיקה והפעלת טוטוריאל
        if (typeof TutorialSystem !== 'undefined') {
          TutorialSystem.checkAndStartTutorial(pageId);
        }
      },

      // עדכון ניווט פעיל
      updateNavigation(activePageId) {
        document.querySelectorAll('.navbar-item').forEach(item => {
          item.classList.remove('active');
          if (item.dataset.page === activePageId) {
            item.classList.add('active');
          }
        });
      },

      // רינדור מחברות
      renderNotebooks() {
        const container = document.getElementById('subjectsGrid');
        if (!container) return;
        
        container.innerHTML = '';
        
        Object.keys(this.subjects).forEach(subjectKey => {
          const subject = this.subjects[subjectKey];
          const card = this.createNotebookCard(subjectKey, subject);
          container.appendChild(card);
        });
      },

      // יצירת כרטיס מחברת
createNotebookCard(subjectKey, subject) {
  const cardDiv = document.createElement('div');
  cardDiv.className = `subject-card ${subjectKey}`;
  cardDiv.onclick = () => this.openNotebook(subjectKey);
  
  // Set the color variable for CSS
  cardDiv.style.setProperty('--subject-color', subject.color);
  
  // בדיקה אם pages קיים, אם לא - יצירת מערך ריק
  const pagesCount = subject.pages ? subject.pages.length : 0;
  
  // כפתור שכפול (רק לפרימיום)
  const duplicateBtn = this.isPro ? 
    `<button class="notebook-duplicate-btn" onclick="event.stopPropagation(); app.duplicateNotebook('${subjectKey}')" title="שכפול מחברת">📋</button>` : 
    `<button class="notebook-duplicate-btn premium-locked" onclick="event.stopPropagation(); app.openUpgradeModal('שכפול מחברות')" title="שכפול מחברת - פרימיום">📋⭐</button>`;
  
  cardDiv.innerHTML = `
    <span class="subject-icon">${subject.icon}</span>
    <div class="subject-title">${subject.title}</div>
    <div class="subject-info">${subject.description}</div>
    <div class="subject-stats">
      <span class="pages-count">${pagesCount} דפים</span>
      <span class="last-updated">עודכן היום</span>
    </div>
    <div class="notebook-actions">
      ${duplicateBtn}
      <button class="notebook-delete-btn" onclick="event.stopPropagation(); app.deleteNotebookWithConfirmation('${subjectKey}')">🗑️</button>
    </div>
  `;
  
  return cardDiv;
},

      // פתיחת מחברת
openNotebook(notebookKey) {
  this.currentNotebook = notebookKey;
  const notebook = this.subjects[notebookKey];
  
  // עדכון כותרת
  document.getElementById('currentNotebookIcon').textContent = notebook.icon;
  document.getElementById('currentNotebookName').textContent = notebook.title;
  
  // רינדור תוכן המחברת
  this.renderNotebookContent();
  
  // המרה אוטומטית של דפים עם תוכן HTML
  setTimeout(() => {
    this.autoConvertRichTextPages();
  }, 300);
  
  // מעבר לדף המחברת
// הצגה/הסתרה של סרגל המתמטיקה לפי סוג המחברת
  const mathToolbar = document.getElementById('mathFormulasToolbar');
  if (mathToolbar) {
    if (notebook.pageType === 'grid') {
      mathToolbar.style.display = 'flex';
    } else {
      mathToolbar.style.display = 'none';
    }
  }
  this.showPage('notebookView');
  
  // Show gallery controls
  const galleryControls = document.getElementById('galleryControls');
  if (galleryControls) {
    galleryControls.classList.add('active');
  }
  
  // Show zoom controls
  const zoomControls = document.getElementById('zoomControls');
  if (zoomControls) {
    zoomControls.classList.add('active');
  }
},

// Toggle Gallery View
toggleGalleryView() {
  const galleryView = document.getElementById('galleryView');
  const notebookContent = document.getElementById('notebookContent');
  
  if (galleryView.classList.contains('active')) {
    this.closeGalleryView();
  } else {
    this.openGalleryView();
  }
},

// Open Gallery View
openGalleryView() {
  const galleryView = document.getElementById('galleryView');
  const notebookContent = document.getElementById('notebookContent');
  const galleryGrid = document.getElementById('galleryGrid');
  const galleryNotebookName = document.getElementById('galleryNotebookName');
  
  if (!this.currentNotebook) return;
  
  const notebook = this.subjects[this.currentNotebook];
  if (!notebook) return;
  
  // Update gallery title
  galleryNotebookName.textContent = `תצוגת גלריה - ${notebook.title}`;
  
  // Hide content, show gallery
document.getElementById('notebookView').style.display = 'none';
  galleryView.classList.add('active');
  
  // Generate gallery items
  this.generateGalleryItems(notebook);
},

// Close Gallery View
closeGalleryView() {
  const galleryView = document.getElementById('galleryView');
  const notebookContent = document.getElementById('notebookContent');
  
  galleryView.classList.remove('active');
document.getElementById('notebookView').style.display = 'block';
},

// Generate Gallery Items
generateGalleryItems(notebook) {
  const galleryGrid = document.getElementById('galleryGrid');
  
  if (!notebook.pages || notebook.pages.length === 0) {
    galleryGrid.innerHTML = `
      <div class="gallery-empty">
        <div class="gallery-empty-icon">📄</div>
        <div class="gallery-empty-text">אין דפים במחברת זו</div>
      </div>
    `;
    return;
  }
  
  galleryGrid.innerHTML = notebook.pages.map((page, index) => {
    const isCurrent = index === this.currentPage;
    const textPreview = this.getPageTextPreview(page);
    const pageTitle = page.title && page.title.trim() ? page.title.trim() : `דף ${index + 1}`;
    
    return `
      <div class="gallery-item ${isCurrent ? 'current-page' : ''}" 
           onclick="app.goToPageFromGallery(${index})"
           title="לחץ למעבר לדף זה">
        <div class="gallery-thumbnail">
          <div class="gallery-thumbnail-content" id="galleryThumb${index}">
            ${this.renderPagePreview(page, notebook.pageType)}
          </div>
        </div>
        <div class="gallery-info">
          <div class="gallery-page-number">${pageTitle}</div>
          <div class="gallery-page-preview">${textPreview || 'דף ריק'}</div>
        </div>
      </div>
    `;
  }).join('');
},

// Get text preview from page
getPageTextPreview(page) {
  if (!page.content) return '';
  
  // Extract text from page content
  let text = page.content.replace(/<[^>]*>/g, ' ').trim();
  
  // Limit length
  if (text.length > 50) {
    text = text.substring(0, 50) + '...';
  }
  
  return text;
},

// Render page preview for gallery
renderPagePreview(page, pageType) {
  let html = `
    <div style="width: 100%; height: 100%; background: white; position: relative;
                border: 1px solid #e0e0e0; padding: 20px; overflow: hidden;">
  `;
  
  // Render page background based on type
  if (pageType === 'lined') {
    for (let i = 0; i < 12; i++) {
      html += `<div style="border-bottom: 1px solid #d3d3d3; height: 28px;"></div>`;
    }
  } else if (pageType === 'grid') {
    html += `<div style="background-image: 
              linear-gradient(#d3d3d3 1px, transparent 1px),
              linear-gradient(90deg, #d3d3d3 1px, transparent 1px);
              background-size: 20px 20px; height: 100%; width: 100%;"></div>`;
  } else if (pageType === 'dotted') {
    html += `<div style="background-image: 
              radial-gradient(circle, #d3d3d3 1px, transparent 1px);
              background-size: 20px 20px; height: 100%; width: 100%;"></div>`;
  } else if (pageType === 'checklist') {
    for (let i = 0; i < 8; i++) {
      html += `<div style="display: flex; align-items: center; height: 28px; border-bottom: 1px solid #e0e0e0;">
                <div style="width: 14px; height: 14px; border: 2px solid #ccc; border-radius: 3px; margin-left: 8px;"></div>
                <div style="flex: 1; height: 1px; background: #e8e8e8; margin: 0 8px;"></div>
              </div>`;
    }
  }
  
  // Render content preview (simplified)
  if (page.content) {
    const textContent = page.content.replace(/<[^>]*>/g, '').trim();
    if (textContent.length > 0) {
      html += `<div style="position: absolute; top: 20px; right: 20px; left: 20px;">`;
      
      const lines = textContent.split('\n').slice(0, 10);
      lines.forEach(line => {
        if (line.trim()) {
          html += `<div style="font-size: 11px; margin-bottom: 4px; color: #333;">
                    ${this.escapeHtml(line.substring(0, 60))}
                  </div>`;
        }
      });
      
      if (textContent.split('\n').length > 10) {
        html += `<div style="font-size: 9px; color: #999; margin-top: 8px;">
                  ...ועוד תוכן נוסף
                </div>`;
      }
      
      html += `</div>`;
    }
  }
  
  html += `</div>`;
  return html;
},

// Go to page from gallery
goToPageFromGallery(pageIndex) {
  this.currentPage = pageIndex;
  this.closeGalleryView();
  
  // Scroll to the selected page
  setTimeout(() => {
    const container = document.getElementById('notebookContent');
    if (container && container.children[pageIndex]) {
      container.children[pageIndex].scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }, 100);
},

// Escape HTML for security
escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
},

// Zoom functionality
currentZoom: 100,

zoomIn() {
  if (this.currentZoom < 200) {
    this.currentZoom += 10;
    this.applyZoom();
  }
},

zoomOut() {
  if (this.currentZoom > 50) {
    this.currentZoom -= 10;
    this.applyZoom();
  }
},

resetZoom() {
  this.currentZoom = 100;
  this.applyZoom();
},

applyZoom() {
  const notebookContent = document.getElementById('notebookContent');
  if (notebookContent) {
    const scale = this.currentZoom / 100;
    notebookContent.style.transform = `scale(${scale})`;
  }
  
  const zoomLevel = document.getElementById('zoomLevel');
  if (zoomLevel) {
    zoomLevel.textContent = `${this.currentZoom}%`;
  }
},

      // רינדור תוכן מחברת
      renderNotebookContent() {
        if (!this.currentNotebook) return;
        
        const notebook = this.subjects[this.currentNotebook];
        const container = document.getElementById('notebookContent');
        
        if (!container || !notebook) return;
        
        container.innerHTML = '';
        
        notebook.pages.forEach((page, index) => {
          const pageElement = this.createNotebookPage(page, index, notebook.pageType);
          container.appendChild(pageElement);
style="position: sticky !important;"
          
          // טעינת עיצוב שמור
          if (page.formatting) {
            setTimeout(() => {
              this.loadPageFormatting(index, page.formatting);
            }, 100);
          }
        });

        // הוספת בוחרי צבעים לכלי העיצוב הגלובליים
        this.initializeGlobalColorPickers();
        
        // סגירת כל בוחרי הצבעים בלחיצה מחוץ להם
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.toolbar-color-btn') && !e.target.closest('.color-picker')) {
            document.querySelectorAll('.color-picker').forEach(picker => {
              picker.classList.remove('show');
            });
          }
        });
      },

      // יצירת דף מחברת
      createNotebookPage(pageData, index, pageType) {
        const pageDiv = document.createElement('div');
        pageDiv.className = 'notebook-page';
        
        const pageTypeClass = `${pageType}-page`;
        const textareaClass = `enhanced-textarea`;
        const placeholder = this.getPlaceholderForPageType(pageType);
        
        // בדיקה אם זה דף צ'קליסט
        if (pageType === 'checklist') {
          pageDiv.innerHTML = this.createChecklistPageHTML(pageData, index);
          return pageDiv;
        }
        
        pageDiv.innerHTML = `
<div class="notebook-header">
            <div style="display: flex; gap: 20px; align-items: center; flex: 1;">
              <div style="display: flex; gap: 8px; align-items: center;">
                <label style="font-weight: 600; color: var(--text-primary);">נושא:</label>
                <input 
                  type="text" 
                  class="header-input" 
                  placeholder="כתוב נושא..."
                  value="${pageData.title || ''}"
                  onblur="app.updatePageTitle(${index}, this.value)"
                  style="border: 1px solid var(--border-color); padding: 6px 10px; border-radius: 6px; font-size: 0.95rem; min-width: 200px;"
                />
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <label style="font-weight: 600; color: var(--text-primary);">תאריך:</label>
                <span style="font-size: 0.9rem; color: var(--text-secondary); padding: 6px 10px; background: var(--background-main); border-radius: 6px;">${pageData.date}</span>
              </div>
            </div>
            <button class="tool-btn delete-page-btn" onclick="app.deletePage(${index})" title="מחק דף זה">
              🗑️ מחק דף
            </button>
          </div>
      
          <div class="${pageTypeClass}" style="position: relative;">
            <div class="formatting-indicator" id="format-indicator-${index}">RTL</div>
<textarea 
  class="${textareaClass}" 
  id="textarea-${index}"
  placeholder="${placeholder}" 
  onchange="app.savePage(${index}, this.value)"
  oninput="app.handleTextInput(${index})"
  onfocus="app.setActiveTextarea(${index})"
  onselect="app.updateFormatting(${index})"
  ondrop="app.dropFormula(event, ${index})"
  ondragover="app.allowDrop(event)"
  onkeydown="app.handleTextareaKeydown(event, ${index})"
  style="font-family: Arial; font-size: 28px; text-align: right;"
>${pageData.content || ''}</textarea>
          </div>
        `;
   
  if (pageData.formulas && pageData.formulas.length > 0) {
    setTimeout(() => {
      const pageContainer = pageDiv.querySelector('.lined-page, .grid-page, .blank-page');
      // ניקוי נוסחאות קיימות לפני טעינה
      pageContainer.querySelectorAll('.dropped-formula').forEach(f => f.remove());
      this.isLoadingFormulas = true;
      pageData.formulas.forEach(f => {
        this.createDroppedFormula(pageContainer, f.text, parseFloat(f.x), parseFloat(f.y), index, f.width || null, f.height || null, f.fontSize || 16);
      });
      this.isLoadingFormulas = false;
    }, 100);
  }
     
// טעינת ציור שמור
if (pageData.drawing) {
  setTimeout(() => {
    const pageContainer = pageDiv.querySelector('.lined-page, .grid-page, .blank-page');
    if (pageContainer) {
      let canvas = pageContainer.querySelector('.page-canvas');
      if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.className = 'page-canvas';
        pageContainer.appendChild(canvas);
        canvas.width = pageContainer.offsetWidth;
        canvas.height = pageContainer.offsetHeight;
      }
      
      const ctx = canvas.getContext('2d');
      const img = new Image();
      img.onload = () => {
        ctx.drawImage(img, 0, 0);
        
        // חיבור מחדש לאירועי ציור אם מצב הציור פעיל
        if (app.drawing.isDrawingModeActive) {
          canvas.classList.add('drawing-active');
          canvas.style.pointerEvents = 'auto';
          app.drawing.attachCanvasEvents(canvas);
        }
      };
      img.src = pageData.drawing;
    }
  }, 200);
}

// טעינת צורות אינטראקטיביות שמורות
if (pageData.interactiveShapes && pageData.interactiveShapes.length > 0) {
  setTimeout(() => {
    const pageContainer = pageDiv.querySelector('.lined-page, .grid-page, .blank-page');
    if (pageContainer) {
      pageData.interactiveShapes.forEach(shapeData => {
        app.interactiveShapes.loadShape(pageContainer, shapeData, index);
      });
    }
  }, 250);
}

// טעינת נוסחאות שמורות
if (pageData.formulas && pageData.formulas.length > 0) {
  setTimeout(() => {
    const pageContainer = pageDiv.querySelector('.lined-page, .grid-page, .blank-page');
    if (pageContainer) {
      // ניקוי נוסחאות קיימות לפני טעינה
      pageContainer.querySelectorAll('.dropped-formula').forEach(f => f.remove());
      app.isLoadingFormulas = true;
      pageData.formulas.forEach(f => {
        app.createDroppedFormula(pageContainer, f.text, parseFloat(f.x), parseFloat(f.y), index, f.width || null, f.height || null, f.fontSize || 16);
      });
      app.isLoadingFormulas = false;
    }
  }, 100);
}

        return pageDiv;
      },

      // קבלת placeholder לפי סוג דף
      getPlaceholderForPageType(pageType) {
        const placeholders = {
          'lined': 'כתוב כאן בגודל פונט 28 והטקסט יתיישר אוטומטית לשורות.',
          'grid': 'דף משובץ למתמטיקה וגרפים. הכתיבה רציפה ללא התחשבות במשבצות.',
          'blank': 'דף חלק לציורים, רעיונות וכתיבה חופשית.',
          'checklist': 'רשימת מטלות - לחץ על + להוספת פריט חדש'
        };
        return placeholders[pageType] || 'כתוב כאן...';
      },

      // הוספת דף חדש למחברת
      addNotebookPage() {
        if (!this.currentNotebook || !this.subjects[this.currentNotebook]) return;
        
        // בדיקת מגבלות גרסה חינמית
        if (!this.canAddPage(this.currentNotebook)) {
          return;
        }
        
        const pageTitle = prompt('שם הדף החדש:');
        if (!pageTitle || pageTitle.trim() === '') return;
        
        const newPage = {
          title: pageTitle.trim(),
          content: '',
          date: new Date().toLocaleDateString('he-IL')
        };
        
        this.subjects[this.currentNotebook].pages.push(newPage);
        this.saveNotebookData();
        this.renderNotebookContent();
        
        // גלילה לדף החדש
        setTimeout(() => {
          const notebookContent = document.getElementById('notebookContent');
          if (notebookContent) {
            notebookContent.scrollTop = notebookContent.scrollHeight;
          }
        }, 100);
      },

      // === פונקציות צ'קליסט ===
      
      // יצירת HTML לדף צ'קליסט
      createChecklistPageHTML(pageData, index) {
        const items = pageData.checklistItems || [];
        const maxItems = this.isPro ? Infinity : FREE_LIMITS.maxChecklistItems;
        const canAddMore = this.isPro || items.length < maxItems;
        
        let itemsHTML = items.map((item, itemIndex) => `
          <div class="checklist-item ${item.checked ? 'completed' : ''}" data-index="${itemIndex}">
            <div class="checklist-checkbox ${item.checked ? 'checked' : ''}" 
                 onclick="app.toggleChecklistItem(${index}, ${itemIndex})">
              ${item.checked ? '✓' : ''}
            </div>
            <input type="text" 
                   class="checklist-text" 
                   value="${this.escapeHtml(item.text || '')}"
                   placeholder="הקלד פריט..."
                   onchange="app.updateChecklistItem(${index}, ${itemIndex}, this.value)"
                   onkeydown="app.handleChecklistKeydown(event, ${index}, ${itemIndex})">
            <button class="checklist-delete" onclick="app.deleteChecklistItem(${index}, ${itemIndex})">🗑️</button>
          </div>
        `).join('');
        
        // הצגת אזהרה למשתמש חינמי
        let limitWarning = '';
        if (!this.isPro && items.length >= maxItems) {
          limitWarning = `
            <div class="checklist-limit-warning">
              <div>⭐ הגעת למגבלת ${maxItems} פריטים בגרסה החינמית</div>
              <button onclick="app.openUpgradeModal('פריטי צ\'קליסט ללא הגבלה')">שדרג לפרימיום</button>
            </div>
          `;
        }
        
        return `
          <div class="notebook-header">
            <div style="display: flex; gap: 20px; align-items: center; flex: 1;">
              <div style="display: flex; gap: 8px; align-items: center;">
                <label style="font-weight: 600; color: var(--text-primary);">שם הרשימה:</label>
                <input 
                  type="text" 
                  class="header-input" 
                  placeholder="רשימת קניות / ציוד לטיול..."
                  value="${pageData.title || ''}"
                  onblur="app.updatePageTitle(${index}, this.value)"
                  style="border: 1px solid var(--border-color); padding: 6px 10px; border-radius: 6px; font-size: 0.95rem; min-width: 250px;"
                />
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <label style="font-weight: 600; color: var(--text-primary);">תאריך:</label>
                <span style="font-size: 0.9rem; color: var(--text-secondary); padding: 6px 10px; background: var(--background-main); border-radius: 6px;">${pageData.date}</span>
              </div>
            </div>
            <button class="tool-btn delete-page-btn" onclick="app.deletePage(${index})" title="מחק רשימה זו">
              🗑️ מחק רשימה
            </button>
          </div>
          
          <div class="checklist-page">
            <div class="checklist-container" id="checklist-${index}">
              ${itemsHTML}
              ${limitWarning}
              <button class="checklist-add-btn" 
                      onclick="app.addChecklistItem(${index})"
                      ${!canAddMore ? 'disabled' : ''}>
                ➕ הוסף פריט
              </button>
            </div>
          </div>
        `;
      },
      
      // הוספת פריט לצ'קליסט
      addChecklistItem(pageIndex) {
        if (!this.currentNotebook || !this.subjects[this.currentNotebook]) return;
        
        const page = this.subjects[this.currentNotebook].pages[pageIndex];
        if (!page.checklistItems) page.checklistItems = [];
        
        // בדיקת מגבלה
        if (!this.isPro && page.checklistItems.length >= FREE_LIMITS.maxChecklistItems) {
          this.openUpgradeModal('פריטי צ\'קליסט ללא הגבלה');
          return;
        }
        
        page.checklistItems.push({ text: '', checked: false });
        this.saveNotebookData();
        this.renderNotebookContent();
        
        // פוקוס על השדה החדש
        setTimeout(() => {
          const inputs = document.querySelectorAll(`#checklist-${pageIndex} .checklist-text`);
          if (inputs.length > 0) {
            inputs[inputs.length - 1].focus();
          }
        }, 100);
      },
      
      // עדכון פריט בצ'קליסט
      updateChecklistItem(pageIndex, itemIndex, text) {
        if (!this.currentNotebook || !this.subjects[this.currentNotebook]) return;
        
        const page = this.subjects[this.currentNotebook].pages[pageIndex];
        if (page.checklistItems && page.checklistItems[itemIndex]) {
          page.checklistItems[itemIndex].text = text;
          this.saveNotebookData();
        }
      },
      
      // החלפת סטטוס צ'קבוקס
      toggleChecklistItem(pageIndex, itemIndex) {
        if (!this.currentNotebook || !this.subjects[this.currentNotebook]) return;
        
        const page = this.subjects[this.currentNotebook].pages[pageIndex];
        if (page.checklistItems && page.checklistItems[itemIndex]) {
          page.checklistItems[itemIndex].checked = !page.checklistItems[itemIndex].checked;
          this.saveNotebookData();
          this.renderNotebookContent();
        }
      },
      
      // מחיקת פריט מצ'קליסט
      deleteChecklistItem(pageIndex, itemIndex) {
        if (!this.currentNotebook || !this.subjects[this.currentNotebook]) return;
        
        const page = this.subjects[this.currentNotebook].pages[pageIndex];
        if (page.checklistItems) {
          page.checklistItems.splice(itemIndex, 1);
          this.saveNotebookData();
          this.renderNotebookContent();
        }
      },
      
      // טיפול במקש Enter בצ'קליסט
      handleChecklistKeydown(event, pageIndex, itemIndex) {
        if (event.key === 'Enter') {
          event.preventDefault();
          this.addChecklistItem(pageIndex);
        }
      },

      // מחיקת דף
      deletePage(pageIndex) {
        if (!this.currentNotebook || !this.subjects[this.currentNotebook]) return;
        
        const notebook = this.subjects[this.currentNotebook];
        const pageTitle = notebook.pages[pageIndex]?.title || `דף ${pageIndex + 1}`;
        
        if (confirm(`האם אתה בטוח שברצונך למחוק את הדף "${pageTitle}"?\n\nהתוכן ימחק לצמיתות ולא ניתן יהיה לשחזר אותו.`)) {
          notebook.pages.splice(pageIndex, 1);
          this.saveNotebookData();
          this.renderNotebookContent();
          
          alert(`הדף "${pageTitle}" נמחק בהצלחה.`);
          this.loadWelcomeData();
        }
      },

      // שמירת דף
savePage(pageIndex, content) {
  if (!this.currentNotebook || !this.subjects[this.currentNotebook]) return;
  
  if (this.subjects[this.currentNotebook].pages[pageIndex]) {
    this.subjects[this.currentNotebook].pages[pageIndex].content = content;
    
    // שמירת ציורים
    const pages = document.querySelectorAll('.lined-page, .grid-page, .blank-page');
    const pageContainer = pages[pageIndex];
    if (pageContainer) {
      const canvas = pageContainer.querySelector('.page-canvas');
      if (canvas) {
        this.subjects[this.currentNotebook].pages[pageIndex].drawing = canvas.toDataURL();
      }
      
      // שמירת צורות אינטראקטיביות
      const shapes = [];
      pageContainer.querySelectorAll('.interactive-shape').forEach(shape => {
        shapes.push({
          type: shape.dataset.shapeType,
          color: shape.dataset.color,
          fillColor: shape.dataset.fillColor || shape.dataset.color,
          thickness: shape.dataset.thickness,
          fill: shape.dataset.fill,
          rotation: shape.dataset.rotation,
          left: shape.style.left,
          top: shape.style.top,
          width: shape.style.width,
          height: shape.style.height
        });
      });
      this.subjects[this.currentNotebook].pages[pageIndex].interactiveShapes = shapes;
    }
    
    this.saveNotebookData();
  }
},

// שמירת כל הציורים והנוסחאות של המחברת הנוכחית
saveCurrentNotebookDrawings() {
  if (!this.currentNotebook) return;
  
  const pages = document.querySelectorAll('.lined-page, .grid-page, .blank-page');
  pages.forEach((pageContainer, index) => {
    if (!this.subjects[this.currentNotebook].pages[index]) return;
    
    // שמירת ציור
    const canvas = pageContainer.querySelector('.page-canvas');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      // בדוק אם יש משהו מצויר
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const hasDrawing = imageData.data.some(pixel => pixel !== 0);
      
      if (hasDrawing) {
        this.subjects[this.currentNotebook].pages[index].drawing = canvas.toDataURL();
      }
    }
    
    // שמירת צורות אינטראקטיביות
    const shapes = [];
    pageContainer.querySelectorAll('.interactive-shape').forEach(shape => {
      shapes.push({
        type: shape.dataset.shapeType,
        color: shape.dataset.color,
        fillColor: shape.dataset.fillColor || shape.dataset.color,
        thickness: shape.dataset.thickness,
        fill: shape.dataset.fill,
        rotation: shape.dataset.rotation,
        left: shape.style.left,
        top: shape.style.top,
        width: shape.style.width,
        height: shape.style.height
      });
    });
    if (shapes.length > 0) {
      this.subjects[this.currentNotebook].pages[index].interactiveShapes = shapes;
    }
    
    // שמירת נוסחאות
    const formulas = [];
    pageContainer.querySelectorAll('.dropped-formula').forEach(formula => {
      const content = formula.querySelector('.formula-content');
      formulas.push({
        text: content ? content.textContent : formula.textContent,
        x: formula.style.left,
        y: formula.style.top,
        width: formula.offsetWidth,
        height: formula.offsetHeight,
        fontSize: parseInt(formula.style.fontSize) || 16
      });
    });
    
    if (formulas.length > 0) {
      this.subjects[this.currentNotebook].pages[index].formulas = formulas;
    }
  });
  
  this.saveNotebookData();
},

// גרירת נוסחה
// מחק את הפונקציות הישנות dragFormula, endDragFormula, dropFormula

// והוסף פונקציות חדשות:

allowDrop(event) {
  event.preventDefault();
},

dragFormula(event) {
  const formula = event.target.getAttribute('data-formula');
  event.dataTransfer.setData('text/plain', formula);
  event.target.classList.add('dragging');
},

endDragFormula(event) {
  event.target.classList.remove('dragging');
},

dropFormula(event, pageIndex) {
  event.preventDefault();
  const formula = event.dataTransfer.getData('text/plain');
  
  // קבל את מיקום השחרור
  const pageContainer = event.currentTarget.closest('.lined-page, .grid-page, .blank-page');
  if (!pageContainer) return;
  
  const rect = pageContainer.getBoundingClientRect();
  const x = event.clientX - rect.left;
  const y = event.clientY - rect.top;
  
  // צור אלמנט נוסחא
  this.createDroppedFormula(pageContainer, formula, x, y, pageIndex);
},

createDroppedFormula(container, formula, x, y, pageIndex, width = null, height = null, fontSize = 16) {
  const formulaDiv = document.createElement('div');
  formulaDiv.className = 'dropped-formula';
  formulaDiv.style.left = x + 'px';
  formulaDiv.style.top = y + 'px';
  
  if (width) formulaDiv.style.width = width + 'px';
  if (height) formulaDiv.style.height = height + 'px';
  formulaDiv.style.fontSize = fontSize + 'px';
  
  // תוכן הנוסחה - ניתן לעריכה
  const content = document.createElement('span');
  content.className = 'formula-content';
  content.contentEditable = 'true';
  content.textContent = formula;
  content.spellcheck = false;
  
  // מניעת גרירה כשעורכים
  content.addEventListener('mousedown', (e) => {
    e.stopPropagation();
  });
  
  content.addEventListener('focus', () => {
    formulaDiv.classList.add('selected');
  });
  
  // שמירה אחרי עריכת טקסט
  content.addEventListener('blur', () => {
    setTimeout(() => app.saveCurrentNotebookDrawings(), 100);
  });
  
  content.addEventListener('input', () => {
    clearTimeout(content.saveTimeout);
    content.saveTimeout = setTimeout(() => app.saveCurrentNotebookDrawings(), 500);
  });
  
  formulaDiv.appendChild(content);
  
  // כפתור מחיקה
  const deleteBtn = document.createElement('span');
  deleteBtn.className = 'formula-delete-btn';
  deleteBtn.innerHTML = '×';
  deleteBtn.onclick = (e) => {
    e.stopPropagation();
    if (confirm('למחוק נוסחה זו?')) {
      formulaDiv.remove();
      setTimeout(() => app.saveCurrentNotebookDrawings(), 100);
    }
  };
  formulaDiv.appendChild(deleteBtn);
  
  // יצירת 8 ידיות resize
  const handles = [
    'top-left', 'top-middle', 'top-right',
    'middle-left', 'middle-right',
    'bottom-left', 'bottom-middle', 'bottom-right'
  ];
  
  handles.forEach(pos => {
    const handle = document.createElement('div');
    handle.className = 'formula-resize-handle ' + pos;
    handle.dataset.handle = pos;
    formulaDiv.appendChild(handle);
  });
  
  // === משתנים לגרירה ו-resize ===
  let isDragging = false;
  let isResizing = false;
  let currentHandle = null;
  let startX, startY, startWidth, startHeight, startLeft, startTop;
  
  // === אירועי גרירה של הנוסחה ===
  formulaDiv.addEventListener('mousedown', (e) => {
    if (e.target.classList.contains('formula-resize-handle')) return;
    if (e.target.classList.contains('formula-delete-btn')) return;
    if (e.target.classList.contains('formula-content')) return;
    
    isDragging = true;
    
    document.querySelectorAll('.dropped-formula').forEach(f => f.classList.remove('selected'));
    formulaDiv.classList.add('selected');
    
    const rect = formulaDiv.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    
    e.preventDefault();
  });
  
  // === אירועי resize ===
  formulaDiv.querySelectorAll('.formula-resize-handle').forEach(handle => {
    handle.addEventListener('mousedown', (e) => {
      e.stopPropagation();
      isResizing = true;
      currentHandle = handle.dataset.handle;
      
      const rect = formulaDiv.getBoundingClientRect();
      startX = e.clientX;
      startY = e.clientY;
      startWidth = rect.width;
      startHeight = rect.height;
      startLeft = formulaDiv.offsetLeft;
      startTop = formulaDiv.offsetTop;
      
      document.querySelectorAll('.dropped-formula').forEach(f => f.classList.remove('selected'));
      formulaDiv.classList.add('selected');
      
      e.preventDefault();
    });
  });
  
  // === אירועי עכבר גלובליים ===
  const handleMouseMove = (e) => {
    if (isDragging) {
      const parentRect = container.getBoundingClientRect();
      let newX = e.clientX - parentRect.left - startX;
      let newY = e.clientY - parentRect.top - startY;
      
      newX = Math.max(0, Math.min(newX, container.offsetWidth - formulaDiv.offsetWidth));
      newY = Math.max(0, Math.min(newY, container.offsetHeight - formulaDiv.offsetHeight));
      
      formulaDiv.style.left = newX + 'px';
      formulaDiv.style.top = newY + 'px';
    }
    
    if (isResizing && currentHandle) {
      const deltaX = e.clientX - startX;
      const deltaY = e.clientY - startY;
      
      let newWidth = startWidth;
      let newHeight = startHeight;
      let newLeft = startLeft;
      let newTop = startTop;
      
      switch (currentHandle) {
        case 'top-left':
          newWidth = startWidth - deltaX;
          newHeight = startHeight - deltaY;
          newLeft = startLeft + deltaX;
          newTop = startTop + deltaY;
          break;
        case 'top-middle':
          newHeight = startHeight - deltaY;
          newTop = startTop + deltaY;
          break;
        case 'top-right':
          newWidth = startWidth + deltaX;
          newHeight = startHeight - deltaY;
          newTop = startTop + deltaY;
          break;
        case 'middle-left':
          newWidth = startWidth - deltaX;
          newLeft = startLeft + deltaX;
          break;
        case 'middle-right':
          newWidth = startWidth + deltaX;
          break;
        case 'bottom-left':
          newWidth = startWidth - deltaX;
          newHeight = startHeight + deltaY;
          newLeft = startLeft + deltaX;
          break;
        case 'bottom-middle':
          newHeight = startHeight + deltaY;
          break;
        case 'bottom-right':
          newWidth = startWidth + deltaX;
          newHeight = startHeight + deltaY;
          break;
      }
      
      const minSize = 40;
      if (newWidth >= minSize) {
        formulaDiv.style.width = newWidth + 'px';
        formulaDiv.style.left = newLeft + 'px';
      }
      if (newHeight >= minSize) {
        formulaDiv.style.height = newHeight + 'px';
        formulaDiv.style.top = newTop + 'px';
      }
      
      // התאמת גודל פונט
      const avgSize = (formulaDiv.offsetWidth + formulaDiv.offsetHeight) / 2;
      const newFontSize = Math.max(12, Math.min(48, avgSize / 5));
      formulaDiv.style.fontSize = newFontSize + 'px';
    }
  };
  
  const handleMouseUp = () => {
    if (isDragging || isResizing) {
      setTimeout(() => app.saveCurrentNotebookDrawings(), 100);
    }
    isDragging = false;
    isResizing = false;
    currentHandle = null;
  };
  
  document.addEventListener('mousemove', handleMouseMove);
  document.addEventListener('mouseup', handleMouseUp);

  container.appendChild(formulaDiv);
  // לא לשמור אם זו טעינה מהזיכרון
  if (!this.isLoadingFormulas) {
    this.saveCurrentNotebookDrawings();
  }
},

makeFormulaDraggable(formulaDiv, pageIndex) {
  let isDragging = false;
  let offsetX, offsetY;
  
  formulaDiv.onmousedown = function(e) {
    if (e.target !== formulaDiv) return;
    isDragging = true;
    formulaDiv.style.cursor = 'grabbing';
    
    const rect = formulaDiv.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    
    e.preventDefault();
  };
  
  document.onmousemove = function(e) {
    if (!isDragging) return;
    
    const parent = formulaDiv.parentElement;
    const parentRect = parent.getBoundingClientRect();
    
    let x = e.clientX - parentRect.left - offsetX;
    let y = e.clientY - parentRect.top - offsetY;
    
    // הגבל בתוך הדף
    x = Math.max(0, Math.min(x, parent.offsetWidth - formulaDiv.offsetWidth));
    y = Math.max(0, Math.min(y, parent.offsetHeight - formulaDiv.offsetHeight));
    
    formulaDiv.style.left = x + 'px';
    formulaDiv.style.top = y + 'px';
  };
  
  document.onmouseup = function() {
    if (isDragging) {
      isDragging = false;
      formulaDiv.style.cursor = 'move';
      app.saveFormulaPositions(pageIndex);
    }
  };
},

saveFormulaPositions(pageIndex) {
  if (!app.currentNotebook) return;
  
  const pages = document.querySelectorAll('.lined-page, .grid-page, .blank-page');
  const pageContainer = pages[pageIndex];
  if (!pageContainer) return;
  
  const formulas = [];
  pageContainer.querySelectorAll('.dropped-formula').forEach(formula => {
    formulas.push({
      text: formula.textContent.replace('×', ''), // הסרת כפתור ה-X
      x: formula.style.left,
      y: formula.style.top
    });
  });
  
  // שמירה במבנה הנתונים
  if (app.subjects[app.currentNotebook].pages[pageIndex]) {
    app.subjects[app.currentNotebook].pages[pageIndex].formulas = formulas;
    app.saveNotebookData();
  }
},

// עדכון כותרת דף
updatePageTitle(pageIndex, newTitle) {
  if (!this.currentNotebook || !this.subjects[this.currentNotebook]) return;
  
  const trimmedTitle = newTitle.trim() || 'דף ללא כותרת';
  
  if (this.subjects[this.currentNotebook].pages[pageIndex]) {
    this.subjects[this.currentNotebook].pages[pageIndex].title = trimmedTitle;
    this.saveNotebookData();
  }
},

      // טיפול בקלט טקסט
      handleTextInput(pageIndex) {
        this.savePage(pageIndex, document.getElementById(`textarea-${pageIndex}`).value);
        this.updateFormatIndicator(pageIndex);
      },

      // הגדרת textarea פעיל
      setActiveTextarea(pageIndex) {
        this.activeTextareaIndex = pageIndex;
        const indicator = document.getElementById('inPageIndicator');
        if (indicator) {
          indicator.textContent = `עריכת דף ${pageIndex + 1}`;
        }
        
        // הסרת הדגשה מכל הדפים
        document.querySelectorAll('.notebook-page').forEach(page => {
          page.classList.remove('active-page');
        });
        
        // הוספת הדגשה לדף הנוכחי
        const textarea = document.getElementById(`textarea-${pageIndex}`);
        if (textarea) {
          const page = textarea.closest('.notebook-page');
          if (page) {
            page.classList.add('active-page');
          }
        }
      },

      // עדכון מחוון עיצוב
      updateFormatIndicator(pageIndex) {
        const textarea = document.getElementById(`textarea-${pageIndex}`);
        const indicator = document.getElementById(`format-indicator-${pageIndex}`);
        
        if (textarea && indicator) {
          const styles = [];
          if (textarea.style.fontWeight === 'bold') styles.push('B');
          if (textarea.style.fontStyle === 'italic') styles.push('I');
          if (textarea.style.textDecoration.includes('underline')) styles.push('U');
          
          indicator.textContent = styles.length > 0 ? styles.join(' ') : 'RTL';
        }
      },

      // עדכון מצב עיצוב
      updateFormatting(pageIndex) {
        this.updateFormatIndicator(pageIndex);
      },

      // === פונקציות עיצוב גלובליות ===
      
      // אתחול בוחרי צבעים גלובליים
initializeGlobalColorPickers() {
  const colors = [
    '#000000', '#333333', '#666666', '#999999', '#cccccc', '#ffffff', '#ff0000', '#ff9900',
    '#ffff00', '#00ff00', '#00ffff', '#0099ff', '#0000ff', '#9900ff', '#ff00ff', '#ff0099',
    '#8b4513', '#daa520', '#556b2f', '#8fbc8f', '#20b2aa', '#4682b4', '#6a5acd', '#9370db',
    '#dc143c', '#ff6347', '#ffd700', '#32cd32', '#00ced1', '#1e90ff', '#4169e1', '#8a2be2'
  ];
  
  const textColorPicker = document.getElementById('inpage-text-color-picker');
  const bgColorPicker = document.getElementById('inpage-bg-color-picker');
  
  if (textColorPicker) {
    textColorPicker.innerHTML = colors.map(color => 
      `<div class="color-option-mini" style="background: ${color};" onclick="app.applyColor('text', '${color}')"></div>`
    ).join('');
  }
  
  if (bgColorPicker) {
    bgColorPicker.innerHTML = colors.map(color => 
      `<div class="color-option-mini" style="background: ${color};" onclick="app.applyColor('background', '${color}')"></div>`
    ).join('');
  }
},

// שינוי גופן - עובד על טקסט מסומן או מכאן והלאה
changeGlobalFontFamily(fontFamily) {
  if (this.activeTextareaIndex === undefined) {
    alert('נא לבחור דף לעריכה');
    return;
  }
  
  const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  if (!element) return;
  
  // אם זה textarea רגיל, בדוק אם יש טקסט מסומן
  if (element.tagName === 'TEXTAREA') {
    const start = element.selectionStart;
    const end = element.selectionEnd;
    
    if (start !== end) {
      // יש טקסט מסומן - עטוף בתג
      const selectedText = element.value.substring(start, end);
      const beforeText = element.value.substring(0, start);
      const afterText = element.value.substring(end);
      const styledText = `<span style="font-family: ${fontFamily};">${selectedText}</span>`;
      
      element.value = beforeText + styledText + afterText;
      this.convertToRichText(this.activeTextareaIndex);
    } else {
      // אין בחירה - המר לrich text עם הפונט החדש
      const currentText = element.value;
      element.value = `<span style="font-family: ${fontFamily};">${currentText}</span>`;
      this.convertToRichText(this.activeTextareaIndex);
      
      // שים את הסמן בסוף
      setTimeout(() => {
        const richEl = document.getElementById(`textarea-${this.activeTextareaIndex}`);
        if (richEl) {
          richEl.focus();
          const range = document.createRange();
          const sel = window.getSelection();
          range.selectNodeContents(richEl);
          range.collapse(false);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }, 100);
    }
  } else {
    // זה כבר contentEditable
    const selection = window.getSelection();
    element.focus();
    
    if (selection.toString().length > 0) {
      // יש בחירה
      document.execCommand('fontName', false, fontFamily);
    } else {
      // אין בחירה - החל מכאן והלאה
      document.execCommand('fontName', false, fontFamily);
    }
    
    this.savePage(this.activeTextareaIndex, element.innerHTML);
  }
  
  element.focus();
},

// שינוי גודל גופן - עובד על טקסט מסומן או מכאן והלאה
changeGlobalFontSize(fontSize) {
  if (this.activeTextareaIndex === undefined) {
    alert('נא לבחור דף לעריכה');
    return;
  }
  
  const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  if (!element) return;
  
  // אם זה textarea רגיל, בדוק אם יש טקסט מסומן
  if (element.tagName === 'TEXTAREA') {
    const start = element.selectionStart;
    const end = element.selectionEnd;
    
    if (start !== end) {
      // יש טקסט מסומן - עטוף בתג
      const selectedText = element.value.substring(start, end);
      const beforeText = element.value.substring(0, start);
      const afterText = element.value.substring(end);
      const styledText = `<span style="font-size: ${fontSize}px;">${selectedText}</span>`;
      
      element.value = beforeText + styledText + afterText;
      this.convertToRichText(this.activeTextareaIndex);
    } else {
      // אין בחירה - המר לrich text עם הגודל החדש
      const currentText = element.value;
      element.value = `<span style="font-size: ${fontSize}px;">${currentText}</span>`;
      this.convertToRichText(this.activeTextareaIndex);
      
      // שים את הסמן בסוף
      setTimeout(() => {
        const richEl = document.getElementById(`textarea-${this.activeTextareaIndex}`);
        if (richEl) {
          richEl.focus();
          const range = document.createRange();
          const sel = window.getSelection();
          range.selectNodeContents(richEl);
          range.collapse(false);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }, 100);
    }
  } else {
    // זה כבר contentEditable
    const selection = window.getSelection();
    element.focus();
    
    if (selection.toString().length > 0) {
      // יש בחירה - עטוף את הטקסט המסומן ב-span
      const span = document.createElement('span');
      span.style.fontSize = fontSize + 'px';
      
      const range = selection.getRangeAt(0);
      const contents = range.extractContents();
      span.appendChild(contents);
      range.insertNode(span);
      
      // הזז את הסמן אחרי ה-span
      range.setStartAfter(span);
      range.collapse(true);
      selection.removeAllRanges();
      selection.addRange(range);
    } else {
      // אין בחירה - הכנס span חדש עם הגודל החדש
      const span = document.createElement('span');
      span.style.fontSize = fontSize + 'px';
      span.appendChild(document.createTextNode('\u200B')); // Zero-width space
      
      const sel = window.getSelection();
      if (sel.rangeCount > 0) {
        const range = sel.getRangeAt(0);
        
        // הכנס את ה-span
        range.insertNode(span);
        
        // שים את הסמן בתוך ה-span
        range.setStart(span.firstChild, 1);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }
    
    this.savePage(this.activeTextareaIndex, element.innerHTML);
  }
  
  element.focus();
},

toggleGlobalFormat(format) {
  if (this.activeTextareaIndex === undefined) {
    alert('נא לבחור דף לעריכה');
    return;
  }

  const textarea = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  const btn = event.target.closest('.toolbar-btn');
  
  if (!textarea) return;

  // בדיקה אם יש טקסט מסומן
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const hasSelection = start !== end;

  if (hasSelection) {
    // אם יש בחירה - עטוף את הטקסט בתגי HTML
    const selectedText = textarea.value.substring(start, end);
    let wrappedText = '';
    
    switch(format) {
      case 'bold':
        wrappedText = `<strong>${selectedText}</strong>`;
        break;
      case 'italic':
        wrappedText = `<em>${selectedText}</em>`;
        break;
      case 'underline':
        wrappedText = `<u>${selectedText}</u>`;
        break;
      case 'strikethrough':
        wrappedText = `<s>${selectedText}</s>`;
        break;
    }
    
    // החלף את הטקסט
    const beforeText = textarea.value.substring(0, start);
    const afterText = textarea.value.substring(end);
    textarea.value = beforeText + wrappedText + afterText;
    
    // שמור מיקום סמן
    const newCursorPos = start + wrappedText.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    
    // המר ל-HTML אם יש תגים
    this.convertTextareaToContentEditable(this.activeTextareaIndex);
    
  } else {
    // אם אין בחירה - שנה את כל הדף
    btn.classList.toggle('active');
    
    switch(format) {
      case 'bold':
        textarea.style.fontWeight = textarea.style.fontWeight === 'bold' ? 'normal' : 'bold';
        break;
      case 'italic':
        textarea.style.fontStyle = textarea.style.fontStyle === 'italic' ? 'normal' : 'italic';
        break;
      case 'underline':
        const hasUnderline = textarea.style.textDecoration.includes('underline');
        if (hasUnderline) {
          textarea.style.textDecoration = textarea.style.textDecoration.replace('underline', '').trim();
        } else {
          textarea.style.textDecoration += ' underline';
        }
        break;
      case 'strikethrough':
        const hasStrike = textarea.style.textDecoration.includes('line-through');
        if (hasStrike) {
          textarea.style.textDecoration = textarea.style.textDecoration.replace('line-through', '').trim();
        } else {
          textarea.style.textDecoration += ' line-through';
        }
        break;
    }
  }
  
  this.savePageFormatting(this.activeTextareaIndex);
  textarea.focus();
},

// המרת textarea ל-contentEditable כשיש עיצוב HTML
convertTextareaToContentEditable(index) {
  const textarea = document.getElementById(`textarea-${index}`);
  if (!textarea) return;
  
  // בדוק אם יש תגי HTML בתוכן
  const content = textarea.value;
  const hasHtmlTags = /<(strong|em|u|s|b|i)>/.test(content);
  
  if (hasHtmlTags && textarea.tagName === 'TEXTAREA') {
    // צור div חדש במקום textarea
    const div = document.createElement('div');
    div.id = textarea.id;
    div.className = textarea.className;
    div.contentEditable = 'true';
    div.innerHTML = content;
    div.style.cssText = textarea.style.cssText;
    
    // העתק את כל האטריביוטים
    Array.from(textarea.attributes).forEach(attr => {
      if (attr.name !== 'id' && attr.name !== 'class' && attr.name !== 'style') {
        div.setAttribute(attr.name, attr.value);
      }
    });
    
    // החלף את ה-textarea ב-div
    textarea.parentNode.replaceChild(div, textarea);
    
    // הוסף מאזין לשמירה
    div.addEventListener('input', () => {
      this.savePageFormatting(index);
    });
    
    div.focus();
  }
},

// שינוי צבע טקסט או רקע - בדיוק כמו toolbarHighlight
// משתנה לשמירת הסימון
savedSelection: null,

// הצגה/הסתרה של בוחר צבעים גלובלי - עם שמירת סימון
toggleGlobalColorPicker(type) {
  // שמור את הסימון הנוכחי!
  const sel = window.getSelection();
  if (sel.rangeCount > 0) {
    this.savedSelection = sel.getRangeAt(0);
  }
  
  const picker = document.getElementById(`inpage-${type}-color-picker`);
  const allPickers = document.querySelectorAll('.color-picker');
  
  // סגור את כל הבוחרים האחרים
  allPickers.forEach(p => {
    if (p !== picker) p.classList.remove('show');
  });
  
  // הפעל/כבה את הבוחר הנוכחי
  picker.classList.toggle('show');
},

applyColor(type, color) {
  const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  if (!element) return;
  
  // אם זה עדיין textarea - המר ל-richtext קודם
  if (element.tagName === 'TEXTAREA') {
    // שמור את הבחירה
    const start = element.selectionStart;
    const end = element.selectionEnd;
    const text = element.value;
    
    // אם יש טקסט נבחר, צור HTML עם צבע
    if (start !== end) {
      const before = text.substring(0, start);
      const selected = text.substring(start, end);
      const after = text.substring(end);
      
      let coloredText;
      if (type === 'text') {
        coloredText = `<font color="${color}">${selected}</font>`;
      } else {
        coloredText = `<span style="background-color: ${color};">${selected}</span>`;
      }
      
      element.value = before + coloredText + after;
      this.convertToRichText(this.activeTextareaIndex);
      this.savePage(this.activeTextareaIndex, document.getElementById(`textarea-${this.activeTextareaIndex}`).innerHTML);
    }
    return;
  }
  
  // החזר את הסימון ששמרנו!
  if (this.savedSelection) {
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(this.savedSelection);
  }
  
  // אם זה contentEditable - פשוט תעשה את זה!
  if (element.getAttribute('data-is-richtext') === 'true') {
    if (type === 'text') {
      document.execCommand('foreColor', false, color);
    } else {
      document.execCommand('backColor', false, color);
    }
    this.savePage(this.activeTextareaIndex, element.innerHTML);
  }
  
  // נקה את הסימון השמור
  this.savedSelection = null;
  
  // סגור פיקר
  setTimeout(() => {
    const picker = document.getElementById(`inpage-${type}-color-picker`);
    if (picker) picker.classList.remove('show');
  }, 100);
},

      // קביעת יישור גלובלי
      setGlobalAlignment(alignment) {
        if (this.activeTextareaIndex === undefined) {
          alert('נא לבחור דף לעריכה');
          return;
        }

        const textarea = document.getElementById(`textarea-${this.activeTextareaIndex}`);
        if (textarea) {
          textarea.style.textAlign = alignment;
          this.savePageFormatting(this.activeTextareaIndex);
          
          // עדכון מצב הכפתורים
          document.querySelectorAll('.toolbar-group:nth-child(4) .toolbar-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          event.target.classList.add('active');
        }
      },

      // הוספת רשימה גלובלית
      insertGlobalList(listType) {
        // אם אין דף פעיל, נסה לבחור את הדף הראשון
        if (this.activeTextareaIndex === undefined) {
          const notebook = this.subjects[this.currentNotebook];
          if (!notebook || !notebook.pages || notebook.pages.length === 0) {
            alert('נא ליצור דף במחברת ולהקליק עליו לפני שימוש בכלי זה');
            return;
          }
          
          // בחר את הדף הראשון אם קיים
          this.activeTextareaIndex = 0;
        }

        const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
        if (!element) {
          alert('שגיאה: לא נמצא דף פעיל. נא להקליק על הדף במחברת');
          return;
        }
        
        element.focus();

        // אם זה textarea רגיל
        if (element.tagName === 'TEXTAREA') {
          const start = element.selectionStart;
          const end = element.selectionEnd;
          const selectedText = element.value.substring(start, end);
          
          let listText;
          
          // אם יש טקסט נבחר - הופך אותו לרשימה
          if (selectedText && selectedText.trim()) {
            if (listType === 'bullet') {
              const lines = selectedText.split('\n');
              listText = lines.map(line => line.trim() ? `• ${line.trim()}` : line).join('\n');
            } else {
              const lines = selectedText.split('\n').filter(line => line.trim());
              listText = lines.map((line, i) => `${i + 1}. ${line.trim()}`).join('\n');
            }
            
            element.value = element.value.substring(0, start) + listText + element.value.substring(end);
            element.setSelectionRange(start + listText.length, start + listText.length);
          } 
          // אם אין טקסט נבחר - מוסיף פריט רשימה חדש
          else {
            listText = listType === 'bullet' ? '• ' : '1. ';
            element.value = element.value.substring(0, start) + listText + element.value.substring(end);
            element.setSelectionRange(start + listText.length, start + listText.length);
          }
          
          this.savePage(this.activeTextareaIndex, element.value);
        }
        // אם זה contentEditable div
        else {
          const selection = window.getSelection();
          const selectedText = selection.toString();
          
          if (selectedText && selectedText.trim()) {
            // יש טקסט מסומן - הפוך לרשימה
            const lines = selectedText.split('\n').filter(line => line.trim());
            let listHTML;
            if (listType === 'bullet') {
              listHTML = '<ul>' + lines.map(line => `<li>${line.trim()}</li>`).join('') + '</ul>';
            } else {
              listHTML = '<ol>' + lines.map(line => `<li>${line.trim()}</li>`).join('') + '</ol>';
            }
            document.execCommand('insertHTML', false, listHTML);
          } else {
            // אין טקסט מסומן - הוסף פריט רשימה
            const listText = listType === 'bullet' ? '• ' : '1. ';
            document.execCommand('insertText', false, listText);
          }
          this.savePage(this.activeTextareaIndex, element.innerHTML);
        }
      },

      // טיפול במקשים בתוך textarea (רשימות אוטומטיות)
      handleTextareaKeydown(event, pageIndex) {
        if (event.key !== 'Enter') return;
        
        const textarea = document.getElementById(`textarea-${pageIndex}`);
        if (!textarea) return;
        
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        
        // מציאת תחילת השורה הנוכחית
        const beforeCursor = textarea.value.substring(0, start);
        const lineStart = beforeCursor.lastIndexOf('\n') + 1;
        const currentLine = textarea.value.substring(lineStart, start);
        
        // בדיקה אם השורה מתחילה בתבלית רשימה
        const bulletMatch = currentLine.match(/^(\s*)(•|◦|▪)\s*(.*)$/);
        const numberedMatch = currentLine.match(/^(\s*)(\d+)\.\s*(.*)$/);
        
        if (bulletMatch) {
          const indent = bulletMatch[1];
          const content = bulletMatch[3];
          
          // אם השורה ריקה (רק תבלית) - מוחק את התבלית
          if (!content.trim()) {
            event.preventDefault();
            textarea.value = textarea.value.substring(0, lineStart) + 
                           indent + 
                           textarea.value.substring(end);
            textarea.setSelectionRange(lineStart + indent.length, lineStart + indent.length);
            this.savePage(pageIndex, textarea.value);
          } 
          // אחרת - מוסיף שורה חדשה עם תבלית
          else {
            event.preventDefault();
            const newLine = '\n' + indent + '• ';
            textarea.value = textarea.value.substring(0, end) + newLine + textarea.value.substring(end);
            textarea.setSelectionRange(end + newLine.length, end + newLine.length);
            this.savePage(pageIndex, textarea.value);
          }
        } 
        else if (numberedMatch) {
          const indent = numberedMatch[1];
          const currentNum = parseInt(numberedMatch[2]);
          const content = numberedMatch[3];
          
          // אם השורה ריקה (רק מספור) - מוחק את המספור
          if (!content.trim()) {
            event.preventDefault();
            textarea.value = textarea.value.substring(0, lineStart) + 
                           indent + 
                           textarea.value.substring(end);
            textarea.setSelectionRange(lineStart + indent.length, lineStart + indent.length);
            this.savePage(pageIndex, textarea.value);
          } 
          // אחרת - מוסיף שורה חדשה עם המספר הבא
          else {
            event.preventDefault();
            const newLine = '\n' + indent + (currentNum + 1) + '. ';
            textarea.value = textarea.value.substring(0, end) + newLine + textarea.value.substring(end);
            textarea.setSelectionRange(end + newLine.length, end + newLine.length);
            this.savePage(pageIndex, textarea.value);
          }
        }
      },

      // הוספת סימן גלובלי - תומך גם ב-textarea וגם ב-contentEditable
      insertGlobalSymbol(symbol) {
        // אם אין דף פעיל, נסה לבחור את הדף הראשון
        if (this.activeTextareaIndex === undefined) {
          const notebook = this.subjects[this.currentNotebook];
          if (!notebook || !notebook.pages || notebook.pages.length === 0) {
            alert('נא ליצור דף במחברת ולהקליק עליו לפני שימוש בכלי זה');
            return;
          }
          
          // בחר את הדף הראשון
          this.activeTextareaIndex = 0;
        }

        const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
        if (!element) {
          alert('נא לבחור דף לעריכה');
          return;
        }
        
        element.focus();

        // אם זה textarea רגיל
        if (element.tagName === 'TEXTAREA') {
          const start = element.selectionStart;
          element.value = element.value.substring(0, start) + symbol + element.value.substring(start);
          element.setSelectionRange(start + symbol.length, start + symbol.length);
          this.savePage(this.activeTextareaIndex, element.value);
        } 
        // אם זה contentEditable div
        else {
          document.execCommand('insertText', false, symbol);
          this.savePage(this.activeTextareaIndex, element.innerHTML);
        }
      },

      // ניקוי עיצוב גלובלי
      clearGlobalFormatting() {
        if (this.activeTextareaIndex === undefined) {
          alert('נא לבחור דף לעריכה');
          return;
        }

        const textarea = document.getElementById(`textarea-${this.activeTextareaIndex}`);
        if (textarea) {
          textarea.style.fontWeight = 'normal';
          textarea.style.fontStyle = 'normal';
          textarea.style.textDecoration = 'none';
          textarea.style.color = '';
          textarea.style.backgroundColor = '';
          textarea.style.textAlign = 'right';
          textarea.style.fontFamily = 'Arial';
          textarea.style.fontSize = '28px';
          
          // איפוס כפתורי הסרגל
          document.querySelectorAll('.toolbar-btn.active').forEach(btn => {
            btn.classList.remove('active');
          });
          
          this.savePageFormatting(this.activeTextareaIndex);
        }
      },

      // הפעלה/כיבוי גלישת מילים גלובלי
      toggleGlobalWordWrap() {
        if (this.activeTextareaIndex === undefined) {
          alert('נא לבחור דף לעריכה');
          return;
        }

        const textarea = document.getElementById(`textarea-${this.activeTextareaIndex}`);
        if (textarea) {
          const currentWrap = textarea.style.whiteSpace;
          textarea.style.whiteSpace = currentWrap === 'nowrap' ? 'pre-wrap' : 'nowrap';
          event.target.classList.toggle('active');
          this.savePageFormatting(this.activeTextareaIndex);
        }
      },

savePageFormatting(index) {
  const element = document.getElementById(`textarea-${index}`);
  if (!element) return;
  
  const key = this.currentNotebook;
  if (!key || !this.subjects[key]) return;
  
  const page = this.subjects[key].pages[index];
  if (page) {
    // שמור את התוכן (תמיכה גם ב-textarea וגם ב-contentEditable)
    page.content = element.tagName === 'TEXTAREA' ? element.value : element.innerHTML;
    page.isHtml = element.tagName === 'DIV'; // סימון אם זה HTML
    
    // שמור את הסגנון
    page.style = {
      fontWeight: element.style.fontWeight,
      fontStyle: element.style.fontStyle,
      textDecoration: element.style.textDecoration,
      backgroundColor: element.style.backgroundColor,
      color: element.style.color,
      fontSize: element.style.fontSize,
      textAlign: element.style.textAlign
    };
    
    this.saveNotebookData();
  }
},

      // טעינת עיצוב דף
      loadPageFormatting(pageIndex, formatting) {
        const textarea = document.getElementById(`textarea-${pageIndex}`);
        if (!textarea || !formatting) return;
        
        Object.keys(formatting).forEach(key => {
          if (formatting[key]) {
            textarea.style[key] = formatting[key];
          }
        });
        
        this.updateFormatIndicator(pageIndex);
      },

// === פונקציות יצירת מחברות ===
      
      // פתיחת יוצר מחברת
      openNotebookCreator() {
        document.getElementById('notebookModal').classList.add('show');
        document.getElementById('notebookName').focus();
        
        // Reset to defaults
        this.selectPageType('lined');
        this.selectColor('#9b59b6');
        document.getElementById('notebookName').value = '';
        this.updateCreateButton();
      },
      
      // סגירת יוצר מחברת
      closeNotebookCreator() {
        document.getElementById('notebookModal').classList.remove('show');
      },
      
      // בחירת סוג דף
      selectPageType(type) {
        this.selectedPageType = type;
        
        // Update UI
        document.querySelectorAll('.page-type-option').forEach(option => {
          option.classList.remove('selected');
        });
        
        const selectedElement = document.querySelector(`[data-type="${type}"]`);
        if (selectedElement) {
          selectedElement.classList.add('selected');
        }
        
        this.updateCreateButton();
      },

      // בחירת צבע
      selectColor(color) {
        this.selectedColor = color;
        
        // Update UI
        document.querySelectorAll('.color-option').forEach(option => {
          option.classList.remove('selected');
        });
        
        const selectedElement = document.querySelector(`[data-color="${color}"]`);
        if (selectedElement) {
          selectedElement.classList.add('selected');
        }
        
        // Update preview
        const preview = document.getElementById('colorPreview');
        if (preview) {
          preview.style.background = color;
        }
        
        this.updateCreateButton();
      },

      // עדכון מצב כפתור יצירה
      updateCreateButton() {
        const nameInput = document.getElementById('notebookName');
        const createBtn = document.getElementById('createBtn');
        
        if (!nameInput || !createBtn) return;
        
        const canCreate = nameInput.value.trim().length > 0 && this.selectedPageType && this.selectedColor;
        createBtn.disabled = !canCreate;
      },
      
      // יצירת מחברת
      createNotebook() {
        const name = document.getElementById('notebookName').value.trim();
        
        if (!name) {
          alert('אנא הכנס שם למחברת');
          return;
        }
        
        // בדיקת מגבלות גרסה חינמית
        if (!this.canCreateNotebook(this.selectedPageType)) {
          return;
        }
        
        const notebookKey = 'custom_' + Date.now();
        
        const newNotebook = {
          title: name,
          icon: this.getIconForPageType(this.selectedPageType),
          color: this.selectedColor,
          description: 'מחברת מותאמת אישית',
          pageType: this.selectedPageType,
          pages: [
            {
              title: 'דף ראשון',
              content: `ברוכים הבאים למחברת "${name}"!\nהתחילו לכתוב כאן...`,
              date: new Date().toLocaleDateString('he-IL')
            }
          ]
        };
        
        this.subjects[notebookKey] = newNotebook;
        this.saveNotebookData();
        this.renderNotebooks();
        this.loadWelcomeData();
        
        alert(`מחברת "${name}" נוצרה בהצלחה! 🎉`);
        this.closeNotebookCreator();
      },
      
      // קבלת אייקון לפי סוג דף
      getIconForPageType(type) {
        const icons = {
          'lined': '📝',
          'grid': '📊', 
          'blank': '🎨',
          'checklist': '✅'
        };
        return icons[type] || '📝';
      },

      // מחיקת מחברת עם אישור כפול
// מחיקת מחברת עם אישור כפול
deleteNotebookWithConfirmation(notebookKey) {
  const notebook = this.subjects[notebookKey];
  
  // אם המחברת לא קיימת או שבורה - מחק אותה ישירות
  if (!notebook || !notebook.title) {
    delete this.subjects[notebookKey];
    this.saveNotebookData();
    this.renderNotebooks();
    this.loadWelcomeData();
    alert('מחברת שבורה נמחקה בהצלחה.');
    return;
  }
  
  const notebookTitle = notebook.title;
  const pagesCount = notebook.pages ? notebook.pages.length : 0;
  
  if (confirm(`האם אתה בטוח שברצונך למחוק את המחברת "${notebookTitle}"?\n\nהמחברת מכילה ${pagesCount} דפים.\nלאחר המחיקה, כל התוכן יאבד לצמיתות!`)) {
    // יצירת קוד אקראי בן 4 ספרות
    const randomCode = Math.floor(1000 + Math.random() * 9000);
    
    const userInput = prompt(`כדי לאשר את המחיקה, העתק והדבק את הקוד הבא:\n\n${randomCode}\n\nהכנס את הקוד:`);
    
    if (userInput === randomCode.toString()) {
      delete this.subjects[notebookKey];
      this.saveNotebookData();
      this.renderNotebooks();
      
      if (this.currentNotebook === notebookKey) {
        this.currentNotebook = null;
        this.showPage('notebooks');
      }
      
      this.loadWelcomeData();
      alert(`המחברת "${notebookTitle}" נמחקה בהצלחה.`);
    } else if (userInput !== null) {
      alert('הקוד שהוזן שגוי. המחיקה בוטלה.');
    }
  }
},

// שכפול מחברת (פרימיום בלבד)
duplicateNotebook(notebookKey) {
  // בדיקת פרימיום
  if (!this.isPro) {
    this.openUpgradeModal('שכפול מחברות');
    return;
  }
  
  const notebook = this.subjects[notebookKey];
  if (!notebook) return;
  
  // יצירת שם חדש
  const newTitle = prompt('הכנס שם למחברת המשוכפלת:', `${notebook.title} (עותק)`);
  if (!newTitle || newTitle.trim() === '') return;
  
  // יצירת מפתח ייחודי חדש
  const newKey = `notebook_${Date.now()}`;
  
  // העתקה עמוקה של המחברת
  const duplicatedNotebook = JSON.parse(JSON.stringify(notebook));
  duplicatedNotebook.title = newTitle.trim();
  
  // שמירת המחברת החדשה
  this.subjects[newKey] = duplicatedNotebook;
  this.saveNotebookData();
  this.renderNotebooks();
  this.loadWelcomeData();
  
  alert(`המחברת "${newTitle}" נוצרה בהצלחה! 📋`);
},


// ניקוי מחברות שבורות
cleanBrokenNotebooks() {
  let cleaned = 0;
  const keysToDelete = [];
  
  Object.keys(this.subjects).forEach(key => {
    const notebook = this.subjects[key];
    if (!notebook || !notebook.title || !notebook.pages) {
      keysToDelete.push(key);
      cleaned++;
    }
  });
  
  keysToDelete.forEach(key => {
    delete this.subjects[key];
  });
  
  if (cleaned > 0) {
    this.saveNotebookData();
    this.renderNotebooks();
    this.loadWelcomeData();
    alert(`${cleaned} מחברות שבורות נוקו בהצלחה! ✨`);
  } else {
    alert('לא נמצאו מחברות שבורות.');
  }
},

// Toggle Export Menu
toggleExportMenu(event) {
  event.stopPropagation();
  const menu = document.getElementById('exportMenu');
  menu.classList.toggle('active');
  
  // סגור את התפריט אם לוחצים מחוץ לו
  if (menu.classList.contains('active')) {
    setTimeout(() => {
      document.addEventListener('click', this.closeExportMenu.bind(this), { once: true });
    }, 100);
  }
},

// Close Export Menu
closeExportMenu() {
  const menu = document.getElementById('exportMenu');
  if (menu) {
    menu.classList.remove('active');
  }
},

// Export Current Page Only
async exportCurrentPage() {
  this.closeExportMenu();
  
  // בדיקת פרימיום
  if (!this.isPro) {
    this.openUpgradeModal('ייצוא ל-PDF');
    return;
  }
  
  if (!this.currentNotebook) {
    alert('לא נבחרה מחברת');
    return;
  }
  
  const loading = document.createElement('div');
  loading.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:40px;border-radius:20px;box-shadow:0 10px 50px rgba(0,0,0,0.3);z-index:10001;text-align:center;';
  loading.innerHTML = '<div style="margin-bottom:15px;font-size:2rem;">📄</div><div style="font-size:1.2rem;font-weight:600;">מייצא דף...</div>';
  document.body.appendChild(loading);

  try {
    // טעינת ספריות
    if (!window.jspdf) {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      document.head.appendChild(s);
      await new Promise(r => setTimeout(r, 2000));
    }
    if (!window.html2canvas) {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      document.head.appendChild(s);
      await new Promise(r => setTimeout(r, 2000));
    }

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');

    // טעינת גופן עברי
    const fontResp = await fetch('https://fonts.gstatic.com/s/rubik/v28/iJWZBXyIfDnIV5PNhY1KTN7Z-Yh-B4i1UA.ttf');
    const fontBuf = await fontResp.arrayBuffer();
    const bytes = new Uint8Array(fontBuf);
    let binary = '';
    for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
    pdf.addFileToVFS('Rubik.ttf', btoa(binary));
    pdf.addFont('Rubik.ttf', 'Rubik', 'normal');
    pdf.setFont('Rubik');

    const pageWidth = 210, pageHeight = 297, marginLeft = 20, marginTop = 30, lineHeight = 8, marginRight = 25;

    // פונקציות עזר
    const parseHTML = (el) => {
      const lines = [];
      let currentLine = [];
      const processNode = (node, styles) => {
        if (node.nodeType === 3) {
          const text = node.textContent;
          if (text.includes('\n')) {
            text.split('\n').forEach((part, i, arr) => {
              if (part) currentLine.push({ text: part, ...styles });
              if (i < arr.length - 1) { lines.push([...currentLine]); currentLine = []; }
            });
          } else if (text) currentLine.push({ text, ...styles });
        } else if (node.nodeType === 1) {
          const tag = node.tagName;
          if (tag === 'BR') { lines.push([...currentLine]); currentLine = []; return; }
          if (['DIV','P'].includes(tag) && currentLine.length > 0) { lines.push([...currentLine]); currentLine = []; }
          let newStyles = { ...styles };
          if (tag === 'FONT' && node.getAttribute('color')) newStyles.color = node.getAttribute('color');
          if (node.style?.color) newStyles.color = node.style.color;
          if (node.style?.backgroundColor) newStyles.bgColor = node.style.backgroundColor;
          if (tag === 'B' || tag === 'STRONG') newStyles.bold = true;
          if (tag === 'U') newStyles.underline = true;
          if (tag === 'S' || tag === 'STRIKE' || tag === 'DEL') newStyles.strike = true;
          for (const child of node.childNodes) processNode(child, newStyles);
          if (['DIV','P'].includes(tag) && currentLine.length > 0) { lines.push([...currentLine]); currentLine = []; }
        }
      };
      processNode(el, { color: null, bold: false, underline: false, strike: false, bgColor: null });
      if (currentLine.length > 0) lines.push(currentLine);
      return lines;
    };

    const toRGB = (color) => {
      if (!color) return { r: 44, g: 62, b: 80 };
      if (color.startsWith('#')) {
        const hex = color.slice(1);
        if (hex.length === 3) return { r: parseInt(hex[0]+hex[0], 16), g: parseInt(hex[1]+hex[1], 16), b: parseInt(hex[2]+hex[2], 16) };
        return { r: parseInt(hex.slice(0,2), 16), g: parseInt(hex.slice(2,4), 16), b: parseInt(hex.slice(4,6), 16) };
      }
      if (color.startsWith('rgb')) {
        const m = color.match(/(\d+)/g);
        if (m) return { r: +m[0], g: +m[1], b: +m[2] };
      }
      return { r: 44, g: 62, b: 80 };
    };
    
    const splitSegment = (segment) => {
      const parts = segment.text.match(/[\u0590-\u05FF]+|[^\u0590-\u05FF]+/g) || [segment.text];
      return parts.map(part => ({
        ...segment,
        text: part,
        isHebrew: /[\u0590-\u05FF]/.test(part)
      }));
    };

    // מצא את הדף הנוכחי
    const pageEl = document.querySelector('.lined-page, .grid-page, .blank-page');
    if (!pageEl) {
      throw new Error('לא נמצא דף');
    }
    
    const pageRect = pageEl.getBoundingClientRect();
    const scaleX = pageWidth / pageRect.width;
    const isGridPage = pageEl.classList.contains('grid-page');

    // רקע
    pdf.setFillColor(248, 250, 252);
    pdf.rect(0, 0, pageWidth, pageHeight, 'F');
    
    if (isGridPage) {
      // קווי רשת לדף משובץ
      pdf.setDrawColor(200, 220, 240);
      pdf.setLineWidth(0.1);
      const gridSize = 5;
      for (let x = 10; x < pageWidth - 10; x += gridSize) {
        pdf.line(x, 10, x, pageHeight - 10);
      }
      for (let y = 10; y < pageHeight - 10; y += gridSize) {
        pdf.line(10, y, pageWidth - 10, y);
      }
    } else {
      // קווים לדף שורות
      pdf.setDrawColor(210, 225, 240);
      pdf.setLineWidth(0.2);
      for (let yLine = marginTop; yLine < pageHeight - 15; yLine += lineHeight) {
        pdf.line(15, yLine, pageWidth - 15, yLine);
      }
      pdf.setDrawColor(255, 107, 107);
      pdf.setLineWidth(0.4);
      pdf.line(pageWidth - marginRight + 5, 15, pageWidth - marginRight + 5, pageHeight - 10);
    }

    // צורות
    for (const shape of pageEl.querySelectorAll('.interactive-shape')) {
      try {
        const svg = shape.querySelector('svg');
        if (svg) {
          const polygon = svg.querySelector('polygon, rect, ellipse, path, circle');
          if (polygon) {
            const bbox = polygon.getBBox();
            const padding = 5;
            svg.setAttribute('viewBox', `${bbox.x - padding} ${bbox.y - padding} ${bbox.width + padding*2} ${bbox.height + padding*2}`);
          }
        }
        await new Promise(r => setTimeout(r, 30));
        const shapeCanvas = await html2canvas(shape, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: null, logging: false });
        const shapeRect = shape.getBoundingClientRect();
        const xPercent = (shapeRect.left - pageRect.left + shapeRect.width/2) / pageRect.width;
        const yPercent = (shapeRect.top - pageRect.top + shapeRect.height/2) / pageRect.height;
        const aspectRatio = shapeCanvas.height / shapeCanvas.width;
        const shapeW = shapeRect.width * scaleX;
        const shapeH = shapeW * aspectRatio;
        const shapeX = (xPercent * pageWidth) - (shapeW / 2);
        const shapeY = (yPercent * pageHeight) - (shapeH / 2);
        pdf.addImage(shapeCanvas.toDataURL('image/png'), 'PNG', shapeX, shapeY, shapeW, shapeH);
      } catch(e) { console.log('Shape error:', e); }
    }

    // ציורים
    for (const canvas of pageEl.querySelectorAll('canvas')) {
      try {
        const r = canvas.getBoundingClientRect();
        const xPercent = (r.left - pageRect.left + r.width/2) / pageRect.width;
        const yPercent = (r.top - pageRect.top + r.height/2) / pageRect.height;
        const aspectRatio = canvas.height / canvas.width;
        const w = r.width * scaleX;
        const h = w * aspectRatio;
        const x = (xPercent * pageWidth) - (w / 2);
        const yPos = (yPercent * pageHeight) - (h / 2);
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, yPos, w, h);
      } catch(e) { console.log('Canvas error:', e); }
    }

    // נוסחאות
    for (const formula of pageEl.querySelectorAll('.dropped-formula')) {
      try {
        const handles = formula.querySelectorAll('.formula-resize-handle, .formula-delete-btn');
        handles.forEach(h => h.style.display = 'none');
        await new Promise(r => setTimeout(r, 30));
        const formulaCanvas = await html2canvas(formula, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: null, logging: false });
        handles.forEach(h => h.style.display = '');
        const formulaRect = formula.getBoundingClientRect();
        const xPercent = (formulaRect.left - pageRect.left + formulaRect.width/2) / pageRect.width;
        const yPercent = (formulaRect.top - pageRect.top + formulaRect.height/2) / pageRect.height;
        const aspectRatio = formulaCanvas.height / formulaCanvas.width;
        const formulaW = formulaRect.width * scaleX;
        const formulaH = formulaW * aspectRatio;
        const formulaX = (xPercent * pageWidth) - (formulaW / 2);
        const formulaY = (yPercent * pageHeight) - (formulaH / 2);
        pdf.addImage(formulaCanvas.toDataURL('image/png'), 'PNG', formulaX, formulaY, formulaW, formulaH);
      } catch(e) { console.log('Formula error:', e); }
    }

    // טקסט
    const richText = pageEl.querySelector('[data-is-richtext="true"]');
    const textarea = pageEl.querySelector('textarea');
    const textElement = richText || textarea;
    
    let isPageRTL = true;
    if (textElement) {
      try {
        isPageRTL = window.getComputedStyle(textElement).direction === 'rtl';
      } catch(e) {
        isPageRTL = true;
      }
    }
    
    let y = marginTop;
    pdf.setFontSize(14);

    if (richText) {
      const coloredLines = parseHTML(richText);
      
      for (let lineSegments of coloredLines) {
        if (y > pageHeight - 20) break;
        if (lineSegments.length === 0) { y += lineHeight; continue; }
        
        const fullLineText = lineSegments.map(s => s.text).join('');
        if (!fullLineText.trim()) { y += lineHeight; continue; }
        
        const hasHebrew = /[\u0590-\u05FF]/.test(fullLineText);
        const hasEnglish = /[a-zA-Z]/.test(fullLineText);
        
        // עברית בלבד
        if (hasHebrew && !hasEnglish) {
          let xPos = pageWidth - marginRight;
          
          for (const segment of lineSegments) {
            if (!segment.text) continue;
            
            const rgb = toRGB(segment.color);
            pdf.setTextColor(rgb.r, rgb.g, rgb.b);
            
            const reversed = segment.text.split('').reverse().join('');
            const textWidth = pdf.getTextWidth(reversed);
            
            if (segment.bgColor) {
              const bgRgb = toRGB(segment.bgColor);
              pdf.setFillColor(bgRgb.r, bgRgb.g, bgRgb.b);
              pdf.rect(xPos - textWidth, y - 4.5, textWidth, 6, 'F');
            }
            
            pdf.text(reversed, xPos, y, { align: 'right' });
            if (segment.bold) pdf.text(reversed, xPos + 0.2, y, { align: 'right' });
            
            if (segment.underline) {
              pdf.setDrawColor(rgb.r, rgb.g, rgb.b);
              pdf.setLineWidth(0.4);
              pdf.line(xPos - textWidth, y + 1.5, xPos, y + 1.5);
            }
            if (segment.strike) {
              pdf.setDrawColor(rgb.r, rgb.g, rgb.b);
              pdf.setLineWidth(0.4);
              pdf.line(xPos - textWidth, y - 1.5, xPos, y - 1.5);
            }
            
            xPos -= textWidth;
          }
        }
        // אנגלית בלבד
        else if (hasEnglish && !hasHebrew) {
          let xPos = marginLeft;
          
          for (const segment of lineSegments) {
            if (!segment.text) continue;
            
            const rgb = toRGB(segment.color);
            pdf.setTextColor(rgb.r, rgb.g, rgb.b);
            
            const textWidth = pdf.getTextWidth(segment.text);
            
            if (segment.bgColor) {
              const bgRgb = toRGB(segment.bgColor);
              pdf.setFillColor(bgRgb.r, bgRgb.g, bgRgb.b);
              pdf.rect(xPos, y - 4.5, textWidth, 6, 'F');
            }
            
            pdf.text(segment.text, xPos, y);
            if (segment.bold) pdf.text(segment.text, xPos + 0.2, y);
            
            if (segment.underline) {
              pdf.setDrawColor(rgb.r, rgb.g, rgb.b);
              pdf.setLineWidth(0.4);
              pdf.line(xPos, y + 1.5, xPos + textWidth, y + 1.5);
            }
            if (segment.strike) {
              pdf.setDrawColor(rgb.r, rgb.g, rgb.b);
              pdf.setLineWidth(0.4);
              pdf.line(xPos, y - 1.5, xPos + textWidth, y - 1.5);
            }
            
            xPos += textWidth;
          }
        }
        // מעורב עברית ואנגלית
        else {
          let allParts = [];
          for (const segment of lineSegments) {
            const parts = splitSegment(segment);
            allParts = allParts.concat(parts);
          }
          
          allParts = allParts.reverse();
          
          let totalWidth = 0;
          for (const part of allParts) {
            const displayText = part.isHebrew ? part.text.split('').reverse().join('') : part.text;
            totalWidth += pdf.getTextWidth(displayText);
          }
          
          let xPos = pageWidth - marginRight - totalWidth;
          
          for (const part of allParts) {
            if (!part.text) continue;
            
            const rgb = toRGB(part.color);
            pdf.setTextColor(rgb.r, rgb.g, rgb.b);
            
            const displayText = part.isHebrew ? part.text.split('').reverse().join('') : part.text;
            const textWidth = pdf.getTextWidth(displayText);
            
            if (part.bgColor) {
              const bgRgb = toRGB(part.bgColor);
              pdf.setFillColor(bgRgb.r, bgRgb.g, bgRgb.b);
              pdf.rect(xPos, y - 4.5, textWidth, 6, 'F');
            }
            
            pdf.text(displayText, xPos, y);
            if (part.bold) pdf.text(displayText, xPos + 0.2, y);
            
            if (part.underline) {
              pdf.setDrawColor(rgb.r, rgb.g, rgb.b);
              pdf.setLineWidth(0.4);
              pdf.line(xPos, y + 1.5, xPos + textWidth, y + 1.5);
            }
            if (part.strike) {
              pdf.setDrawColor(rgb.r, rgb.g, rgb.b);
              pdf.setLineWidth(0.4);
              pdf.line(xPos, y - 1.5, xPos + textWidth, y - 1.5);
            }
            
            xPos += textWidth;
          }
        }
        
        y += lineHeight;
      }
    } else if (textarea) {
      // טקסט רגיל מ-textarea
      const lines = textarea.value.split('\n');
      pdf.setTextColor(44, 62, 80);
      
      for (const line of lines) {
        if (y > pageHeight - 20) break;
        if (!line.trim()) { y += lineHeight; continue; }
        
        const hasHebrew = /[\u0590-\u05FF]/.test(line);
        
        if (hasHebrew) {
          const reversed = line.split('').reverse().join('');
          pdf.text(reversed, pageWidth - marginRight, y, { align: 'right' });
        } else {
          pdf.text(line, marginLeft, y);
        }
        
        y += lineHeight;
      }
    }

    // שמירת הקובץ
    const notebook = this.subjects[this.currentNotebook];
    const pg = notebook?.pages?.[notebook?.currentPage] || {};
    pdf.save(`${notebook?.title || 'מחברת'} - ${pg.title || 'דף'}.pdf`);
    
    document.body.removeChild(loading);
    
  } catch(e) {
    document.body.removeChild(loading);
    alert('שגיאה בייצוא: ' + e.message);
    console.error(e);
  }
},

// Export Today's Pages
async exportTodayPages() {
  this.closeExportMenu();
  
  // בדיקת פרימיום
  if (!this.isPro) {
    this.openUpgradeModal('ייצוא ל-PDF');
    return;
  }
  
  if (!this.currentNotebook) {
    alert('לא נבחרה מחברת');
    return;
  }
  
  const notebook = this.subjects[this.currentNotebook];
  if (!notebook || !notebook.pages || notebook.pages.length === 0) {
    alert('אין דפים במחברת');
    return;
  }
  
  // קבלת תאריך של היום
  const today = new Date().toLocaleDateString('he-IL');
  
  // מצא אינדקסים של דפים מהיום
  const todayIndices = [];
  notebook.pages.forEach((page, index) => {
    if (page.date === today) {
      todayIndices.push(index);
    }
  });
  
  if (todayIndices.length === 0) {
    alert('אין דפים שנוצרו היום');
    return;
  }
  
  const notebookContent = document.getElementById('notebookContent');
  const children = Array.from(notebookContent.children);
  
  // הוסף class זמני רק לדפי היום
  const markedElements = [];
  todayIndices.forEach(index => {
    const pageElement = children[index]?.querySelector('.lined-page, .grid-page, .blank-page');
    if (pageElement) {
      pageElement.classList.add('export-this-page');
      markedElements.push(pageElement);
    }
  });
  
  // קרא לפונקציה הקיימת
  await this.exportNotebookToPDF();
  
  // הסר את ה-class
  markedElements.forEach(el => el.classList.remove('export-this-page'));
},

// Export All Notebook
async exportAllNotebook() {
  this.closeExportMenu();
  
  // בדיקת פרימיום
  if (!this.isPro) {
    this.openUpgradeModal('ייצוא ל-PDF');
    return;
  }
  
  await this.exportNotebookToPDF();
},

// ייצוא מחברת ל-PDF
async exportNotebookToPDF() {
  if (!this.currentNotebook) {
    alert('לא נבחרה מחברת לייצוא');
    return;
  }
  
  const notebook = this.subjects[this.currentNotebook];
  if (!notebook) {
    alert('שגיאה: המחברת לא נמצאה');
    return;
  }
  
  const loadingMessage = document.createElement('div');
  loadingMessage.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px 50px;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 10000;
    text-align: center;
    font-size: 1.2rem;
    font-weight: 600;
  `;
  loadingMessage.innerHTML = `
    <div style="margin-bottom: 15px;">📄</div>
    <div>יוצר PDF...</div>
    <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">אנא המתן</div>
  `;
  document.body.appendChild(loadingMessage);
  
  try {
    // טעינת html2canvas לציורים
    if (typeof html2canvas === 'undefined') {
      await this.loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    }
    
    // טעינת jsPDF
    if (typeof jspdf === 'undefined') {
      await this.loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    }
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    
    // טעינת גופן עברי
    try {
      const response = await fetch('https://fonts.gstatic.com/s/rubik/v28/iJWZBXyIfDnIV5PNhY1KTN7Z-Yh-B4i1UA.ttf');
      const arrayBuffer = await response.arrayBuffer();
      const bytes = new Uint8Array(arrayBuffer);
      let binary = '';
      for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
      pdf.addFileToVFS('Rubik.ttf', btoa(binary));
      pdf.addFont('Rubik.ttf', 'Rubik', 'normal');
      pdf.setFont('Rubik');
    } catch(e) {
      console.error('שגיאה בטעינת גופן:', e);
    }
    
    // הגדרות עמוד
    const pageWidth = 210, pageHeight = 297;
    const marginRight = 25, marginLeft = 20, marginTop = 30, lineHeight = 8;
    const linesPerPage = Math.floor((pageHeight - marginTop - 20) / lineHeight);
    
    pdf.setFontSize(12);
    
    // פונקציה להפיכת טקסט עברי בלבד (שומרת על אנגלית ומספרים)
    const processLineForPDF = (str) => {
      const hasHebrew = /[\u0590-\u05FF]/.test(str);
      if (!hasHebrew) return { text: str, isRTL: false };
      
      const hasEnglish = /[a-zA-Z]/.test(str);
      if (!hasEnglish) {
        // עברית בלבד - להפוך
        return { text: str.split('').reverse().join(''), isRTL: true };
      }
      
      // שורה מעורבת
      const parts = str.match(/[\u0590-\u05FF]+|\s+|[^\u0590-\u05FF\s]+/g);
      
      let hebrewEnd = 0;
      for (let i = 0; i < parts.length; i++) {
        if (/[a-zA-Z0-9]/.test(parts[i])) {
          hebrewEnd = i;
          break;
        }
      }
      
      const hebrewPart = parts.slice(0, hebrewEnd).join('');
      const englishPart = parts.slice(hebrewEnd).join('');
      
      return { text: englishPart + hebrewPart, isRTL: true };
    };
    
    // פונקציה לחילוץ צבעים מ-HTML - מחזירה מערך של שורות עם קטעים צבעוניים
    const parseColoredHTML = (html) => {
      // יצירת אלמנט זמני לפרסור
      const temp = document.createElement('div');
      temp.innerHTML = html;
      
      const lines = [];
      let currentLine = [];
      
      const processNode = (node, inheritedColor = null) => {
        if (node.nodeType === Node.TEXT_NODE) {
          const text = node.textContent;
          if (text) {
            // פצל לפי שורות חדשות
            const parts = text.split('\n');
            parts.forEach((part, idx) => {
              if (part) {
                currentLine.push({ text: part, color: inheritedColor });
              }
              if (idx < parts.length - 1) {
                lines.push([...currentLine]);
                currentLine = [];
              }
            });
          }
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          // בדוק אם זה אלמנט שיוצר שורה חדשה
          const tagName = node.tagName.toUpperCase();
          
          // BR תמיד יוצר שורה חדשה
          if (tagName === 'BR') {
            lines.push([...currentLine]);
            currentLine = [];
            return;
          }
          
          // DIV יוצר שורה חדשה לפני ואחרי (אם יש תוכן)
          const isBlockElement = ['DIV', 'P', 'LI', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(tagName);
          
          if (isBlockElement && currentLine.length > 0) {
            lines.push([...currentLine]);
            currentLine = [];
          }
          
          let color = inheritedColor;
          
          // בדוק צבע מתגית font
          if (tagName === 'FONT' && node.getAttribute('color')) {
            color = node.getAttribute('color');
          }
          
          // בדוק צבע מ-style
          if (node.style && node.style.color) {
            color = node.style.color;
          }
          
          // עבור על ילדים
          for (const child of node.childNodes) {
            processNode(child, color);
          }
          
          // אחרי אלמנט בלוק, סיים שורה
          if (isBlockElement && currentLine.length > 0) {
            lines.push([...currentLine]);
            currentLine = [];
          }
        }
      };
      
      processNode(temp);
      
      // הוסף שורה אחרונה אם יש
      if (currentLine.length > 0) {
        lines.push(currentLine);
      }
      
      return lines;
    };
    
    // פונקציה להמרת צבע לפורמט RGB
    const colorToRGB = (color) => {
      if (!color) return { r: 44, g: 62, b: 80 }; // ברירת מחדל - אפור כהה
      
      // אם זה כבר hex
      if (color.startsWith('#')) {
        const hex = color.slice(1);
        if (hex.length === 3) {
          return {
            r: parseInt(hex[0] + hex[0], 16),
            g: parseInt(hex[1] + hex[1], 16),
            b: parseInt(hex[2] + hex[2], 16)
          };
        }
        return {
          r: parseInt(hex.slice(0, 2), 16),
          g: parseInt(hex.slice(2, 4), 16),
          b: parseInt(hex.slice(4, 6), 16)
        };
      }
      
      // אם זה rgb()
      const rgbMatch = color.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
      if (rgbMatch) {
        return {
          r: parseInt(rgbMatch[1]),
          g: parseInt(rgbMatch[2]),
          b: parseInt(rgbMatch[3])
        };
      }
      
      // צבעים בסיסיים
      const namedColors = {
        'red': { r: 255, g: 0, b: 0 },
        'green': { r: 0, g: 128, b: 0 },
        'blue': { r: 0, g: 0, b: 255 },
        'yellow': { r: 255, g: 255, b: 0 },
        'orange': { r: 255, g: 165, b: 0 },
        'purple': { r: 128, g: 0, b: 128 },
        'black': { r: 0, g: 0, b: 0 },
        'white': { r: 255, g: 255, b: 255 }
      };
      
      return namedColors[color.toLowerCase()] || { r: 44, g: 62, b: 80 };
    };
    
    // קבלת הדפים לייצוא
    const notebookContent = document.getElementById('notebookContent');
    const pagesToExport = notebookContent.querySelectorAll('.export-this-page');
    const pageElements = pagesToExport.length > 0 ? pagesToExport : notebookContent.querySelectorAll('.lined-page, .grid-page, .blank-page');
    
    if (pageElements.length === 0) {
      alert('אין דפים לייצוא');
      document.body.removeChild(loadingMessage);
      return;
    }
    
    let isFirstPdfPage = true;
    
    // עבור על כל דף במחברת
    for (let pageIdx = 0; pageIdx < pageElements.length; pageIdx++) {
      const pageEl = pageElements[pageIdx];
      
      // בדוק אם יש ציורים או צורות בדף
      const hasDrawings = pageEl.querySelector('canvas') || pageEl.querySelector('.interactive-shape') || pageEl.querySelector('.draggable-image') || pageEl.querySelector('.dropped-formula');
      const richTextElement = pageEl.querySelector('[data-is-richtext="true"]');
      
      if (hasDrawings) {
        // אם יש ציורים או צורות - ייצוא משולב
        try {
          loadingMessage.innerHTML = `
            <div style="margin-bottom: 15px;">📄</div>
            <div>יוצר PDF...</div>
            <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">מייצא דף ${pageIdx + 1} עם ציורים...</div>
          `;
          
          if (!isFirstPdfPage) {
            pdf.addPage();
          }
          isFirstPdfPage = false;
          
          const isGridPage = pageEl.classList.contains('grid-page');
          const textarea = pageEl.querySelector('textarea');
          // אם יש richText, קח ממנו. אחרת מ-textarea
          const hasColoredContent = richTextElement && (
            richTextElement.innerHTML.includes('color=') || 
            richTextElement.innerHTML.includes('color:') || 
            richTextElement.innerHTML.includes('<font')
          );
          const text = richTextElement ? richTextElement.innerText || '' : (textarea ? textarea.value || '' : '');
          const textLines = text.split('\n');
          const shapes = pageEl.querySelectorAll('.interactive-shape');
          
          // רקע
          pdf.setFillColor(248, 250, 252);
          pdf.rect(0, 0, pageWidth, pageHeight, 'F');
          
          // משבצות או שורות
          if (isGridPage) {
            pdf.setDrawColor(180, 200, 220);
            pdf.setLineWidth(0.15);
            for (let x = 10; x < pageWidth - 10; x += 5) pdf.line(x, 10, x, pageHeight - 10);
            for (let y = 10; y < pageHeight - 10; y += 5) pdf.line(10, y, pageWidth - 10, y);
          } else {
            pdf.setDrawColor(210, 225, 240);
            pdf.setLineWidth(0.2);
            for (let y = marginTop; y < pageHeight - 15; y += lineHeight) pdf.line(15, y, pageWidth - 15, y);
          }
          
          // קו אדום
          pdf.setDrawColor(255, 107, 107);
          pdf.setLineWidth(0.4);
          pdf.line(pageWidth - marginRight + 5, 15, pageWidth - marginRight + 5, pageHeight - 10);
          
          // צילום כל הצורות
          const pageRect = pageEl.getBoundingClientRect();
          
          for (const shape of shapes) {
            const svg = shape.querySelector('svg');
            if (!svg) continue;
            
            const shapeRect = shape.getBoundingClientRect();
            
            // תקן את ה-SVG viewBox
            const polygon = svg.querySelector('polygon, rect, ellipse, path, circle');
            if (polygon) {
              const bbox = polygon.getBBox();
              const padding = 5;
              svg.setAttribute('viewBox', `${bbox.x - padding} ${bbox.y - padding} ${bbox.width + padding*2} ${bbox.height + padding*2}`);
            }
            
            await new Promise(r => setTimeout(r, 30));
            
            const shapeCanvas = await html2canvas(shape, {
              scale: 2,
              useCORS: true,
              allowTaint: true,
              backgroundColor: null,
              logging: false
            });
            
            // מיקום באחוזים
            const xPercent = (shapeRect.left - pageRect.left + shapeRect.width/2) / pageRect.width;
            const yPercent = (shapeRect.top - pageRect.top + shapeRect.height/2) / pageRect.height;
            
            const scaleX = pageWidth / pageRect.width;
            
            // שמור על יחס הגובה-רוחב המקורי של הצורה
            const aspectRatio = shapeCanvas.height / shapeCanvas.width;
            const shapeW = shapeRect.width * scaleX;
            const shapeH = shapeW * aspectRatio;
            
            const shapeX = (xPercent * pageWidth) - (shapeW / 2);
            const shapeY = (yPercent * pageHeight) - (shapeH / 2);
            
            const imgData = shapeCanvas.toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', shapeX, shapeY, shapeW, shapeH);
          }
          
          // ייצוא נוסחאות
          const droppedFormulas = pageEl.querySelectorAll('.dropped-formula');
          for (const formula of droppedFormulas) {
            // הסתר ידיות וכפתור מחיקה לפני הצילום
            const handles = formula.querySelectorAll('.formula-resize-handle, .formula-delete-btn');
            handles.forEach(h => h.style.display = 'none');
            
            await new Promise(r => setTimeout(r, 30));
            
            const formulaCanvas = await html2canvas(formula, {
              scale: 2,
              backgroundColor: '#ffffff',
              logging: false
            });
            
            // החזר את הידיות
            handles.forEach(h => h.style.display = '');
            
            const formulaRect = formula.getBoundingClientRect();
            const scaleX = pageWidth / pageRect.width;
            const scaleY = pageHeight / pageRect.height;
            
            const fX = (formulaRect.left - pageRect.left) * scaleX;
            const fY = (formulaRect.top - pageRect.top) * scaleY;
            const fW = formulaRect.width * scaleX;
            const fH = formulaRect.height * scaleY;
            
            const imgData = formulaCanvas.toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', fX, fY, fW, fH);
          }
          
          // טקסט - עם תמיכה בצבעים
          pdf.setFontSize(14);
          let y = marginTop;
          
          if (hasColoredContent && richTextElement) {
            // יש טקסט צבעוני - פרסר את ה-HTML
            const coloredLines = parseColoredHTML(richTextElement.innerHTML);
            
            for (const lineSegments of coloredLines) {
              if (lineSegments.length === 0) {
                y += lineHeight;
                continue;
              }
              
              // חבר את כל הקטעים לשורה אחת לבדיקת כיוון
              const fullLineText = lineSegments.map(s => s.text).join('');
              if (!fullLineText.trim()) {
                y += lineHeight;
                continue;
              }
              
              const hasHebrew = /[\u0590-\u05FF]/.test(fullLineText);
              
              if (hasHebrew) {
                // שורה עברית - כתוב מימין לשמאל
                let xPos = pageWidth - marginRight;
                
                // הפוך את סדר הקטעים לכתיבה מימין
                const reversedSegments = [...lineSegments].reverse();
                
                for (const segment of reversedSegments) {
                  if (!segment.text) continue;
                  
                  const rgb = colorToRGB(segment.color);
                  pdf.setTextColor(rgb.r, rgb.g, rgb.b);
                  
                  // הפוך טקסט עברי
                  const processedText = segment.text.split('').reverse().join('');
                  
                  pdf.text(processedText, xPos, y, { align: 'right' });
                  
                  // חשב את רוחב הטקסט וזוז שמאלה
                  const textWidth = pdf.getTextWidth(processedText);
                  xPos -= textWidth;
                }
              } else {
                // שורה באנגלית - כתוב משמאל לימין
                let xPos = marginLeft;
                
                for (const segment of lineSegments) {
                  if (!segment.text) continue;
                  
                  const rgb = colorToRGB(segment.color);
                  pdf.setTextColor(rgb.r, rgb.g, rgb.b);
                  
                  pdf.text(segment.text, xPos, y, { align: 'left' });
                  
                  const textWidth = pdf.getTextWidth(segment.text);
                  xPos += textWidth;
                }
              }
              
              y += lineHeight;
            }
          } else {
            // טקסט רגיל ללא צבעים
            pdf.setTextColor(44, 62, 80);
            for (const line of textLines) {
              if (line.trim()) {
                const result = processLineForPDF(line);
                pdf.text(result.text, result.isRTL ? pageWidth - marginRight : marginLeft, y, { align: result.isRTL ? 'right' : 'left' });
              }
              y += lineHeight;
            }
          }
          
        } catch (drawingError) {
          console.error('שגיאה בייצוא ציורים:', drawingError);
        }
      } else {
        // אם אין ציורים - בדוק אם יש טקסט צבעוני
        const richTextEl = pageEl.querySelector('[data-is-richtext="true"]');
        const textarea = pageEl.querySelector('textarea');
        
        const hasColoredContent = richTextEl && (
          richTextEl.innerHTML.includes('color=') || 
          richTextEl.innerHTML.includes('color:') || 
          richTextEl.innerHTML.includes('<font')
        );
        
        // קבל את הטקסט מהמקור המתאים
        const text = richTextEl ? richTextEl.innerText || '' : (textarea ? textarea.value || '' : '');
        if (!text.trim()) continue;
        
        const textLines = text.split('\n');
        let currentLine = 0;
        
        // אם יש צבעים, פרסר את ה-HTML
        const coloredLines = hasColoredContent ? parseColoredHTML(richTextEl.innerHTML) : null;
        
        while (currentLine < textLines.length || (coloredLines && currentLine < coloredLines.length)) {
          if (!isFirstPdfPage) {
            pdf.addPage();
          }
          isFirstPdfPage = false;
          
          // בדיקה אם זה דף משובץ או שורות
          const isGridPage = pageEl.classList.contains('grid-page');
          
          if (isGridPage) {
            // ציור משבצות
            pdf.setDrawColor(200, 220, 240);
            pdf.setLineWidth(0.1);
            const gridSize = 5;
            for (let x = 10; x < pageWidth - 10; x += gridSize) {
              pdf.line(x, 20, x, pageHeight - 15);
            }
            for (let y = 20; y < pageHeight - 15; y += gridSize) {
              pdf.line(10, y, pageWidth - 10, y);
            }
          } else {
            // ציור קווי מחברת
            pdf.setDrawColor(210, 225, 240);
            pdf.setLineWidth(0.2);
            for (let y = marginTop; y < pageHeight - 15; y += lineHeight) {
              pdf.line(15, y, pageWidth - 15, y);
            }
          }
          
          // קו שוליים אדום
          pdf.setDrawColor(255, 107, 107);
          pdf.setLineWidth(0.4);
          pdf.line(pageWidth - marginRight + 5, 15, pageWidth - marginRight + 5, pageHeight - 10);
          
          // כתיבת הטקסט
          pdf.setFontSize(14);
          let y = marginTop;
          
          if (hasColoredContent && coloredLines) {
            // טקסט צבעוני
            for (let i = 0; i < linesPerPage && currentLine < coloredLines.length; i++) {
              const lineSegments = coloredLines[currentLine];
              
              if (!lineSegments || lineSegments.length === 0) {
                y += lineHeight;
                currentLine++;
                continue;
              }
              
              const fullLineText = lineSegments.map(s => s.text).join('');
              if (!fullLineText.trim()) {
                y += lineHeight;
                currentLine++;
                continue;
              }
              
              const hasHebrew = /[\u0590-\u05FF]/.test(fullLineText);
              
              if (hasHebrew) {
                let xPos = pageWidth - marginRight;
                const reversedSegments = [...lineSegments].reverse();
                
                for (const segment of reversedSegments) {
                  if (!segment.text) continue;
                  const rgb = colorToRGB(segment.color);
                  pdf.setTextColor(rgb.r, rgb.g, rgb.b);
                  const processedText = segment.text.split('').reverse().join('');
                  pdf.text(processedText, xPos, y, { align: 'right' });
                  xPos -= pdf.getTextWidth(processedText);
                }
              } else {
                let xPos = marginLeft;
                for (const segment of lineSegments) {
                  if (!segment.text) continue;
                  const rgb = colorToRGB(segment.color);
                  pdf.setTextColor(rgb.r, rgb.g, rgb.b);
                  pdf.text(segment.text, xPos, y, { align: 'left' });
                  xPos += pdf.getTextWidth(segment.text);
                }
              }
              
              y += lineHeight;
              currentLine++;
            }
          } else {
            // טקסט רגיל
            pdf.setTextColor(44, 62, 80);
          
            for (let i = 0; i < linesPerPage && currentLine < textLines.length; i++) {
              const line = textLines[currentLine];
              if (line && line.trim()) {
                const result = processLineForPDF(line);
                if (result.isRTL) {
                  pdf.text(result.text, pageWidth - marginRight, y, { align: 'right' });
                } else {
                  pdf.text(result.text, marginLeft, y, { align: 'left' });
                }
              }
              y += lineHeight;
              currentLine++;
            }
          }
        }
      }
    }
    
    // שמירת הקובץ
    const firstPage = notebook.pages && notebook.pages.length > 0 ? notebook.pages[0] : null;
    const pageTitle = firstPage && firstPage.title ? firstPage.title : 'ללא כותרת';
    const pageDate = firstPage && firstPage.date ? firstPage.date : '';
    const fileName = `${notebook.title}, ${pageTitle}, ${pageDate}.pdf`;
    pdf.save(fileName);
    
    document.body.removeChild(loadingMessage);
    alert(`המחברת "${notebook.title}" יוצאה בהצלחה! 🎉`);
    
  } catch (error) {
    console.error('שגיאה בייצוא PDF:', error);
    document.body.removeChild(loadingMessage);
    alert('אירעה שגיאה בייצוא ל-PDF. אנא נסה שוב.');
  }
},

loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
},

// ===== מערכת סרגל כלים חדשה - עיצוב טקסט כמו וורד =====

// פונקציה ראשית לעיצוב טקסט
applyTextFormat(command) {
  if (this.activeTextareaIndex === undefined) {
    alert('נא לבחור דף לעריכה');
    return;
  }

  const textarea = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  if (!textarea) return;

  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);

  // אם יש טקסט מסומן
  if (selectedText.length > 0) {
    const beforeText = textarea.value.substring(0, start);
    const afterText = textarea.value.substring(end);
    
    let newText = '';
    switch(command) {
      case 'bold':
        newText = `<b>${selectedText}</b>`;
        break;
      case 'italic':
        newText = `<i>${selectedText}</i>`;
        break;
      case 'underline':
        newText = `<u>${selectedText}</u>`;
        break;
      case 'strikethrough':
        newText = `<s>${selectedText}</s>`;
        break;
      default:
        newText = selectedText;
    }
    
    textarea.value = beforeText + newText + afterText;
    
    // שמור מיקום הסמן
    const newPos = start + newText.length;
    textarea.setSelectionRange(newPos, newPos);
    
    // המר ל-contentEditable אם יש HTML
    this.convertToRichText(this.activeTextareaIndex);
    
  } else {
    // אין טקסט מסומן - הצג הודעה
    alert('נא לסמן טקסט תחילה');
  }
  
  textarea.focus();
  this.updateToolbarButtons();
},

// המרת textarea ל-div עם contentEditable
convertToRichText(index) {
  const textarea = document.getElementById(`textarea-${index}`);
  if (!textarea || textarea.tagName !== 'TEXTAREA') return;
  
  const content = textarea.value;
  
  // רק אם יש תגי HTML
  if (!/<[^>]+>/.test(content)) return;
  
  // שמור את מיקום הסמן המקורי
  const cursorPos = textarea.selectionStart;
  
  // צור div חדש
  const div = document.createElement('div');
  div.id = `textarea-${index}`;
  div.className = textarea.className;
  div.contentEditable = 'true';
  div.innerHTML = content;
  
  // העתק סגנונות
  div.style.cssText = textarea.style.cssText;
  div.style.whiteSpace = 'pre-wrap';
  div.style.overflowWrap = 'break-word';
  
  // העתק אטריביוטים
  div.setAttribute('onfocus', `app.setActiveTextarea(${index})`);
  div.setAttribute('data-is-richtext', 'true');
  
  // החלף
  textarea.parentNode.replaceChild(div, textarea);
  
  // הוסף מאזינים
  div.addEventListener('input', () => {
    this.savePage(index, div.innerHTML);
  });
  
  div.addEventListener('blur', () => {
    this.savePage(index, div.innerHTML);
  });
  
  div.addEventListener('mouseup', () => {
    this.updateToolbarButtons();
  });
  
  div.addEventListener('keyup', () => {
    this.updateToolbarButtons();
  });
  
  div.focus();
  
  // החזר את הסמן למיקום המקורי
  setTimeout(() => {
    try {
      const range = document.createRange();
      const sel = window.getSelection();
      
      // נסה למצוא את המיקום הנכון בתוך הטקסט
      let charCount = 0;
      let foundPosition = false;
      
      const walkTextNodes = (node) => {
        if (foundPosition) return;
        
        if (node.nodeType === 3) { // Text node
          const textLength = node.textContent.length;
          if (charCount + textLength >= cursorPos) {
            const offset = Math.min(cursorPos - charCount, textLength);
            range.setStart(node, offset);
            range.collapse(true);
            foundPosition = true;
            return;
          }
          charCount += textLength;
        } else if (node.nodeType === 1) { // Element node
          for (let i = 0; i < node.childNodes.length; i++) {
            walkTextNodes(node.childNodes[i]);
            if (foundPosition) return;
          }
        }
      };
      
      walkTextNodes(div);
      
      if (foundPosition) {
        sel.removeAllRanges();
        sel.addRange(range);
      }
    } catch (e) {
      console.log('Could not restore cursor position');
    }
  }, 50);
  
  // שמור
  this.savePage(index, div.innerHTML);
  this.updateToolbarButtons();
},

// החל עיצוב אם האלמנט כבר contentEditable
applyRichFormat(command) {
  if (this.activeTextareaIndex === undefined) {
    alert('נא לבחור דף לעריכה');
    return;
  }

  const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  if (!element) return;
  
  // אם זה textarea רגיל, השתמש בפונקציה הרגילה
  if (element.tagName === 'TEXTAREA') {
    this.applyTextFormat(command);
    return;
  }
  
  // אם זה contentEditable, השתמש ב-execCommand
  element.focus();
  document.execCommand(command, false, null);
  this.savePage(this.activeTextareaIndex, element.innerHTML);
  
  setTimeout(() => this.updateToolbarButtons(), 10);
},

// עדכון מצב כפתורי הסרגל
updateToolbarButtons() {
  if (this.activeTextareaIndex === undefined) return;
  
  const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  if (!element || element.getAttribute('data-is-richtext') !== 'true') {
    // אם זה לא richtext, הסר את כל ההדגשות
    document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
    return;
  }
  
  // בדוק מצב כל פקודה
  const commands = {
    'inPageBold': 'bold',
    'inPageItalic': 'italic',
    'inPageUnderline': 'underline',
    'inPageStrike': 'strikethrough'
  };
  
  Object.keys(commands).forEach(btnId => {
    const btn = document.getElementById(btnId);
    if (btn) {
      const isActive = document.queryCommandState(commands[btnId]);
      if (isActive) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    }
  });
  
  // בדיקה מיוחדת לכפתור הסימון (Highlight)
  const selection = window.getSelection();
  if (selection.rangeCount > 0) {
    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;
    
    // בדוק אם הטקסט הנוכחי מודגש
    let parent = container.nodeType === 3 ? container.parentNode : container;
    let isHighlighted = false;
    
    // עלה בעץ ה-DOM לחפש רקע צהוב
    while (parent && parent !== element) {
      const bgColor = window.getComputedStyle(parent).backgroundColor;
      if (bgColor === 'rgb(255, 235, 59)' || // #ffeb3b
          bgColor === 'rgb(255, 255, 0)' ||   // yellow
          parent.style.backgroundColor === '#ffeb3b' ||
          parent.tagName === 'MARK') {
        isHighlighted = true;
        break;
      }
      parent = parent.parentNode;
    }
    
    // הדגש/בטל הדגשה של כפתור הסימון
    const highlightBtns = document.querySelectorAll('.toolbar-btn[onclick*="toolbarHighlight"]');
    highlightBtns.forEach(btn => {
      if (isHighlighted) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }
},

// המרה אוטומטית של דפים עם HTML בטעינה
autoConvertRichTextPages() {
  if (!this.currentNotebook) return;
  
  const notebook = this.subjects[this.currentNotebook];
  if (!notebook || !notebook.pages) return;
  
  // עבור על כל הדפים ובדוק אם יש HTML
  notebook.pages.forEach((page, index) => {
    if (page.content && /<[^>]+>/.test(page.content)) {
      // יש HTML בתוכן - המר לאחר שה-DOM נטען
      setTimeout(() => {
        const textarea = document.getElementById(`textarea-${index}`);
        if (textarea && textarea.tagName === 'TEXTAREA') {
          this.convertToRichText(index);
        }
      }, 100);
    }
  });
},

// כפתור Bold
toolbarBold() {
  const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  if (element && element.getAttribute('data-is-richtext') === 'true') {
    this.applyRichFormat('bold');
  } else {
    this.applyTextFormat('bold');
  }
},

// כפתור Italic
toolbarItalic() {
  const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  if (element && element.getAttribute('data-is-richtext') === 'true') {
    this.applyRichFormat('italic');
  } else {
    this.applyTextFormat('italic');
  }
},

// כפתור Underline
toolbarUnderline() {
  const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  if (element && element.getAttribute('data-is-richtext') === 'true') {
    this.applyRichFormat('underline');
  } else {
    this.applyTextFormat('underline');
  }
},

// כפתור Strikethrough
toolbarStrikethrough() {
  const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  if (element && element.getAttribute('data-is-richtext') === 'true') {
    this.applyRichFormat('strikethrough');
  } else {
    this.applyTextFormat('strikethrough');
  }
},

// הדגשת טקסט (Highlight) - עובד כמתג
toolbarHighlight() {
  if (this.activeTextareaIndex === undefined) {
    alert('נא לבחור דף לעריכה');
    return;
  }

  const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  if (!element) return;
  
  // מצא את כפתור ההדגשה
  const highlightBtn = document.getElementById('inPageHighlight') || 
                       document.querySelector('.toolbar-btn[onclick*="toolbarHighlight"]');
  
  if (element.getAttribute('data-is-richtext') === 'true') {
    // בדוק אם הכפתור כבר פעיל (מצב סימון דולק)
    const isButtonActive = highlightBtn && highlightBtn.classList.contains('active');
    
    if (isButtonActive) {
      // כבה את מצב הסימון - החזר לרקע רגיל
      document.execCommand('hiliteColor', false, 'white');
      if (highlightBtn) highlightBtn.classList.remove('active');
    } else {
      // הדלק את מצב הסימון
      document.execCommand('hiliteColor', false, '#ffeb3b');
      if (highlightBtn) highlightBtn.classList.add('active');
    }
    
    this.savePage(this.activeTextareaIndex, element.innerHTML);
    
  } else {
    // עבור textarea רגיל
    const start = element.selectionStart;
    const end = element.selectionEnd;
    const selectedText = element.value.substring(start, end);
    
    if (selectedText.length > 0) {
      const beforeText = element.value.substring(0, start);
      const afterText = element.value.substring(end);
      const highlighted = `<mark style="background-color: #ffeb3b; padding: 2px 4px; border-radius: 3px;">${selectedText}</mark>`;
      
      element.value = beforeText + highlighted + afterText;
      element.setSelectionRange(start + highlighted.length, start + highlighted.length);
      
      this.convertToRichText(this.activeTextareaIndex);
      
      // הדלק את הכפתור
      if (highlightBtn) highlightBtn.classList.add('active');
    } else {
      alert('נא לסמן טקסט תחילה');
    }
  }
  
  element.focus();
},

// הוספת קישור
toolbarInsertLink() {
  if (this.activeTextareaIndex === undefined) {
    alert('נא לבחור דף לעריכה');
    return;
  }

  const element = document.getElementById(`textarea-${this.activeTextareaIndex}`);
  if (!element) return;
  
  const url = prompt('הכנס כתובת URL:\n(לדוגמה: https://www.google.com)');
  if (!url) return;
  
  let linkText = '';
  
  if (element.getAttribute('data-is-richtext') === 'true') {
    const selection = window.getSelection();
    linkText = selection.toString() || prompt('הכנס טקסט להצגה:', url);
    if (!linkText) return;
    
    if (selection.toString()) {
      document.execCommand('createLink', false, url);
    } else {
      const link = `<a href="${url}" target="_blank" style="color: #667eea; text-decoration: underline;">${linkText}</a>`;
      document.execCommand('insertHTML', false, link);
    }
    
    this.savePage(this.activeTextareaIndex, element.innerHTML);
  } else {
    const start = element.selectionStart;
    const end = element.selectionEnd;
    const selectedText = element.value.substring(start, end);
    
    linkText = selectedText || prompt('הכנס טקסט להצגה:', url);
    if (!linkText) return;
    
    const beforeText = element.value.substring(0, start);
    const afterText = element.value.substring(end);
    const link = `<a href="${url}" target="_blank" style="color: #667eea; text-decoration: underline;">${linkText}</a>`;
    
    element.value = beforeText + link + afterText;
    element.setSelectionRange(start + link.length, start + link.length);
    
    this.convertToRichText(this.activeTextareaIndex);
  }
  
  element.focus();
},

toolbarInsertImage() {
  if (this.activeTextareaIndex === undefined) {
    alert('נא לבחור דף לעריכה');
    return;
  }

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      const pageContainer = document.querySelector(`#textarea-${this.activeTextareaIndex}`).closest('.lined-page, .grid-page, .blank-page');
      if (!pageContainer) return;
      
      // יצירת קונטיינר תמונה אינטראקטיבי
      this.createInteractiveImage(pageContainer, event.target.result, this.activeTextareaIndex);
    };
    
    reader.readAsDataURL(file);
  };
  
  input.click();
},

// יצירת תמונה אינטראקטיבית
createInteractiveImage(container, imageSrc, pageIndex) {
  const imageContainer = document.createElement('div');
  imageContainer.className = 'interactive-image-container';
  imageContainer.style.left = '100px';
  imageContainer.style.top = '100px';
  imageContainer.style.width = '200px';
  imageContainer.style.height = '200px';
  
  imageContainer.innerHTML = `
    <div class="image-controls">
<button class="image-control-btn" onclick="app.rotateImage(this)" title="סובב 90°">↻</button>
      <button class="image-control-btn" onclick="app.enableFreeRotation(this)" title="סובב חופשי">🔄</button>
      <button class="image-control-btn" onclick="app.flipImageH(this)" title="היפוך אופקי">↔️</button>
      <button class="image-control-btn" onclick="app.flipImageV(this)" title="היפוך אנכי">↕️</button>
      <button class="image-control-btn" onclick="app.deleteImage(this)" title="מחק">🗑️</button>
    </div>
    <img src="${imageSrc}" draggable="false">
    <div class="resize-handle nw"></div>
    <div class="resize-handle ne"></div>
    <div class="resize-handle sw"></div>
    <div class="resize-handle se"></div>
  `;
  
  container.appendChild(imageContainer);
  
  // הוספת אירועי גרירה
  this.makeImageDraggable(imageContainer);
  
  // הוספת אירועי שינוי גודל
  this.makeImageResizable(imageContainer);
  
  // בחירת התמונה
  imageContainer.addEventListener('click', (e) => {
    e.stopPropagation();
    this.selectImage(imageContainer);
  });
},

// בחירת תמונה
selectImage(imageContainer) {
  // ביטול בחירה מכל התמונות האחרות
  document.querySelectorAll('.interactive-image-container').forEach(img => {
    img.classList.remove('selected');
  });
  
  // בחירת התמונה הנוכחית
  imageContainer.classList.add('selected');
},

// גרירת תמונה
makeImageDraggable(element) {
  let isDragging = false;
  let currentX;
  let currentY;
  let initialX;
  let initialY;
  
  element.addEventListener('mousedown', (e) => {
    // רק אם לוחצים על התמונה עצמה, לא על הכפתורים או הידיות
    if (e.target.classList.contains('image-control-btn') || 
        e.target.classList.contains('resize-handle')) {
      return;
    }
    
    isDragging = true;
    initialX = e.clientX - element.offsetLeft;
    initialY = e.clientY - element.offsetTop;
    
    element.style.cursor = 'grabbing';
  });
  
  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    
    e.preventDefault();
    currentX = e.clientX - initialX;
    currentY = e.clientY - initialY;
    
    element.style.left = currentX + 'px';
    element.style.top = currentY + 'px';
  });
  
  document.addEventListener('mouseup', () => {
    if (isDragging) {
      isDragging = false;
      element.style.cursor = 'move';
    }
  });
},

// שינוי גודל תמונה
makeImageResizable(element) {
  const handles = element.querySelectorAll('.resize-handle');
  
  handles.forEach(handle => {
    handle.addEventListener('mousedown', (e) => {
      e.stopPropagation();
      
      const startX = e.clientX;
      const startY = e.clientY;
      const startWidth = element.offsetWidth;
      const startHeight = element.offsetHeight;
      const startLeft = element.offsetLeft;
      const startTop = element.offsetTop;
      const handleClass = handle.className.split(' ')[1];
      
      const onMouseMove = (e) => {
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
const aspectRatio = startWidth / startHeight;
        
        if (handleClass === 'se') {
          const newWidth = startWidth + deltaX;
          const newHeight = newWidth / aspectRatio;
          element.style.width = newWidth + 'px';
          element.style.height = newHeight + 'px';
        } else if (handleClass === 'sw') {
          const newWidth = startWidth - deltaX;
          const newHeight = newWidth / aspectRatio;
          element.style.width = newWidth + 'px';
          element.style.height = newHeight + 'px';
          element.style.left = (startLeft + deltaX) + 'px';
        } else if (handleClass === 'ne') {
          const newWidth = startWidth + deltaX;
          const newHeight = newWidth / aspectRatio;
          element.style.width = newWidth + 'px';
          element.style.height = newHeight + 'px';
          element.style.top = (startTop - (newHeight - startHeight)) + 'px';
        } else if (handleClass === 'nw') {
          const newWidth = startWidth - deltaX;
          const newHeight = newWidth / aspectRatio;
          element.style.width = newWidth + 'px';
          element.style.height = newHeight + 'px';
          element.style.left = (startLeft + deltaX) + 'px';
          element.style.top = (startTop - (newHeight - startHeight)) + 'px';
        }
      };
      
      const onMouseUp = () => {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      };
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });
  });
},

// סיבוב תמונה
rotateImage(button) {
  const container = button.closest('.interactive-image-container');
  const img = container.querySelector('img');
  const currentRotation = parseInt(img.dataset.rotation || '0');
  const newRotation = currentRotation + 90;
  
  img.dataset.rotation = newRotation;
  img.style.transform = `rotate(${newRotation}deg)`;
},

// הפעלת מצב סיבוב חופשי
enableFreeRotation(button) {
  const container = button.closest('.interactive-image-container');
  const img = container.querySelector('img');
  
  // שינוי צבע הכפתור להצגת מצב פעיל
  button.style.background = 'var(--primary-color)';
  button.style.color = 'white';
  button.textContent = '🔄';
  
  let isRotating = false;
  let startAngle = 0;
  let currentRotation = parseInt(container.dataset.rotation || '0');
  
  const centerX = container.offsetLeft + container.offsetWidth / 2;
  const centerY = container.offsetTop + container.offsetHeight / 2;
  
  const onMouseDown = (e) => {
    if (!container.classList.contains('selected')) return;
    
    isRotating = true;
    const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
    startAngle = angle - (currentRotation * Math.PI / 180);
    
    container.style.cursor = 'grab';
    e.stopPropagation();
  };
  
  const onMouseMove = (e) => {
    if (!isRotating) return;
    
    const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
    const rotation = ((angle - startAngle) * 180 / Math.PI);
    
    container.style.transform = `rotate(${rotation}deg)`;
    container.dataset.rotation = rotation;
  };
  
  const onMouseUp = () => {
    if (isRotating) {
      isRotating = false;
      container.style.cursor = 'move';
      currentRotation = parseInt(container.dataset.rotation || '0');
      
      // כיבוי מצב הסיבוב
      button.style.background = '';
      button.style.color = '';
      
      // הסרת מאזינים
      document.removeEventListener('mousedown', onMouseDown);
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    }
  };
  
  document.addEventListener('mousedown', onMouseDown);
  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
},

// היפוך אופקי
flipImageH(button) {
  const container = button.closest('.interactive-image-container');
  const img = container.querySelector('img');
  const currentFlip = img.dataset.flipH === 'true';
  
  img.dataset.flipH = !currentFlip;
  img.style.transform = `scaleX(${currentFlip ? '1' : '-1'})`;
},

// היפוך אנכי
flipImageV(button) {
  const container = button.closest('.interactive-image-container');
  const img = container.querySelector('img');
  const currentFlip = img.dataset.flipV === 'true';
  
  img.dataset.flipV = !currentFlip;
  img.style.transform = `scaleY(${currentFlip ? '1' : '-1'})`;
},

// מחיקת תמונה
deleteImage(button) {
  if (confirm('האם למחוק את התמונה?')) {
    const container = button.closest('.interactive-image-container');
    container.remove();
  }
},

// ===== PDF Upload & Viewer =====

toolbarInsertPDF() {
  if (this.activeTextareaIndex === undefined) {
    alert('נא לבחור דף לעריכה');
    return;
  }

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/pdf';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    if (file.type !== 'application/pdf') {
      alert('יש להעלות קובץ PDF בלבד');
      return;
    }
    
    const pageContainer = document.querySelector(`#textarea-${this.activeTextareaIndex}`).closest('.lined-page, .grid-page, .blank-page');
    if (!pageContainer) return;
    
    // קריאת הקובץ
    const reader = new FileReader();
    reader.onload = async (event) => {
      await this.createPDFViewer(pageContainer, event.target.result, file.name, this.activeTextareaIndex);
    };
    
    reader.readAsDataURL(file);
  };
  
  input.click();
},

// יצירת PDF Viewer
async createPDFViewer(container, pdfData, fileName, pageIndex) {
  // טעינת PDF.js אם עדיין לא נטען
  if (typeof pdfjsLib === 'undefined') {
    await this.loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }
  
  const viewerContainer = document.createElement('div');
  viewerContainer.className = 'pdf-viewer-container';
  viewerContainer.style.left = '150px';
  viewerContainer.style.top = '150px';
  viewerContainer.style.width = '500px';
  
  viewerContainer.innerHTML = `
    <div class="pdf-viewer-header">
      <div class="pdf-viewer-title">
        <span>📄</span>
        <span>${fileName}</span>
      </div>
      <div class="pdf-viewer-controls">
        <button class="pdf-control-btn" onclick="app.minimizePDF(this)" title="מזער">−</button>
        <button class="pdf-control-btn" onclick="app.maximizePDF(this)" title="הגדל">□</button>
        <button class="pdf-control-btn" onclick="app.closePDF(this)" title="סגור">✕</button>
      </div>
    </div>
    <div class="pdf-viewer-body" id="pdf-body-${Date.now()}"></div>
    <div class="pdf-viewer-footer">
      <div class="pdf-page-nav">
        <button class="pdf-nav-btn" onclick="app.prevPDFPage(this)">◀ הקודם</button>
        <span class="pdf-page-info">עמוד <span class="current-page">1</span> מתוך <span class="total-pages">-</span></span>
        <button class="pdf-nav-btn" onclick="app.nextPDFPage(this)">הבא ▶</button>
      </div>
      <button class="pdf-nav-btn" onclick="app.downloadPDF(this)" title="הורד PDF">💾 הורד</button>
    </div>
    <div class="resize-handle se"></div>
  `;
  
  container.appendChild(viewerContainer);
  
  // שמירת נתוני PDF
  viewerContainer.dataset.pdfData = pdfData;
  viewerContainer.dataset.fileName = fileName;
  viewerContainer.dataset.currentPage = '1';
  
  // טעינת PDF
  try {
    const loadingTask = pdfjsLib.getDocument(pdfData);
    const pdf = await loadingTask.promise;
    
    viewerContainer.dataset.totalPages = pdf.numPages;
    viewerContainer.querySelector('.total-pages').textContent = pdf.numPages;
    
    // רינדור עמוד ראשון
    await this.renderPDFPage(viewerContainer, pdf, 1);
    
    // הוספת יכולות גרירה
    this.makePDFDraggable(viewerContainer);
    
    // הוספת יכולות שינוי גודל
    this.makePDFResizable(viewerContainer);
    
    // בחירת ה-PDF
    viewerContainer.addEventListener('click', (e) => {
      if (!e.target.closest('.pdf-control-btn') && !e.target.closest('.pdf-nav-btn')) {
        this.selectPDF(viewerContainer);
      }
    });
    
  } catch (error) {
    console.error('שגיאה בטעינת PDF:', error);
    alert('שגיאה בטעינת קובץ ה-PDF');
    viewerContainer.remove();
  }
},

// רינדור עמוד PDF
async renderPDFPage(viewerContainer, pdf, pageNumber) {
  const page = await pdf.getPage(pageNumber);
  const viewport = page.getViewport({ scale: 1.5 });
  
  const body = viewerContainer.querySelector('.pdf-viewer-body');
  body.innerHTML = '';
  
  const canvas = document.createElement('canvas');
  canvas.className = 'pdf-page-canvas';
  const context = canvas.getContext('2d');
  
  canvas.height = viewport.height;
  canvas.width = viewport.width;
  
  body.appendChild(canvas);
  
  const renderContext = {
    canvasContext: context,
    viewport: viewport
  };
  
  await page.render(renderContext).promise;
  
  viewerContainer.querySelector('.current-page').textContent = pageNumber;
  viewerContainer.dataset.currentPage = pageNumber;
  
  // עדכון כפתורי הניווט
  const prevBtn = viewerContainer.querySelector('.pdf-nav-btn:first-child');
  const nextBtn = viewerContainer.querySelector('.pdf-nav-btn:nth-child(3)');
  
  prevBtn.disabled = pageNumber === 1;
  nextBtn.disabled = pageNumber === parseInt(viewerContainer.dataset.totalPages);
},

// בחירת PDF
selectPDF(viewerContainer) {
  document.querySelectorAll('.pdf-viewer-container').forEach(pdf => {
    pdf.classList.remove('selected');
  });
  viewerContainer.classList.add('selected');
},

// גרירת PDF
makePDFDraggable(element) {
  const header = element.querySelector('.pdf-viewer-header');
  let isDragging = false;
  let currentX, currentY, initialX, initialY;
  
  header.addEventListener('mousedown', (e) => {
    if (e.target.classList.contains('pdf-control-btn')) return;
    
    isDragging = true;
    initialX = e.clientX - element.offsetLeft;
    initialY = e.clientY - element.offsetTop;
  });
  
  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    
    e.preventDefault();
    currentX = e.clientX - initialX;
    currentY = e.clientY - initialY;
    
    element.style.left = currentX + 'px';
    element.style.top = currentY + 'px';
  });
  
  document.addEventListener('mouseup', () => {
    isDragging = false;
  });
},

// שינוי גודל PDF
makePDFResizable(element) {
  const handle = element.querySelector('.resize-handle.se');
  
  handle.addEventListener('mousedown', (e) => {
    e.stopPropagation();
    
    const startX = e.clientX;
    const startY = e.clientY;
    const startWidth = element.offsetWidth;
    const startHeight = element.offsetHeight;
    
    const onMouseMove = (e) => {
      const deltaX = e.clientX - startX;
      const deltaY = e.clientY - startY;
      
      element.style.width = (startWidth + deltaX) + 'px';
      element.style.height = (startHeight + deltaY) + 'px';
    };
    
    const onMouseUp = () => {
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    };
    
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  });
},

// ניווט בין עמודים
async prevPDFPage(button) {
  const container = button.closest('.pdf-viewer-container');
  const currentPage = parseInt(container.dataset.currentPage);
  
  if (currentPage > 1) {
    const pdfData = container.dataset.pdfData;
    const loadingTask = pdfjsLib.getDocument(pdfData);
    const pdf = await loadingTask.promise;
    
    await this.renderPDFPage(container, pdf, currentPage - 1);
  }
},

async nextPDFPage(button) {
  const container = button.closest('.pdf-viewer-container');
  const currentPage = parseInt(container.dataset.currentPage);
  const totalPages = parseInt(container.dataset.totalPages);
  
  if (currentPage < totalPages) {
    const pdfData = container.dataset.pdfData;
    const loadingTask = pdfjsLib.getDocument(pdfData);
    const pdf = await loadingTask.promise;
    
    await this.renderPDFPage(container, pdf, currentPage + 1);
  }
},

// פקדי חלון
minimizePDF(button) {
  const container = button.closest('.pdf-viewer-container');
  const body = container.querySelector('.pdf-viewer-body');
  const footer = container.querySelector('.pdf-viewer-footer');
  
  if (body.style.display === 'none') {
    body.style.display = 'flex';
    footer.style.display = 'flex';
    button.textContent = '−';
  } else {
    body.style.display = 'none';
    footer.style.display = 'none';
    button.textContent = '+';
  }
},

maximizePDF(button) {
  const container = button.closest('.pdf-viewer-container');
  
  if (container.dataset.maximized === 'true') {
    container.style.width = container.dataset.originalWidth;
    container.style.height = container.dataset.originalHeight;
    container.style.left = container.dataset.originalLeft;
    container.style.top = container.dataset.originalTop;
    container.dataset.maximized = 'false';
  } else {
    container.dataset.originalWidth = container.style.width;
    container.dataset.originalHeight = container.style.height;
    container.dataset.originalLeft = container.style.left;
    container.dataset.originalTop = container.style.top;
    
    container.style.width = '90%';
    container.style.height = '90%';
    container.style.left = '5%';
    container.style.top = '5%';
    container.dataset.maximized = 'true';
  }
},

closePDF(button) {
  if (confirm('האם לסגור את קובץ ה-PDF?')) {
    const container = button.closest('.pdf-viewer-container');
    container.remove();
  }
},

downloadPDF(button) {
  const container = button.closest('.pdf-viewer-container');
  const pdfData = container.dataset.pdfData;
  const fileName = container.dataset.fileName;
  
  const link = document.createElement('a');
  link.href = pdfData;
  link.download = fileName;
  link.click();
},

// Format text functions - גרסה מתוקנת
formatText(command) {
  const pageContent = document.querySelector('.notebook-page-content');
  if (!pageContent) return;
  
  // מוודא שהאזור ממוקד
  pageContent.focus();
  
  const selection = window.getSelection();
  const hasSelection = selection && selection.toString().length > 0;
  
  if (hasSelection) {
    // אם יש טקסט מסומן - החל עליו את העיצוב
    document.execCommand(command, false, null);
  } else {
    // אם אין טקסט מסומן - הפעל/כבה את המצב ל"מכאן והלאה"
    document.execCommand(command, false, null);
  }
  
  this.saveNotebookData();
},

// Highlight text function - גרסה מתוקנת
highlightText() {
  const pageContent = document.querySelector('.notebook-page-content');
  if (!pageContent) return;
  
  pageContent.focus();
  
  const selection = window.getSelection();
  const hasSelection = selection && selection.toString().length > 0;
  
  if (hasSelection) {
    // השתמש ב-execCommand שעובד טוב יותר
    document.execCommand('backColor', false, '#ffeb3b');
  } else {
    // הפעל מצב הדגשה
    document.execCommand('backColor', false, '#ffeb3b');
  }
  
  this.saveNotebookData();
},

// Insert link function - גרסה מתוקנת
insertLink() {
  const pageContent = document.querySelector('.notebook-page-content');
  if (!pageContent) return;
  
  pageContent.focus();
  
  const selection = window.getSelection();
  const selectedText = selection.toString().trim();
  
  const url = prompt('הכנס כתובת URL:');
  if (!url) return;
  
  let displayText = selectedText;
  
  // אם אין טקסט מסומן, בקש מהמשתמש טקסט להצגה
  if (!displayText) {
    displayText = prompt('הכנס טקסט להצגה:', url);
    if (!displayText) return;
  }
  
  // אם יש טקסט מסומן, השתמש ב-execCommand
  if (selectedText) {
    document.execCommand('createLink', false, url);
  } else {
    // אם אין בחירה, צור קישור ידנית
    const link = document.createElement('a');
    link.href = url;
    link.textContent = displayText;
    link.target = '_blank';
    link.style.color = '#667eea';
    link.style.textDecoration = 'underline';
    
    const range = selection.getRangeAt(0);
    range.insertNode(link);
    
    // הוסף רווח אחרי הקישור
    const space = document.createTextNode(' ');
    range.setStartAfter(link);
    range.insertNode(space);
    range.setStartAfter(space);
    range.collapse(true);
    selection.removeAllRanges();
    selection.addRange(range);
  }
  
  this.saveNotebookData();
},

// Insert image function - ללא שינוי
insertImage() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      const pageContent = document.querySelector('.notebook-page-content');
      if (pageContent) {
        const img = document.createElement('img');
        img.src = event.target.result;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        img.style.margin = '10px 0';
        img.style.borderRadius = '8px';
        img.style.display = 'block';
        
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.insertNode(img);
          
          // הוסף שורה חדשה אחרי התמונה
          const br = document.createElement('br');
          range.setStartAfter(img);
          range.insertNode(br);
          range.setStartAfter(br);
          range.collapse(true);
          selection.removeAllRanges();
          selection.addRange(range);
        } else {
          pageContent.appendChild(img);
          pageContent.appendChild(document.createElement('br'));
        }
        
        this.saveNotebookData();
      }
    };
    
    reader.readAsDataURL(file);
  };
  
  input.click();
},

      // שמירת נתוני מחברות
      saveNotebookData: async function() {
        try {
          // שמירה ב-localStorage (תמיד)
          localStorage.setItem('notebookData', JSON.stringify(this.subjects));
          
          // שמירה ב-Supabase (אם זמין)
          await saveToSupabase('notebook_data', this.subjects);
        } catch (error) {
          console.error('שגיאה בשמירת נתונים:', error);
        }
      },

      // טעינת נתוני מחברות
      loadNotebookData: async function() {
        try {
          console.log('📚 טוען נתוני מחברות...');
          
          // ניסיון לטעון מ-Supabase קודם
          const cloudData = await loadFromSupabase('notebook_data');
          
          if (cloudData && Object.keys(cloudData).length > 0) {
            // יש נתונים בענן - החלף את ברירות המחדל לגמרי
            console.log('✅ נטען מהענן - מחברות');
            this.subjects = cloudData;
            // שמור גם ב-localStorage כגיבוי
            localStorage.setItem('notebookData', JSON.stringify(cloudData));
          } else {
            // אין נתונים בענן - השתמש בברירות המחדל (כבר מוגדרות ב-subjects)
            console.log('📓 משתמש חדש - טוען מחברות ברירת מחדל');
            // שמור את ברירות המחדל בענן
            await this.saveNotebookData();
          }
        } catch (error) {
          console.error('שגיאה בטעינת נתונים:', error);
        }
      },

      // === פונקציות משימות ===

      // טעינת נתוני משימות
      loadTaskData: async function() {
        try {
          console.log('📋 טוען נתוני משימות...');
          
          // ניסיון לטעון מ-Supabase קודם
          const cloudData = await loadFromSupabase('task_data');
          
          if (cloudData && cloudData.length > 0) {
            // יש נתונים בענן
            console.log('✅ נטען מהענן - משימות');
            this.tasks = cloudData;
            localStorage.setItem('taskData', JSON.stringify(cloudData));
          } else {
            // אין נתונים בענן - התחל ריק
            console.log('⚠️ אין נתונים בענן - התחל ריק');
            // יצירת משימות לדוגמה
            this.tasks = [
              {
                id: (Date.now() + 1).toString(),
                title: 'לסיים מטלה במתמטיקה',
                description: 'פתרון תרגילים בעמודים 45-50',
                category: 'מטלות',
                priority: 'high',
                dueDate: new Date().toISOString().split('T')[0],
                completed: false,
                createdAt: new Date().toISOString()
              },
              {
                id: (Date.now() + 2).toString(),
                title: 'קריאה לבחינת היסטוריה',
                description: 'פרק 3: מלחמת העצמאות',
                category: 'בחינות',
                priority: 'medium',
                dueDate: this.getDateInDays(3),
                completed: false,
                createdAt: new Date().toISOString()
              },
              {
                id: (Date.now() + 3).toString(),
                title: 'הכנת פרויקט מדעים',
                description: 'מחקר על מערכת השמש',
                category: 'פרויקטים',
                priority: 'medium',
                dueDate: this.getDateInDays(7),
                completed: true,
                createdAt: new Date().toISOString()
              }
            ];
            await this.saveTaskData();
          }
        } catch (error) {
          console.error('שגיאה בטעינת משימות:', error);
          this.tasks = [];
        }
      },

      // שמירת נתוני משימות
      saveTaskData: async function() {
        try {
          localStorage.setItem('taskData', JSON.stringify(this.tasks));
          await saveToSupabase('task_data', this.tasks);
        } catch (error) {
          console.error('שגיאה בשמירת משימות:', error);
        }
      },

      // עזר: קבלת תאריך בעוד X ימים
      getDateInDays(days) {
        const date = new Date();
        date.setDate(date.getDate() + days);
        return date.toISOString().split('T')[0];
      },

      // רינדור משימות
      renderTasks() {
        const container = document.getElementById('tasksList');
        if (!container) return;

        const filteredTasks = this.getFilteredTasks();
        
        if (filteredTasks.length === 0) {
          container.innerHTML = this.getEmptyTasksHTML();
          return;
        }

        container.innerHTML = '';
        
        filteredTasks.forEach(task => {
          const taskElement = this.createTaskCard(task);
          container.appendChild(taskElement);
        });
      },

      // קבלת משימות מסוננות
      getFilteredTasks() {
        const today = new Date().toISOString().split('T')[0];
        switch (this.currentFilter) {
          case 'pending':
            return this.tasks.filter(task => !task.completed);
          case 'completed':
            return this.tasks.filter(task => task.completed);
          case 'today':
            return this.tasks.filter(task => task.dueDate === today && !task.completed);
          case 'overdue':
            return this.tasks.filter(task => 
              task.dueDate < today && !task.completed
            );
          default:
            return [...this.tasks].sort((a, b) => {
              // מיון: לא הושלמו קודם, אחר כך לפי עדיפות, אחר כך לפי תאריך
              if (a.completed !== b.completed) {
                return a.completed ? 1 : -1;
              }
              
              const priorityOrder = { high: 0, medium: 1, low: 2 };
              if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                return priorityOrder[a.priority] - priorityOrder[b.priority];
              }
              
              return new Date(a.dueDate) - new Date(b.dueDate);
            });
        }
      },

      // יצירת כרטיס משימה
      createTaskCard(task) {
        const taskDiv = document.createElement('div');
        taskDiv.className = `task-card ${task.completed ? 'completed' : ''}`;
        
        const dueDateText = this.formatDueDate(task.dueDate);
        const dueTimeText = task.dueTime ? ` בשעה ${task.dueTime}` : '';
        const dueDateClass = this.getDueDateClass(task.dueDate, task.completed);
        
        taskDiv.innerHTML = `
          <div class="task-priority ${task.priority}"></div>
          <div class="task-header">
            <div>
              <div class="task-title">${task.title}</div>
              <span class="task-category">${task.category}</span>
            </div>
          </div>
          <div class="task-content">
            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
          </div>
          <div class="task-footer">
            <div class="task-due-date ${dueDateClass}">
              <span>📅</span>
              ${dueDateText}${dueTimeText}
            </div>
            <div class="task-actions">
              ${!task.completed ? 
                `<button class="task-btn complete-btn" onclick="app.toggleTaskComplete('${task.id}')">
                  ✅ סיים
                </button>` : 
                `<button class="task-btn complete-btn" onclick="app.toggleTaskComplete('${task.id}')" style="background: var(--completed-task)">
                  ↩️ בטל
                </button>`
              }
              <button class="task-btn edit-btn" onclick="app.editTask('${task.id}')">
                ✏️ ערוך
              </button>
              <button class="task-btn delete-btn" onclick="app.deleteTask('${task.id}')">
                🗑️ מחק
              </button>
            </div>
          </div>
        `;
        
        return taskDiv;
      },

      // עיצוב תאריך יעד
      formatDueDate(dueDate) {
        const today = new Date().toISOString().split('T')[0];
        const tomorrow = this.getDateInDays(1);
        const yesterday = this.getDateInDays(-1);
        
        if (dueDate === today) return 'היום';
        if (dueDate === tomorrow) return 'מחר';
        if (dueDate === yesterday) return 'אתמול';
        
        const date = new Date(dueDate);
        return date.toLocaleDateString('he-IL');
      },

      // קבלת מחלקת CSS לתאריך יעד
      getDueDateClass(dueDate, completed) {
        if (completed) return '';
        
        const today = new Date().toISOString().split('T')[0];
        
        if (dueDate < today) return 'overdue';
        if (dueDate === today) return 'today';
        return '';
      },

      // HTML למצב ריק
      getEmptyTasksHTML() {
        const messages = {
          all: { icon: '📝', title: 'אין משימות', desc: 'התחל ביצירת המשימה הראשונה שלך!' },
          pending: { icon: '✅', title: 'כל המשימות הושלמו!', desc: 'עבודה מצוינת! כל המשימות הושלמו בהצלחה.' },
          completed: { icon: '📝', title: 'אין משימות שהושלמו', desc: 'כשתסיים משימות הן יופיעו כאן.' },
          today: { icon: '📅', title: 'אין משימות להיום', desc: 'נהדר! אין משימות דחופות להיום.' },
          overdue: { icon: '⏰', title: 'אין משימות באיחור', desc: 'מצוין! אתה עומד בלוחות הזמנים.' }
        };
        
        const msg = messages[this.currentFilter] || messages.all;
        
        return `
          <div class="empty-state">
            <div class="empty-icon">${msg.icon}</div>
            <div class="empty-title">${msg.title}</div>
            <div class="empty-description">${msg.desc}</div>
          </div>
        `;
      },

      // עדכון סטטיסטיקות משימות
      updateTaskStats() {
        const total = this.tasks.length;
        const pending = this.tasks.filter(task => !task.completed).length;
        const completed = this.tasks.filter(task => task.completed).length;
        const today = new Date().toISOString().split('T')[0];
        const overdue = this.tasks.filter(task => 
          task.dueDate < today && !task.completed
        ).length;

        document.getElementById('totalTasks').textContent = total;
        document.getElementById('pendingTasks').textContent = pending;
        document.getElementById('completedTasks').textContent = completed;
        document.getElementById('overdueTasks').textContent = overdue;
      },

      // סינון משימות
      filterTasks(filter) {
        this.currentFilter = filter;
        
        // עדכון כפתורי סינון
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.filter === filter) {
            btn.classList.add('active');
          }
        });
        
        this.renderTasks();
      },

      // בחירת עדיפות
      selectPriority(priority) {
        this.selectedPriority = priority;
        
        document.querySelectorAll('.priority-option').forEach(option => {
          option.classList.remove('selected');
        });
        
        document.querySelectorAll('.priority-option').forEach(option => {
          if (option.dataset.priority === priority) {
            option.classList.add('selected');
          }
        });
      },

      // יצירת משימה חדשה
      createTask() {
        // בדיקת מגבלת משימות פעילות
        if (!this.canAddTask()) {
          return;
        }
        
        const title = document.getElementById('taskTitle').value.trim();
        const description = document.getElementById('taskDescription').value.trim();
        const category = document.getElementById('taskCategory').value;
        const dueDate = document.getElementById('taskDueDate').value;
        const dueTime = document.getElementById('taskDueTime').value;
        
        if (!title) {
          alert('נא להזין כותרת למשימה');
          return;
        }
        
        if (!dueDate) {
          alert('נא לבחור תאריך יעד');
          return;
        }
        
        if (!dueTime) {
          alert('נא לבחור שעת יעד');
          return;
        }
        
        const newTask = {
          id: Date.now().toString(),
          title,
          description,
          category,
          priority: this.selectedPriority,
          dueDate,
          dueTime,
          completed: false,
          createdAt: new Date().toISOString()
        };
        
        this.tasks.unshift(newTask);
        this.saveTaskData();
        this.renderTasks();
        this.updateTaskStats();
        this.loadWelcomeData();
        
        // ניקוי הטופס
        this.clearTaskForm();
        
        alert('המשימה נוצרה בהצלחה! 🎉');
        
        // שליחת התראה על משימה חדשה
        this.sendPushNotification(
          '✨ משימה חדשה נוספה',
          `${newTask.title} - עד ${newTask.dueDate} בשעה ${newTask.dueTime}`
        );
      },

      // ניקוי טופס משימה
      clearTaskForm() {
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDescription').value = '';
        document.getElementById('taskCategory').selectedIndex = 0;
        document.getElementById('taskDueDate').value = '';
        document.getElementById('taskDueTime').value = '';
        this.selectPriority('medium');
      },

      // החלפת מצב השלמת משימה
      toggleTaskComplete(taskId) {
        const task = this.tasks.find(t => t.id === taskId);
        if (task) {
          task.completed = !task.completed;
          task.completedAt = task.completed ? new Date().toISOString() : null;
          
          this.saveTaskData();
          this.renderTasks();
          this.updateTaskStats();
          this.loadWelcomeData();
        }
      },

      // עריכת משימה
      editTask(taskId) {
        const task = this.tasks.find(t => t.id === taskId);
        if (!task) return;
        
        this.editingTaskId = taskId;
        
        // מילוי הטופס
        document.getElementById('editTaskTitle').value = task.title;
        document.getElementById('editTaskDescription').value = task.description;
        document.getElementById('editTaskCategory').value = task.category;
        document.getElementById('editTaskDueDate').value = task.dueDate;
        document.getElementById('editTaskDueTime').value = task.dueTime || '';
        
        // עדכון עדיפות
        document.querySelectorAll('#editPriorityOptions .priority-option').forEach(option => {
          option.classList.remove('selected');
          if (option.dataset.priority === task.priority) {
            option.classList.add('selected');
          }
        });
        
        // פתיחת המודל
        document.getElementById('taskEditModal').classList.add('show');
      },

      // בחירת עדיפות בעריכה
      selectEditPriority(priority) {
        document.querySelectorAll('#editPriorityOptions .priority-option').forEach(option => {
          option.classList.remove('selected');
          if (option.dataset.priority === priority) {
            option.classList.add('selected');
          }
        });
      },

      // שמירת עריכת משימה
      saveTaskEdit() {
        const task = this.tasks.find(t => t.id === this.editingTaskId);
        if (!task) return;
        
        const title = document.getElementById('editTaskTitle').value.trim();
        const description = document.getElementById('editTaskDescription').value.trim();
        const category = document.getElementById('editTaskCategory').value;
        const dueDate = document.getElementById('editTaskDueDate').value;
        const dueTime = document.getElementById('editTaskDueTime').value;
        const priority = document.querySelector('#editPriorityOptions .priority-option.selected')?.dataset.priority || 'medium';
        
        if (!title) {
          alert('נא להזין כותרת למשימה');
          return;
        }
        
        if (!dueDate) {
          alert('נא לבחור תאריך יעד');
          return;
        }
        
        if (!dueTime) {
          alert('נא לבחור שעת יעד');
          return;
        }
        
        // עדכון המשימה
        task.title = title;
        task.description = description;
        task.category = category;
        task.priority = priority;
        task.dueDate = dueDate;
        task.dueTime = dueTime;
        task.updatedAt = new Date().toISOString();
        
        this.saveTaskData();
        this.renderTasks();
        this.updateTaskStats();
        this.closeTaskEditModal();
        
        alert('המשימה עודכנה בהצלחה! ✅');
      },

      // סגירת מודל עריכה
      closeTaskEditModal() {
        document.getElementById('taskEditModal').classList.remove('show');
        this.editingTaskId = null;
      },

      // מחיקת משימה
      deleteTask(taskId) {
        const task = this.tasks.find(t => t.id === taskId);
        if (!task) return;
        
        if (confirm(`האם אתה בטוח שברצונך למחוק את המשימה "${task.title}"?\n\nפעולה זו לא ניתנת לביטול.`)) {
          this.tasks = this.tasks.filter(t => t.id !== taskId);
          this.saveTaskData();
          this.renderTasks();
          this.updateTaskStats();
          this.loadWelcomeData();
          
          alert('המשימה נמחקה בהצלחה.');
        }
      },

      // === פונקציות לוח שנה ===

      // טעינת נתוני לוח שנה
      loadCalendarData: async function() {
        try {
          console.log('📅 טוען נתוני לוח שנה...');
          
          // ניסיון לטעון מ-Supabase קודם
          const cloudData = await loadFromSupabase('calendar_data');
          
          if (cloudData && cloudData.length > 0) {
            // יש נתונים בענן
            console.log('✅ נטען מהענן - לוח שנה');
            this.events = cloudData;
            localStorage.setItem('calendarData', JSON.stringify(cloudData));
          } else {
            // אין נתונים בענן - התחל ריק
            console.log('⚠️ אין נתונים בענן - התחל ריק');
            // יצירת אירועים לדוגמה
            this.events = [
              {
                id: (Date.now() + 1).toString(),
                title: 'בחינת מתמטיקה',
                type: 'exam',
                date: new Date().toISOString().split('T')[0],
                startTime: '09:00',
                endTime: '11:00',
                description: 'בחינת הצבה באלגברה',
                location: 'כיתה 15',
                createdAt: new Date().toISOString()
              },
              {
                id: (Date.now() + 2).toString(),
                title: 'שיעור פיזיקה',
                type: 'lesson',
                date: this.getDateInDays(1),
                startTime: '10:00',
                endTime: '11:30',
                description: 'חוקי ניוטון',
                location: 'מעבדת מדעים',
                createdAt: new Date().toISOString()
              },
              {
                id: (Date.now() + 3).toString(),
                title: 'הגשת פרויקט',
                type: 'assignment',
                date: this.getDateInDays(5),
                startTime: '23:59',
                endTime: '23:59',
                description: 'הגשת פרויקט מדעים על מערכת השמש',
                location: '',
                createdAt: new Date().toISOString()
              }
            ];
            await this.saveCalendarData();
          }
        } catch (error) {
          console.error('שגיאה בטעינת אירועים:', error);
          this.events = [];
        }
      },

      // שמירת נתוני לוח שנה
      saveCalendarData: async function() {
        try {
          localStorage.setItem('calendarData', JSON.stringify(this.events));
          await saveToSupabase('calendar_data', this.events);
        } catch (error) {
          console.error('שגיאה בשמירת אירועים:', error);
        }
      },

      // רינדור לוח השנה
      renderCalendar() {
        this.updateCalendarHeader();
        this.renderCalendarGrid();
        this.updateSidebarEventsList();
      },

      // עדכון כותרת הלוח
      updateCalendarHeader() {
        const monthNames = [
          'ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
          'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'
        ];
        
        document.getElementById('currentMonth').textContent = 
          `${monthNames[this.currentCalendarMonth]} ${this.currentCalendarYear}`;
      },

      // רינדור רשת הלוח
      renderCalendarGrid() {
        const grid = document.getElementById('calendarGrid');
        if (!grid) return;

        grid.innerHTML = '';

        const firstDay = new Date(this.currentCalendarYear, this.currentCalendarMonth, 1);
        const startDate = new Date(firstDay);
        
        // התחלה מיום ראשון - התאמה לעברית
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        // תיקון: השתמש בתאריך מדויק ללא שעות
        const today = new Date();
        const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

        for (let i = 0; i < 42; i++) { // 6 שבועות * 7 ימים
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + i);
          
const dateString = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
          const dayNumber = currentDate.getDate();
          const isCurrentMonth = currentDate.getMonth() === this.currentCalendarMonth;
          const isToday = dateString === todayString;
          
          const dayEvents = this.events.filter(event => event.date === dateString);
          
          const dayCell = document.createElement('div');
          dayCell.className = `calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${dayEvents.length > 0 ? 'has-events' : ''}`;
          dayCell.onclick = () => this.selectCalendarDay(dateString);
          
          dayCell.innerHTML = `
            <div class="day-number">${dayNumber}</div>
            <div class="day-events">
              ${dayEvents.slice(0, 3).map(event => `
                <div class="event-item ${event.type}" onclick="event.stopPropagation(); app.viewEvent('${event.id}')" title="${event.title}">
                  ${event.title}
                </div>
              `).join('')}
              ${dayEvents.length > 3 ? `<div class="event-more">+${dayEvents.length - 3} נוספים</div>` : ''}
            </div>
          `;
          
          grid.appendChild(dayCell);
        }
      },

      // רינדור תצוגת שבוע
      renderWeekView() {
        const startOfWeek = this.getStartOfWeek();
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        this.renderWeekHeader(startOfWeek);
        this.renderWeekContent(startOfWeek);
      },

      // קבלת תחילת השבוע הנוכחי
      getStartOfWeek() {
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - day;
        const startOfWeek = new Date(today.setDate(diff));
        return startOfWeek;
      },

      // רינדור כותרת שבוע
      renderWeekHeader(startOfWeek) {
        const header = document.getElementById('weekHeader');
        if (!header) return;
        
        const days = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
        
        header.innerHTML = `
          <div class="week-time-label">שעה</div>
          ${days.map((day, index) => {
            const currentDate = new Date(startOfWeek);
            currentDate.setDate(startOfWeek.getDate() + index);
            return `
              <div class="week-day-header">
                ${day}<br>
                <span style="font-size: 0.8rem; font-weight: normal;">
                  ${currentDate.getDate()}/${currentDate.getMonth() + 1}
                </span>
              </div>
            `;
          }).join('')}
        `;
      },

      // רינדור תוכן שבוע
      renderWeekContent(startOfWeek) {
        const content = document.getElementById('weekContent');
        if (!content) return;
        
        content.innerHTML = '';
        
        // יצירת שורות שעות (6:00-22:00)
        for (let hour = 6; hour <= 22; hour++) {
          const timeLabel = document.createElement('div');
          timeLabel.className = 'week-hour-slot week-time-label';
          timeLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
          content.appendChild(timeLabel);
          
          // יצירת עמודות ימים
          for (let day = 0; day < 7; day++) {
            const dayColumn = document.createElement('div');
            dayColumn.className = 'week-day-column';
            
            const currentDate = new Date(startOfWeek);
            currentDate.setDate(startOfWeek.getDate() + day);
            const dateString = currentDate.toISOString().split('T')[0];
            
            // הוספת אירועים לשעה הזו
            const dayEvents = this.events.filter(event => {
              if (event.date !== dateString) return false;
              const eventHour = parseInt(event.startTime.split(':')[0]);
              return eventHour === hour;
            });
            
            dayEvents.forEach(event => {
              const eventElement = document.createElement('div');
              eventElement.className = `week-event ${event.type}`;
              eventElement.textContent = event.title;
              eventElement.onclick = () => this.viewEvent(event.id);
              dayColumn.appendChild(eventElement);
            });
            
            content.appendChild(dayColumn);
          }
        }
      },

      // רינדור תצוגת יום
      renderDayView() {
        const today = new Date();
        
        this.renderDayHeader(today);
        this.renderDayContent(today);
      },

      // רינדור כותרת יום
      renderDayHeader(date) {
        const header = document.getElementById('dayHeader');
        if (!header) return;
        
        const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
        const dayName = dayNames[date.getDay()];
        const dateStr = date.toLocaleDateString('he-IL');
        
        header.innerHTML = `
          <h3>${dayName}</h3>
          <div class="day-date">${dateStr}</div>
        `;
      },

      // רינדור תוכן יום
      renderDayContent(date) {
        const content = document.getElementById('dayContent');
        if (!content) return;
        
        const dateString = date.toISOString().split('T')[0];
        const dayEvents = this.events
          .filter(event => event.date === dateString)
          .sort((a, b) => a.startTime.localeCompare(b.startTime));
        
        if (dayEvents.length === 0) {
          content.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">📅</div>
              <div class="empty-title">אין אירועים היום</div>
              <div class="empty-description">יום פנוי ללימודים!</div>
            </div>
          `;
          return;
        }
        
        content.innerHTML = dayEvents.map(event => `
          <div class="day-event ${event.type}" onclick="app.viewEvent('${event.id}')">
            <div class="day-event-header">
              <div class="day-event-title">${event.title}</div>
              <div class="day-event-type">${this.getEventTypeName(event.type)}</div>
            </div>
            <div class="day-event-details">
              <div class="day-event-time">⏰ ${event.isAllDay ? 'כל היום' : `${event.startTime} - ${event.endTime}`}</div>
              ${event.location ? `<div class="day-event-location">📍 ${event.location}</div>` : ''}
              ${event.description ? `<div class="day-event-description">${event.description}</div>` : ''}
            </div>
          </div>
        `).join('');
      },

      // ניווט תקופות (חודש/שבוע/יום)
      previousPeriod() {
        switch(this.currentCalendarView) {
          case 'month':
            this.previousMonth();
            break;
          case 'week':
            this.currentCalendarMonth--;
            if (this.currentCalendarMonth < 0) {
              this.currentCalendarMonth = 11;
              this.currentCalendarYear--;
            }
            this.renderWeekView();
            break;
          case 'day':
            const currentDate = new Date(this.currentCalendarYear, this.currentCalendarMonth, 1);
            currentDate.setDate(currentDate.getDate() - 1);
            this.currentCalendarMonth = currentDate.getMonth();
            this.currentCalendarYear = currentDate.getFullYear();
            this.renderDayView();
            break;
        }
        this.updateCalendarHeader();
        this.updateCalendarStats();
      },

      nextPeriod() {
        switch(this.currentCalendarView) {
          case 'month':
            this.nextMonth();
            break;
          case 'week':
            this.currentCalendarMonth++;
            if (this.currentCalendarMonth > 11) {
              this.currentCalendarMonth = 0;
              this.currentCalendarYear++;
            }
            this.renderWeekView();
            break;
          case 'day':
            const currentDate = new Date(this.currentCalendarYear, this.currentCalendarMonth, 1);
            currentDate.setDate(currentDate.getDate() + 1);
            this.currentCalendarMonth = currentDate.getMonth();
            this.currentCalendarYear = currentDate.getFullYear();
            this.renderDayView();
            break;
        }
        this.updateCalendarHeader();
        this.updateCalendarStats();
      },

      // חודש קודם
      previousMonth() {
        if (this.currentCalendarMonth === 0) {
          this.currentCalendarMonth = 11;
          this.currentCalendarYear--;
        } else {
          this.currentCalendarMonth--;
        }
        this.renderCalendar();
        this.updateCalendarStats();
      },

      // חודש הבא
      nextMonth() {
        if (this.currentCalendarMonth === 11) {
          this.currentCalendarMonth = 0;
          this.currentCalendarYear++;
        } else {
          this.currentCalendarMonth++;
        }
        this.renderCalendar();
        this.updateCalendarStats();
      },

      // חזרה להיום
      goToToday() {
        const today = new Date();
        this.currentCalendarMonth = today.getMonth();
        this.currentCalendarYear = today.getFullYear();
        this.renderCalendar();
        this.updateCalendarStats();
      },

      // שינוי תצוגה
      changeView(view) {
        this.currentCalendarView = view;
        
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.view === view) {
            btn.classList.add('active');
          }
        });
        
        // הסתר כל התצוגות
        document.getElementById('monthView').style.display = 'none';
        document.getElementById('weekView').style.display = 'none';
        document.getElementById('dayView').style.display = 'none';
        
        // הצג את התצוגה הנבחרת
        switch(view) {
          case 'month':
            document.getElementById('monthView').style.display = 'block';
            this.renderCalendar();
            break;
          case 'week':
            document.getElementById('weekView').style.display = 'block';
            this.renderWeekView();
            break;
          case 'day':
            document.getElementById('dayView').style.display = 'block';
            this.renderDayView();
            break;
        }
        
        this.updateCalendarHeader();
      },

      // בחירת יום בלוח
      selectCalendarDay(dateString) {
        this.selectedDate = dateString;
        this.openEventCreator(dateString);
      },

      // פתיחת יוצר אירוע
      openEventCreator(preselectedDate = null) {
        const modal = this.createEventModal();
        document.body.appendChild(modal);
        
        if (preselectedDate) {
          document.getElementById('eventDate').value = preselectedDate;
        } else {
          document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
        }
        
        document.getElementById('eventTitle').focus();
      },

      // יצירת מודל אירוע
      createEventModal() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.id = 'eventModal';
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2 class="modal-title">
                <span>📅</span>
                יצירת אירוע חדש
              </h2>
              <button class="close-btn" onclick="app.closeEventModal()">✕</button>
            </div>
            
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label" for="eventTitle">כותרת האירוע</label>
                <input type="text" id="eventTitle" class="form-input" placeholder="לדוגמה: בחינת מתמטיקה" maxlength="80">
              </div>

              <div class="form-group">
                <label class="form-label">סוג האירוע</label>
                <div class="event-type-grid">
                  <div class="event-type-option selected" data-type="lesson" onclick="app.selectEventType('lesson')">
                    <span class="event-type-icon">📚</span>
                    <div class="event-type-title">שיעור</div>
                  </div>
                  <div class="event-type-option" data-type="exam" onclick="app.selectEventType('exam')">
                    <span class="event-type-icon">📝</span>
                    <div class="event-type-title">בחינה</div>
                  </div>
                  <div class="event-type-option" data-type="assignment" onclick="app.selectEventType('assignment')">
                    <span class="event-type-icon">📋</span>
                    <div class="event-type-title">מטלה</div>
                  </div>
                  <div class="event-type-option" data-type="personal" onclick="app.selectEventType('personal')">
                    <span class="event-type-icon">🎉</span>
                    <div class="event-type-title">אישי</div>
                  </div>
                  <div class="event-type-option" data-type="holiday" onclick="app.selectEventType('holiday')">
                    <span class="event-type-icon">🏖️</span>
                    <div class="event-type-title">חופש</div>
                  </div>
                  <div class="event-type-option" data-type="task" onclick="app.selectEventType('task')">
                    <span class="event-type-icon">✅</span>
                    <div class="event-type-title">משימה</div>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="eventDate">תאריך</label>
                <input type="date" id="eventDate" class="form-input">
              </div>

              <div class="time-inputs">
                <div class="form-group">
                  <label class="form-label" for="eventStartTime">שעת התחלה</label>
                  <input type="time" id="eventStartTime" class="form-input" value="09:00">
                </div>
                <div class="form-group">
                  <label class="form-label" for="eventEndTime">שעת סיום</label>
                  <input type="time" id="eventEndTime" class="form-input" value="10:00">
                </div>
              </div>

              <div class="checkbox-group">
                <input type="checkbox" id="allDayEvent" onchange="app.toggleAllDay()">
                <label for="allDayEvent">אירוע כל היום</label>
              </div>

              <div class="form-group">
                <label class="form-label" for="eventLocation">מיקום (אופציונלי)</label>
                <input type="text" id="eventLocation" class="form-input" placeholder="לדוגמה: כיתה 15, מעבדת מדעים">
              </div>

              <div class="form-group">
                <label class="form-label" for="eventDescription">תיאור (אופציונלי)</label>
                <textarea id="eventDescription" class="form-textarea" placeholder="תיאור האירוע או הערות נוספות..."></textarea>
              </div>

              <div class="checkbox-group">
                <input type="checkbox" id="repeatEvent" onchange="app.toggleRepeatOptions()">
                <label for="repeatEvent">אירוע חוזר</label>
              </div>

              <div class="repeat-options" id="repeatOptions">
                <label class="form-label" for="repeatFrequency">תדירות</label>
                <select id="repeatFrequency" class="form-select">
                  <option value="weekly">שבועי</option>
                  <option value="monthly">חודשי</option>
                  <option value="yearly">שנתי</option>
                </select>
              </div>
            </div>

            <div class="modal-footer">
              <button class="btn btn-cancel" onclick="app.closeEventModal()">
                <span>✕</span>
                ביטול
              </button>
              <button class="btn btn-primary" onclick="app.createEvent()">
                <span>✨</span>
                צור אירוע
              </button>
            </div>
          </div>
        `;
        
        this.selectedEventType = 'lesson';
        
        // סגירה בלחיצה על הרקע
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            this.closeEventModal();
          }
        });
        
        return modal;
      },

      // בחירת סוג אירוע
      selectEventType(type) {
        this.selectedEventType = type;
        
        document.querySelectorAll('.event-type-option').forEach(option => {
          option.classList.remove('selected');
          if (option.dataset.type === type) {
            option.classList.add('selected');
          }
        });
      },

      // הפעלה/כיבוי אירוע כל היום
      toggleAllDay() {
        const isAllDay = document.getElementById('allDayEvent').checked;
        const startTime = document.getElementById('eventStartTime');
        const endTime = document.getElementById('eventEndTime');
        
        startTime.disabled = isAllDay;
        endTime.disabled = isAllDay;
        
        if (isAllDay) {
          startTime.value = '00:00';
          endTime.value = '23:59';
        } else {
          startTime.value = '09:00';
          endTime.value = '10:00';
        }
      },

      // הפעלה/כיבוי אפשרויות חזרה
      toggleRepeatOptions() {
        const isRepeat = document.getElementById('repeatEvent').checked;
        const repeatOptions = document.getElementById('repeatOptions');
        
        if (isRepeat) {
          repeatOptions.classList.add('show');
        } else {
          repeatOptions.classList.remove('show');
        }
      },

      // יצירת אירוע
      createEvent() {
        const title = document.getElementById('eventTitle').value.trim();
        const type = this.selectedEventType;
        const date = document.getElementById('eventDate').value;
        const startTime = document.getElementById('eventStartTime').value;
        const endTime = document.getElementById('eventEndTime').value;
        const location = document.getElementById('eventLocation').value.trim();
        const description = document.getElementById('eventDescription').value.trim();
        const isAllDay = document.getElementById('allDayEvent').checked;
        const isRepeat = document.getElementById('repeatEvent').checked;
        const repeatFrequency = document.getElementById('repeatFrequency').value;
        
        if (!title) {
          alert('נא להזין כותרת לאירוע');
          return;
        }
        
        if (!date) {
          alert('נא לבחור תאריך');
          return;
        }
        
        if (!isAllDay && startTime >= endTime) {
          alert('שעת הסיום חייבת להיות אחרי שעת ההתחלה');
          return;
        }
        
        const newEvent = {
          id: Date.now().toString(),
          title,
          type,
          date,
          startTime: isAllDay ? '00:00' : startTime,
          endTime: isAllDay ? '23:59' : endTime,
          location,
          description,
          isAllDay,
          isRepeat,
          repeatFrequency: isRepeat ? repeatFrequency : null,
          createdAt: new Date().toISOString()
        };
        
        this.events.push(newEvent);
        
        // יצירת אירועים חוזרים
        if (isRepeat) {
          this.createRepeatingEvents(newEvent);
        }
        
        this.saveCalendarData();
        this.renderCalendar();
        this.updateCalendarStats();
        this.loadWelcomeData();
        this.closeEventModal();
        
        alert('האירוע נוצר בהצלחה! 🎉');
        
        // שליחת התראה על אירוע חדש
        this.sendPushNotification(
          '📅 אירוע חדש נוסף',
          `${newEvent.title} - ${newEvent.date} בשעה ${newEvent.startTime}`
        );
      },

      // יצירת אירועים חוזרים
      createRepeatingEvents(baseEvent) {
        const baseDate = new Date(baseEvent.date);
        const eventsToCreate = 12; // יוצר אירועים ל-12 פעמים הבאות
        
        for (let i = 1; i <= eventsToCreate; i++) {
          const newDate = new Date(baseDate);
          
          switch (baseEvent.repeatFrequency) {
            case 'weekly':
              newDate.setDate(baseDate.getDate() + (i * 7));
              break;
            case 'monthly':
              newDate.setMonth(baseDate.getMonth() + i);
              break;
            case 'yearly':
              newDate.setFullYear(baseDate.getFullYear() + i);
              break;
          }
          
          const repeatedEvent = {
            ...baseEvent,
            id: (Date.now() + i).toString(),
            date: newDate.toISOString().split('T')[0],
            title: baseEvent.title + ` (${i + 1})`,
            isRepeatInstance: true,
            parentEventId: baseEvent.id
          };
          
          this.events.push(repeatedEvent);
        }
      },

      // סגירת מודל אירוע
      closeEventModal() {
        const modal = document.getElementById('eventModal');
        if (modal) {
          modal.remove();
        }
      },

      // הוספה מהירה של אירוע
      quickAddEvent(type) {
        const title = prompt(`הזן כותרת ל${this.getEventTypeName(type)}:`);
        if (!title || title.trim() === '') return;
        
        const today = new Date().toISOString().split('T')[0];
        
        const quickEvent = {
          id: Date.now().toString(),
          title: title.trim(),
          type,
          date: today,
          startTime: '09:00',
          endTime: '10:00',
          location: '',
          description: '',
          isAllDay: false,
          isRepeat: false,
          repeatFrequency: null,
          createdAt: new Date().toISOString()
        };
        
        this.events.push(quickEvent);
        this.saveCalendarData();
        this.renderCalendar();
        this.updateCalendarStats();
        this.loadWelcomeData();
        
        alert(`${this.getEventTypeName(type)} נוסף בהצלחה!`);
      },

      // קבלת שם סוג אירוע
      getEventTypeName(type) {
        const names = {
          lesson: 'שיעור',
          exam: 'בחינה',
          assignment: 'מטלה',
          personal: 'אירוע אישי',
          holiday: 'חופש',
          task: 'משימה'
        };
        return names[type] || 'אירוע';
      },

      // צפייה באירוע
      viewEvent(eventId) {
        const event = this.events.find(e => e.id === eventId);
        if (!event) return;
        
        const eventDate = new Date(event.date).toLocaleDateString('he-IL');
        const timeRange = event.isAllDay ? 'כל היום' : `${event.startTime} - ${event.endTime}`;
        
        let eventDetails = `📅 ${this.getEventTypeName(event.type)}: ${event.title}\n\n`;
        eventDetails += `🗓️ תאריך: ${eventDate}\n`;
        eventDetails += `⏰ שעה: ${timeRange}\n`;
        
        if (event.location) {
          eventDetails += `📍 מיקום: ${event.location}\n`;
        }
        
        if (event.description) {
          eventDetails += `📝 תיאור: ${event.description}\n`;
        }
        
        if (event.isRepeat) {
          eventDetails += `🔄 אירוע חוזר: ${event.repeatFrequency === 'weekly' ? 'שבועי' : event.repeatFrequency === 'monthly' ? 'חודשי' : 'שנתי'}\n`;
        }
        
        const action = confirm(eventDetails + '\n\nבחר פעולה:\nOK = עריכה\nביטול = מחיקה');
        
        if (action) {
          this.editEvent(eventId);
        } else {
          const deleteConfirm = confirm('האם ברצונך למחוק אירוע זה?');
          if (deleteConfirm) {
            this.deleteEvent(eventId);
          }
        }
      },
      
      // עריכת אירוע
      editEvent(eventId) {
        const event = this.events.find(e => e.id === eventId);
        if (!event) return;
        
        const modal = this.createEventModal();
        document.body.appendChild(modal);
        
        // מילוי הטופס עם הנתונים הקיימים
        document.getElementById('eventTitle').value = event.title;
        document.getElementById('eventDate').value = event.date;
        document.getElementById('eventType').value = event.type;
        document.getElementById('eventLocation').value = event.location || '';
        document.getElementById('eventDescription').value = event.description || '';
        document.getElementById('eventAllDay').checked = event.isAllDay;
        document.getElementById('eventStartTime').value = event.startTime || '08:00';
        document.getElementById('eventEndTime').value = event.endTime || '09:00';
        
        // שינוי כפתור השמירה לעדכון
        const saveBtn = modal.querySelector('.modal-footer button:first-child');
        if (saveBtn) {
          saveBtn.textContent = '🔄 עדכן אירוע';
          saveBtn.onclick = () => this.updateEvent(eventId);
        }
      },
      
      // עדכון אירוע
      updateEvent(eventId) {
        const title = document.getElementById('eventTitle').value.trim();
        const date = document.getElementById('eventDate').value;
        const type = document.getElementById('eventType').value;
        const location = document.getElementById('eventLocation').value;
        const description = document.getElementById('eventDescription').value;
        const isAllDay = document.getElementById('eventAllDay').checked;
        const startTime = document.getElementById('eventStartTime').value;
        const endTime = document.getElementById('eventEndTime').value;
        
        if (!title || !date) {
          alert('נא למלא כותרת ותאריך');
          return;
        }
        
        const eventIndex = this.events.findIndex(e => e.id === eventId);
        if (eventIndex !== -1) {
          this.events[eventIndex] = {
            ...this.events[eventIndex],
            title,
            date,
            type,
            location,
            description,
            isAllDay,
            startTime,
            endTime
          };
          
          this.saveCalendarData();
          this.closeEventModal();
          this.renderCalendar();
          this.updateCalendarStats();
          alert('אירוע עודכן בהצלחה!');
        }
      },

      // מחיקת אירוע
      deleteEvent(eventId) {
        const event = this.events.find(e => e.id === eventId);
        if (!event) return;
        
        let eventsToDelete = [eventId];
        
        // אם זה אירוע חוזר, שאל אם למחוק את כל הסדרה
        if (event.isRepeat && !event.isRepeatInstance) {
          const deleteAll = confirm('האם למחוק את כל הסדרה של האירועים החוזרים?');
          if (deleteAll) {
            eventsToDelete = this.events
              .filter(e => e.id === eventId || e.parentEventId === eventId)
              .map(e => e.id);
          }
        } else if (event.isRepeatInstance) {
          const deleteAll = confirm('האם למחוק את כל הסדרה של האירועים החוזרים?');
          if (deleteAll) {
            eventsToDelete = this.events
              .filter(e => e.parentEventId === event.parentEventId || e.id === event.parentEventId)
              .map(e => e.id);
          }
        }
        
        this.events = this.events.filter(e => !eventsToDelete.includes(e.id));
        this.saveCalendarData();
        this.renderCalendar();
        this.updateCalendarStats();
        this.loadWelcomeData();
        
        alert(`האירוע${eventsToDelete.length > 1 ? 'ים' : ''} נמחק${eventsToDelete.length > 1 ? 'ו' : ''} בהצלחה.`);
      },

      // עדכון סטטיסטיקות לוח שנה
      updateCalendarStats() {
        const currentMonth = this.currentCalendarMonth;
        const currentYear = this.currentCalendarYear;
        const today = new Date();
        const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        
        // אירועים החודש
        const monthEvents = this.events.filter(event => {
          const eventDate = new Date(event.date);
          return eventDate.getMonth() === currentMonth && 
                 eventDate.getFullYear() === currentYear;
        }).length;
        
        // בחינות קרובות (7 ימים הקרובים)
        const upcomingExams = this.events.filter(event => {
          const eventDate = new Date(event.date);
          const todayDate = new Date(todayString);
          const weekFromNow = new Date(todayDate.getTime() + 7 * 24 * 60 * 60 * 1000);
          
          return event.type === 'exam' && 
                 eventDate >= todayDate && 
                 eventDate <= weekFromNow;
        }).length;
        
        // שיעורים השבוע
        const startOfWeek = new Date();
        startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        const weekClasses = this.events.filter(event => {
          const eventDate = new Date(event.date);
          return event.type === 'lesson' && 
                 eventDate >= startOfWeek && 
                 eventDate <= endOfWeek;
        }).length;
        
        // אירועים היום
        const todayEvents = this.events.filter(event => event.date === todayString).length;
        
        // עדכון התצוגה
        document.getElementById('monthEvents').textContent = monthEvents;
        document.getElementById('upcomingExams').textContent = upcomingExams;
        document.getElementById('weekClasses').textContent = weekClasses;
        document.getElementById('todayEvents').textContent = todayEvents;

        // עדכון הסרגל הצדדי
        this.updateSidebarEventsList();
      },

      // חיפוש אירועים
      searchEvents(query) {
        this.searchQuery = query.toLowerCase();
        this.updateSidebarEventsList();
      },

      // סינון לפי סוג אירוע
      filterEventsByType(type) {
        this.selectedEventType = type;
        this.updateSidebarEventsList();
      },

      // סינון לפי טווח תאריכים
      filterByDateRange() {
        this.updateSidebarEventsList();
      },

      // ניקוי סינונים
      clearFilters() {
        document.getElementById('eventSearchInput').value = '';
        document.getElementById('eventTypeFilter').value = '';
        document.getElementById('startDateFilter').value = '';
        document.getElementById('endDateFilter').value = '';
        
        this.searchQuery = '';
        this.selectedEventType = '';
        this.updateSidebarEventsList();
      },

      // עדכון רשימת אירועים בסרגל
updateSidebarEventsList() {
  if (!this.events || !Array.isArray(this.events)) {
    this.events = [];
  }
        const container = document.getElementById('sidebarEventsList');
        const titleElement = document.getElementById('eventsListTitle');
        
        if (!container) return;
        
        let filteredEvents = [...this.events];
        
        // סינון לפי חיפוש טקסט
        if (this.searchQuery) {
          filteredEvents = filteredEvents.filter(event => 
            event.title.toLowerCase().includes(this.searchQuery) ||
            (event.description && event.description.toLowerCase().includes(this.searchQuery)) ||
            (event.location && event.location.toLowerCase().includes(this.searchQuery))
          );
        }
        
        // סינון לפי סוג אירוע
        const eventTypeFilter = document.getElementById('eventTypeFilter')?.value;
        if (eventTypeFilter) {
          filteredEvents = filteredEvents.filter(event => event.type === eventTypeFilter);
        }
        
        // סינון לפי טווח תאריכים
        const startDateFilter = document.getElementById('startDateFilter')?.value;
        const endDateFilter = document.getElementById('endDateFilter')?.value;
        
        if (startDateFilter) {
          filteredEvents = filteredEvents.filter(event => event.date >= startDateFilter);
        }
        
        if (endDateFilter) {
          filteredEvents = filteredEvents.filter(event => event.date <= endDateFilter);
        }
        
        // מיון לפי תאריך ושעה
        filteredEvents.sort((a, b) => {
          const dateCompare = new Date(a.date) - new Date(b.date);
          if (dateCompare !== 0) return dateCompare;
          return a.startTime.localeCompare(b.startTime);
        });
        
        // עדכון כותרת
        if (this.searchQuery || eventTypeFilter || startDateFilter || endDateFilter) {
          titleElement.textContent = `🔍 תוצאות חיפוש (${filteredEvents.length})`;
        } else {
          titleElement.textContent = '📋 אירועים קרובים';
          // הצגת רק 20 האירועים הקרובים ביותר
          const today = new Date();
          const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
          filteredEvents = filteredEvents
            .filter(event => event.date >= todayString)
            .slice(0, 20);
        }
        
        if (filteredEvents.length === 0) {
          container.innerHTML = `
            <div class="empty-state" style="padding: 20px;">
              <div class="empty-icon" style="font-size: 2rem;">🔍</div>
              <div class="empty-title" style="font-size: 1rem;">לא נמצאו אירועים</div>
              <div class="empty-description" style="font-size: 0.8rem;">נסה לשנות את הסינונים</div>
            </div>
          `;
          return;
        }
        
        container.innerHTML = filteredEvents.map(event => {
          const eventDate = new Date(event.date);
          const dateStr = eventDate.toLocaleDateString('he-IL');
          const timeStr = event.isAllDay ? 'כל היום' : `${event.startTime} - ${event.endTime}`;
          
          return `
            <div class="sidebar-event-item ${event.type}" onclick="app.viewEvent('${event.id}')">
              <div class="sidebar-event-title">${event.title}</div>
              <div class="sidebar-event-details">
                <div class="sidebar-event-time">
                  <span>📅</span>
                  ${dateStr}
                </div>
                <div class="sidebar-event-time">
                  <span>⏰</span>
                  ${timeStr}
                </div>
                ${event.location ? `
                  <div class="sidebar-event-location">
                    <span>📍</span>
                    ${event.location}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      },

// ===== הגדרות =====
      
      // פתיחת חלון הגדרות
      openSettings() {
        this.loadSettings();
        const modal = document.getElementById('settingsModal');
        if (modal) {
          modal.classList.add('show');
        }
      },

      // סגירת חלון הגדרות
      closeSettings() {
        const modal = document.getElementById('settingsModal');
        if (modal) {
          modal.classList.remove('show');
        }
      },

      // טעינת הגדרות מ-localStorage
      loadSettings() {
        const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
        
        // טעינת פרטי משתמש
        document.getElementById('userName').value = settings.userName || '';
        document.getElementById('userAge').value = settings.userAge || '';
        document.getElementById('userAddress').value = settings.userAddress || '';
        document.getElementById('userSchool').value = settings.userSchool || '';
        
        // טעינת ערכת צבעים
        const theme = settings.theme || 'light';
        document.querySelector(`input[name="theme"][value="${theme}"]`).checked = true;
        this.applyTheme(theme);
        
        // טעינת שפה
        const language = settings.language || 'he';
        document.querySelector(`input[name="language"][value="${language}"]`).checked = true;
        
        // טעינת הגדרות שמירה אוטומטית
        document.getElementById('autoSaveInterval').value = settings.autoSaveInterval || 30;
      },

      // שמירת הגדרות
      saveSettings() {
        const settings = {
          userName: document.getElementById('userName').value,
          userAge: document.getElementById('userAge').value,
          userAddress: document.getElementById('userAddress').value,
          userSchool: document.getElementById('userSchool').value,
          theme: document.querySelector('input[name="theme"]:checked').value,
          language: document.querySelector('input[name="language"]:checked').value,
          autoSaveInterval: parseInt(document.getElementById('autoSaveInterval').value) || 30
        };
        
        localStorage.setItem('appSettings', JSON.stringify(settings));
        
        // החלת ערכת צבעים
        this.applyTheme(settings.theme);
        
        // הפעלת שמירה אוטומטית
        this.startAutoSave(settings.autoSaveInterval);
        
        // עדכון שם המשתמש בתצוגה
        this.updateUserNameDisplay();
        
        this.closeSettings();
        alert('ההגדרות נשמרו בהצלחה! ✅');
      },

      // עדכון שם המשתמש בתצוגה
      updateUserNameDisplay() {
        const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
        const userName = settings.userName || '';
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        
        if (isLoggedIn && userName) {
          document.getElementById('navUserName').textContent = userName;
          document.getElementById('logoutBtn').style.display = 'block';
        } else {
          document.getElementById('navUserName').textContent = 'לא מחובר';
          document.getElementById('logoutBtn').style.display = 'none';
        }
        
        // עדכון דף הבית
        this.updateHomePage();
      },

      // עדכון דף הבית עם פרטי המשתמש
      updateHomePage() {
        const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        
        // בדיקה אם באמת מחובר (רק אם הערך הוא במפורש 'true')
        const loggedIn = isLoggedIn === 'true';
        
        // עדכון ברכה
        const greetingElement = document.getElementById('welcomeGreeting');
        if (loggedIn && settings.userName) {
          greetingElement.textContent = 'שלום ' + settings.userName + '!';
        } else {
          greetingElement.textContent = 'שלום!';
        }
        
        // עדכון כיתוב משנה
        const subtitleElement = document.getElementById('welcomeSubtitle');
        if (loggedIn && settings.userName) {
subtitleElement.textContent = 'מיקוד שמוביל להצלחה';
        } else {
          subtitleElement.textContent = 'מיקוד שמוביל להצלחה';
        }
        
        // עדכון מוסד לימוד
        const institutionElement = document.getElementById('welcomeInstitution');
        if (loggedIn && settings.userSchool) {
          institutionElement.textContent = settings.userSchool;
        } else {
          institutionElement.textContent = 'הילקוט החכם שלך';
        }
      },

      // שמירת הגדרות והתחברות
      saveSettingsAndLogin() {
        const userName = document.getElementById('userName').value.trim();
        
        if (!userName) {
          alert('⚠️ אנא הזן שם משתמש כדי להתחבר');
          return;
        }
        
        const settings = {
          userName: userName,
          userAge: document.getElementById('userAge').value,
          userAddress: document.getElementById('userAddress').value,
          userSchool: document.getElementById('userSchool').value,
          theme: document.querySelector('input[name="theme"]:checked').value,
          language: document.querySelector('input[name="language"]:checked').value,
          autoSaveInterval: parseInt(document.getElementById('autoSaveInterval').value) || 30
        };
        
        localStorage.setItem('appSettings', JSON.stringify(settings));
        localStorage.setItem('isLoggedIn', 'true');
        
        // החלת ערכת צבעים
        this.applyTheme(settings.theme);
        
        // הפעלת שמירה אוטומטית
        this.startAutoSave(settings.autoSaveInterval);
        
        // עדכון שם המשתמש בתצוגה
        this.updateUserNameDisplay();
        
        this.closeSettings();
        alert('✅ התחברת בהצלחה, ' + userName + '!');
      },

      // התנתקות
      logout() {
        if (confirm('האם אתה בטוח שברצונך להתנתק?')) {
          localStorage.setItem('isLoggedIn', 'false');
          this.updateUserNameDisplay();
          alert('👋 התנתקת בהצלחה!');
        }
      },

      // מעבר למסך מלא או יציאה ממנו
      toggleFullscreen() {
        if (!document.fullscreenElement) {
          // כניסה למסך מלא
          document.documentElement.requestFullscreen().then(() => {
            document.getElementById('fullscreenBtn').textContent = '⛶';
            document.getElementById('fullscreenBtn').classList.add('active');
            document.getElementById('fullscreenBtn').title = 'צא ממסך מלא';
          }).catch(err => {
            console.log('שגיאה בכניסה למסך מלא:', err);
          });
        } else {
          // יציאה ממסך מלא
          document.exitFullscreen().then(() => {
            document.getElementById('fullscreenBtn').textContent = '⛶';
            document.getElementById('fullscreenBtn').classList.remove('active');
            document.getElementById('fullscreenBtn').title = 'מסך מלא';
          }).catch(err => {
            console.log('שגיאה ביציאה ממסך מלא:', err);
          });
        }
      },

      // כניסה אוטומטית למסך מלא בטעינה
      autoEnterFullscreen() {
        // ממתין לאינטראקציה ראשונה של המשתמש (דרישה של הדפדפן)
        const enterFullscreen = () => {
          document.documentElement.requestFullscreen().then(() => {
            document.getElementById('fullscreenBtn').textContent = '⛶';
            document.getElementById('fullscreenBtn').classList.add('active');
            document.getElementById('fullscreenBtn').title = 'צא ממסך מלא';
          }).catch(err => {
            console.log('לא ניתן להיכנס למסך מלא אוטומטית. לחץ על כפתור מסך מלא.');
          });
          // מסיר את מאזין האירוע אחרי שימוש
          document.removeEventListener('click', enterFullscreen);
          document.removeEventListener('keydown', enterFullscreen);
        };
        
        // מנסה להיכנס למסך מלא בלחיצה או מקש ראשון
        document.addEventListener('click', enterFullscreen, { once: true });
        document.addEventListener('keydown', enterFullscreen, { once: true });
      },

      // שינוי ערכת צבעים
      changeTheme(theme) {
        this.applyTheme(theme);
      },

      // החלת ערכת צבעים
      applyTheme(theme) {
        if (theme === 'dark') {
          document.documentElement.style.setProperty('--background-main', '#1a1a2e');
          document.documentElement.style.setProperty('--background-card', '#16213e');
          document.documentElement.style.setProperty('--text-primary', '#eaeaea');
          document.documentElement.style.setProperty('--text-secondary', '#a0a0a0');
          document.documentElement.style.setProperty('--border-color', '#2d3748');
        } else {
          document.documentElement.style.setProperty('--background-main', '#f8f9fa');
          document.documentElement.style.setProperty('--background-card', '#ffffff');
          document.documentElement.style.setProperty('--text-primary', '#2c3e50');
          document.documentElement.style.setProperty('--text-secondary', '#7f8c8d');
          document.documentElement.style.setProperty('--border-color', '#e9ecef');
        }
      },

      // שינוי שפה
      changeLanguage(language) {
        // כאן תוכל להוסיף לוגיקה לשינוי שפה בעתיד
        console.log(`שפה השתנתה ל: ${language}`);
      },

      // הפעלת שמירה אוטומטית
      startAutoSave(intervalSeconds) {
        // ניקוי interval קודם אם קיים
        if (this.autoSaveInterval) {
          clearInterval(this.autoSaveInterval);
        }
        
        // הפעלת interval חדש
        this.autoSaveInterval = setInterval(() => {
          if (this.currentNotebook && this.activeTextareaIndex !== undefined) {
            const textarea = document.getElementById(`textarea-${this.activeTextareaIndex}`);
            if (textarea) {
              this.savePage(this.activeTextareaIndex, textarea.value);
              console.log('שמירה אוטומטית בוצעה');
            }
          }
        }, intervalSeconds * 1000);
        
        console.log(`שמירה אוטומטית הופעלה - כל ${intervalSeconds} שניות`);
      },

// === Drawing Tools ===
drawing: {
  canvas: null,
  ctx: null,
  isDrawing: false,
  currentTool: 'pencil',
  currentColor: '#000000',
  currentThickness: 3,
  pencilType: 'solid',
  currentShape: 'circle',
  fillShape: false,
  startX: 0,
  startY: 0,
  history: [],
  historyStep: -1,
  tempCanvas: null,

init() {
  // אתחול כלי ציור - ריק כרגע
  console.log('🎨 כלי ציור מוכנים');
},

toggleDrawingMode() {
  const btn = document.getElementById('drawingModeBtn');
  const btnText = document.getElementById('drawingModeText');
  
  if (!btn) return;
  
  const isActive = btn.classList.toggle('active');
  
  if (isActive) {
    btnText.textContent = 'כתיבה רגילה';
    btn.style.background = '#e74c3c';
    this.enableDrawingMode();  // שינוי כאן
  } else {
    btnText.textContent = 'הפעל ציור';
    btn.style.background = '#27ae60';
    this.disableDrawingMode();
  }
},

enableDrawingMode() {
  // עדכן את כפתור "הפעל ציור"
  const btn = document.getElementById('drawingModeBtn');
  const btnText = document.getElementById('drawingModeText');
  if (btn && !btn.classList.contains('active')) {
    btn.classList.add('active');
    btnText.textContent = 'כתיבה רגילה';
    btn.style.background = '#e74c3c';
  }
  
  const notebookContent = document.getElementById('notebookContent');
  if (!notebookContent) return;
  
const pagesToExport = notebookContent.querySelectorAll('.export-this-page');
const pages = pagesToExport.length > 0 ? pagesToExport : notebookContent.querySelectorAll('.lined-page, .grid-page, .blank-page');
  
  pages.forEach((pageContainer) => {
    let canvas = pageContainer.querySelector('.page-canvas');
    
if (!canvas) {
  canvas = document.createElement('canvas');
  canvas.className = 'page-canvas';
  pageContainer.style.position = 'relative';
  pageContainer.appendChild(canvas);
  
  setTimeout(() => {
    canvas.width = pageContainer.offsetWidth;
    canvas.height = pageContainer.offsetHeight;
    this.attachCanvasEvents(canvas);
  }, 100);
} else {
  // אם כבר יש canvas (מציור קודם), רק חבר מחדש את האירועים
  this.attachCanvasEvents(canvas);
}
    
    // הפעל את הציור
    canvas.classList.add('drawing-active');
    canvas.style.pointerEvents = 'auto';
  });
},

disableDrawingMode() {
  const canvases = document.querySelectorAll('.page-canvas');
  canvases.forEach(canvas => {
    canvas.classList.remove('drawing-active');
    canvas.style.pointerEvents = 'none';
  });
},

initCanvasLayers() {
  const notebookContent = document.getElementById('notebookContent');
  if (!notebookContent) {
    console.log('notebookContent not found');
    return;
  }
  
  // עבור כל דף במחברת
  const pages = notebookContent.querySelectorAll('.lined-page, .grid-page, .blank-page');
  console.log('Found pages:', pages.length);
  
  pages.forEach((pageContainer, index) => {
    // בדוק אם כבר יש canvas
    let canvas = pageContainer.querySelector('.page-canvas');
    if (!canvas) {
      console.log('Creating canvas for page', index);
      canvas = document.createElement('canvas');
      canvas.className = 'page-canvas';
      canvas.id = `pageCanvas-${index}`;
      
      // ודא שהקונטיינר הוא relative
      pageContainer.style.position = 'relative';
      pageContainer.appendChild(canvas);
      
      // המתן רגע שה-DOM יתעדכן
      setTimeout(() => {
        // התאם גודל
        canvas.width = pageContainer.offsetWidth;
        canvas.height = pageContainer.offsetHeight;
        console.log('Canvas size:', canvas.width, 'x', canvas.height);
        
        // הפעל ציור
        canvas.classList.add('drawing-active');
        this.attachCanvasEvents(canvas);
      }, 100);
    } else {
      console.log('Canvas already exists for page', index);
      canvas.classList.add('drawing-active');
      
      // עדכן גודל אם צריך
      if (canvas.width !== pageContainer.offsetWidth || canvas.height !== pageContainer.offsetHeight) {
        canvas.width = pageContainer.offsetWidth;
        canvas.height = pageContainer.offsetHeight;
      }
    }
  });
},

attachCanvasEvents(canvas) {
  const ctx = canvas.getContext('2d');
  let isDrawing = false;
  let startX = 0;
  let startY = 0;
  let tempCanvas = null;
 
let history = [];
let historyStep = -1;

// שמירת מצב
const saveState = () => {
  historyStep++;
  if (historyStep < history.length) {
    history.length = historyStep;
  }
  history.push(canvas.toDataURL());
};

// שמירת מצב התחלתי
saveState();
 
  const getMousePos = (e) => {
    const rect = canvas.getBoundingClientRect();
    const zoom = 0.85; // התאמה לזום של הדף
    return {
      x: (e.clientX - rect.left) / zoom,
      y: (e.clientY - rect.top) / zoom
    };
  };
 
// שמירת פונקציית ביטול על ה-canvas
canvas._undo = () => {
  if (historyStep > 0) {
    historyStep--;
    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
    };
    img.src = history[historyStep];
  } else {
    alert('אין מה לבטל');
  }
};
 
  canvas.onmousedown = (e) => {
    isDrawing = true;
    const pos = getMousePos(e);
    startX = pos.x;
    startY = pos.y;
    
    // רק אם זה לא כלי צורה - התחל path
    if (this.currentTool !== 'shape') {
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    }
    
    if (this.currentTool === 'shape') {
      tempCanvas = ctx.getImageData(0, 0, canvas.width, canvas.height);
    }
  };
  
  canvas.onmousemove = (e) => {
    if (!isDrawing) return;
    const pos = getMousePos(e);
    
    if (this.currentTool === 'eraser') {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.lineWidth = this.currentThickness * 3;
      ctx.lineCap = 'round';
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
      ctx.globalCompositeOperation = 'source-over';
    } else if (this.currentTool === 'pencil') {
      this.drawWithPencil(ctx, pos.x, pos.y);
    } else if (this.currentTool === 'shape' && tempCanvas) {
      ctx.putImageData(tempCanvas, 0, 0);
      this.drawShapeOnCanvas(ctx, startX, startY, pos.x, pos.y);
    }
  };
  
canvas.onmouseup = () => {
  if (isDrawing) {
    isDrawing = false;
    ctx.beginPath();
    saveState(); // שמירה אחרי כל ציור
  }
};
  
  canvas.onmouseleave = () => {
    if (isDrawing) {
      isDrawing = false;
      ctx.beginPath();
    }
  };
},

drawWithPencil(ctx, x, y) {
  ctx.globalCompositeOperation = 'source-over';
  ctx.strokeStyle = this.currentColor;
  ctx.lineWidth = this.currentThickness;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  
  if (this.pencilType === 'solid') {
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  } else if (this.pencilType === 'marker') {
    ctx.globalAlpha = 0.4;
    ctx.lineWidth = this.currentThickness * 2;
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.globalAlpha = 1;
  } else if (this.pencilType === 'chalk') {
    for (let i = 0; i < 5; i++) {
      const offsetX = (Math.random() - 0.5) * 3;
      const offsetY = (Math.random() - 0.5) * 3;
      ctx.globalAlpha = 0.6;
      ctx.fillStyle = this.currentColor;
      ctx.fillRect(x + offsetX, y + offsetY, 2, 2);
    }
    ctx.globalAlpha = 1;
  } else if (this.pencilType === 'spray') {
    const density = 15;
    const radius = this.currentThickness * 2;
    for (let i = 0; i < density; i++) {
      const angle = Math.random() * Math.PI * 2;
      const dist = Math.random() * radius;
      const sprayX = x + Math.cos(angle) * dist;
      const sprayY = y + Math.sin(angle) * dist;
      ctx.fillStyle = this.currentColor;
      ctx.fillRect(sprayX, sprayY, 1, 1);
    }
  }
},

drawShapeOnCanvas(ctx, startX, startY, x, y) {
  ctx.strokeStyle = this.currentColor;
  ctx.fillStyle = this.currentColor;
  ctx.lineWidth = this.currentThickness;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';

  const width = x - startX;
  const height = y - startY;

  ctx.beginPath();

  if (this.currentShape === 'circle') {
    const radius = Math.sqrt(width * width + height * height);
    ctx.arc(startX, startY, radius, 0, Math.PI * 2);
  } else if (this.currentShape === 'square') {
    const size = Math.max(Math.abs(width), Math.abs(height));
    ctx.rect(startX, startY, size * Math.sign(width), size * Math.sign(height));
  } else if (this.currentShape === 'rectangle') {
    ctx.rect(startX, startY, width, height);
  } else if (this.currentShape === 'triangle') {
    ctx.moveTo(startX + width / 2, startY);
    ctx.lineTo(startX, startY + height);
    ctx.lineTo(startX + width, startY + height);
    ctx.closePath();
  } else if (this.currentShape === 'line') {
    ctx.moveTo(startX, startY);
    ctx.lineTo(x, y);
  } else if (this.currentShape === 'arrow') {
    const headlen = 15;
    const angle = Math.atan2(y - startY, x - startX);
    ctx.moveTo(startX, startY);
    ctx.lineTo(x, y);
    ctx.lineTo(x - headlen * Math.cos(angle - Math.PI / 6), y - headlen * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(x, y);
    ctx.lineTo(x - headlen * Math.cos(angle + Math.PI / 6), y - headlen * Math.sin(angle + Math.PI / 6));
  } else if (this.currentShape === 'star') {
    const cx = startX;
    const cy = startY;
    const spikes = 5;
    const outerRadius = Math.abs(width);
    const innerRadius = outerRadius / 2;
    let rot = Math.PI / 2 * 3;
    const step = Math.PI / spikes;

    ctx.moveTo(cx, cy - outerRadius);
    for (let i = 0; i < spikes; i++) {
      let xOuter = cx + Math.cos(rot) * outerRadius;
      let yOuter = cy + Math.sin(rot) * outerRadius;
      ctx.lineTo(xOuter, yOuter);
      rot += step;

      let xInner = cx + Math.cos(rot) * innerRadius;
      let yInner = cy + Math.sin(rot) * innerRadius;
      ctx.lineTo(xInner, yInner);
      rot += step;
    }
    ctx.lineTo(cx, cy - outerRadius);
    ctx.closePath();
  } else if (this.currentShape === 'heart') {
    const w = Math.abs(width) / 2;
    const h = Math.abs(height);
    const cx = startX;
    const cy = startY;
    
    ctx.moveTo(cx, cy + h * 0.3);
    ctx.bezierCurveTo(cx, cy, cx - w, cy, cx - w, cy + h * 0.3);
    ctx.bezierCurveTo(cx - w, cy + h * 0.6, cx, cy + h * 0.9, cx, cy + h);
    ctx.bezierCurveTo(cx, cy + h * 0.9, cx + w, cy + h * 0.6, cx + w, cy + h * 0.3);
    ctx.bezierCurveTo(cx + w, cy, cx, cy, cx, cy + h * 0.3);
    ctx.closePath();
  } else if (this.currentShape === 'diamond') {
    ctx.moveTo(startX + width / 2, startY);
    ctx.lineTo(startX + width, startY + height / 2);
    ctx.lineTo(startX + width / 2, startY + height);
    ctx.lineTo(startX, startY + height / 2);
    ctx.closePath();
  }

  if (this.fillShape && this.currentShape !== 'line' && this.currentShape !== 'arrow') {
    ctx.fill();
  }
  ctx.stroke();
},

  selectTool(tool) {
    this.currentTool = tool;
    document.querySelectorAll('.drawing-btn').forEach(btn => btn.classList.remove('active'));
    
    const btnId = tool === 'pencil' ? 'pencilBtn' : tool === 'eraser' ? 'eraserBtn' : 'shapeBtn';
    const btn = document.getElementById(btnId);
    if (btn) btn.classList.add('active');
  },

  toggleShapeMenu() {
    const menu = document.getElementById('shapeOptions');
    if (menu) menu.classList.toggle('show');
    this.selectTool('shape');
  },

  selectShape(shape) {
    if (!shape) return; // אם לא נבחרה צורה
    this.currentShape = shape;
    this.selectTool('shape');
  },

  changePencilType(type) {
    this.pencilType = type;
  },

  changeColor(color) {
    this.currentColor = color;
  },

  changeThickness(thickness) {
    this.currentThickness = parseInt(thickness);
    const display = document.getElementById('thicknessDisplay');
    if (display) display.textContent = thickness;
  },

  toggleFill() {
    this.fillShape = !this.fillShape;
    const btn = document.getElementById('fillBtn');
    if (btn) btn.classList.toggle('active');
  },

  getMousePos(e) {
    const rect = this.canvas.getBoundingClientRect();
    return {
      x: e.clientX - rect.left,
      y: e.clientY - rect.top
    };
  },

  startDrawing(e) {
    if (!this.ctx) return;
    this.isDrawing = true;
    const pos = this.getMousePos(e);
    this.startX = pos.x;
    this.startY = pos.y;
    
    this.ctx.beginPath();
    this.ctx.moveTo(pos.x, pos.y);
    
    if (this.currentTool === 'shape') {
      this.tempCanvas = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
    }
  },

draw(e) {
  if (!this.isDrawing || !this.ctx) return;

  const pos = this.getMousePos(e);
  
  if (this.currentTool === 'eraser') {
    this.ctx.globalCompositeOperation = 'destination-out';
    this.ctx.lineWidth = this.currentThickness * 3;
    this.ctx.lineCap = 'round';
    this.ctx.lineTo(pos.x, pos.y);
    this.ctx.stroke();
    this.ctx.beginPath();
    this.ctx.moveTo(pos.x, pos.y);
    this.ctx.globalCompositeOperation = 'source-over';
  } else if (this.currentTool === 'pencil') {
    this.ctx.globalCompositeOperation = 'source-over';
    this.ctx.strokeStyle = this.currentColor;
    this.ctx.lineWidth = this.currentThickness;
    this.ctx.lineCap = 'round';
    this.ctx.lineJoin = 'round';
    
    // סוגי עיפרון שונים
    if (this.pencilType === 'solid') {
      this.ctx.lineTo(pos.x, pos.y);
      this.ctx.stroke();
      this.ctx.beginPath();
      this.ctx.moveTo(pos.x, pos.y);
    } else if (this.pencilType === 'marker') {
      this.ctx.globalAlpha = 0.4;
      this.ctx.lineWidth = this.currentThickness * 2;
      this.ctx.lineTo(pos.x, pos.y);
      this.ctx.stroke();
      this.ctx.beginPath();
      this.ctx.moveTo(pos.x, pos.y);
      this.ctx.globalAlpha = 1;
    } else if (this.pencilType === 'chalk') {
      for (let i = 0; i < 5; i++) {
        const offsetX = (Math.random() - 0.5) * 3;
        const offsetY = (Math.random() - 0.5) * 3;
        this.ctx.globalAlpha = 0.6;
        this.ctx.fillStyle = this.currentColor;
        this.ctx.fillRect(pos.x + offsetX, pos.y + offsetY, 2, 2);
      }
      this.ctx.globalAlpha = 1;
    } else if (this.pencilType === 'spray') {
      const density = 15;
      const radius = this.currentThickness * 2;
      for (let i = 0; i < density; i++) {
        const angle = Math.random() * Math.PI * 2;
        const dist = Math.random() * radius;
        const sprayX = pos.x + Math.cos(angle) * dist;
        const sprayY = pos.y + Math.sin(angle) * dist;
        this.ctx.fillStyle = this.currentColor;
        this.ctx.fillRect(sprayX, sprayY, 1, 1);
      }
    }
  } else if (this.currentTool === 'shape' && this.tempCanvas) {
    this.ctx.putImageData(this.tempCanvas, 0, 0);
    this.drawShape(pos.x, pos.y);
  }
},

drawShape(x, y) {
  if (!this.ctx) return;
  
  this.ctx.strokeStyle = this.currentColor;
  this.ctx.fillStyle = this.currentColor;
  this.ctx.lineWidth = this.currentThickness;
  this.ctx.lineCap = 'round';
  this.ctx.lineJoin = 'round';

  const width = x - this.startX;
  const height = y - this.startY;

  this.ctx.beginPath();

  if (this.currentShape === 'circle') {
    const radius = Math.sqrt(width * width + height * height);
    this.ctx.arc(this.startX, this.startY, radius, 0, Math.PI * 2);
  } else if (this.currentShape === 'square') {
    const size = Math.max(Math.abs(width), Math.abs(height));
    this.ctx.rect(this.startX, this.startY, size * Math.sign(width), size * Math.sign(height));
  } else if (this.currentShape === 'rectangle') {
    this.ctx.rect(this.startX, this.startY, width, height);
  } else if (this.currentShape === 'triangle') {
    this.ctx.moveTo(this.startX + width / 2, this.startY);
    this.ctx.lineTo(this.startX, this.startY + height);
    this.ctx.lineTo(this.startX + width, this.startY + height);
    this.ctx.closePath();
  } else if (this.currentShape === 'line') {
    this.ctx.moveTo(this.startX, this.startY);
    this.ctx.lineTo(x, y);
  } else if (this.currentShape === 'arrow') {
    // חץ
    const headlen = 15;
    const angle = Math.atan2(y - this.startY, x - this.startX);
    this.ctx.moveTo(this.startX, this.startY);
    this.ctx.lineTo(x, y);
    this.ctx.lineTo(x - headlen * Math.cos(angle - Math.PI / 6), y - headlen * Math.sin(angle - Math.PI / 6));
    this.ctx.moveTo(x, y);
    this.ctx.lineTo(x - headlen * Math.cos(angle + Math.PI / 6), y - headlen * Math.sin(angle + Math.PI / 6));
  } else if (this.currentShape === 'star') {
    // כוכב
    const cx = this.startX;
    const cy = this.startY;
    const spikes = 5;
    const outerRadius = Math.abs(width);
    const innerRadius = outerRadius / 2;
    let rot = Math.PI / 2 * 3;
    const step = Math.PI / spikes;

    this.ctx.moveTo(cx, cy - outerRadius);
    for (let i = 0; i < spikes; i++) {
      let xOuter = cx + Math.cos(rot) * outerRadius;
      let yOuter = cy + Math.sin(rot) * outerRadius;
      this.ctx.lineTo(xOuter, yOuter);
      rot += step;

      let xInner = cx + Math.cos(rot) * innerRadius;
      let yInner = cy + Math.sin(rot) * innerRadius;
      this.ctx.lineTo(xInner, yInner);
      rot += step;
    }
    this.ctx.lineTo(cx, cy - outerRadius);
    this.ctx.closePath();
  } else if (this.currentShape === 'heart') {
    // לב
    const size = Math.abs(width);
    const cx = this.startX;
    const cy = this.startY;
    this.ctx.moveTo(cx, cy + size / 4);
    this.ctx.bezierCurveTo(cx, cy, cx - size / 2, cy - size / 2, cx - size / 2, cy);
    this.ctx.bezierCurveTo(cx - size / 2, cy + size / 4, cx, cy + size / 2, cx, cy + size);
    this.ctx.bezierCurveTo(cx, cy + size / 2, cx + size / 2, cy + size / 4, cx + size / 2, cy);
    this.ctx.bezierCurveTo(cx + size / 2, cy - size / 2, cx, cy, cx, cy + size / 4);
  } else if (this.currentShape === 'diamond') {
    // מעויין
    this.ctx.moveTo(this.startX + width / 2, this.startY);
    this.ctx.lineTo(this.startX + width, this.startY + height / 2);
    this.ctx.lineTo(this.startX + width / 2, this.startY + height);
    this.ctx.lineTo(this.startX, this.startY + height / 2);
    this.ctx.closePath();
  }

  // מילוי או רק קו
  if (this.fillShape && this.currentShape !== 'line' && this.currentShape !== 'arrow') {
    this.ctx.fill();
  }
  this.ctx.stroke();
},

  stopDrawing() {
    if (this.isDrawing) {
      this.isDrawing = false;
      if (this.ctx) this.ctx.beginPath();
      this.saveState();
    }
  },

  saveState() {
    if (!this.canvas) return;
    this.historyStep++;
    if (this.historyStep < this.history.length) {
      this.history.length = this.historyStep;
    }
    this.history.push(this.canvas.toDataURL());
  },

  undo() {
    if (this.historyStep > 0 && this.history[this.historyStep - 1]) {
      this.historyStep--;
      this.loadState(this.history[this.historyStep]);
    }
  },

  redo() {
    if (this.historyStep < this.history.length - 1) {
      this.historyStep++;
      this.loadState(this.history[this.historyStep]);
    }
  },

  loadState(dataUrl) {
    if (!this.ctx) return;
    const img = new Image();
    img.onload = () => {
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      this.ctx.drawImage(img, 0, 0);
    };
    img.src = dataUrl;
  },

  clearCanvas() {
    if (!this.ctx) return;
    if (confirm('האם אתה בטוח שברצונך לנקות את כל הציור?')) {
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      this.saveState();
    }
  }
},

// === מערכת צורות אינטראקטיביות ===
interactiveShapes: {
  shapes: [],
  selectedShape: null,
  isCapturing: false,
  startX: 0,
  startY: 0,
  canvasStateBeforeShape: null,
  currentCanvas: null,
  
  init() {
    console.log('🎨 מערכת צורות אינטראקטיביות מאותחלת...');
    this.setupCanvasCapture();
    this.setupGlobalListeners();
    console.log('✅ מערכת צורות אינטראקטיביות מוכנה!');
  },
  
  setupCanvasCapture() {
    const self = this;
    
    document.addEventListener('mousedown', function(e) {
      const canvas = e.target.closest('.page-canvas');
      if (!canvas) return;
      if (app.drawing.currentTool !== 'shape') return;
      
      const rect = canvas.getBoundingClientRect();
      const zoom = 0.85;
      self.startX = (e.clientX - rect.left) / zoom;
      self.startY = (e.clientY - rect.top) / zoom;
      self.isCapturing = true;
      self.currentCanvas = canvas;
      
      const ctx = canvas.getContext('2d');
      self.canvasStateBeforeShape = ctx.getImageData(0, 0, canvas.width, canvas.height);
    }, true);
    
    document.addEventListener('mouseup', function(e) {
      if (!self.isCapturing) return;
      if (app.drawing.currentTool !== 'shape') {
        self.isCapturing = false;
        self.canvasStateBeforeShape = null;
        return;
      }
      
      const canvas = self.currentCanvas;
      if (!canvas) {
        self.isCapturing = false;
        self.canvasStateBeforeShape = null;
        return;
      }
      
      const rect = canvas.getBoundingClientRect();
      const zoom = 0.85;
      const endX = (e.clientX - rect.left) / zoom;
      const endY = (e.clientY - rect.top) / zoom;
      
      const width = Math.abs(endX - self.startX);
      const height = Math.abs(endY - self.startY);
      
      if (width > 10 || height > 10) {
        const ctx = canvas.getContext('2d');
        if (self.canvasStateBeforeShape) {
          ctx.putImageData(self.canvasStateBeforeShape, 0, 0);
        }
        
        const pageContainer = canvas.parentElement;
        
        self.createInteractiveShape(
          pageContainer,
          app.drawing.currentShape,
          self.startX,
          self.startY,
          endX,
          endY,
          app.drawing.currentColor,
          app.drawing.currentThickness,
          app.drawing.fillShape
        );
      }
      
      self.isCapturing = false;
      self.currentCanvas = null;
      self.canvasStateBeforeShape = null;
    }, true);
  },
  
  createInteractiveShape(container, shapeType, startX, startY, endX, endY, color, thickness, fill) {
    const origWidth = endX - startX;
    const origHeight = endY - startY;
    
    let left, top, width, height;
    
    if (shapeType === 'circle') {
      const radius = Math.sqrt(origWidth * origWidth + origHeight * origHeight);
      left = startX - radius;
      top = startY - radius;
      width = radius * 2;
      height = radius * 2;
    } else if (shapeType === 'star') {
      const radius = Math.abs(origWidth);
      left = startX - radius;
      top = startY - radius;
      width = radius * 2;
      height = radius * 2;
    } else if (shapeType === 'heart') {
      const w = Math.abs(origWidth) / 2;
      const h = Math.abs(origHeight);
      left = startX - w;
      top = startY;
      width = w * 2;
      height = h;
    } else if (shapeType === 'square') {
      const size = Math.max(Math.abs(origWidth), Math.abs(origHeight));
      left = origWidth >= 0 ? startX : startX - size;
      top = origHeight >= 0 ? startY : startY - size;
      width = size;
      height = size;
    } else {
      left = Math.min(startX, endX);
      top = Math.min(startY, endY);
      width = Math.abs(origWidth);
      height = Math.abs(origHeight);
    }
    
    const shapeWrapper = document.createElement('div');
    shapeWrapper.className = 'interactive-shape';
    shapeWrapper.style.cssText = `
      position: absolute;
      left: ${left}px;
      top: ${top}px;
      width: ${width}px;
      height: ${height}px;
    `;
    
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', '100%');
    svg.style.cssText = 'overflow: visible; display: block;';
    
    const relStartX = startX - left;
    const relStartY = startY - top;
    const relEndX = endX - left;
    const relEndY = endY - top;
    
    const shape = this.createSVGShape(shapeType, width, height, color, thickness, fill, relStartX, relStartY, relEndX, relEndY, origWidth, origHeight);
    svg.appendChild(shape);
    shapeWrapper.appendChild(svg);
    
    shapeWrapper.dataset.shapeType = shapeType;
    shapeWrapper.dataset.color = color;
    shapeWrapper.dataset.thickness = thickness;
    shapeWrapper.dataset.fill = fill ? 'true' : 'false';
    shapeWrapper.dataset.rotation = '0';
    
    this.addControls(shapeWrapper);
    this.addResizeHandles(shapeWrapper);
    this.addRotateHandle(shapeWrapper);
    this.makeDraggable(shapeWrapper);
    
    container.appendChild(shapeWrapper);
    this.shapes.push(shapeWrapper);
    this.selectShape(shapeWrapper);
    
    // שמירה אוטומטית
    this.saveShapes();
    
    return shapeWrapper;
  },
  
  createSVGShape(type, width, height, color, thickness, fill, relStartX, relStartY, relEndX, relEndY, origWidth, origHeight) {
    const ns = 'http://www.w3.org/2000/svg';
    let shape;
    const t = thickness / 2;
    
    switch(type) {
      case 'circle':
        shape = document.createElementNS(ns, 'ellipse');
        shape.setAttribute('cx', width / 2);
        shape.setAttribute('cy', height / 2);
        shape.setAttribute('rx', Math.max(1, (width - thickness) / 2));
        shape.setAttribute('ry', Math.max(1, (height - thickness) / 2));
        break;
        
      case 'square':
      case 'rectangle':
        shape = document.createElementNS(ns, 'rect');
        shape.setAttribute('x', t);
        shape.setAttribute('y', t);
        shape.setAttribute('width', Math.max(1, width - thickness));
        shape.setAttribute('height', Math.max(1, height - thickness));
        break;
        
      case 'triangle':
        shape = document.createElementNS(ns, 'polygon');
        if (origHeight >= 0) {
          shape.setAttribute('points', `${width/2},${t} ${t},${height-t} ${width-t},${height-t}`);
        } else {
          shape.setAttribute('points', `${width/2},${height-t} ${t},${t} ${width-t},${t}`);
        }
        break;
        
      case 'star':
        shape = document.createElementNS(ns, 'polygon');
        const cx = width / 2;
        const cy = height / 2;
        const outerR = Math.min(width, height) / 2 - thickness;
        const innerR = outerR / 2;
        let starPoints = [];
        let rot = Math.PI / 2 * 3;
        const step = Math.PI / 5;
        
        for (let i = 0; i < 5; i++) {
          starPoints.push(`${cx + Math.cos(rot) * outerR},${cy + Math.sin(rot) * outerR}`);
          rot += step;
          starPoints.push(`${cx + Math.cos(rot) * innerR},${cy + Math.sin(rot) * innerR}`);
          rot += step;
        }
        shape.setAttribute('points', starPoints.join(' '));
        break;
        
      case 'heart':
        shape = document.createElementNS(ns, 'path');
        const hw = width / 2;
        const hh = height;
        const hcx = hw;
        const hcy = 0;
        
        const d = `M ${hcx} ${hcy + hh * 0.3}
                   C ${hcx} ${hcy}, ${hcx - hw} ${hcy}, ${hcx - hw} ${hcy + hh * 0.3}
                   C ${hcx - hw} ${hcy + hh * 0.6}, ${hcx} ${hcy + hh * 0.9}, ${hcx} ${hcy + hh}
                   C ${hcx} ${hcy + hh * 0.9}, ${hcx + hw} ${hcy + hh * 0.6}, ${hcx + hw} ${hcy + hh * 0.3}
                   C ${hcx + hw} ${hcy}, ${hcx} ${hcy}, ${hcx} ${hcy + hh * 0.3} Z`;
        shape.setAttribute('d', d);
        break;
        
      case 'diamond':
        shape = document.createElementNS(ns, 'polygon');
        shape.setAttribute('points', `${width/2},${t} ${width-t},${height/2} ${width/2},${height-t} ${t},${height/2}`);
        break;
        
      case 'line':
        shape = document.createElementNS(ns, 'line');
        shape.setAttribute('x1', relStartX);
        shape.setAttribute('y1', relStartY);
        shape.setAttribute('x2', relEndX);
        shape.setAttribute('y2', relEndY);
        break;
        
      case 'arrow':
        shape = document.createElementNS(ns, 'g');
        
        const line = document.createElementNS(ns, 'line');
        line.setAttribute('x1', relStartX);
        line.setAttribute('y1', relStartY);
        line.setAttribute('x2', relEndX);
        line.setAttribute('y2', relEndY);
        line.setAttribute('stroke', color);
        line.setAttribute('stroke-width', thickness);
        
        const headlen = 15;
        const angle = Math.atan2(relEndY - relStartY, relEndX - relStartX);
        
        const arrow1 = document.createElementNS(ns, 'line');
        arrow1.setAttribute('x1', relEndX);
        arrow1.setAttribute('y1', relEndY);
        arrow1.setAttribute('x2', relEndX - headlen * Math.cos(angle - Math.PI/6));
        arrow1.setAttribute('y2', relEndY - headlen * Math.sin(angle - Math.PI/6));
        arrow1.setAttribute('stroke', color);
        arrow1.setAttribute('stroke-width', thickness);
        
        const arrow2 = document.createElementNS(ns, 'line');
        arrow2.setAttribute('x1', relEndX);
        arrow2.setAttribute('y1', relEndY);
        arrow2.setAttribute('x2', relEndX - headlen * Math.cos(angle + Math.PI/6));
        arrow2.setAttribute('y2', relEndY - headlen * Math.sin(angle + Math.PI/6));
        arrow2.setAttribute('stroke', color);
        arrow2.setAttribute('stroke-width', thickness);
        
        shape.appendChild(line);
        shape.appendChild(arrow1);
        shape.appendChild(arrow2);
        return shape;
        
      default:
        shape = document.createElementNS(ns, 'rect');
        shape.setAttribute('x', 0);
        shape.setAttribute('y', 0);
        shape.setAttribute('width', width);
        shape.setAttribute('height', height);
    }
    
    if (type !== 'arrow') {
      shape.setAttribute('stroke', color);
      shape.setAttribute('stroke-width', thickness);
      shape.setAttribute('fill', fill ? color : 'none');
    }
    
    return shape;
  },
  
  addControls(wrapper) {
    const controls = document.createElement('div');
    controls.className = 'shape-controls';
    const fillColor = wrapper.dataset.fillColor || wrapper.dataset.color;
    controls.innerHTML = `
      <div style="display:flex;align-items:center;gap:2px;" title="צבע קו">
        <span style="font-size:12px;">🖊️</span>
        <input type="color" class="shape-color-input stroke-color" value="${wrapper.dataset.color}">
      </div>
      <div style="display:flex;align-items:center;gap:2px;" title="צבע מילוי">
        <span style="font-size:12px;">🎨</span>
        <input type="color" class="shape-color-input fill-color" value="${fillColor}">
      </div>
      <button class="shape-control-btn fill-toggle" title="מילוי/ללא מילוי">🪣</button>
      <button class="shape-control-btn delete-btn" title="מחק">🗑️</button>
    `;
    
    const self = this;
    
    controls.querySelector('.stroke-color').addEventListener('input', function(e) {
      e.stopPropagation();
      self.setStrokeColor(wrapper, e.target.value);
    });
    
    controls.querySelector('.fill-color').addEventListener('input', function(e) {
      e.stopPropagation();
      self.setFillColor(wrapper, e.target.value);
    });
    
    controls.querySelector('.fill-toggle').addEventListener('click', function(e) {
      e.stopPropagation();
      self.toggleFill(wrapper);
    });
    
    controls.querySelector('.delete-btn').addEventListener('click', function(e) {
      e.stopPropagation();
      self.deleteShape(wrapper);
    });
    
    wrapper.appendChild(controls);
  },
  
  addResizeHandles(wrapper) {
    const self = this;
    ['nw', 'ne', 'sw', 'se'].forEach(pos => {
      const handle = document.createElement('div');
      handle.className = `shape-resize-handle ${pos}`;
      handle.addEventListener('mousedown', function(e) {
        e.stopPropagation();
        self.startResize(wrapper, pos, e);
      });
      wrapper.appendChild(handle);
    });
  },
  
  addRotateHandle(wrapper) {
    const line = document.createElement('div');
    line.className = 'shape-rotate-line';
    wrapper.appendChild(line);
    
    const handle = document.createElement('div');
    handle.className = 'shape-rotate-handle';
    handle.textContent = '↻';
    
    const self = this;
    handle.addEventListener('mousedown', function(e) {
      e.stopPropagation();
      self.startRotate(wrapper, e);
    });
    
    wrapper.appendChild(handle);
  },
  
  makeDraggable(wrapper) {
    const self = this;
    let isDragging = false;
    let startX, startY, initLeft, initTop;
    
    wrapper.addEventListener('mousedown', function(e) {
      if (e.target.classList.contains('shape-resize-handle') ||
          e.target.classList.contains('shape-rotate-handle') ||
          e.target.classList.contains('shape-control-btn') ||
          e.target.type === 'color') return;
      
      e.stopPropagation();
      self.selectShape(wrapper);
      
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      initLeft = wrapper.offsetLeft;
      initTop = wrapper.offsetTop;
      wrapper.style.cursor = 'grabbing';
    });
    
    document.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      const zoom = 0.85;
      wrapper.style.left = (initLeft + (e.clientX - startX) / zoom) + 'px';
      wrapper.style.top = (initTop + (e.clientY - startY) / zoom) + 'px';
    });
    
    document.addEventListener('mouseup', function() {
      if (isDragging) {
        isDragging = false;
        wrapper.style.cursor = 'move';
        self.saveShapes();
      }
    });
  },
  
  selectShape(wrapper) {
    if (this.selectedShape && this.selectedShape !== wrapper) {
      this.selectedShape.classList.remove('selected');
    }
    wrapper.classList.add('selected');
    this.selectedShape = wrapper;
  },
  
  deselectAll() {
    if (this.selectedShape) {
      this.selectedShape.classList.remove('selected');
      this.selectedShape = null;
    }
  },
  
  setStrokeColor(wrapper, color) {
    const shapes = wrapper.querySelectorAll('svg *[stroke]');
    shapes.forEach(s => s.setAttribute('stroke', color));
    wrapper.dataset.color = color;
    this.saveShapes();
  },
  
  setFillColor(wrapper, color) {
    const shape = wrapper.querySelector('svg rect, svg ellipse, svg polygon, svg path, svg circle');
    if (shape) {
      // שמור את צבע המילוי
      wrapper.dataset.fillColor = color;
      // אם הצורה מלאה, עדכן את הצבע
      if (wrapper.dataset.fill === 'true') {
        shape.setAttribute('fill', color);
      }
    }
    this.saveShapes();
  },
  
  toggleFill(wrapper) {
    const shape = wrapper.querySelector('svg rect, svg ellipse, svg polygon, svg path, svg circle');
    if (!shape) return;
    
    const currentFill = shape.getAttribute('fill');
    if (currentFill === 'none' || !currentFill) {
      // השתמש בצבע המילוי השמור, או בצבע הקו כברירת מחדל
      const fillColor = wrapper.dataset.fillColor || wrapper.dataset.color;
      shape.setAttribute('fill', fillColor);
      wrapper.dataset.fill = 'true';
    } else {
      shape.setAttribute('fill', 'none');
      wrapper.dataset.fill = 'false';
    }
    this.saveShapes();
  },
  
  startRotate(wrapper, e) {
    const rect = wrapper.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;
    const startAngle = Math.atan2(e.clientY - cy, e.clientX - cx);
    const initRotation = parseFloat(wrapper.dataset.rotation) || 0;
    const self = this;
    
    const onMove = (ev) => {
      const angle = Math.atan2(ev.clientY - cy, ev.clientX - cx);
      const rotation = initRotation + (angle - startAngle) * (180 / Math.PI);
      wrapper.dataset.rotation = rotation;
      wrapper.style.transform = `rotate(${rotation}deg)`;
    };
    
    const onUp = () => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      self.saveShapes();
    };
    
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  },
  
  startResize(wrapper, pos, e) {
    const startX = e.clientX;
    const startY = e.clientY;
    const initW = wrapper.offsetWidth;
    const initH = wrapper.offsetHeight;
    const initL = wrapper.offsetLeft;
    const initT = wrapper.offsetTop;
    const self = this;
    
    const onMove = (ev) => {
      const zoom = 0.85;
      const dx = (ev.clientX - startX) / zoom;
      const dy = (ev.clientY - startY) / zoom;
      
      let w = initW, h = initH, l = initL, t = initT;
      
      if (pos.includes('e')) w = Math.max(20, initW + dx);
      if (pos.includes('w')) { w = Math.max(20, initW - dx); l = initL + dx; }
      if (pos.includes('s')) h = Math.max(20, initH + dy);
      if (pos.includes('n')) { h = Math.max(20, initH - dy); t = initT + dy; }
      
      wrapper.style.width = w + 'px';
      wrapper.style.height = h + 'px';
      wrapper.style.left = l + 'px';
      wrapper.style.top = t + 'px';
      
      self.updateShape(wrapper);
    };
    
    const onUp = () => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      self.saveShapes();
    };
    
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  },
  
  updateShape(wrapper) {
    const svg = wrapper.querySelector('svg');
    const w = wrapper.offsetWidth;
    const h = wrapper.offsetHeight;
    const type = wrapper.dataset.shapeType;
    const color = wrapper.dataset.color;
    const thickness = parseInt(wrapper.dataset.thickness);
    const fill = wrapper.dataset.fill === 'true';
    
    svg.innerHTML = '';
    const newShape = this.createSVGShape(type, w, h, color, thickness, fill, 0, 0, w, h, w, h);
    svg.appendChild(newShape);
  },
  
  deleteShape(wrapper) {
    const idx = this.shapes.indexOf(wrapper);
    if (idx > -1) this.shapes.splice(idx, 1);
    if (this.selectedShape === wrapper) this.selectedShape = null;
    wrapper.remove();
    this.saveShapes();
  },
  
  // טעינת צורה שמורה
  loadShape(container, shapeData, pageIndex) {
    const width = parseFloat(shapeData.width);
    const height = parseFloat(shapeData.height);
    
    const shapeWrapper = document.createElement('div');
    shapeWrapper.className = 'interactive-shape';
    shapeWrapper.style.cssText = `
      position: absolute;
      left: ${shapeData.left};
      top: ${shapeData.top};
      width: ${shapeData.width};
      height: ${shapeData.height};
    `;
    
    if (shapeData.rotation && shapeData.rotation !== '0') {
      shapeWrapper.style.transform = `rotate(${shapeData.rotation}deg)`;
    }
    
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', '100%');
    svg.style.cssText = 'overflow: visible; display: block;';
    
    const fill = shapeData.fill === 'true';
    const fillColor = shapeData.fillColor || shapeData.color;
    const strokeColor = shapeData.color;
    
    // יצירת הצורה עם צבע הקו
    const shape = this.createSVGShape(
      shapeData.type, width, height, 
      strokeColor, parseInt(shapeData.thickness), fill,
      0, 0, width, height, width, height
    );
    
    // עדכון צבע המילוי בנפרד אם הצורה מלאה
    if (fill && shape) {
      const fillElement = shape.tagName === 'g' ? shape.querySelector('rect, ellipse, polygon, path, circle') : shape;
      if (fillElement && fillElement.getAttribute('fill') !== 'none') {
        fillElement.setAttribute('fill', fillColor);
      }
    }
    
    svg.appendChild(shape);
    shapeWrapper.appendChild(svg);
    
    shapeWrapper.dataset.shapeType = shapeData.type;
    shapeWrapper.dataset.color = shapeData.color;
    shapeWrapper.dataset.fillColor = fillColor;
    shapeWrapper.dataset.thickness = shapeData.thickness;
    shapeWrapper.dataset.fill = shapeData.fill;
    shapeWrapper.dataset.rotation = shapeData.rotation || '0';
    shapeWrapper.dataset.pageIndex = pageIndex;
    
    this.addControls(shapeWrapper);
    this.addResizeHandles(shapeWrapper);
    this.addRotateHandle(shapeWrapper);
    this.makeDraggable(shapeWrapper);
    
    container.appendChild(shapeWrapper);
    this.shapes.push(shapeWrapper);
  },
  
  // שמירת כל הצורות
  saveShapes() {
    if (!app.currentNotebook) return;
    
    const pages = document.querySelectorAll('.lined-page, .grid-page, .blank-page');
    pages.forEach((pageContainer, index) => {
      if (!app.subjects[app.currentNotebook].pages[index]) return;
      
      // שמירת צורות אינטראקטיביות
      const shapes = [];
      pageContainer.querySelectorAll('.interactive-shape').forEach(shape => {
        shapes.push({
          type: shape.dataset.shapeType,
          color: shape.dataset.color,
          fillColor: shape.dataset.fillColor || shape.dataset.color,
          thickness: shape.dataset.thickness,
          fill: shape.dataset.fill,
          rotation: shape.dataset.rotation,
          left: shape.style.left,
          top: shape.style.top,
          width: shape.style.width,
          height: shape.style.height
        });
      });
      app.subjects[app.currentNotebook].pages[index].interactiveShapes = shapes;
    });
    
    // שמירה ל-Supabase
    app.saveNotebookData();
  },
  
  setupGlobalListeners() {
    const self = this;
    
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.interactive-shape') && !e.target.closest('.shape-controls')) {
        self.deselectAll();
      }
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Delete' && self.selectedShape) {
        self.deleteShape(self.selectedShape);
      }
    });
  }
},

      // === מחשבון מדעי ===
calculator: {
  currentValue: '0',
  previousValue: null,
  operationSymbol: null,  // ⬅️ שינוי שם בלבד!
  waitingForOperand: false,
  memory: 0,
  angleMode: 'DEG',
  currentMode: 'basic',
  currentBase: 10,
  history: [],
  openParentheses: 0,
  keyboardListenersAdded: false,

        // עדכון התצוגה
        updateDisplay() {
          const display = document.getElementById('displayCurrent');
          const historyDisplay = document.getElementById('displayHistory');
          const modeDisplay = document.getElementById('angleMode');
          const memoryIndicator = document.getElementById('memoryIndicator');
          
          if (display) {
            // Handle error state
            if (this.currentValue === 'Error' || this.currentValue === 'NaN' || this.currentValue === 'Infinity') {
              display.textContent = 'Error';
              display.style.color = '#e74c3c';
            } else {
              display.style.color = 'white';
              
              // Format the number properly
              let displayValue = this.currentValue;
              
              if (this.currentMode === 'programmer' && this.currentBase !== 10) {
                const num = parseInt(displayValue) || 0;
                displayValue = this.formatInCurrentBase(num.toString());
              } else if (!isNaN(displayValue) && displayValue !== '' && Math.abs(parseFloat(displayValue)) >= 1e12) {
                // Use scientific notation for very large numbers
                displayValue = parseFloat(displayValue).toExponential(6);
              } else if (!isNaN(displayValue) && displayValue !== '' && displayValue.length > 15) {
                // Limit decimal places for long numbers
                const num = parseFloat(displayValue);
                displayValue = num.toPrecision(12);
              }
              
              display.textContent = displayValue;
            }
          }
          
          if (modeDisplay) {
            modeDisplay.textContent = this.angleMode;
          }
          
          if (memoryIndicator) {
            memoryIndicator.style.display = this.memory !== 0 ? 'inline' : 'none';
          }

          // Update programmer displays
          if (this.currentMode === 'programmer') {
            this.updateProgrammerDisplays();
          }
        },

        // עדכון תצוגות מתכנת
        updateProgrammerDisplays() {
          const value = parseInt(this.currentValue) || 0;
          
          const hexDisplay = document.getElementById('hexDisplay');
          const decDisplay = document.getElementById('decDisplay');
          const octDisplay = document.getElementById('octDisplay');
          const binDisplay = document.getElementById('binDisplay');
          
          if (hexDisplay) hexDisplay.textContent = value.toString(16).toUpperCase();
          if (decDisplay) decDisplay.textContent = value.toString(10);
          if (octDisplay) octDisplay.textContent = value.toString(8);
          if (binDisplay) binDisplay.textContent = value.toString(2);
        },

        // עיצוב במערכת המספרים הנוכחית  
        formatInCurrentBase(value) {
          const num = parseInt(value) || 0;
          switch(this.currentBase) {
            case 2: return num.toString(2);
            case 8: return num.toString(8);
            case 16: return num.toString(16).toUpperCase();
            default: return num.toString();
          }
        },

        // החלפת מצב
        toggleMode(mode) {
          this.currentMode = mode;
          
          // Update mode buttons
          document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.mode === mode) {
              btn.classList.add('active');
            }
          });
          
          // Show/hide appropriate button grids
          document.querySelectorAll('.button-grid').forEach(grid => {
            grid.style.display = 'none';
          });
          
          const activeGrid = document.querySelector(`.${mode}-mode`);
          if (activeGrid) {
            activeGrid.style.display = 'grid';
          }
          
          // Reset to base 10 when switching modes
          if (mode !== 'programmer') {
            this.currentBase = 10;
          } else {
            this.updateHexButtonStates();
            this.updateProgrammerDisplays();
          }
          
          this.updateDisplay();
        },

        // עדכון מצב כפתורי hex
        updateHexButtonStates() {
          const hexButtons = document.querySelectorAll('.hex-btn');
          hexButtons.forEach(btn => {
            const digit = btn.textContent;
            const digitValue = parseInt(digit, 16);
            btn.disabled = digitValue >= this.currentBase;
          });
        },

        // קלט מספר
// קלט מספר
// קלט מספר
inputNumber(num) {
  console.log('inputNumber called:', num, 'waitingForOperand:', this.waitingForOperand);
  
  if (this.currentMode === 'programmer' && this.currentBase !== 10) {
    const digitValue = parseInt(num, this.currentBase);
    if (digitValue >= this.currentBase) return;
  }
  
  // אם התוצאה היא שגיאה, אפס
  if (this.currentValue === 'Error' || this.currentValue === 'NaN' || this.currentValue === 'Infinity') {
    this.currentValue = '0';
  }
  
  if (this.waitingForOperand) {
    this.currentValue = num;
    this.waitingForOperand = false;
  } else {
    this.currentValue = this.currentValue === '0' ? num : this.currentValue + num;
  }
  
  console.log('New currentValue:', this.currentValue);
  this.updateDisplay();
},

// נקודה עשרונית
decimal() {
  if (this.currentMode === 'programmer') return;
  
  if (this.waitingForOperand) {
    this.currentValue = '0.';
    this.waitingForOperand = false;
  } else if (this.currentValue.indexOf('.') === -1) {
    this.currentValue += '.';
  }
  
  this.updateDisplay();
},

// ניקוי
clear() {
  this.currentValue = '0';
  this.previousValue = null;
  this.operationSymbol = null;
  this.waitingForOperand = false;
  this.openParentheses = 0;
  document.getElementById('displayHistory').textContent = '';
  
  const display = document.getElementById('displayCurrent');
  if (display) {
    display.style.color = 'white';
  }
  
  this.updateDisplay();
},

// ניקוי כניסה
clearEntry() {
  this.currentValue = '0';
  this.updateDisplay();
},

// מחיקה אחורנית
backspace() {
  if (this.currentValue.length > 1 && this.currentValue !== '0') {
    this.currentValue = this.currentValue.slice(0, -1);
  } else {
    this.currentValue = '0';
  }
  this.updateDisplay();
},

// סימן פלוס מינוס
plusMinus() {
  if (this.currentValue !== '0' && this.currentValue !== 'Error') {
    if (this.currentValue.startsWith('-')) {
      this.currentValue = this.currentValue.slice(1);
    } else {
      this.currentValue = '-' + this.currentValue;
    }
  }
  this.updateDisplay();
},

operation(nextOperation) {
  const inputValue = this.currentMode === 'programmer' && ['and', 'or', 'xor', 'lshift', 'rshift', 'mod'].includes(nextOperation) 
    ? parseInt(this.currentValue) 
    : parseFloat(this.currentValue);
  
  if (this.previousValue === null) {
    this.previousValue = inputValue;
  } else if (this.operationSymbol && !this.waitingForOperand) {
    let newValue;
    
    if (['and', 'or', 'xor', 'lshift', 'rshift', 'mod'].includes(this.operationSymbol)) {
      newValue = this.calculateBitwise(parseInt(this.previousValue), parseInt(inputValue), this.operationSymbol);
    } else {
      newValue = this.calculate(this.previousValue, inputValue, this.operationSymbol);
    }
    
    this.currentValue = String(newValue);
    this.previousValue = newValue;
  }
  
  this.waitingForOperand = true;
  this.operationSymbol = nextOperation;
  
  document.getElementById('displayHistory').textContent = 
    `${this.previousValue} ${this.getOperationSymbol(nextOperation)}`;
},

equals() {
  const inputValue = parseFloat(this.currentValue);
  
  if (this.previousValue !== null && this.operationSymbol) {
    const expression = `${this.previousValue} ${this.getOperationSymbol(this.operationSymbol)} ${inputValue}`;
    let newValue;
    
    if (['and', 'or', 'xor', 'lshift', 'rshift', 'mod'].includes(this.operationSymbol)) {
      newValue = this.calculateBitwise(parseInt(this.previousValue), parseInt(inputValue), this.operationSymbol);
    } else {
      newValue = this.calculate(this.previousValue, inputValue, this.operationSymbol);
    }
    
    this.addToHistory(expression, newValue);
    
    this.currentValue = String(newValue);
    this.previousValue = null;
    this.operationSymbol = null;
    this.waitingForOperand = true;
    
    document.getElementById('displayHistory').textContent = '';
    this.updateDisplay();
  }
},

// ניקוי
clear() {
  this.currentValue = '0';
  this.previousValue = null;
  this.currentOperation = null;  // ⬅️ שינוי שם
  this.waitingForOperand = false;
  this.openParentheses = 0;
  
  const historyDisplay = document.getElementById('displayHistory');
  if (historyDisplay) {
    historyDisplay.textContent = '';
  }
  
  const display = document.getElementById('displayCurrent');
  if (display) {
    display.style.color = 'white';
  }
  
  this.updateDisplay();
},

        // פונקציות מתמטיות
        function(func) {
          const value = parseFloat(this.currentValue);
          let result;
          let functionExpression = `${func}(${value})`;
          
          switch(func) {
            case 'sin':
              result = Math.sin(this.angleMode === 'DEG' ? value * Math.PI / 180 : value);
              functionExpression = `sin(${value}${this.angleMode === 'DEG' ? '°' : ''})`;
              break;
            case 'cos':
              result = Math.cos(this.angleMode === 'DEG' ? value * Math.PI / 180 : value);
              functionExpression = `cos(${value}${this.angleMode === 'DEG' ? '°' : ''})`;
              break;
            case 'tan':
              result = Math.tan(this.angleMode === 'DEG' ? value * Math.PI / 180 : value);
              functionExpression = `tan(${value}${this.angleMode === 'DEG' ? '°' : ''})`;
              break;
            case 'asin':
              if (value < -1 || value > 1) {
                result = NaN;
              } else {
                result = Math.asin(value);
                result = this.angleMode === 'DEG' ? result * 180 / Math.PI : result;
              }
              functionExpression = `asin(${value})`;
              break;
            case 'acos':
              if (value < -1 || value > 1) {
                result = NaN;
              } else {
                result = Math.acos(value);
                result = this.angleMode === 'DEG' ? result * 180 / Math.PI : result;
              }
              functionExpression = `acos(${value})`;
              break;
            case 'atan':
              result = Math.atan(value);
              result = this.angleMode === 'DEG' ? result * 180 / Math.PI : result;
              functionExpression = `atan(${value})`;
              break;
            case 'log':
              result = value > 0 ? Math.log10(value) : NaN;
              break;
            case 'ln':
              result = value > 0 ? Math.log(value) : NaN;
              break;
            case 'sqrt':
              result = value >= 0 ? Math.sqrt(value) : NaN;
              break;
            case 'square':
              result = value * value;
              functionExpression = `(${value})²`;
              break;
            case 'cube':
              result = value * value * value;
              functionExpression = `(${value})³`;
              break;
            case 'reciprocal':
              result = value !== 0 ? 1 / value : NaN;
              functionExpression = `1/(${value})`;
              break;
            case 'factorial':
              const n = Math.floor(Math.abs(value));
              result = this.factorial(n);
              functionExpression = `${n}!`;
              break;
            case 'exp':
              result = Math.exp(value);
              functionExpression = `e^(${value})`;
              break;
            case 'power10':
              result = Math.pow(10, value);
              functionExpression = `10^(${value})`;
              break;
            case 'abs':
              result = Math.abs(value);
              functionExpression = `|${value}|`;
              break;
            case 'percent':
              result = value / 100;
              functionExpression = `${value}%`;
              break;
            case 'rand':
              result = Math.random();
              functionExpression = 'rand()';
              break;
case 'mod':
  // This will be handled as an operation, not a function
  this.operation('mod');  // ⬅️ זה נשאר operation (זו הפונקציה!)
  return;
          }
          
          // Handle NaN results
          if (isNaN(result) || !isFinite(result)) {
            result = 'Error';
          }
          
          this.addToHistory(functionExpression, result);
          this.currentValue = String(result);
          this.waitingForOperand = true;
          this.updateDisplay();
        },

        // חישוב עצרת
        factorial(n) {
          if (n < 0 || n > 170) return NaN; // Prevent overflow
          if (n === 0 || n === 1) return 1;
          let result = 1;
          for (let i = 2; i <= n; i++) {
            result *= i;
          }
          return result;
        },

        // קבועים
        constant(name) {
          let value;
          switch(name) {
            case 'pi':
              value = Math.PI;
              break;
            case 'e':
              value = Math.E;
              break;
            default:
              return;
          }
          
          this.currentValue = String(value);
          this.waitingForOperand = true;
          this.updateDisplay();
        },

        // החלפת מצב זוויות
        toggleAngleMode() {
          this.angleMode = this.angleMode === 'DEG' ? 'RAD' : 'DEG';
          const btn = document.querySelector('[onclick="app.calculator.toggleAngleMode()"]');
          if (btn) btn.textContent = this.angleMode;
          this.updateDisplay();
        },

        // סוגריים
        openParenthesis() {
          if (this.waitingForOperand) {
            this.currentValue = '';
            this.waitingForOperand = false;
          }
          this.currentValue += '(';
          this.openParentheses++;
          this.updateDisplay();
        },

        closeParenthesis() {
          if (this.openParentheses > 0) {
            this.currentValue += ')';
            this.openParentheses--;
            this.updateDisplay();
          }
        },

        // פונקציות זיכרון
        memoryRecall() {
          this.currentValue = String(this.memory);
          this.waitingForOperand = true;
          this.updateDisplay();
        },

        memoryClear() {
          this.memory = 0;
          this.updateDisplay();
        },

        memoryPlus() {
          this.memory += parseFloat(this.currentValue) || 0;
          this.updateDisplay();
        },

        memoryMinus() {
          this.memory -= parseFloat(this.currentValue) || 0;
          this.updateDisplay();
        },

        // פונקציות מתכנת
        setBase(base) {
          this.currentBase = base;
          
          // Update button labels
          const baseButtons = {
            2: 'BIN',
            8: 'OCT', 
            10: 'DEC',
            16: 'HEX'
          };
          
          document.querySelectorAll('[onclick*="setBase"]').forEach(btn => {
            btn.classList.remove('active');
          });
          
          const activeButton = document.querySelector(`[onclick="app.calculator.setBase(${base})"]`);
          if (activeButton) {
            activeButton.classList.add('active');
          }
          
          this.updateHexButtonStates();
          
          // Convert current value to new base
          const currentNum = parseInt(this.currentValue) || 0;
          this.currentValue = this.formatInCurrentBase(currentNum.toString());
          
          this.updateDisplay();
        },

bitwiseOperation(op) {
  const value = parseInt(this.currentValue) || 0;
  let result;
  
  switch(op) {
    case 'and':
      this.operationSymbol = 'and';
      this.waitingForOperand = true;
      this.previousValue = value;
      break;
    case 'or':
      this.operationSymbol = 'or';
      this.waitingForOperand = true;
      this.previousValue = value;
      break;
    case 'xor':
      this.operationSymbol = 'xor';
      this.waitingForOperand = true;
      this.previousValue = value;
      break;
    case 'not':
      result = ~value;
      this.currentValue = String(result);
      this.waitingForOperand = true;
      this.updateDisplay();
      break;
    case 'lshift':
      this.operationSymbol = 'lshift';
      this.waitingForOperand = true;
      this.previousValue = value;
      break;
    case 'rshift':
      this.operationSymbol = 'rshift';
      this.waitingForOperand = true;
      this.previousValue = value;
      break;
  }
},

// קבלת סימן פעולה
getOperationSymbol(op) {
  const symbols = {
    '+': '+',
    '-': '−',
    '*': '×',
    '/': '÷',
    '^': '^',
    'and': '&',
    'or': '|',
    'xor': '⊕',
    'lshift': '<<',
    'rshift': '>>',
    'mod': 'mod'
  };
  return symbols[op] || op;
},

// חישוב
calculate(firstValue, secondValue, operation) {
  switch (operation) {
    case '+': return firstValue + secondValue;
    case '-': return firstValue - secondValue;
    case '*': return firstValue * secondValue;
    case '/': return secondValue !== 0 ? firstValue / secondValue : NaN;
    case '^': return Math.pow(firstValue, secondValue);
    default: return secondValue;
  }
},

// חישוב bitwise
calculateBitwise(first, second, operation) {
  switch(operation) {
    case 'and': return first & second;
    case 'or': return first | second;
    case 'xor': return first ^ second;
    case 'lshift': return first << second;
    case 'rshift': return first >> second;
    case 'mod': return first % second;
    default: return this.calculate(first, second, operation);
  }
},

        // הוספה להיסטוריה
        addToHistory(expression, result) {
          const historyItem = {
            expression: expression,
            result: result,
            timestamp: new Date().toLocaleTimeString('he-IL')
          };
          
          this.history.unshift(historyItem);
          if (this.history.length > 50) {
            this.history = this.history.slice(0, 50); // Keep only last 50 calculations
          }
          
          this.updateHistoryDisplay();
        },

        // עדכון תצוגת היסטוריה
        updateHistoryDisplay() {
          const historyList = document.getElementById('historyList');
          if (!historyList) return;
          
          if (this.history.length === 0) {
            historyList.innerHTML = `
              <div class="history-empty">
                <div class="empty-icon">🧮</div>
                <div class="empty-text">אין היסטוריה עדיין<br>התחל לחשב!</div>
              </div>
            `;
            return;
          }
          
          historyList.innerHTML = this.history.map(item => `
            <div class="history-item" onclick="app.calculator.useHistoryResult('${item.result}')">
              <div class="history-expression">${item.expression}</div>
              <div class="history-result">= ${item.result}</div>
              <div class="history-time">${item.timestamp}</div>
            </div>
          `).join('');
        },

        // שימוש בתוצאה מההיסטוריה
        useHistoryResult(result) {
          this.currentValue = String(result);
          this.waitingForOperand = true;
          this.updateDisplay();
        },

        // ניקוי היסטוריה
        clearHistory() {
          if (confirm('האם אתה בטוח שברצונך למחוק את כל ההיסטוריה?')) {
            this.history = [];
            this.updateHistoryDisplay();
          }
        },

        // אתחול
        init() {
          this.updateDisplay();
          this.updateHistoryDisplay();
          
          // Setup keyboard listeners only once
          if (!this.keyboardListenersAdded) {
            this.setupKeyboardListeners();
            this.keyboardListenersAdded = true;
          }
        },

        // הגדרת מאזיני מקלדת
        setupKeyboardListeners() {
          document.addEventListener('keydown', (e) => {
            // Only handle keyboard when calculator page is active
            if (!document.getElementById('calculator').classList.contains('active')) return;
            
            e.preventDefault();
            
            switch(e.key) {
              case '0': case '1': case '2': case '3': case '4':
              case '5': case '6': case '7': case '8': case '9':
                this.inputNumber(e.key);
                break;
              case '+':
                this.currentOperation('+');
                break;
              case '-':
                this.currentOperation('-');
                break;
              case '*':
                this.currentOperation('*');
                break;
              case '/':
                this.currentOperation('/');
                break;
              case '=':
              case 'Enter':
                this.equals();
                break;
              case '.':
                this.decimal();
                break;
              case 'Escape':
                this.clear();
                break;
              case 'Backspace':
                this.backspace();
                break;
              case 'Delete':
                this.clearEntry();
                break;
              case 'A': case 'B': case 'C': case 'D': case 'E': case 'F':
                if (this.currentMode === 'programmer') {
                  this.inputHex(e.key);
                }
                break;
            }
          });
        }
      }
    };

    // הפעלת האפליקציה כשהדף נטען
    document.addEventListener('DOMContentLoaded', function() {
      app.init();
      
      // הפעלת מערכת Auto Logout
      setTimeout(() => {
        if (currentUser) {
          autoLogout.init();
        }
      }, 2000);
      
      // אירועי מודל עריכת משימה
      document.getElementById('taskEditModal').addEventListener('click', function(e) {
        if (e.target === this) {
          app.closeTaskEditModal();
        }
      });

      // אירועי מודל יצירת מחברת
      document.getElementById('notebookModal').addEventListener('click', function(e) {
        if (e.target === this) {
          app.closeNotebookCreator();
        }
      });
      
      document.getElementById('notebookName').addEventListener('input', function() {
        app.updateCreateButton();
      });
      
      document.getElementById('notebookName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !document.getElementById('createBtn').disabled) {
          app.createNotebook();
        }
      });
      
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          app.closeTaskEditModal();
          app.closeNotebookCreator();
          app.closeEventModal();
        }
      });
      
      // Initialize with default selections for notebook creator
      app.selectPageType('lined');
      app.selectColor('#9b59b6');
      
      // טעינת שם המשתמש לתצוגה
      app.updateUserNameDisplay();
      
      // כניסה אוטומטית למסך מלא
      app.autoEnterFullscreen();
      
      // מאזין לשינוי מצב מסך מלא (למקרה שלוחצים ESC)
      document.addEventListener('fullscreenchange', function() {
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        if (document.fullscreenElement) {
          fullscreenBtn.classList.add('active');
          fullscreenBtn.title = 'צא ממסך מלא';
        } else {
          fullscreenBtn.classList.remove('active');
          fullscreenBtn.title = 'מסך מלא';
        }
      });
    });

    // שמירה לפני סגירת הדף
    window.addEventListener('beforeunload', function() {
      app.saveTaskData();
      app.saveNotebookData();
      app.saveCalendarData();
      stickyNotes.saveAllNotes();
    });

    // ===== Sticky Notes System =====
    const stickyNotes = {
      notes: [],
      draggedNote: null,
      dragOffset: { x: 0, y: 0 },
      nextId: 1,

      init() {
        this.loadNotes();
        this.updateCounter();
        
        // סגירת תפריט בלחיצה מחוץ לו
        document.addEventListener('click', (e) => {
          const menu = document.getElementById('stickyNotesMenu');
          const fab = document.getElementById('stickyNotesFab');
          if (!menu.contains(e.target) && !fab.contains(e.target)) {
            menu.classList.remove('show');
          }
        });
      },

      toggleMenu() {
        const menu = document.getElementById('stickyNotesMenu');
        menu.classList.toggle('show');
      },

      createNote(color = 'yellow') {
        const note = {
          id: this.nextId++,
          color: color,
          content: '',
          x: window.innerWidth / 2 - 140,
          y: window.innerHeight / 2 - 100,
          width: 280,
          height: 200
        };

        this.notes.push(note);
        this.renderNote(note);
        this.saveAllNotes();
        this.updateCounter();
        
        // סגירת התפריט
        document.getElementById('stickyNotesMenu').classList.remove('show');
      },

      renderNote(note) {
        const noteDiv = document.createElement('div');
        noteDiv.className = `sticky-note color-${note.color}`;
        noteDiv.id = `sticky-note-${note.id}`;
        noteDiv.style.left = `${note.x}px`;
        noteDiv.style.top = `${note.y}px`;
        noteDiv.style.width = `${note.width}px`;
        noteDiv.style.height = `${note.height}px`;

        noteDiv.innerHTML = `
          <div class="sticky-note-header" data-note-id="${note.id}">
            <div class="sticky-note-title">📝 דף ממו</div>
            <div class="sticky-note-controls">
              <button class="sticky-note-btn" onclick="stickyNotes.minimizeNote(${note.id})" title="מזער">−</button>
              <button class="sticky-note-btn" onclick="stickyNotes.deleteNote(${note.id})" title="סגור">✕</button>
            </div>
          </div>
          <textarea 
            class="sticky-note-content" 
            placeholder="כתוב כאן..."
            data-note-id="${note.id}"
            oninput="stickyNotes.updateNoteContent(${note.id}, this.value)"
          >${note.content || ''}</textarea>
        `;

        document.body.appendChild(noteDiv);

        // הוספת גרירה
        const header = noteDiv.querySelector('.sticky-note-header');
        header.addEventListener('mousedown', (e) => this.startDrag(e, note.id));

        // שמירת שינויי גודל
        const resizeObserver = new ResizeObserver(() => {
          this.updateNoteSize(note.id);
        });
        resizeObserver.observe(noteDiv);

        // מיקוד על התוכן
        setTimeout(() => {
          noteDiv.querySelector('.sticky-note-content').focus();
        }, 100);
      },

      startDrag(e, noteId) {
        this.draggedNote = noteId;
        const noteDiv = document.getElementById(`sticky-note-${noteId}`);
        const rect = noteDiv.getBoundingClientRect();
        
        this.dragOffset = {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };

        noteDiv.style.zIndex = 9001;

        document.addEventListener('mousemove', this.onDrag);
        document.addEventListener('mouseup', this.stopDrag);
        
        e.preventDefault();
      },

      onDrag: function(e) {
        if (!stickyNotes.draggedNote) return;
        
        const noteDiv = document.getElementById(`sticky-note-${stickyNotes.draggedNote}`);
        const newX = e.clientX - stickyNotes.dragOffset.x;
        const newY = e.clientY - stickyNotes.dragOffset.y;
        
        noteDiv.style.left = `${newX}px`;
        noteDiv.style.top = `${newY}px`;
      },

      stopDrag: function() {
        if (stickyNotes.draggedNote) {
          stickyNotes.updateNotePosition(stickyNotes.draggedNote);
          stickyNotes.draggedNote = null;
        }
        
        document.removeEventListener('mousemove', stickyNotes.onDrag);
        document.removeEventListener('mouseup', stickyNotes.stopDrag);
      },

      updateNoteContent(noteId, content) {
        const note = this.notes.find(n => n.id === noteId);
        if (note) {
          note.content = content;
          this.saveAllNotes();
        }
      },

      updateNotePosition(noteId) {
        const noteDiv = document.getElementById(`sticky-note-${noteId}`);
        const note = this.notes.find(n => n.id === noteId);
        
        if (note && noteDiv) {
          note.x = parseInt(noteDiv.style.left);
          note.y = parseInt(noteDiv.style.top);
          this.saveAllNotes();
        }
      },

      updateNoteSize(noteId) {
        const noteDiv = document.getElementById(`sticky-note-${noteId}`);
        const note = this.notes.find(n => n.id === noteId);
        
        if (note && noteDiv) {
          note.width = noteDiv.offsetWidth;
          note.height = noteDiv.offsetHeight;
          this.saveAllNotes();
        }
      },

      minimizeNote(noteId) {
        const noteDiv = document.getElementById(`sticky-note-${noteId}`);
        if (noteDiv) {
          if (noteDiv.style.height === '40px') {
            const note = this.notes.find(n => n.id === noteId);
            noteDiv.style.height = `${note.height}px`;
            noteDiv.querySelector('.sticky-note-content').style.display = 'block';
          } else {
            noteDiv.style.height = '40px';
            noteDiv.querySelector('.sticky-note-content').style.display = 'none';
          }
        }
      },

      deleteNote(noteId) {
        const noteDiv = document.getElementById(`sticky-note-${noteId}`);
        if (noteDiv) {
          noteDiv.style.animation = 'fadeOut 0.3s ease';
          setTimeout(() => {
            noteDiv.remove();
            this.notes = this.notes.filter(n => n.id !== noteId);
            this.saveAllNotes();
            this.updateCounter();
          }, 300);
        }
      },

      clearAll() {
        if (this.notes.length === 0) return;
        
        if (confirm(`האם למחוק את כל ${this.notes.length} דפי הממו?`)) {
          this.notes.forEach(note => {
            const noteDiv = document.getElementById(`sticky-note-${note.id}`);
            if (noteDiv) noteDiv.remove();
          });
          
          this.notes = [];
          this.saveAllNotes();
          this.updateCounter();
          document.getElementById('stickyNotesMenu').classList.remove('show');
        }
      },

      updateCounter() {
        const count = this.notes.length;
        const counterEl = document.getElementById('notesCount');
        if (counterEl) {
          counterEl.textContent = count === 0 ? 'אין דפי ממו' : 
                                  count === 1 ? 'דף ממו אחד' : 
                                  `${count} דפי ממו`;
        }
      },

      saveAllNotes() {
        localStorage.setItem('stickyNotes', JSON.stringify(this.notes));
        localStorage.setItem('stickyNotesNextId', this.nextId);
      },

      loadNotes() {
        const saved = localStorage.getItem('stickyNotes');
        const savedNextId = localStorage.getItem('stickyNotesNextId');
        
        if (saved) {
          this.notes = JSON.parse(saved);
          this.nextId = savedNextId ? parseInt(savedNextId) : this.notes.length + 1;
          
          this.notes.forEach(note => {
            this.renderNote(note);
          });
        }
      }
    };

    // ===== Timer and Stopwatch System =====
    const timerApp = {
      stopwatchRunning: false,
      stopwatchStart: 0,
      stopwatchElapsed: 0,
      stopwatchInterval: null,
      laps: [],
      
      timerRunning: false,
      timerStart: 0,
      timerDuration: 0,
      timerRemaining: 0,
      timerInterval: null,

      init() {
        ['timerHours', 'timerMinutes', 'timerSeconds'].forEach(id => {
          const input = document.getElementById(id);
          if (input) {
            input.addEventListener('input', () => {
              let value = parseInt(input.value) || 0;
              const max = parseInt(input.max);
              if (value > max) input.value = max;
              if (value < 0) input.value = 0;
            });
          }
        });
      },

      switchTab(tab) {
        document.querySelectorAll('.timer-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.timer-tab-content').forEach(c => c.classList.remove('active'));

        if (tab === 'stopwatch') {
          document.querySelectorAll('.timer-tab')[0].classList.add('active');
          document.getElementById('stopwatchContent').classList.add('active');
        } else {
          document.querySelectorAll('.timer-tab')[1].classList.add('active');
          document.getElementById('timerContent').classList.add('active');
        }
      },

      startStopwatch() {
        if (!this.stopwatchRunning) {
          this.stopwatchRunning = true;
          this.stopwatchStart = Date.now() - this.stopwatchElapsed;
          this.stopwatchInterval = setInterval(() => this.updateStopwatch(), 100);

          document.getElementById('stopwatchStart').style.display = 'none';
          document.getElementById('stopwatchPause').style.display = 'flex';
          document.getElementById('stopwatchLap').disabled = false;
          document.getElementById('stopwatchPulse').classList.add('active');
        }
      },

      pauseStopwatch() {
        if (this.stopwatchRunning) {
          this.stopwatchRunning = false;
          clearInterval(this.stopwatchInterval);

          document.getElementById('stopwatchStart').style.display = 'flex';
          document.getElementById('stopwatchPause').style.display = 'none';
          document.getElementById('stopwatchPulse').classList.remove('active');
        }
      },

      resetStopwatch() {
        this.stopwatchRunning = false;
        this.stopwatchElapsed = 0;
        this.laps = [];
        clearInterval(this.stopwatchInterval);

        document.getElementById('stopwatchTime').innerHTML = '00:00:00<span style="font-size: 0.6em; opacity: 0.8;">.0</span>';
        document.getElementById('stopwatchCircle').style.strokeDashoffset = '565.48';

        document.getElementById('stopwatchStart').style.display = 'flex';
        document.getElementById('stopwatchPause').style.display = 'none';
        document.getElementById('stopwatchLap').disabled = true;
        document.getElementById('lapsContainer').style.display = 'none';
        document.getElementById('lapsList').innerHTML = '';
        document.getElementById('stopwatchPulse').classList.remove('active');
      },

      updateStopwatch() {
        this.stopwatchElapsed = Date.now() - this.stopwatchStart;

        const deciseconds = Math.floor((this.stopwatchElapsed % 1000) / 100);
        const secs = Math.floor((this.stopwatchElapsed / 1000) % 60);
        const mins = Math.floor((this.stopwatchElapsed / 60000) % 60);
        const hrs = Math.floor(this.stopwatchElapsed / 3600000);

        const display = 
          String(hrs).padStart(2, '0') + ':' +
          String(mins).padStart(2, '0') + ':' +
          String(secs).padStart(2, '0') +
          '<span style="font-size: 0.6em; opacity: 0.8;">.' + deciseconds + '</span>';

        document.getElementById('stopwatchTime').innerHTML = display;

        const progress = (this.stopwatchElapsed % 60000) / 60000;
        const offset = 565.48 - (progress * 565.48);
        document.getElementById('stopwatchCircle').style.strokeDashoffset = offset;
      },

      recordLap() {
        if (!this.stopwatchRunning) return;

        const lapTime = this.stopwatchElapsed;
        const prevLap = this.laps.length > 0 ? this.laps[this.laps.length - 1].time : 0;
        const diff = lapTime - prevLap;

        this.laps.push({
          number: this.laps.length + 1,
          time: lapTime,
          diff: diff
        });

        this.renderLaps();
        document.getElementById('lapsContainer').style.display = 'flex';
      },

      renderLaps() {
        const list = document.getElementById('lapsList');
        list.innerHTML = '';

        if (this.laps.length === 0) {
          list.innerHTML = '<div class="timer-empty-state"><div class="timer-empty-icon">🏁</div><div class="timer-empty-text">לא נרשמו סיבובים עדיין</div></div>';
          return;
        }

        document.getElementById('lapsCount').textContent = this.laps.length;

        const diffs = this.laps.map(l => l.diff);
        const fastest = Math.min(...diffs);
        const slowest = Math.max(...diffs);

        this.laps.slice().reverse().forEach(lap => {
          const div = document.createElement('div');
          div.className = 'timer-lap-item';

          if (this.laps.length > 1) {
            if (lap.diff === fastest) div.classList.add('fastest');
            if (lap.diff === slowest) div.classList.add('slowest');
          }

          div.innerHTML = `
            <div class="timer-lap-number">סיבוב ${lap.number}</div>
            <div class="timer-lap-time">${this.formatTime(lap.time)}</div>
            <div class="timer-lap-diff">+${this.formatTime(lap.diff)}</div>
          `;

          list.appendChild(div);
        });
      },

      formatTime(ms) {
        const secs = Math.floor((ms / 1000) % 60);
        const mins = Math.floor((ms / 60000) % 60);
        const hrs = Math.floor(ms / 3600000);

        return String(hrs).padStart(2, '0') + ':' +
               String(mins).padStart(2, '0') + ':' +
               String(secs).padStart(2, '0');
      },

      setPreset(minutes, seconds) {
        document.getElementById('timerHours').value = 0;
        document.getElementById('timerMinutes').value = minutes;
        document.getElementById('timerSeconds').value = seconds;
        
        if (this.timerRunning) {
          this.resetTimer();
        }
        
        setTimeout(() => this.startTimer(), 100);
      },

      focusOnInput() {
        if (this.timerRunning) {
          this.resetTimer();
        }
        
        document.getElementById('timerHours').value = 0;
        document.getElementById('timerMinutes').value = 0;
        document.getElementById('timerSeconds').value = 0;
        
        const inputs = ['timerHours', 'timerMinutes', 'timerSeconds'];
        inputs.forEach(id => {
          const input = document.getElementById(id);
          input.classList.add('highlight');
          setTimeout(() => input.classList.remove('highlight'), 1000);
        });
        
        setTimeout(() => {
          const minutesInput = document.getElementById('timerMinutes');
          minutesInput.focus();
          minutesInput.select();
        }, 100);
        
        const inputSection = document.querySelector('.timer-input-section');
        if (inputSection) {
          inputSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      },

      startTimer() {
        const hours = parseInt(document.getElementById('timerHours').value) || 0;
        const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
        const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;

        if (!this.timerRunning) {
          if (this.timerRemaining === 0) {
            this.timerDuration = (hours * 3600 + minutes * 60 + seconds) * 1000;
            this.timerRemaining = this.timerDuration;
          }

          if (this.timerRemaining === 0) {
            alert('⚠️ אנא הגדר זמן לטיימר');
            return;
          }

          this.timerRunning = true;
          this.timerStart = Date.now();
          this.timerInterval = setInterval(() => this.updateTimer(), 100);

          document.getElementById('timerStart').style.display = 'none';
          document.getElementById('timerPause').style.display = 'flex';
          document.getElementById('timerHours').disabled = true;
          document.getElementById('timerMinutes').disabled = true;
          document.getElementById('timerSeconds').disabled = true;
          document.getElementById('timerPulse').classList.add('active');
        }
      },

      pauseTimer() {
        if (this.timerRunning) {
          this.timerRunning = false;
          clearInterval(this.timerInterval);
          this.timerRemaining -= (Date.now() - this.timerStart);

          document.getElementById('timerStart').style.display = 'flex';
          document.getElementById('timerStart').innerHTML = '<span>▶️</span><span>המשך</span>';
          document.getElementById('timerPause').style.display = 'none';
          document.getElementById('timerPulse').classList.remove('active');
        }
      },

      resetTimer() {
        this.timerRunning = false;
        this.timerRemaining = 0;
        this.timerDuration = 0;
        clearInterval(this.timerInterval);

        document.getElementById('timerTime').textContent = '00:00:00';
        document.getElementById('timerCircle').style.strokeDashoffset = '0';

        document.getElementById('timerStart').style.display = 'flex';
        document.getElementById('timerStart').innerHTML = '<span>▶️</span><span>התחל</span>';
        document.getElementById('timerPause').style.display = 'none';
        document.getElementById('timerHours').disabled = false;
        document.getElementById('timerMinutes').disabled = false;
        document.getElementById('timerSeconds').disabled = false;
        document.getElementById('timerPulse').classList.remove('active');
      },

      updateTimer() {
        const elapsed = Date.now() - this.timerStart;
        let remaining = this.timerRemaining - elapsed;

        if (remaining <= 0) {
          remaining = 0;
          this.timerComplete();
        }

        const totalSecs = Math.ceil(remaining / 1000);
        const hrs = Math.floor(totalSecs / 3600);
        const mins = Math.floor((totalSecs % 3600) / 60);
        const secs = totalSecs % 60;

        const display = 
          String(hrs).padStart(2, '0') + ':' +
          String(mins).padStart(2, '0') + ':' +
          String(secs).padStart(2, '0');

        document.getElementById('timerTime').textContent = display;

        const progress = 1 - (remaining / this.timerDuration);
        const offset = 565.48 - (progress * 565.48);
        document.getElementById('timerCircle').style.strokeDashoffset = offset;
      },

      timerComplete() {
        this.resetTimer();

        alert('⏰ הזמן נגמר!\n\nהטיימר הושלם בהצלחה! 🎉');

        if ('vibrate' in navigator) {
          navigator.vibrate([300, 100, 300, 100, 300]);
        }

        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = 800;
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.5);
        } catch (e) {
          console.log('Audio not supported');
        }
      }
    };

    // ========== Weekly Schedule App ==========
    const scheduleApp = {
      schedule: {},
      currentCell: null,
      timeSlots: [
        '08:00-08:45',
        '08:50-09:35',
        '09:50-10:35',
        '10:40-11:25',
        '11:45-12:30',
        '12:35-13:20',
        '13:30-14:15',
        '14:20-15:05',
        '15:10-15:55'
      ],
      days: ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
      dayNames: ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי'],

      async init() {
        await this.loadSchedule();
        this.renderTable();
        this.updateStats();
      },

      async loadSchedule() {
        try {
          // נסה לטעון מהענן
          const cloudData = await loadFromSupabase('weekly_schedule');
          if (cloudData && Object.keys(cloudData).length > 0) {
            this.schedule = cloudData;
            console.log('✅ מערכת שעות נטענה מהענן');
          } else {
            // נסה מ-localStorage
            const local = localStorage.getItem('weeklySchedule');
            if (local) {
              this.schedule = JSON.parse(local);
            } else {
              this.schedule = {};
            }
          }
        } catch (error) {
          console.error('שגיאה בטעינת מערכת:', error);
          const local = localStorage.getItem('weeklySchedule');
          this.schedule = local ? JSON.parse(local) : {};
        }
      },

      async saveSchedule() {
        try {
          localStorage.setItem('weeklySchedule', JSON.stringify(this.schedule));
          await saveToSupabase('weekly_schedule', this.schedule);
          console.log('✅ מערכת שעות נשמרה');
        } catch (error) {
          console.error('שגיאה בשמירת מערכת:', error);
        }
      },

      renderTable() {
        const tbody = document.getElementById('scheduleBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        this.timeSlots.forEach((time, timeIndex) => {
          const row = document.createElement('tr');
          
          // תא שעה
          const timeCell = document.createElement('td');
          timeCell.className = 'time-cell';
          timeCell.textContent = time;
          row.appendChild(timeCell);

          // תאי ימים
          this.days.forEach((day, dayIndex) => {
            const cell = document.createElement('td');
            cell.className = 'schedule-cell';
            cell.dataset.day = day;
            cell.dataset.time = timeIndex;
            
            const key = `${day}-${timeIndex}`;
            const lesson = this.schedule[key];
            
            if (lesson) {
              cell.classList.add('has-lesson');
              cell.innerHTML = `
                <div class="lesson-content">
                  <div class="lesson-subject">${lesson.subject}</div>
                  ${lesson.room ? `<div class="lesson-room">📍 ${lesson.room}</div>` : ''}
                  ${lesson.teacher ? `<div class="lesson-teacher">👤 ${lesson.teacher}</div>` : ''}
                </div>
              `;
            } else {
              cell.innerHTML = '<div class="empty-cell-hint">+</div>';
            }
            
            cell.onclick = () => this.openModal(day, timeIndex);
            row.appendChild(cell);
          });

          tbody.appendChild(row);
        });
      },

      openModal(day, timeIndex) {
        this.currentCell = { day, timeIndex };
        const key = `${day}-${timeIndex}`;
        const lesson = this.schedule[key];
        const dayName = this.dayNames[this.days.indexOf(day)];
        const time = this.timeSlots[timeIndex];

        document.getElementById('scheduleModalTitle').textContent = 
          lesson ? `ערוך שיעור - יום ${dayName} ${time}` : `הוסף שיעור - יום ${dayName} ${time}`;
        
        document.getElementById('lessonSubject').value = lesson?.subject || '';
        document.getElementById('lessonRoom').value = lesson?.room || '';
        document.getElementById('lessonTeacher').value = lesson?.teacher || '';
        
        document.getElementById('deleteLessonBtn').style.display = lesson ? 'block' : 'none';
        
        document.getElementById('scheduleModal').classList.add('active');
      },

      closeModal() {
        document.getElementById('scheduleModal').classList.remove('active');
        this.currentCell = null;
      },

      async saveLesson() {
        const subject = document.getElementById('lessonSubject').value.trim();
        
        if (!subject) {
          alert('⚠️ יש להזין שם מקצוע');
          return;
        }

        const { day, timeIndex } = this.currentCell;
        const key = `${day}-${timeIndex}`;
        
        this.schedule[key] = {
          subject: subject,
          room: document.getElementById('lessonRoom').value.trim(),
          teacher: document.getElementById('lessonTeacher').value.trim()
        };

        await this.saveSchedule();
        this.renderTable();
        this.updateStats();
        this.closeModal();
        
        // סנכרן אוטומטית ליומן
        await this.syncSingleLesson(day, timeIndex);
      },

      async deleteLesson() {
        if (!confirm('האם למחוק את השיעור?')) return;
        
        const { day, timeIndex } = this.currentCell;
        const key = `${day}-${timeIndex}`;
        
        delete this.schedule[key];
        
        await this.saveSchedule();
        this.renderTable();
        this.updateStats();
        this.closeModal();
        
        // הסר מהיומן
        await this.removeFromCalendar(day, timeIndex);
      },

      updateStats() {
        const lessons = Object.keys(this.schedule).length;
        document.getElementById('totalLessons').textContent = lessons;
        
        // שיעורים היום
        const today = new Date().getDay();
        const todayDay = this.days[today] || 'saturday';
        const todayLessons = Object.keys(this.schedule).filter(key => key.startsWith(todayDay)).length;
        document.getElementById('todayLessons').textContent = todayLessons;
        
        // מקצועות ייחודיים
        const subjects = new Set(Object.values(this.schedule).map(l => l.subject));
        document.getElementById('uniqueSubjects').textContent = subjects.size;
      },

      // סנכרון שיעור בודד ליומן
      async syncSingleLesson(day, timeIndex) {
        const key = `${day}-${timeIndex}`;
        const lesson = this.schedule[key];
        if (!lesson) return;

        const dayIndex = this.days.indexOf(day);
        const timeSlot = this.timeSlots[timeIndex];
        const [startTime, endTime] = timeSlot.split('-');

        // חשב את התאריכים לשבועות הקרובים (4 שבועות קדימה)
        const today = new Date();
        const currentDayOfWeek = today.getDay();
        
        for (let week = 0; week < 4; week++) {
          let daysUntil = dayIndex - currentDayOfWeek;
          if (daysUntil < 0) daysUntil += 7;
          daysUntil += (week * 7);
          
          const lessonDate = new Date(today);
          lessonDate.setDate(today.getDate() + daysUntil);
          
          const dateStr = lessonDate.toISOString().split('T')[0];
          const eventId = `schedule-${day}-${timeIndex}-${dateStr}`;
          
          // בדוק אם האירוע כבר קיים
          const existingIndex = app.events.findIndex(e => e.id === eventId);
          
          const eventData = {
            id: eventId,
            title: lesson.subject,
            type: 'lesson',
            date: dateStr,
            startTime: startTime,
            endTime: endTime,
            description: `${lesson.teacher ? 'מורה: ' + lesson.teacher : ''}`,
            location: lesson.room || '',
            isFromSchedule: true,
            createdAt: new Date().toISOString()
          };
          
          if (existingIndex >= 0) {
            app.events[existingIndex] = eventData;
          } else {
            app.events.push(eventData);
          }
        }
        
        await app.saveCalendarData();
        app.loadWelcomeData(); // עדכן את "השיעור הבא"
      },

      // הסרה מהיומן
      async removeFromCalendar(day, timeIndex) {
        const prefix = `schedule-${day}-${timeIndex}`;
        app.events = app.events.filter(e => !e.id.startsWith(prefix));
        await app.saveCalendarData();
        app.loadWelcomeData();
      },

      // סנכרון מלא ליומן
      async syncToCalendar() {
        if (!confirm('לסנכרן את כל המערכת ליומן?\nזה יוסיף שיעורים ל-4 השבועות הקרובים.')) return;

        // הסר קודם את כל השיעורים מהמערכת
        app.events = app.events.filter(e => !e.isFromSchedule);

        // הוסף את כל השיעורים מחדש
        for (const [key, lesson] of Object.entries(this.schedule)) {
          const [day, timeIndex] = key.split('-');
          await this.syncSingleLesson(day, parseInt(timeIndex));
        }

        alert('✅ המערכת סונכרנה בהצלחה ליומן!');
        
        if (typeof app.renderCalendar === 'function') {
          app.renderCalendar();
        }
      },

      // מחיקת כל המערכת
      async clearAll() {
        if (!confirm('האם אתה בטוח?\nזה ימחק את כל המערכת השבועית!')) return;
        
        // הסר מהיומן
        app.events = app.events.filter(e => !e.isFromSchedule);
        await app.saveCalendarData();
        
        // נקה מערכת
        this.schedule = {};
        await this.saveSchedule();
        this.renderTable();
        this.updateStats();
        app.loadWelcomeData();
        
        alert('🗑️ המערכת נוקתה');
      }
    };

    // Links App - ניהול קישורים
    const linksApp = {
      links: [],
      editingLinkId: null,

      init() {
        this.loadLinks();
      },

      // טעינת קישורים
      async loadLinks() {
        try {
          // נסה לטעון מהענן
          const cloudData = await loadFromSupabase('user_links');
          if (cloudData && Array.isArray(cloudData) && cloudData.length > 0) {
            this.links = cloudData;
            console.log('✅ קישורים נטענו מהענן');
          } else {
            // נסה מ-localStorage
            const local = localStorage.getItem('myLinks');
            if (local) {
              this.links = JSON.parse(local);
            } else {
              this.links = [];
            }
          }
        } catch (error) {
          console.error('שגיאה בטעינת קישורים:', error);
          const local = localStorage.getItem('myLinks');
          this.links = local ? JSON.parse(local) : [];
        }
        this.renderLinks();
        this.updateStats();
      },

      // שמירת קישורים
      async saveLinks() {
        try {
          localStorage.setItem('myLinks', JSON.stringify(this.links));
          await saveToSupabase('user_links', this.links);
          console.log('✅ קישורים נשמרו');
        } catch (error) {
          console.error('שגיאה בשמירת קישורים:', error);
        }
      },

      // רינדור קישורים
      renderLinks() {
        const grid = document.getElementById('linksGrid');
        const empty = document.getElementById('linksEmpty');
        
        if (!grid) return;

        if (this.links.length === 0) {
          grid.style.display = 'none';
          if (empty) empty.style.display = 'block';
          return;
        }

        grid.style.display = 'grid';
        if (empty) empty.style.display = 'none';

        grid.innerHTML = this.links.map(link => this.createLinkCard(link)).join('');
      },

      // יצירת כרטיס קישור
      createLinkCard(link) {
        const favicon = this.getFaviconUrl(link.url);
        return `
          <div class="link-card" data-id="${link.id}">
            <div class="link-card-header">
              <img src="${favicon}" alt="" class="link-favicon" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🔗</text></svg>'">
              <div class="link-card-actions">
                <button class="link-card-action edit" onclick="linksApp.editLink('${link.id}')" title="ערוך">✏️</button>
                <button class="link-card-action delete" onclick="linksApp.deleteLink('${link.id}')" title="מחק">🗑️</button>
              </div>
            </div>
            <div class="link-name">${this.escapeHtml(link.name)}</div>
            <div class="link-url">${this.escapeHtml(link.url)}</div>
            <button class="link-open-btn" onclick="linksApp.openLink('${link.id}')">
              <span>🚀</span>
              פתח באתר
            </button>
          </div>
        `;
      },

      // קבלת favicon
      getFaviconUrl(url) {
        try {
          const urlObj = new URL(url);
          return `https://www.google.com/s2/favicons?domain=${urlObj.hostname}&sz=64`;
        } catch {
          return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🔗</text></svg>';
        }
      },

      // escape HTML
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },

      // פתיחת קישור
      openLink(id) {
        const link = this.links.find(l => l.id === id);
        if (link) {
          window.open(link.url, '_blank');
        }
      },

      // פתיחת מודל הוספה
      openAddModal() {
        this.editingLinkId = null;
        document.getElementById('linkModalTitle').textContent = 'הוסף קישור';
        document.getElementById('linkName').value = '';
        document.getElementById('linkUrl').value = '';
        document.getElementById('linkModal').classList.add('active');
      },

      // עריכת קישור
      editLink(id) {
        const link = this.links.find(l => l.id === id);
        if (!link) return;

        this.editingLinkId = id;
        document.getElementById('linkModalTitle').textContent = 'ערוך קישור';
        document.getElementById('linkName').value = link.name;
        document.getElementById('linkUrl').value = link.url;
        document.getElementById('linkModal').classList.add('active');
      },

      // שמירת קישור
      async saveLink() {
        const name = document.getElementById('linkName').value.trim();
        let url = document.getElementById('linkUrl').value.trim();

        if (!name || !url) {
          alert('נא למלא את כל השדות');
          return;
        }

        // הוסף https:// אם חסר
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          url = 'https://' + url;
        }

        // בדיקת URL תקין
        try {
          new URL(url);
        } catch {
          alert('כתובת URL לא תקינה');
          return;
        }

        if (this.editingLinkId) {
          // עריכה
          const index = this.links.findIndex(l => l.id === this.editingLinkId);
          if (index !== -1) {
            this.links[index].name = name;
            this.links[index].url = url;
          }
        } else {
          // הוספה
          this.links.push({
            id: Date.now().toString(),
            name: name,
            url: url,
            createdAt: new Date().toISOString()
          });
        }

        await this.saveLinks();
        this.renderLinks();
        this.updateStats();
        this.closeModal();
      },

      // מחיקת קישור
      async deleteLink(id) {
        if (!confirm('האם למחוק את הקישור?')) return;

        this.links = this.links.filter(l => l.id !== id);
        await this.saveLinks();
        this.renderLinks();
        this.updateStats();
      },

      // סגירת מודל
      closeModal() {
        document.getElementById('linkModal').classList.remove('active');
        this.editingLinkId = null;
      },

      // ניקוי כל הקישורים
      async clearAll() {
        if (!confirm('האם אתה בטוח?\nזה ימחק את כל הקישורים!')) return;

        this.links = [];
        await this.saveLinks();
        this.renderLinks();
        this.updateStats();
        alert('🗑️ כל הקישורים נמחקו');
      },

      // סינון קישורים
      filterLinks() {
        const searchTerm = document.getElementById('linksSearchInput').value.toLowerCase();
        const cards = document.querySelectorAll('.link-card');

        cards.forEach(card => {
          const name = card.querySelector('.link-name').textContent.toLowerCase();
          const url = card.querySelector('.link-url').textContent.toLowerCase();
          
          if (name.includes(searchTerm) || url.includes(searchTerm)) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        });
      },

      // עדכון סטטיסטיקות
      updateStats() {
        const totalEl = document.getElementById('totalLinks');
        const homeEl = document.getElementById('linksStatusHome');
        
        if (totalEl) totalEl.textContent = this.links.length;
        if (homeEl) homeEl.textContent = this.links.length + ' קישורים';
      }
    };

    // אתחול דפי ממו
    document.addEventListener('DOMContentLoaded', function() {
      stickyNotes.init();
      timerApp.init();
      scheduleApp.init();
      linksApp.init();
      
      // אתחול מערכת טוטוריאל
      TutorialSystem.init();
    });

// ========== מערכת טוטוריאל - My Campus ==========
const TutorialSystem = {
  tutorials: {
    homepage: [
      { target: '.navbar', title: 'סרגל ניווט 🧭', text: 'מכאן תנווט לכל חלקי האפליקציה.', position: 'bottom' },
      { target: '.welcome-section', title: 'התראות ומידע 📢', text: 'אזור התראות ומידע מהיר. לחיצה על תיבה תוביל ליעד שלה.', position: 'bottom' },
      { target: '.tools-grid', title: 'הכלים שלך 🛠️', text: 'גישה מהירה לכל הכלים.', position: 'top' }
    ],
    notebooks: [
      { target: '#notebooks .page-header', title: 'דף המחברות 📚', text: 'כאן מנוהלות כל המחברות שלך.', position: 'bottom' },
      { target: '#subjectsGrid', title: 'המחברות שלך 📓', text: 'לחץ על מחברת כדי לפתוח.', position: 'top' },
      { target: '#notebooks .add-page-btn', title: 'מחברת חדשה ➕', text: 'לחץ כאן ליצירת מחברת.', position: 'bottom' }
    ],
    notebookView: [
      { target: '#inPageToolbar', title: 'סרגל כלים ✏️', text: 'ערוך טקסט, צייר והוסף צורות ותמונות.', position: 'bottom', noPosition: true },
      { target: '#mathFormulasToolbar', title: 'סרגל נוסחאות 🔢 (בדף משובץ)', text: 'גרור וערוך נוסחאות על הדף.', position: 'right', noPosition: true }
    ],
    tasks: [
      { target: '#tasks .page-header', title: 'מנהל משימות ✅', text: 'כאן תנהל את המשימות שלך.', position: 'bottom' },
      { target: '.task-filters', title: 'סינון 🔍', text: 'סנן לפי סטטוס.', position: 'top' },
      { target: '.task-creator', title: 'משימה חדשה ➕', text: 'הוסף משימה כאן.', position: 'right' }
    ],
    calendar: [
      { target: '.calendar-nav', title: 'ניווט 📅', text: 'עבור בין חודשים.', position: 'bottom-far' },
      { target: '#calendarGrid', title: 'הימים 🗓️', text: 'לחץ על יום להוספת אירוע.', position: 'top' },
      { target: '.calendar-sidebar', title: 'חיפוש אירועים 🔍', text: 'חפש וסנן אירועים לפי סוג או תאריך.', position: 'left' }
    ],
    timer: [
      { target: '#timer .page-header', title: 'טיימר ⏱️', text: 'מדידת זמן וספירה לאחור.', position: 'bottom' }
    ],
    calculator: [
      { target: '#calculator .page-header', title: 'מחשבון 🧮', text: 'מחשבון מדעי מתקדם.', position: 'bottom' },
      { target: '.mode-btn', title: 'מצבים 🔢', text: 'בסיסי, מדעי ומתכנת.', position: 'bottom' }
    ],
    mylinks: [
      { target: '#mylinks .page-header', title: 'קישורים 🔗', text: 'שמור קישורים שימושיים.', position: 'bottom' }
    ],
    schedule: [
      { target: '#schedule .page-header', title: 'מערכת שעות 🗓️', text: 'בנה את מערכת השיעורים שלך.', position: 'bottom' },
      { target: '#scheduleTable', title: 'הוסף שיעור 📚', text: 'לחץ על תא להוספת שיעור. יסתנכרן אוטומטית ליומן!', position: 'top' }
    ]
  },
  currentPage: null,
  currentStep: 0,
  overlay: null,
  tooltip: null,
  highlightedEl: null,
  oldStyle: '',
  completedTutorials: {},
  currentUserId: null,

  getCurrentUser() {
    // בדוק את כל המקומות האפשריים למשתמש
    if (typeof currentUser !== 'undefined' && currentUser) return currentUser;
    if (app && app.currentUser) return app.currentUser;
    return null;
  },

  getLocalStorageKey() {
    const user = this.getCurrentUser();
    return 'tutorialState_' + (user ? user.id : 'guest');
  },

  async loadTutorialState() {
    // שמור מזהה משתמש נוכחי
    const user = this.getCurrentUser();
    this.currentUserId = user ? user.id : null;
    this.completedTutorials = {};
    
    try {
      if (typeof supabase !== 'undefined' && supabase && user) {
        const { data } = await supabase
          .from('user_data')
          .select('data')
          .eq('user_id', user.id)
          .eq('data_type', 'tutorial_state')
          .single();
        if (data && data.data) {
          this.completedTutorials = data.data;
          console.log('✅ מצב טוטוריאל נטען מ-Supabase:', this.completedTutorials);
          // עדכן גם localStorage
          localStorage.setItem(this.getLocalStorageKey(), JSON.stringify(this.completedTutorials));
          return;
        }
      }
    } catch (e) {
      console.log('⚠️ טעינה מ-Supabase נכשלה, מנסה localStorage');
    }
    
    // נסה מ-localStorage עם מזהה משתמש
    const saved = localStorage.getItem(this.getLocalStorageKey());
    if (saved) {
      this.completedTutorials = JSON.parse(saved);
      console.log('✅ מצב טוטוריאל נטען מ-localStorage:', this.completedTutorials);
    }
  },

  async saveTutorialState() {
    const user = this.getCurrentUser();
    
    // שמור ב-localStorage עם מזהה משתמש
    localStorage.setItem(this.getLocalStorageKey(), JSON.stringify(this.completedTutorials));
    
    try {
      if (typeof supabase !== 'undefined' && supabase && user) {
        await supabase.from('user_data').upsert({
          user_id: user.id,
          data_type: 'tutorial_state',
          data: this.completedTutorials,
          updated_at: new Date().toISOString()
        }, { onConflict: 'user_id,data_type' });
        console.log('✅ מצב טוטוריאל נשמר ב-Supabase');
      }
    } catch (e) {
      console.log('⚠️ שמירה ב-Supabase נכשלה');
    }
  },

  isPageCompleted(pageId) {
    return this.completedTutorials[pageId] === true;
  },

  markPageCompleted(pageId) {
    this.completedTutorials[pageId] = true;
    this.saveTutorialState();
  },

  doHighlight(el, noPosition) {
    if (this.highlightedEl) {
      this.highlightedEl.setAttribute('style', this.oldStyle);
    }
    this.oldStyle = el.getAttribute('style') || '';
    let styles = ';box-shadow:0 0 0 4px #667eea, 0 0 20px rgba(102,126,234,0.7) !important;outline:3px solid white !important;z-index:9999 !important;';
    if (!noPosition) styles += ';position:relative !important';
    el.setAttribute('style', this.oldStyle + styles);
    this.highlightedEl = el;
  },

  clearHighlight() {
    if (this.highlightedEl) {
      this.highlightedEl.setAttribute('style', this.oldStyle);
      this.highlightedEl = null;
      this.oldStyle = '';
    }
  },

  showStep() {
    const steps = this.tutorials[this.currentPage];
    if (this.currentStep >= steps.length) {
      this.endTutorial();
      return;
    }
    const step = steps[this.currentStep];
    const el = document.querySelector(step.target);
    if (!el) {
      this.currentStep++;
      this.showStep();
      return;
    }
    this.doHighlight(el, step.noPosition);
    const isLast = this.currentStep === steps.length - 1;
    this.tooltip.innerHTML = '<div style="font-size:1.2rem;font-weight:700;margin-bottom:10px;color:#333;">' + step.title + '</div><div style="font-size:0.95rem;color:#666;line-height:1.6;margin-bottom:15px;">' + step.text + '</div><div style="display:flex;justify-content:space-between;align-items:center;"><span style="color:#999;font-size:0.85rem;">' + (this.currentStep + 1) + ' / ' + steps.length + '</span><button style="padding:10px 20px;border-radius:10px;border:none;cursor:pointer;font-weight:600;background:linear-gradient(135deg,#667eea,#764ba2);color:white;" onclick="TutorialSystem.nextStep()">' + (isLast ? 'סיום ✓' : 'הבא ←') + '</button></div>';
    const rect = el.getBoundingClientRect();
    let top, left;
    if (step.position === 'bottom') { top = rect.bottom + 15; left = rect.left + rect.width / 2 - 160; }
    else if (step.position === 'bottom-far') { top = rect.bottom + 80; left = rect.left + rect.width / 2 - 160; }
    else if (step.position === 'top') { top = rect.top - 180; left = rect.left + rect.width / 2 - 160; }
    else if (step.position === 'left') { top = rect.top; left = rect.left - 340; }
    else if (step.position === 'right') { top = rect.top; left = rect.right + 15; }
    else { top = rect.top; left = rect.right + 15; }
    top = Math.max(10, Math.min(top, window.innerHeight - 200));
    left = Math.max(10, Math.min(left, window.innerWidth - 340));
    this.tooltip.style.top = top + 'px';
    this.tooltip.style.left = left + 'px';
  },

  nextStep() {
    this.currentStep++;
    this.showStep();
  },

  startTutorial(pageId) {
    if (!this.tutorials[pageId]) return;
    this.currentPage = pageId;
    this.currentStep = 0;
    if (this.overlay) this.overlay.remove();
    if (this.tooltip) this.tooltip.remove();
    this.clearHighlight();
    this.overlay = document.createElement('div');
    this.overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9990;pointer-events:none';
    document.body.appendChild(this.overlay);
    this.tooltip = document.createElement('div');
    this.tooltip.style.cssText = 'position:fixed;background:white;border-radius:16px;padding:20px;max-width:320px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:10000;direction:rtl;pointer-events:auto';
    document.body.appendChild(this.tooltip);
    this.showStep();
  },

  endTutorial() {
    this.clearHighlight();
    if (this.overlay) this.overlay.remove();
    if (this.tooltip) this.tooltip.remove();
    this.overlay = null;
    this.tooltip = null;
    this.markPageCompleted(this.currentPage);
    console.log('✅ טוטוריאל הסתיים:', this.currentPage);
  },

  checkAndStartTutorial(pageId) {
    setTimeout(async () => {
      // בדוק אם המשתמש השתנה
      const user = this.getCurrentUser();
      const currentUserId = user ? user.id : null;
      if (currentUserId !== this.currentUserId) {
        console.log('🔄 משתמש השתנה, טוען מצב טוטוריאל מחדש');
        await this.loadTutorialState();
      }
      
      if (!this.isPageCompleted(pageId) && this.tutorials[pageId]) {
        console.log('🎯 מפעיל טוטוריאל:', pageId);
        this.startTutorial(pageId);
      }
    }, 500);
  },

  async init() {
    await this.loadTutorialState();
    console.log('✅ מערכת טוטוריאל מוכנה');
  }
};

window.TutorialSystem = TutorialSystem;

// המשך מספור/תבליטים אוטומטי בלחיצה על Enter ב-contentEditable
document.addEventListener('keydown', function(e) {
  if (e.key !== 'Enter') return;
  
  const element = document.activeElement;
  if (!element || !element.id || !element.id.startsWith('textarea-')) return;
  if (element.tagName === 'TEXTAREA') return; // רק ל-contentEditable
  
  const selection = window.getSelection();
  if (!selection.rangeCount) return;
  
  const range = selection.getRangeAt(0);
  let node = range.startContainer;
  
  if (node.nodeType === 3) node = node.parentNode;
  
  const fullText = element.innerText;
  const lines = fullText.split('\n');
  
  let charCount = 0;
  let currentLineIndex = 0;
  
  const preCaretRange = range.cloneRange();
  preCaretRange.selectNodeContents(element);
  preCaretRange.setEnd(range.startContainer, range.startOffset);
  const caretOffset = preCaretRange.toString().length;
  
  for (let i = 0; i < lines.length; i++) {
    charCount += lines[i].length + 1;
    if (caretOffset < charCount) {
      currentLineIndex = i;
      break;
    }
  }
  
  const currentLine = lines[currentLineIndex] || '';
  
  const numberedMatch = currentLine.match(/^(\s*)(\d+)\.\s*/);
  const bulletMatch = currentLine.match(/^(\s*)(•|◦|▪)\s*/);
  
  if (numberedMatch) {
    e.preventDefault();
    const indent = numberedMatch[1];
    const currentNum = parseInt(numberedMatch[2]);
    const nextNum = currentNum + 1;
    
    const br = document.createElement('br');
    const textNode = document.createTextNode(indent + nextNum + '. ');
    
    range.deleteContents();
    range.insertNode(textNode);
    range.insertNode(br);
    
    range.setStartAfter(textNode);
    range.setEndAfter(textNode);
    selection.removeAllRanges();
    selection.addRange(range);
    
    const pageIndex = parseInt(element.id.replace('textarea-', ''));
    if (typeof app !== 'undefined' && app.savePage) {
      app.savePage(pageIndex, element.innerHTML);
    }
  } 
  else if (bulletMatch) {
    e.preventDefault();
    const indent = bulletMatch[1];
    const bullet = bulletMatch[2];
    
    const br = document.createElement('br');
    const textNode = document.createTextNode(indent + bullet + ' ');
    
    range.deleteContents();
    range.insertNode(textNode);
    range.insertNode(br);
    
    range.setStartAfter(textNode);
    range.setEndAfter(textNode);
    selection.removeAllRanges();
    selection.addRange(range);
    
    const pageIndex = parseInt(element.id.replace('textarea-', ''));
    if (typeof app !== 'undefined' && app.savePage) {
      app.savePage(pageIndex, element.innerHTML);
    }
  }
});

  </script>

<!-- מודאל מידע פרימיום (השוואה) -->
<div id="premiumInfoModal" class="premium-info-modal hidden">
  <div class="premium-info-overlay" onclick="app.closePremiumInfo()"></div>
  <div class="premium-info-content">
    <button class="premium-info-close" onclick="app.closePremiumInfo()">✕</button>
    
    <h2 class="premium-info-title">🌟 גרסה חינמית לעומת פרימיום</h2>
    <p class="premium-info-subtitle">
      אפשר ללמוד בחינם.<br>
      בפרימיום מקבלים יותר חופש, סדר ונוחות.
    </p>

    <div class="premium-plans">
      <!-- FREE -->
      <div class="premium-plan free-plan">
        <h3>🆓 גרסה חינמית</h3>
        <ul>
          <li>📘 2 מחברות שורה (עד 20 דפים)</li>
          <li>📊 מחברת משובצת (עד 20 דפים)</li>
          <li>🎨 מחברת ציור – דף אחד</li>
          <li>✅ מחברת צ'קליסט – דף אחד, עד 5 פריטים</li>
          <li>📋 עד 20 משימות פעילות</li>
          <li>📅 יומן ושעון עצר</li>
        </ul>
      </div>

      <!-- PRO -->
      <div class="premium-plan pro-plan">
        <h3>⭐ פרימיום</h3>
        <div id="proSectionContent">
          <ul>
            <li>📚 מחברות ללא הגבלה</li>
            <li>📄 כל סוגי המחברות</li>
            <li>♾️ דפים ללא הגבלה</li>
            <li>✅ צ'קליסט - דפים ופריטים ללא הגבלה</li>
            <li>📋 משימות פעילות ללא הגבלה</li>
            <li>📤 ייצוא מחברות ל-PDF</li>
            <li>📋 שכפול מחברות</li>
          </ul>
          <button class="premium-upgrade-btn" onclick="app.goToCheckout()">
            שדרוג לפרימיום ⭐
          </button>
        </div>
      </div>
    </div>

    <button class="premium-info-close-btn" onclick="app.closePremiumInfo()">סגור</button>
  </div>
</div>

<!-- עמוד שדרוג לפרימיום -->
<div id="upgradeModal" class="upgrade-page hidden">
  <div class="upgrade-page-content">
    <button class="upgrade-close-btn" onclick="app.closeUpgradeModal()">✕</button>
    
    <div class="upgrade-header">
      <h1>🌟 שדרוג לפרימיום</h1>
      <p class="upgrade-subtitle">הגרסה החינמית מאפשרת ללמוד ולהתקדם. גרסת הפרימיום נותנת יותר חופש, סדר ונוחות – לילד ולהורה.</p>
    </div>

    <div class="upgrade-plans-container">
      <!-- גרסה חינמית -->
      <div class="upgrade-plan free">
        <div class="plan-header">
          <span class="plan-icon">🆓</span>
          <h2>גרסה חינמית</h2>
        </div>
        <p class="plan-desc">מתאימה להתנסות ולשימוש יומיומי:</p>
        <ul class="plan-features">
          <li>📚 עד 5 מחברות (2 שורה, 1 משובצת, התנסות בחלקה ובצ'קליסט)</li>
          <li>📄 עד 20 דפים למחברת</li>
          <li>📋 עד 20 משימות פעילות</li>
          <li>✏️ כתיבה חופשית ולמידה מלאה</li>
        </ul>
        <div class="plan-price free-price">
          <span class="price-amount">חינם</span>
          <span class="price-period">לתמיד</span>
        </div>
      </div>

      <!-- גרסת פרימיום -->
      <div class="upgrade-plan premium">
        <div class="plan-badge">מומלץ</div>
        <div class="plan-header">
          <span class="plan-icon">⭐</span>
          <h2>גרסת פרימיום</h2>
        </div>
        <p class="plan-desc">למי שרוצה חוויית למידה מלאה ובלי מגבלות:</p>
        <ul class="plan-features">
          <li>📚 מחברות ללא הגבלה</li>
          <li>📄 כל סוגי המחברות והתבניות</li>
          <li>♾️ דפים ללא הגבלה</li>
          <li>📤 ייצוא מחברות ל־PDF ולהדפסה</li>
          <li>🔔 ניהול משימות מתקדם עם התראות</li>
          <li>⚙️ התאמה אישית ונגישות מתקדמת</li>
        </ul>
        <div class="plan-pricing">
          <div class="price-option" onclick="app.selectPlan('monthly')">
            <input type="radio" name="plan" id="monthly" value="monthly">
            <label for="monthly">
              <span class="price-type">חודשי</span>
              <span class="price-amount">₪10.90</span>
              <span class="price-period">לחודש</span>
            </label>
          </div>
          <div class="price-option recommended" onclick="app.selectPlan('yearly')">
            <div class="save-badge">חודש חינם!</div>
            <input type="radio" name="plan" id="yearly" value="yearly" checked>
            <label for="yearly">
              <span class="price-type">שנתי</span>
              <span class="price-amount">₪119.90</span>
              <span class="price-period">לשנה (₪10 לחודש)</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- ניסיון חינם -->
    <div class="trial-section">
      <div class="trial-icon">🎁</div>
      <h3>ניסיון פרימיום חינמי</h3>
      <p>אפשר לנסות את כל פיצ'רי הפרימיום ל־<strong>7 ימים</strong> ללא כרטיס אשראי.</p>
      <p class="trial-note">בסיום הניסיון חוזרים אוטומטית לגרסה החינמית – בלי התחייבות.</p>
    </div>

    <!-- כפתורי פעולה -->
    <div class="upgrade-actions">
      <button class="upgrade-btn primary" onclick="app.startFreeTrial()">
        ⭐ התחלת ניסיון פרימיום (7 ימים חינם)
      </button>
      <button class="upgrade-btn secondary" onclick="app.goToCheckout()">
        💳 שדרוג מיידי לפרימיום
      </button>
    </div>

    <!-- אבטחה -->
    <div class="security-note">
      <span class="security-icon">🔒</span>
      <span>תשלום בטוח דרך Stripe. פרטי האשראי אינם נשמרים אצלנו.</span>
    </div>

    <!-- שורת הרגעה -->
    <p class="reassurance-note">אפשר להמשיך להשתמש בגרסה החינמית גם בלי לשדרג ✨</p>
  </div>
</div>

<style>
/* עמוד שדרוג לפרימיום */
.upgrade-page {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 10000;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
  overflow-y: auto;
  padding: 20px;
}

.upgrade-page-content {
  max-width: 900px;
  margin: 0 auto;
  position: relative;
}

.upgrade-close-btn {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 1.5rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.upgrade-close-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.1);
}

.upgrade-header {
  text-align: center;
  color: white;
  margin-bottom: 30px;
  padding-top: 20px;
}

.upgrade-header h1 {
  font-size: 2.5rem;
  margin-bottom: 15px;
  text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.upgrade-subtitle {
  font-size: 1.1rem;
  opacity: 0.95;
  max-width: 600px;
  margin: 0 auto;
  line-height: 1.6;
}

.upgrade-plans-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 25px;
  margin-bottom: 30px;
}

.upgrade-plan {
  background: white;
  border-radius: 20px;
  padding: 30px;
  position: relative;
  box-shadow: 0 10px 40px rgba(0,0,0,0.15);
}

.upgrade-plan.premium {
  border: 3px solid #fbbf24;
  transform: scale(1.02);
}

.plan-badge {
  position: absolute;
  top: -12px;
  right: 20px;
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: white;
  padding: 5px 15px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 700;
}

.plan-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 15px;
}

.plan-icon {
  font-size: 2rem;
}

.plan-header h2 {
  font-size: 1.5rem;
  color: #1f2937;
  margin: 0;
}

.plan-desc {
  color: #6b7280;
  margin-bottom: 20px;
  font-size: 0.95rem;
}

.plan-features {
  list-style: none;
  padding: 0;
  margin: 0 0 25px 0;
}

.plan-features li {
  padding: 10px 0;
  border-bottom: 1px solid #f3f4f6;
  color: #374151;
  font-size: 0.95rem;
}

.plan-features li:last-child {
  border-bottom: none;
}

.plan-price {
  text-align: center;
  padding: 20px;
  background: #f9fafb;
  border-radius: 12px;
}

.plan-price .price-amount {
  display: block;
  font-size: 2rem;
  font-weight: 700;
  color: #1f2937;
}

.plan-price .price-period {
  color: #6b7280;
  font-size: 0.9rem;
}

.plan-pricing {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.price-option {
  position: relative;
  padding: 15px 20px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.price-option:hover {
  border-color: #667eea;
}

.price-option.recommended {
  border-color: #fbbf24;
  background: #fffbeb;
}

.price-option input {
  position: absolute;
  opacity: 0;
}

.price-option label {
  display: flex;
  align-items: center;
  gap: 15px;
  cursor: pointer;
  width: 100%;
}

.price-option .price-type {
  font-weight: 600;
  color: #374151;
  min-width: 50px;
}

.price-option .price-amount {
  font-size: 1.3rem;
  font-weight: 700;
  color: #667eea;
}

.price-option .price-period {
  color: #6b7280;
  font-size: 0.85rem;
  margin-right: auto;
}

.save-badge {
  position: absolute;
  top: -10px;
  left: 15px;
  background: #22c55e;
  color: white;
  padding: 3px 10px;
  border-radius: 10px;
  font-size: 0.75rem;
  font-weight: 600;
}

.trial-section {
  background: rgba(255,255,255,0.95);
  border-radius: 16px;
  padding: 25px;
  text-align: center;
  margin-bottom: 25px;
  border: 2px dashed #fbbf24;
}

.trial-icon {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

.trial-section h3 {
  color: #1f2937;
  margin-bottom: 10px;
  font-size: 1.3rem;
}

.trial-section p {
  color: #4b5563;
  margin-bottom: 8px;
}

.trial-note {
  font-size: 0.9rem;
  color: #6b7280 !important;
}

.upgrade-actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}

.upgrade-btn {
  padding: 18px 30px;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.upgrade-btn.primary {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: white;
  box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
}

.upgrade-btn.primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 30px rgba(251, 191, 36, 0.5);
}

.upgrade-btn.secondary {
  background: white;
  color: #667eea;
  border: 2px solid white;
}

.upgrade-btn.secondary:hover {
  background: rgba(255,255,255,0.9);
}

.security-note {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  color: rgba(255,255,255,0.9);
  font-size: 0.9rem;
  margin-bottom: 15px;
}

.reassurance-note {
  text-align: center;
  color: rgba(255,255,255,0.85);
  font-size: 0.9rem;
}

/* Responsive */
@media (max-width: 768px) {
  .upgrade-plans-container {
    grid-template-columns: 1fr;
  }
  
  .upgrade-plan.premium {
    transform: none;
    order: -1;
  }
  
  .upgrade-header h1 {
    font-size: 1.8rem;
  }
  
  .upgrade-btn {
    padding: 15px 20px;
    font-size: 1rem;
  }
}
</style>

/* סימוני פרימיום */
.premium-feature-btn {
  position: relative;
}

.premium-badge {
  font-size: 0.8rem;
  margin-right: 5px;
}

.premium-badge-small {
  font-size: 0.7rem;
  margin-right: auto;
  opacity: 0.8;
}

.export-option {
  display: flex;
  align-items: center;
  gap: 8px;
}

.upgrade-modal.hidden {
  display: none;
}

.upgrade-modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
}

.upgrade-modal-content {
  position: relative;
  background: white;
  border-radius: 20px;
  padding: 40px;
  max-width: 420px;
  width: 90%;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.upgrade-modal-close {
  position: absolute;
  top: 15px;
  left: 15px;
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #999;
  transition: color 0.2s;
}

.upgrade-modal-close:hover {
  color: #333;
}

.upgrade-modal-icon {
  font-size: 4rem;
  margin-bottom: 15px;
  animation: starPulse 2s ease-in-out infinite;
}

@keyframes starPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.upgrade-modal-title {
  font-size: 1.8rem;
  font-weight: 700;
  color: #333;
  margin-bottom: 10px;
}

.upgrade-modal-text {
  font-size: 1.1rem;
  color: #666;
  margin-bottom: 25px;
}

#upgradeFeatureName {
  font-weight: 600;
  color: #667eea;
}

.upgrade-modal-features {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 25px;
  text-align: right;
}

.upgrade-feature {
  padding: 8px 0;
  color: #444;
  font-size: 0.95rem;
}

.upgrade-feature:not(:last-child) {
  border-bottom: 1px solid #e9ecef;
}

.upgrade-modal-btn {
  width: 100%;
  padding: 15px 30px;
  font-size: 1.1rem;
  font-weight: 600;
  color: white;
  background: linear-gradient(135deg, #667eea, #764ba2);
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 10px;
}

.upgrade-modal-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.upgrade-modal-btn-secondary {
  width: 100%;
  padding: 12px 30px;
  font-size: 1rem;
  color: #666;
  background: transparent;
  border: none;
  cursor: pointer;
  transition: color 0.2s;
}

.upgrade-modal-btn-secondary:hover {
  color: #333;
}

/* כפתור כוכב פרימיום */
.premium-star-btn {
  background: transparent;
  border: none;
  font-size: 1.4rem;
  cursor: pointer;
  opacity: 0.9;
  transition: all 0.3s ease;
  padding: 5px 10px;
}

.premium-star-btn:hover {
  opacity: 1;
  transform: scale(1.2);
}

/* מודאל מידע פרימיום */
.premium-info-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.premium-info-modal.hidden {
  display: none;
}

.premium-info-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
}

.premium-info-content {
  position: relative;
  background: white;
  border-radius: 20px;
  padding: 35px;
  max-width: 750px;
  width: 95%;
  max-height: 90vh;
  overflow-y: auto;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s ease;
}

.premium-info-close {
  position: absolute;
  top: 15px;
  left: 15px;
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #999;
  transition: color 0.2s;
}

.premium-info-close:hover {
  color: #333;
}

.premium-info-title {
  font-size: 1.8rem;
  font-weight: 700;
  color: #333;
  margin-bottom: 10px;
}

.premium-info-subtitle {
  font-size: 1.1rem;
  color: #666;
  margin-bottom: 25px;
  line-height: 1.6;
}

.premium-plans {
  display: flex;
  gap: 20px;
  margin-bottom: 25px;
}

.premium-plan {
  flex: 1;
  padding: 20px;
  border-radius: 16px;
  text-align: right;
}

.premium-plan h3 {
  margin: 0 0 15px 0;
  font-size: 1.3rem;
  text-align: center;
}

.premium-plan ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.premium-plan li {
  padding: 10px 0;
  border-bottom: 1px solid rgba(0,0,0,0.1);
  font-size: 0.95rem;
}

.premium-plan li:last-child {
  border-bottom: none;
}

.free-plan {
  background: #f5f5f5;
}

.pro-plan {
  background: linear-gradient(135deg, #fff8e1, #fff3cd);
  border: 2px solid #ffc107;
}

.premium-upgrade-btn {
  width: 100%;
  margin-top: 20px;
  padding: 14px 24px;
  font-size: 1.1rem;
  font-weight: 600;
  color: #333;
  background: linear-gradient(135deg, #ffc107, #ffca28);
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.premium-upgrade-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4);
}

.premium-info-close-btn {
  padding: 12px 40px;
  font-size: 1rem;
  color: #666;
  background: #f0f0f0;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
}

.premium-info-close-btn:hover {
  background: #e0e0e0;
  color: #333;
}

.pro-active-message {
  text-align: center;
  padding: 30px 20px;
}

.pro-active-icon {
  font-size: 3rem;
  margin-bottom: 15px;
}

.pro-active-message h4 {
  font-size: 1.4rem;
  color: #27ae60;
  margin: 0 0 10px 0;
}

.pro-active-message p {
  color: #666;
  margin: 0;
}

/* רספונסיבי */
@media (max-width: 600px) {
  .premium-plans {
    flex-direction: column;
  }
  
  .premium-info-content {
    padding: 25px 20px;
  }
}
</style>

<!-- חלונית התראות - מחוץ לכל האלמנטים -->
<div class="notifications-panel" id="notificationsPanel">
  <div class="notifications-header">
    <span>🔔 התראות קרובות</span>
    <button onclick="app.closeNotificationsPanel();">✕</button>
  </div>
  <div class="notifications-list" id="notificationsList">
    <!-- ההתראות יוספו כאן דינמית -->
  </div>
</div>

</body>
</html>